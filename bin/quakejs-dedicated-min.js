//     Underscore.js 1.4.1
//     http://underscorejs.org
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

/**
 * ByteBuffer v0.0.1
 * Copyright (c) 2012 Tim Kurvers <http://moonsphere.net>
 *
 * Wrapper for ArrayBuffer/DataView maintaining index and default endianness.
 * Supports arbitrary reading/writing, implicit growth, clipping, cloning and
 * reversing as well as UTF-8 characters and NULL-terminated C-strings.
 *
 * The contents of this file are subject to the MIT License, under which
 * this library is licensed. See the LICENSE file for the full license.
 */

(function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=r.unshift,l=i.toString,c=i.hasOwnProperty,h=r.forEach,p=r.map,d=r.reduce,v=r.reduceRight,m=r.filter,g=r.every,y=r.some,b=r.indexOf,w=r.lastIndexOf,E=Array.isArray,S=Object.keys,x=s.bind,T=function(e){if(e instanceof T)return e;if(!(this instanceof T))return new T(e);this._wrapped=e};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=T),exports._=T):e._=T,T.VERSION="1.4.1";var N=T.each=T.forEach=function(e,t,r){if(h&&e.forEach===h)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(T.has(e,o)&&t.call(r,e[o],o,e)===n)return};T.map=T.collect=function(e,t,n){var r=[];return p&&e.map===p?e.map(t,n):(N(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)},T.reduce=T.foldl=T.inject=function(e,t,n,r){var i=arguments.length>2;if(d&&e.reduce===d)return r&&(t=T.bind(t,r)),i?e.reduce(t,n):e.reduce(t);N(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},T.reduceRight=T.foldr=function(e,t,n,r){var i=arguments.length>2;if(v&&e.reduceRight===v)return r&&(t=T.bind(t,r)),arguments.length>2?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=T.keys(e);s=o.length}N(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},T.find=T.detect=function(e,t,n){var r;return C(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},T.filter=T.select=function(e,t,n){var r=[];return m&&e.filter===m?e.filter(t,n):(N(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},T.reject=function(e,t,n){var r=[];return N(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r},T.every=T.all=function(e,t,r){t||(t=T.identity);var i=!0;return g&&e.every===g?e.every(t,r):(N(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var C=T.some=T.any=function(e,t,r){t||(t=T.identity);var i=!1;return y&&e.some===y?e.some(t,r):(N(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};T.contains=T.include=function(e,t){var n=!1;return b&&e.indexOf===b?e.indexOf(t)!=-1:(n=C(e,function(e){return e===t}),n)},T.invoke=function(e,t){var n=u.call(arguments,2);return T.map(e,function(e){return(T.isFunction(t)?t:e[t]).apply(e,n)})},T.pluck=function(e,t){return T.map(e,function(e){return e[t]})},T.where=function(e,t){return T.isEmpty(t)?[]:T.filter(e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},T.max=function(e,t,n){if(!t&&T.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&T.isEmpty(e))return-Infinity;var r={computed:-Infinity};return N(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},T.min=function(e,t,n){if(!t&&T.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&T.isEmpty(e))return Infinity;var r={computed:Infinity};return N(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},T.shuffle=function(e){var t,n=0,r=[];return N(e,function(e){t=T.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return T.isFunction(e)?e:function(t){return t[e]}};T.sortBy=function(e,t,n){var r=k(t);return T.pluck(T.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(n<r||r===void 0)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t);return N(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};T.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(T.has(e,t)?e[t]:e[t]=[]).push(n)})},T.countBy=function(e,t,n){return L(e,t,n,function(e,t,n){T.has(e,t)||(e[t]=0),e[t]++})},T.sortedIndex=function(e,t,n,r){n=n==null?T.identity:k(n);var i=n.call(r,t),s=0,o=e.length;while(s<o){var u=s+o>>>1;n.call(r,e[u])<i?s=u+1:o=u}return s},T.toArray=function(e){return e?e.length===+e.length?u.call(e):T.values(e):[]},T.size=function(e){return e.length===+e.length?e.length:T.keys(e).length},T.first=T.head=T.take=function(e,t,n){return t!=null&&!n?u.call(e,0,t):e[0]},T.initial=function(e,t,n){return u.call(e,0,e.length-(t==null||n?1:t))},T.last=function(e,t,n){return t!=null&&!n?u.call(e,Math.max(e.length-t,0)):e[e.length-1]},T.rest=T.tail=T.drop=function(e,t,n){return u.call(e,t==null||n?1:t)},T.compact=function(e){return T.filter(e,function(e){return!!e})};var A=function(e,t,n){return N(e,function(e){T.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};T.flatten=function(e,t){return A(e,t,[])},T.without=function(e){return T.difference(e,u.call(arguments,1))},T.uniq=T.unique=function(e,t,n,r){var i=n?T.map(e,n,r):e,s=[],o=[];return N(i,function(n,r){if(t?!r||o[o.length-1]!==n:!T.contains(o,n))o.push(n),s.push(e[r])}),s},T.union=function(){return T.uniq(a.apply(r,arguments))},T.intersection=function(e){var t=u.call(arguments,1);return T.filter(T.uniq(e),function(e){return T.every(t,function(t){return T.indexOf(t,e)>=0})})},T.difference=function(e){var t=a.apply(r,u.call(arguments,1));return T.filter(e,function(e){return!T.contains(t,e)})},T.zip=function(){var e=u.call(arguments),t=T.max(T.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=T.pluck(e,""+r);return n},T.object=function(e,t){var n={};for(var r=0,i=e.length;r<i;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},T.indexOf=function(e,t,n){var r=0,i=e.length;if(n){if(typeof n!="number")return r=T.sortedIndex(e,t),e[r]===t?r:-1;r=n<0?Math.max(0,i+n):n}if(b&&e.indexOf===b)return e.indexOf(t,n);for(;r<i;r++)if(e[r]===t)return r;return-1},T.lastIndexOf=function(e,t,n){var r=n!=null;if(w&&e.lastIndexOf===w)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);var i=r?n:e.length;while(i--)if(e[i]===t)return i;return-1},T.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var O=function(){};T.bind=function(t,n){var r,i;if(t.bind===x&&x)return x.apply(t,u.call(arguments,1));if(!T.isFunction(t))throw new TypeError;return i=u.call(arguments,2),r=function(){if(this instanceof r){O.prototype=t.prototype;var e=new O,s=t.apply(e,i.concat(u.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(u.call(arguments)))}},T.bindAll=function(e){var t=u.call(arguments,1);return t.length==0&&(t=T.functions(e)),N(t,function(t){e[t]=T.bind(e[t],e)}),e},T.memoize=function(e,t){var n={};return t||(t=T.identity),function(){var r=t.apply(this,arguments);return T.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},T.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},T.defer=function(e){return T.delay.apply(T,[e,1].concat(u.call(arguments,1)))},T.throttle=function(e,t){var n,r,i,s,o,u,a=T.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&(u=e.apply(n,r)),a()};return i||(i=setTimeout(f,t)),s?o=!0:(s=!0,u=e.apply(n,r)),a(),u}},T.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},T.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments),e=null,n)}},T.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},T.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},T.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},T.keys=S||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)T.has(e,n)&&(t[t.length]=n);return t},T.values=function(e){var t=[];for(var n in e)T.has(e,n)&&t.push(e[n]);return t},T.pairs=function(e){var t=[];for(var n in e)T.has(e,n)&&t.push([n,e[n]]);return t},T.invert=function(e){var t={};for(var n in e)T.has(e,n)&&(t[e[n]]=n);return t},T.functions=T.methods=function(e){var t=[];for(var n in e)T.isFunction(e[n])&&t.push(n);return t.sort()},T.extend=function(e){return N(u.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},T.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return N(n,function(n){n in e&&(t[n]=e[n])}),t},T.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)T.contains(n,i)||(t[i]=e[i]);return t},T.defaults=function(e){return N(u.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},T.clone=function(e){return T.isObject(e)?T.isArray(e)?e.slice():T.extend({},e):e},T.tap=function(e,t){return t(e),e};var M=function(e,t,n,r){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e instanceof T&&(e=e._wrapped),t instanceof T&&(t=t._wrapped);var i=l.call(e);if(i!=l.call(t))return!1;switch(i){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var s=n.length;while(s--)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if(i=="[object Array]"){o=e.length,u=o==t.length;if(u)while(o--)if(!(u=M(e[o],t[o],n,r)))break}else{var a=e.constructor,f=t.constructor;if(a!==f&&!(T.isFunction(a)&&a instanceof a&&T.isFunction(f)&&f instanceof f))return!1;for(var c in e)if(T.has(e,c)){o++;if(!(u=T.has(t,c)&&M(e[c],t[c],n,r)))break}if(u){for(c in t)if(T.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};T.isEqual=function(e,t){return M(e,t,[],[])},T.isEmpty=function(e){if(e==null)return!0;if(T.isArray(e)||T.isString(e))return e.length===0;for(var t in e)if(T.has(e,t))return!1;return!0},T.isElement=function(e){return!!e&&e.nodeType===1},T.isArray=E||function(e){return l.call(e)=="[object Array]"},T.isObject=function(e){return e===Object(e)},N(["Arguments","Function","String","Number","Date","RegExp"],function(e){T["is"+e]=function(t){return l.call(t)=="[object "+e+"]"}}),T.isArguments(arguments)||(T.isArguments=function(e){return!!e&&!!T.has(e,"callee")}),typeof /./!="function"&&(T.isFunction=function(e){return typeof e=="function"}),T.isFinite=function(e){return T.isNumber(e)&&isFinite(e)},T.isNaN=function(e){return T.isNumber(e)&&e!=+e},T.isBoolean=function(e){return e===!0||e===!1||l.call(e)=="[object Boolean]"},T.isNull=function(e){return e===null},T.isUndefined=function(e){return e===void 0},T.has=function(e,t){return c.call(e,t)},T.noConflict=function(){return e._=t,this},T.identity=function(e){return e},T.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},T.random=function(e,t){return t==null&&(t=e,e=0),e+(0|Math.random()*(t-e+1))};var _={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};_.unescape=T.invert(_.escape);var D={escape:new RegExp("["+T.keys(_.escape).join("")+"]","g"),unescape:new RegExp("("+T.keys(_.unescape).join("|")+")","g")};T.each(["escape","unescape"],function(e){T[e]=function(t){return t==null?"":(""+t).replace(D[e],function(t){return _[e][t]})}}),T.result=function(e,t){if(e==null)return null;var n=e[t];return T.isFunction(n)?n.call(e):n},T.mixin=function(e){N(T.functions(e),function(t){var n=T[t]=e[t];T.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),F.call(this,n.apply(T,e))}})};var P=0;T.uniqueId=function(e){var t=P++;return e?e+t:t},T.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},j=/\\|'|\r|\n|\t|\u2028|\u2029/g;T.template=function(e,t,n){n=T.defaults({},n,T.templateSettings);var r=new RegExp([(n.escape||H).source,(n.interpolate||H).source,(n.evaluate||H).source].join("|")+"|$","g"),i=0,s="__p+='";e.replace(r,function(t,n,r,o,u){s+=e.slice(i,u).replace(j,function(e){return"\\"+B[e]}),s+=n?"'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":r?"'+\n((__t=("+r+"))==null?'':__t)+\n'":o?"';\n"+o+"\n__p+='":"",i=u+t.length}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{var o=new Function(n.variable||"obj","_",s)}catch(u){throw u.source=s,u}if(t)return o(t,T);var a=function(e){return o.call(this,e,T)};return a.source="function("+(n.variable||"obj")+"){\n"+s+"}",a},T.chain=function(e){return T(e).chain()};var F=function(e){return this._chain?T(e).chain():e};T.mixin(T),N(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];T.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),(e=="shift"||e=="splice")&&n.length===0&&delete n[0],F.call(this,n)}}),N(["concat","join","slice"],function(e){var t=r[e];T.prototype[e]=function(){return F.call(this,t.apply(this._wrapped,arguments))}}),T.extend(T.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),typeof define=="function"&&define.amd&&define("underscore",[],function(){return T})}).call(this),function(e,t){typeof exports=="object"?module.exports=t(global):typeof define=="function"&&define.amd?define("glmatrix",[],function(){return t(e)}):t(e)}(this,function(e){function i(e){return r=e,r}function s(){return r=typeof Float32Array!="undefined"?Float32Array:Array,r}var t=1e-6,n={};(function(){if(typeof Float32Array!="undefined"){var e=new Float32Array(1),t=new Int32Array(e.buffer);n.invsqrt=function(n){var r=n*.5;e[0]=n;var i=1.5;t[0]=1597463007-(t[0]>>1);var s=e[0];return s*(i-r*s*s)}}else n.invsqrt=function(e){return 1/Math.sqrt(e)}})();var r=null;s();var o={};o.create=function(e){var t=new r(3);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):t[0]=t[1]=t[2]=0,t},o.createFrom=function(e,t,n){var i=new r(3);return i[0]=e,i[1]=t,i[2]=n,i},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t},o.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n)},o.subtract=function(e,t,n){return!n||e===n?(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e):(n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n)},o.multiply=function(e,t,n){return!n||e===n?(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e):(n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n)},o.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},o.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e[2]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n)},o.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+r*r+i*i);return s?s===1?(t[0]=n,t[1]=r,t[2]=i,t):(s=1/s,t[0]=n*s,t[1]=r*s,t[2]=i*s,t):(t[0]=0,t[1]=0,t[2]=0,t)},o.cross=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=t[0],u=t[1],a=t[2];return n[0]=i*a-s*u,n[1]=s*o-r*a,n[2]=r*u-i*o,n},o.length=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)},o.squaredLength=function(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},o.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],o=Math.sqrt(r*r+i*i+s*s);return o?(o=1/o,n[0]=r*o,n[1]=i*o,n[2]=s*o,n):(n[0]=0,n[1]=0,n[2]=0,n)},o.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r},o.dist=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)};var u=null,a=new r(4);o.unproject=function(e,t,n,r,i){i||(i=e),u||(u=d.create());var s=u,o=a;return o[0]=(e[0]-r[0])*2/r[2]-1,o[1]=(e[1]-r[1])*2/r[3]-1,o[2]=2*e[2]-1,o[3]=1,d.multiply(n,t,s),d.inverse(s)?(d.multiplyVec4(s,o),o[3]===0?null:(i[0]=o[0]/o[3],i[1]=o[1]/o[3],i[2]=o[2]/o[3],i)):null};var f=o.createFrom(1,0,0),l=o.createFrom(0,1,0),c=o.createFrom(0,0,1),h=o.create();o.rotationTo=function(e,t,n){n||(n=v.create());var r=o.dot(e,t),i=h;if(r>=1)v.set(m,n);else if(r<1e-6-1)o.cross(f,e,i),o.length(i)<1e-6&&o.cross(l,e,i),o.length(i)<1e-6&&o.cross(c,e,i),o.normalize(i),v.fromAngleAxis(Math.PI,i,n);else{var s=Math.sqrt((1+r)*2),u=1/s;o.cross(e,t,i),n[0]=i[0]*u,n[1]=i[1]*u,n[2]=i[2]*u,n[3]=s*.5,v.normalize(n)}return n[3]>1?n[3]=1:n[3]<-1&&(n[3]=-1),n},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var p={};p.create=function(e){var t=new r(9);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]):t[0]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=0,t},p.createFrom=function(e,t,n,i,s,o,u,a,f){var l=new r(9);return l[0]=e,l[1]=t,l[2]=n,l[3]=i,l[4]=s,l[5]=o,l[6]=u,l[7]=a,l[8]=f,l},p.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*(f*s-o*a)+n*(-f*i+o*u)+r*(a*i-s*u)},p.inverse=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=l*o-u*f,h=-l*s+u*a,d=f*s-o*a,v=n*c+r*h+i*d,m;return v?(m=1/v,t||(t=p.create()),t[0]=c*m,t[1]=(-l*r+i*f)*m,t[2]=(u*r-i*o)*m,t[3]=h*m,t[4]=(l*n-i*a)*m,t[5]=(-u*n+i*s)*m,t[6]=d*m,t[7]=(-f*n+r*a)*m,t[8]=(o*n-r*s)*m,t):null},p.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=t[0],p=t[1],d=t[2],v=t[3],m=t[4],g=t[5],y=t[6],b=t[7],w=t[8];return n[0]=h*r+p*o+d*f,n[1]=h*i+p*u+d*l,n[2]=h*s+p*a+d*c,n[3]=v*r+m*o+g*f,n[4]=v*i+m*u+g*l,n[5]=v*s+m*a+g*c,n[6]=y*r+b*o+w*f,n[7]=y*i+b*u+w*l,n[8]=y*s+b*a+w*c,n},p.multiplyVec2=function(e,t,n){n||(n=t);var r=t[0],i=t[1];return n[0]=r*e[0]+i*e[3]+e[6],n[1]=r*e[1]+i*e[4]+e[7],n},p.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];return n[0]=r*e[0]+i*e[3]+s*e[6],n[1]=r*e[1]+i*e[4]+s*e[7],n[2]=r*e[2]+i*e[5]+s*e[8],n},p.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},p.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t&&Math.abs(e[4]-n[4])<t&&Math.abs(e[5]-n[5])<t&&Math.abs(e[6]-n[6])<t&&Math.abs(e[7]-n[7])<t&&Math.abs(e[8]-n[8])<t},p.identity=function(e){return e||(e=p.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},p.transpose=function(e,t){if(!t||e===t){var n=e[1],r=e[2],i=e[5];return e[1]=e[3],e[2]=e[6],e[3]=n,e[5]=e[7],e[6]=r,e[7]=i,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},p.toMat4=function(e,t){return t||(t=d.create()),t[15]=1,t[14]=0,t[13]=0,t[12]=0,t[11]=0,t[10]=e[8],t[9]=e[7],t[8]=e[6],t[7]=0,t[6]=e[5],t[5]=e[4],t[4]=e[3],t[3]=0,t[2]=e[2],t[1]=e[1],t[0]=e[0],t},p.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"};var d={};d.create=function(e){var t=new r(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},d.createFrom=function(e,t,n,i,s,o,u,a,f,l,c,h,p,d,v,m){var g=new r(16);return g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=s,g[5]=o,g[6]=u,g[7]=a,g[8]=f,g[9]=l,g[10]=c,g[11]=h,g[12]=p,g[13]=d,g[14]=v,g[15]=m,g},d.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},d.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t&&Math.abs(e[4]-n[4])<t&&Math.abs(e[5]-n[5])<t&&Math.abs(e[6]-n[6])<t&&Math.abs(e[7]-n[7])<t&&Math.abs(e[8]-n[8])<t&&Math.abs(e[9]-n[9])<t&&Math.abs(e[10]-n[10])<t&&Math.abs(e[11]-n[11])<t&&Math.abs(e[12]-n[12])<t&&Math.abs(e[13]-n[13])<t&&Math.abs(e[14]-n[14])<t&&Math.abs(e[15]-n[15])<t},d.identity=function(e){return e||(e=d.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},d.transpose=function(e,t){if(!t||e===t){var n=e[1],r=e[2],i=e[3],s=e[6],o=e[7],u=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=n,e[6]=e[9],e[7]=e[13],e[8]=r,e[9]=s,e[11]=e[14],e[12]=i,e[13]=o,e[14]=u,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},d.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m},d.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=e[9],h=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T,M;return O?(M=1/O,t[0]=(u*A-a*L+f*k)*M,t[1]=(-r*A+i*L-s*k)*M,t[2]=(v*x-m*S+g*E)*M,t[3]=(-c*x+h*S-p*E)*M,t[4]=(-o*A+a*C-f*N)*M,t[5]=(n*A-i*C+s*N)*M,t[6]=(-d*x+m*w-g*b)*M,t[7]=(l*x-h*w+p*b)*M,t[8]=(o*L-u*C+f*T)*M,t[9]=(-n*L+r*C-s*T)*M,t[10]=(d*S-v*w+g*y)*M,t[11]=(-l*S+c*w-p*y)*M,t[12]=(-o*k+u*N-a*T)*M,t[13]=(n*k-r*N+i*T)*M,t[14]=(-d*E+v*b-m*y)*M,t[15]=(l*E-c*b+h*y)*M,t):null},d.toRotationMat=function(e,t){return t||(t=d.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},d.toMat3=function(e,t){return t||(t=p.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},d.toInverseMat3=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[4],o=e[5],u=e[6],a=e[8],f=e[9],l=e[10],c=l*o-u*f,h=-l*s+u*a,d=f*s-o*a,v=n*c+r*h+i*d,m;return v?(m=1/v,t||(t=p.create()),t[0]=c*m,t[1]=(-l*r+i*f)*m,t[2]=(u*r-i*o)*m,t[3]=h*m,t[4]=(l*n-i*a)*m,t[5]=(-u*n+i*s)*m,t[6]=d*m,t[7]=(-f*n+r*a)*m,t[8]=(o*n-r*s)*m,t):null},d.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],y=e[15],b=t[0],w=t[1],E=t[2],S=t[3];return n[0]=b*r+w*u+E*c+S*v,n[1]=b*i+w*a+E*h+S*m,n[2]=b*s+w*f+E*p+S*g,n[3]=b*o+w*l+E*d+S*y,b=t[4],w=t[5],E=t[6],S=t[7],n[4]=b*r+w*u+E*c+S*v,n[5]=b*i+w*a+E*h+S*m,n[6]=b*s+w*f+E*p+S*g,n[7]=b*o+w*l+E*d+S*y,b=t[8],w=t[9],E=t[10],S=t[11],n[8]=b*r+w*u+E*c+S*v,n[9]=b*i+w*a+E*h+S*m,n[10]=b*s+w*f+E*p+S*g,n[11]=b*o+w*l+E*d+S*y,b=t[12],w=t[13],E=t[14],S=t[15],n[12]=b*r+w*u+E*c+S*v,n[13]=b*i+w*a+E*h+S*m,n[14]=b*s+w*f+E*p+S*g,n[15]=b*o+w*l+E*d+S*y,n},d.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12],n[1]=e[1]*r+e[5]*i+e[9]*s+e[13],n[2]=e[2]*r+e[6]*i+e[10]*s+e[14],n},d.multiplyVec4=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2],o=t[3];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*o,n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*o,n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*o,n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*o,n},d.translate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o,u,a,f,l,c,h,p,d,v,m,g;return!n||e===n?(e[12]=e[0]*r+e[4]*i+e[8]*s+e[12],e[13]=e[1]*r+e[5]*i+e[9]*s+e[13],e[14]=e[2]*r+e[6]*i+e[10]*s+e[14],e[15]=e[3]*r+e[7]*i+e[11]*s+e[15],e):(o=e[0],u=e[1],a=e[2],f=e[3],l=e[4],c=e[5],h=e[6],p=e[7],d=e[8],v=e[9],m=e[10],g=e[11],n[0]=o,n[1]=u,n[2]=a,n[3]=f,n[4]=l,n[5]=c,n[6]=h,n[7]=p,n[8]=d,n[9]=v,n[10]=m,n[11]=g,n[12]=o*r+l*i+d*s+e[12],n[13]=u*r+c*i+v*s+e[13],n[14]=a*r+h*i+m*s+e[14],n[15]=f*r+p*i+g*s+e[15],n)},d.scale=function(e,t,n){var r=t[0],i=t[1],s=t[2];return!n||e===n?(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,e[8]*=s,e[9]*=s,e[10]*=s,e[11]*=s,e):(n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*s,n[9]=e[9]*s,n[10]=e[10]*s,n[11]=e[11]*s,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n)},d.rotate=function(e,t,n,r){var i=n[0],s=n[1],o=n[2],u=Math.sqrt(i*i+s*s+o*o),a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;return u?(u!==1&&(u=1/u,i*=u,s*=u,o*=u),a=Math.sin(t),f=Math.cos(t),l=1-f,c=e[0],h=e[1],p=e[2],d=e[3],v=e[4],m=e[5],g=e[6],y=e[7],b=e[8],w=e[9],E=e[10],S=e[11],x=i*i*l+f,T=s*i*l+o*a,N=o*i*l-s*a,C=i*s*l-o*a,k=s*s*l+f,L=o*s*l+i*a,A=i*o*l+s*a,O=s*o*l-i*a,M=o*o*l+f,r?e!==r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=c*x+v*T+b*N,r[1]=h*x+m*T+w*N,r[2]=p*x+g*T+E*N,r[3]=d*x+y*T+S*N,r[4]=c*C+v*k+b*L,r[5]=h*C+m*k+w*L,r[6]=p*C+g*k+E*L,r[7]=d*C+y*k+S*L,r[8]=c*A+v*O+b*M,r[9]=h*A+m*O+w*M,r[10]=p*A+g*O+E*M,r[11]=d*A+y*O+S*M,r):null},d.rotateX=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11];return n?e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[4]=s*i+f*r,n[5]=o*i+l*r,n[6]=u*i+c*r,n[7]=a*i+h*r,n[8]=s*-r+f*i,n[9]=o*-r+l*i,n[10]=u*-r+c*i,n[11]=a*-r+h*i,n},d.rotateY=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[8],l=e[9],c=e[10],h=e[11];return n?e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*i+f*-r,n[1]=o*i+l*-r,n[2]=u*i+c*-r,n[3]=a*i+h*-r,n[8]=s*r+f*i,n[9]=o*r+l*i,n[10]=u*r+c*i,n[11]=a*r+h*i,n},d.rotateZ=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7];return n?e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*i+f*r,n[1]=o*i+l*r,n[2]=u*i+c*r,n[3]=a*i+h*r,n[4]=s*-r+f*i,n[5]=o*-r+l*i,n[6]=u*-r+c*i,n[7]=a*-r+h*i,n},d.frustum=function(e,t,n,r,i,s,o){o||(o=d.create());var u=t-e,a=r-n,f=s-i;return o[0]=i*2/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i*2/a,o[6]=0,o[7]=0,o[8]=(t+e)/u,o[9]=(r+n)/a,o[10]=-(s+i)/f,o[11]=-1,o[12]=0,o[13]=0,o[14]=-(s*i*2)/f,o[15]=0,o},d.perspective=function(e,t,n,r,i){var s=n*Math.tan(e*Math.PI/360),o=s*t;return d.frustum(-o,o,-s,s,n,r,i)},d.ortho=function(e,t,n,r,i,s,o){o||(o=d.create());var u=t-e,a=r-n,f=s-i;return o[0]=2/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/a,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/f,o[11]=0,o[12]=-(e+t)/u,o[13]=-(r+n)/a,o[14]=-(s+i)/f,o[15]=1,o},d.lookAt=function(e,t,n,r){r||(r=d.create());var i,s,o,u,a,f,l,c,h,p,v=e[0],m=e[1],g=e[2],y=n[0],b=n[1],w=n[2],E=t[0],S=t[1],x=t[2];return v===E&&m===S&&g===x?d.identity(r):(l=v-E,c=m-S,h=g-x,p=1/Math.sqrt(l*l+c*c+h*h),l*=p,c*=p,h*=p,i=b*h-w*c,s=w*l-y*h,o=y*c-b*l,p=Math.sqrt(i*i+s*s+o*o),p?(p=1/p,i*=p,s*=p,o*=p):(i=0,s=0,o=0),u=c*o-h*s,a=h*i-l*o,f=l*s-c*i,p=Math.sqrt(u*u+a*a+f*f),p?(p=1/p,u*=p,a*=p,f*=p):(u=0,a=0,f=0),r[0]=i,r[1]=u,r[2]=l,r[3]=0,r[4]=s,r[5]=a,r[6]=c,r[7]=0,r[8]=o,r[9]=f,r[10]=h,r[11]=0,r[12]=-(i*v+s*m+o*g),r[13]=-(u*v+a*m+f*g),r[14]=-(l*v+c*m+h*g),r[15]=1,r)},d.fromRotationTranslation=function(e,t,n){n||(n=d.create());var r=e[0],i=e[1],s=e[2],o=e[3],u=r+r,a=i+i,f=s+s,l=r*u,c=r*a,h=r*f,p=i*a,v=i*f,m=s*f,g=o*u,y=o*a,b=o*f;return n[0]=1-(p+m),n[1]=c+b,n[2]=h-y,n[3]=0,n[4]=c-b,n[5]=1-(l+m),n[6]=v+g,n[7]=0,n[8]=h+y,n[9]=v-g,n[10]=1-(l+p),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n},d.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var v={};v.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},v.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},v.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},v.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},v.identity=function(e){return e||(e=v.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};var m=v.identity();v.calculateW=function(e,t){var n=e[0],r=e[1],i=e[2];return!t||e===t?(e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e):(t[0]=n,t[1]=r,t[2]=i,t[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t)},v.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},v.inverse=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=n*n+r*r+i*i+s*s,u=o?1/o:0;return!t||e===t?(e[0]*=-u,e[1]*=-u,e[2]*=-u,e[3]*=u,e):(t[0]=-e[0]*u,t[1]=-e[1]*u,t[2]=-e[2]*u,t[3]=e[3]*u,t)},v.conjugate=function(e,t){return!t||e===t?(e[0]*=-1,e[1]*=-1,e[2]*=-1,e):(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t)},v.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},v.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=Math.sqrt(n*n+r*r+i*i+s*s);return o===0?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(o=1/o,t[0]=n*o,t[1]=r*o,t[2]=i*o,t[3]=s*o,t)},v.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n)},v.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=t[0],a=t[1],f=t[2],l=t[3];return n[0]=r*l+o*u+i*f-s*a,n[1]=i*l+o*a+s*u-r*f,n[2]=s*l+o*f+r*a-i*u,n[3]=o*l-r*u-i*a-s*f,n},v.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2],o=e[0],u=e[1],a=e[2],f=e[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return n[0]=l*f+p*-o+c*-a-h*-u,n[1]=c*f+p*-u+h*-o-l*-a,n[2]=h*f+p*-a+l*-u-c*-o,n},v.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n)},v.toMat3=function(e,t){t||(t=p.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,d=r*a,v=i*a,m=s*o,g=s*u,y=s*a;return t[0]=1-(h+v),t[1]=l+y,t[2]=c-g,t[3]=l-y,t[4]=1-(f+v),t[5]=d+m,t[6]=c+g,t[7]=d-m,t[8]=1-(f+h),t},v.toMat4=function(e,t){t||(t=d.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,v=i*a,m=s*o,g=s*u,y=s*a;return t[0]=1-(h+v),t[1]=l+y,t[2]=c-g,t[3]=0,t[4]=l-y,t[5]=1-(f+v),t[6]=p+m,t[7]=0,t[8]=c+g,t[9]=p-m,t[10]=1-(f+h),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},v.slerp=function(e,t,n,r){r||(r=e);var i=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],s,o,u,a;return Math.abs(i)>=1?(r!==e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]),r):(s=Math.acos(i),o=Math.sqrt(1-i*i),Math.abs(o)<.001?(r[0]=e[0]*.5+t[0]*.5,r[1]=e[1]*.5+t[1]*.5,r[2]=e[2]*.5+t[2]*.5,r[3]=e[3]*.5+t[3]*.5,r):(u=Math.sin((1-n)*s)/o,a=Math.sin(n*s)/o,r[0]=e[0]*u+t[0]*a,r[1]=e[1]*u+t[1]*a,r[2]=e[2]*u+t[2]*a,r[3]=e[3]*u+t[3]*a,r))},v.fromRotationMatrix=function(e,t){t||(t=v.create());var n=e[0]+e[4]+e[8],r;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var i=v.fromRotationMatrix.s_iNext=v.fromRotationMatrix.s_iNext||[1,2,0],s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);var o=i[s],u=i[o];r=Math.sqrt(e[s*3+s]-e[o*3+o]-e[u*3+u]+1),t[s]=.5*r,r=.5/r,t[3]=(e[u*3+o]-e[o*3+u])*r,t[o]=(e[o*3+s]+e[s*3+o])*r,t[u]=(e[u*3+s]+e[s*3+u])*r}return t},p.toQuat4=v.fromRotationMatrix,function(){var e=p.create();v.fromAxes=function(t,n,r,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=t[0],e[5]=t[1],e[8]=t[2],v.fromRotationMatrix(e,i)}}(),v.identity=function(e){return e||(e=v.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},v.fromAngleAxis=function(e,t,n){n||(n=v.create());var r=e*.5,i=Math.sin(r);return n[3]=Math.cos(r),n[0]=i*t[0],n[1]=i*t[1],n[2]=i*t[2],n},v.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var i=n.invsqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},v.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var g={};g.create=function(e){var t=new r(2);return e?(t[0]=e[0],t[1]=e[1]):(t[0]=0,t[1]=0),t},g.createFrom=function(e,t){var n=new r(2);return n[0]=e,n[1]=t,n},g.add=function(e,t,n){return n||(n=t),n[0]=e[0]+t[0],n[1]=e[1]+t[1],n},g.subtract=function(e,t,n){return n||(n=t),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n},g.multiply=function(e,t,n){return n||(n=t),n[0]=e[0]*t[0],n[1]=e[1]*t[1],n},g.divide=function(e,t,n){return n||(n=t),n[0]=e[0]/t[0],n[1]=e[1]/t[1],n},g.scale=function(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n},g.dist=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)},g.set=function(e,t){return t[0]=e[0],t[1]=e[1],t},g.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t},g.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t},g.normalize=function(e,t){t||(t=e);var n=e[0]*e[0]+e[1]*e[1];return n>0?(n=Math.sqrt(n),t[0]=e[0]/n,t[1]=e[1]/n):t[0]=t[1]=0,t},g.cross=function(e,t,n){var r=e[0]*t[1]-e[1]*t[0];return n?(n[0]=n[1]=0,n[2]=r,n):r},g.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},g.squaredLength=function(e){var t=e[0],n=e[1];return t*t+n*n},g.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},g.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1],s=r*r+i*i;return s?(s=1/Math.sqrt(s),n[0]=r*s,n[1]=i*s,n):(n[0]=0,n[1]=0,n[2]=0,n)},g.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r},g.str=function(e){return"["+e[0]+", "+e[1]+"]"};var y={};y.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},y.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},y.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},y.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},y.identity=function(e){return e||(e=y.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},y.transpose=function(e,t){if(!t||e===t){var n=e[1];return e[1]=e[2],e[2]=n,e}return t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3],t},y.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},y.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=n*s-i*r;return o?(o=1/o,t[0]=s*o,t[1]=-r*o,t[2]=-i*o,t[3]=n*o,t):null},y.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3];return n[0]=r*t[0]+i*t[2],n[1]=r*t[1]+i*t[3],n[2]=s*t[0]+o*t[2],n[3]=s*t[1]+o*t[3],n},y.rotate=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=Math.sin(t),a=Math.cos(t);return n[0]=r*a+i*u,n[1]=r*-u+i*a,n[2]=s*a+o*u,n[3]=s*-u+o*a,n},y.multiplyVec2=function(e,t,n){n||(n=t);var r=t[0],i=t[1];return n[0]=r*e[0]+i*e[1],n[1]=r*e[2]+i*e[3],n},y.scale=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=t[0],a=t[1];return n[0]=r*u,n[1]=i*a,n[2]=s*u,n[3]=o*a,n},y.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var b={};return b.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t},b.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},b.add=function(e,t,n){return n||(n=t),n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n},b.subtract=function(e,t,n){return n||(n=t),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n},b.multiply=function(e,t,n){return n||(n=t),n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n},b.divide=function(e,t,n){return n||(n=t),n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n},b.scale=function(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n},b.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},b.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},b.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},b.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},b.squaredLength=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i},b.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r[3]=e[3]+n*(t[3]-e[3]),r},b.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},e&&(e.glMatrixArrayType=r,e.MatrixArray=r,e.setMatrixArrayType=i,e.determineMatrixArrayType=s,e.glMath=n,e.vec2=g,e.vec3=o,e.vec4=b,e.mat2=y,e.mat3=p,e.mat4=d,e.quat4=v),{glMatrixArrayType:r,MatrixArray:r,setMatrixArrayType:i,determineMatrixArrayType:s,glMath:n,vec2:g,vec3:o,vec4:b,mat2:y,mat3:p,mat4:d,quat4:v}}),define("common/qmath",[],function(){function r(e){if(!e)return 0;var t=0,r=0,i;for(var s=0,o=n.length;s<o;s++)i=vec3.dot(e,n[s]),i>r&&(r=i,t=s);return t}function i(e,t){if(e<0||e>=n.length){vec3.set(t,[0,0,0]);return}vec3.set(n[e],t)}function s(){return 2*(Math.random()-.5)}function o(e,t){var n,r,i=1;for(var n=0,r=0;n<3;n++)Math.abs(e[n])<i&&(r=n,i=Math.abs(e[n]));var s=[0,0,0];s[r]=1,B(s,e,t),vec3.normalize(t)}function l(e){return e*Math.PI/180}function c(e){return e*180/Math.PI}function h(e,t){var n=e-t;while(n>180)n-=360;while(n<-180)n+=360;return n}function p(e,t,n){n[0]=h(e[0],t[0]),n[1]=h(e[1],t[1]),n[2]=h(e[2],t[2])}function d(e,t,n){return t-e>180&&(t-=360),t-e<-180&&(t+=360),e+n*(t-e)}function v(e){return e=360/65536*(parseInt(e*(65536/360),10)&65535),e}function m(e){return e=v(e),e>180&&(e-=360),e}function g(e,t,n,r){var i,s,o,l,c,h,p;i=e[a]*(Math.PI*2/360),l=Math.sin(i),p=Math.cos(i),i=e[u]*(Math.PI*2/360),o=Math.sin(i),h=Math.cos(i),i=e[f]*(Math.PI*2/360),s=Math.sin(i),c=Math.cos(i),t&&(t[0]=h*p,t[1]=h*l,t[2]=-o),n&&(n[0]=-1*s*o*p+ -1*c*-l,n[1]=-1*s*o*l+ -1*c*p,n[2]=-1*s*h),r&&(r[0]=c*o*p+ -s*-l,r[1]=c*o*l+ -s*p,r[2]=c*h)}function y(e,t){var n,r,i;e[1]===0&&e[0]===0?(r=0,i=e[2]>0?90:270):(e[0]?r=Math.atan2(e[1],e[0])*180/Math.PI:e[1]>0?r=90:r=270,r<0&&(r+=360),n=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=Math.atan2(e[2],n)*180/Math.PI,i<0&&(i+=360)),t[u]=-i,t[a]=r,t[f]=0}function b(e){return e*65536/360&65535}function w(e){return e*(360/65536)}function E(e){e[0][0]=1,e[0][1]=0,e[0][2]=0,e[1][0]=0,e[1][1]=1,e[1][2]=0,e[2][0]=0,e[2][1]=0,e[2][2]=1}function S(e,t){vec3.set(e[0],t[0]),vec3.set(e[1],t[1]),vec3.set(e[2],t[2])}function x(e,t){g(e,t[0],t[1],t[2]),vec3.negate(t[1])}function T(e,t,n){n[0][0]=e[0][0]*t[0][0]+e[0][1]*t[1][0]+e[0][2]*t[2][0],n[0][1]=e[0][0]*t[0][1]+e[0][1]*t[1][1]+e[0][2]*t[2][1],n[0][2]=e[0][0]*t[0][2]+e[0][1]*t[1][2]+e[0][2]*t[2][2],n[1][0]=e[1][0]*t[0][0]+e[1][1]*t[1][0]+e[1][2]*t[2][0],n[1][1]=e[1][0]*t[0][1]+e[1][1]*t[1][1]+e[1][2]*t[2][1],n[1][2]=e[1][0]*t[0][2]+e[1][1]*t[1][2]+e[1][2]*t[2][2],n[2][0]=e[2][0]*t[0][0]+e[2][1]*t[1][0]+e[2][2]*t[2][0],n[2][1]=e[2][0]*t[0][1]+e[2][1]*t[1][1]+e[2][2]*t[2][1],n[2][2]=e[2][0]*t[0][2]+e[2][1]*t[1][2]+e[2][2]*t[2][2]}function N(e,t){var n=vec3.set(e,[0,0,0]);e[0]=vec3.dot(t[0],n),e[1]=vec3.dot(t[1],n),e[2]=vec3.dot(t[2],n)}function C(e,t,n,r){var i=mat4.identity();mat4.rotate(i,l(n),t),mat4.multiplyVec3(i,e,r)}function k(e,t){o(e[0],e[1]);if(t){var n=vec3.create(e[1]);C(n,e[0],t,e[1])}vec3.cross(e[0],e[1],e[2])}function D(e){return e[0]==1?L:e[1]==1?A:e[2]==1?O:M}function P(e){var t=0;for(var n=0;n<3;n++)e[n]<0&&(t|=1<<n);return t}function H(e,t,n){if(n.type<M)return n.dist<=e[n.type]?1:n.dist>=t[n.type]?2:3;var r=[0,0];if(n.signbits<8)for(var i=0;i<3;i++){var s=n.signbits>>i&1;r[s]+=n.normal[i]*t[i],r[s^1]+=n.normal[i]*e[i]}var o=0;return r[0]>=n.dist&&(o=1),r[1]<n.dist&&(o|=2),o}function B(e,t,n){var r=vec3.scale(t,vec3.dot(t,e),[0,0,0]);vec3.subtract(e,r,n)}function j(e,t,n){var r=new _,i=vec3.subtract(t,e,[0,0,0]),s=vec3.subtract(n,e,[0,0,0]);return vec3.cross(s,i,r.normal),vec3.normalize(r.normal),vec3.length(r.normal)===0?null:(r.dist=vec3.dot(e,r.normal),r)}function F(e,t){var n,r,i=[0,0,0];for(var s=0;s<3;s++)n=Math.abs(e[s]),r=Math.abs(t[s]),i[s]=n>r?n:r;return vec3.length(i)}function I(e,t){e[0]=e[1]=e[2]=99999,t[0]=t[1]=t[2]=-99999}function q(e,t,n){e[0]<t[0]&&(t[0]=e[0]),e[0]>n[0]&&(n[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>n[1]&&(n[1]=e[1]),e[2]<t[2]&&(t[2]=e[2]),e[2]>n[2]&&(n[2]=e[2])}function R(e,t,n,r,i){return i=i||0,t[0]<n[0]-i||t[1]<n[1]-i||t[2]<n[2]-i||e[0]>r[0]+i||e[1]>r[1]+i||e[2]>r[2]+i?!1:!0}function U(e,t,n,r){return n[0]-r>t[0]||n[0]+r<e[0]||n[1]-r>t[1]||n[1]+r<e[1]||n[2]-r>t[2]||n[2]+r<e[2]?!1:!0}function z(e,t,n){return n[0]>t[0]||n[0]<e[0]||n[1]>t[1]||n[1]<e[1]||n[2]>t[2]||n[2]<e[2]?!1:!0}function X(e,t,n,r){var i=r-n,s=new Array(i),o=[].concat(W),u=[].concat(W),a=[].concat(W),f=[].concat(W),l=0,c,h=0,p,d=0,v,m=0,g,y;for(y=n;y<r;y++)c=e[y][t]&255,p=e[y][t]>>8&255,v=e[y][t]>>16&255,g=e[y][t]>>24&255^128,o[c]++,u[p]++,a[v]++,f[g]++;for(y=0;y<256;y++)c=l+o[y],p=h+u[y],v=d+a[y],g=m+f[y],o[y]=l,u[y]=h,a[y]=d,f[y]=m,l=c,h=p,d=v,m=g;for(y=n;y<r;y++)c=e[y][t]&255,s[o[c]]=e[y],o[c]++;for(y=0;y<i;y++)p=s[y][t]>>8&255,e[n+u[p]]=s[y],u[p]++;for(y=n;y<r;y++)v=e[y][t]>>16&255,s[a[v]]=e[y],a[v]++;for(y=0;y<i;y++)g=s[y][t]>>24&255^128,e[n+f[g]]=s[y],f[g]++;return e}var e=[0,0,0],t=[[1,0,0],[0,1,0],[0,0,1]],n=[[-0.525731,0,.850651],[-0.442863,.238856,.864188],[-0.295242,0,.955423],[-0.309017,.5,.809017],[-0.16246,.262866,.951056],[0,0,1],[0,.850651,.525731],[-0.147621,.716567,.681718],[.147621,.716567,.681718],[0,.525731,.850651],[.309017,.5,.809017],[.525731,0,.850651],[.295242,0,.955423],[.442863,.238856,.864188],[.16246,.262866,.951056],[-0.681718,.147621,.716567],[-0.809017,.309017,.5],[-0.587785,.425325,.688191],[-0.850651,.525731,0],[-0.864188,.442863,.238856],[-0.716567,.681718,.147621],[-0.688191,.587785,.425325],[-0.5,.809017,.309017],[-0.238856,.864188,.442863],[-0.425325,.688191,.587785],[-0.716567,.681718,-0.147621],[-0.5,.809017,-0.309017],[-0.525731,.850651,0],[0,.850651,-0.525731],[-0.238856,.864188,-0.442863],[0,.955423,-0.295242],[-0.262866,.951056,-0.16246],[0,1,0],[0,.955423,.295242],[-0.262866,.951056,.16246],[.238856,.864188,.442863],[.262866,.951056,.16246],[.5,.809017,.309017],[.238856,.864188,-0.442863],[.262866,.951056,-0.16246],[.5,.809017,-0.309017],[.850651,.525731,0],[.716567,.681718,.147621],[.716567,.681718,-0.147621],[.525731,.850651,0],[.425325,.688191,.587785],[.864188,.442863,.238856],[.688191,.587785,.425325],[.809017,.309017,.5],[.681718,.147621,.716567],[.587785,.425325,.688191],[.955423,.295242,0],[1,0,0],[.951056,.16246,.262866],[.850651,-0.525731,0],[.955423,-0.295242,0],[.864188,-0.442863,.238856],[.951056,-0.16246,.262866],[.809017,-0.309017,.5],[.681718,-0.147621,.716567],[.850651,0,.525731],[.864188,.442863,-0.238856],[.809017,.309017,-0.5],[.951056,.16246,-0.262866],[.525731,0,-0.850651],[.681718,.147621,-0.716567],[.681718,-0.147621,-0.716567],[.850651,0,-0.525731],[.809017,-0.309017,-0.5],[.864188,-0.442863,-0.238856],[.951056,-0.16246,-0.262866],[.147621,.716567,-0.681718],[.309017,.5,-0.809017],[.425325,.688191,-0.587785],[.442863,.238856,-0.864188],[.587785,.425325,-0.688191],[.688191,.587785,-0.425325],[-0.147621,.716567,-0.681718],[-0.309017,.5,-0.809017],[0,.525731,-0.850651],[-0.525731,0,-0.850651],[-0.442863,.238856,-0.864188],[-0.295242,0,-0.955423],[-0.16246,.262866,-0.951056],[0,0,-1],[.295242,0,-0.955423],[.16246,.262866,-0.951056],[-0.442863,-0.238856,-0.864188],[-0.309017,-0.5,-0.809017],[-0.16246,-0.262866,-0.951056],[0,-0.850651,-0.525731],[-0.147621,-0.716567,-0.681718],[.147621,-0.716567,-0.681718],[0,-0.525731,-0.850651],[.309017,-0.5,-0.809017],[.442863,-0.238856,-0.864188],[.16246,-0.262866,-0.951056],[.238856,-0.864188,-0.442863],[.5,-0.809017,-0.309017],[.425325,-0.688191,-0.587785],[.716567,-0.681718,-0.147621],[.688191,-0.587785,-0.425325],[.587785,-0.425325,-0.688191],[0,-0.955423,-0.295242],[0,-1,0],[.262866,-0.951056,-0.16246],[0,-0.850651,.525731],[0,-0.955423,.295242],[.238856,-0.864188,.442863],[.262866,-0.951056,.16246],[.5,-0.809017,.309017],[.716567,-0.681718,.147621],[.525731,-0.850651,0],[-0.238856,-0.864188,-0.442863],[-0.5,-0.809017,-0.309017],[-0.262866,-0.951056,-0.16246],[-0.850651,-0.525731,0],[-0.716567,-0.681718,-0.147621],[-0.716567,-0.681718,.147621],[-0.525731,-0.850651,0],[-0.5,-0.809017,.309017],[-0.238856,-0.864188,.442863],[-0.262866,-0.951056,.16246],[-0.864188,-0.442863,.238856],[-0.809017,-0.309017,.5],[-0.688191,-0.587785,.425325],[-0.681718,-0.147621,.716567],[-0.442863,-0.238856,.864188],[-0.587785,-0.425325,.688191],[-0.309017,-0.5,.809017],[-0.147621,-0.716567,.681718],[-0.425325,-0.688191,.587785],[-0.16246,-0.262866,.951056],[.442863,-0.238856,.864188],[.16246,-0.262866,.951056],[.309017,-0.5,.809017],[.147621,-0.716567,.681718],[0,-0.525731,.850651],[.425325,-0.688191,.587785],[.587785,-0.425325,.688191],[.688191,-0.587785,.425325],[-0.955423,.295242,0],[-0.951056,.16246,.262866],[-1,0,0],[-0.850651,0,.525731],[-0.955423,-0.295242,0],[-0.951056,-0.16246,.262866],[-0.864188,.442863,-0.238856],[-0.951056,.16246,-0.262866],[-0.809017,.309017,-0.5],[-0.864188,-0.442863,-0.238856],[-0.951056,-0.16246,-0.262866],[-0.809017,-0.309017,-0.5],[-0.681718,.147621,-0.716567],[-0.681718,-0.147621,-0.716567],[-0.850651,0,-0.525731],[-0.688191,.587785,-0.425325],[-0.587785,.425325,-0.688191],[-0.425325,.688191,-0.587785],[-0.425325,-0.688191,-0.587785],[-0.587785,-0.425325,-0.688191],[-0.688191,-0.587785,-0.425325]],u=0,a=1,f=2,L=0,A=1,O=2,M=3,_=function(){this.normal=[0,0,0],this.dist=0,this.type=0,this.signbits=0};_.prototype.clone=function(e){return typeof e=="undefined"&&(e=new _),vec3.set(this.normal,e.normal),e.dist=this.dist,e.type=this.type,e.signbits=this.signbits,e};var W=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];return{vec3origin:e,axisDefault:t,DirToByte:r,ByteToDir:i,crandom:s,PerpendicularVector:o,PITCH:u,YAW:a,ROLL:f,DEG2RAD:l,RAD2DEG:c,AngleSubtract:h,AnglesSubtract:p,LerpAngle:d,AngleNormalize360:v,AngleNormalize180:m,AnglesToVectors:g,VectorToAngles:y,AngleToShort:b,ShortToAngle:w,AxisClear:E,AxisCopy:S,AnglesToAxis:x,AxisMultiply:T,RotatePoint:N,RotatePointAroundVector:C,RotateAroundDirection:k,PLANE_X:L,PLANE_Y:A,PLANE_Z:O,PLANE_NON_AXIAL:M,Plane:_,PlaneTypeForNormal:D,GetPlaneSignbits:P,BoxOnPlaneSide:H,ProjectPointOnPlane:B,PlaneFromPoints:j,RadiusFromBounds:F,ClearBounds:I,AddPointToBounds:q,BoundsIntersect:R,BoundsIntersectSphere:U,BoundsIntersectPoint:z,RadixSort:X}}),define("common/sh",["common/qmath"],function(e){function G(e){var t=65536,n=e.length,r=e.slice||e.subarray,i;if(n<t)i=String.fromCharCode.apply(String,e);else{var s=[],o=0;while(o<n)s.push(String.fromCharCode.apply(String,r.call(e,o,o+t))),o+=t;i=s.join("")}return btoa(i)}function rt(e){var t=e.match(/([^\.\[\]]+)/g);return t}function it(e,t){var n,r;for(n=0,r=t.length;n<r-1;n++)e=e[t[n]];return e[t[r-1]]}function st(e,t,n){var r,i;for(r=0,i=t.length;r<i-1;r++)e=e[t[r]];e[t[i-1]]=n}function ot(e){switch(e){case Y:return"readFloat";case Z:return"readByte";case et:return"readUnsignedByte";case tt:return"readUnsignedShort";case nt:return"readUnsignedInt";default:throw new Error("fnread: bad bit count "+e)}}function ut(e){switch(e){case Y:return"writeFloat";case Z:return"writeByte";case et:return"writeUnsignedByte";case tt:return"writeUnsignedShort";case nt:return"writeUnsignedInt";default:throw new Error("fnwrite: bad bit count "+e)}}function lt(e,t,n){t||(t=at),e.writeInt(n.serverTime),e.writeUnsignedShort(n.angles[0]),e.writeUnsignedShort(n.angles[1]),e.writeUnsignedShort(n.angles[2]),e.writeByte(n.forwardmove),e.writeByte(n.rightmove),e.writeByte(n.upmove),e.writeUnsignedShort(n.buttons),e.writeUnsignedByte(n.weapon)}function ct(e,t,n){n.serverTime=e.readInt(),n.angles[0]=e.readUnsignedShort(),n.angles[1]=e.readUnsignedShort(),n.angles[2]=e.readUnsignedShort(),n.forwardmove=e.readByte(),n.rightmove=e.readByte(),n.upmove=e.readByte(),n.buttons=e.readUnsignedShort(),n.weapon=e.readUnsignedByte()}function dt(e,t,n){var r,i,s,o,u,a;t||(t=pt),i=0;for(r=0;r<ht.length;r++)s=ht[r],o=it(t,s.path),u=it(n,s.path),o!==u&&i++;e.writeByte(i);for(r=0;r<ht.length;r++){s=ht[r],o=it(t,s.path),u=it(n,s.path);if(o===u)continue;a=ut(s.bits),e.writeByte(r),e[a](it(n,s.path))}if(x>16||T>16||N>16||C>16)throw new Error("Array maxes exceed bitmask length");var f=0,l=0,c=0,h=0;for(r=0;r<x;r++)n.stats[r]!==t.stats[r]&&(f|=1<<r);for(r=0;r<T;r++)n.persistant[r]!==t.persistant[r]&&(l|=1<<r);for(r=0;r<N;r++)n.powerups[r]!==t.powerups[r]&&(c|=1<<r);for(r=0;r<C;r++)n.ammo[r]!==t.ammo[r]&&(h|=1<<r);var p=(f?1:0)|(l?2:0)|(c?4:0)|(h?8:0);e.writeByte(p);if(f){e.writeShort(f);for(r=0;r<x;r++)f&1<<r&&e.writeShort(n.stats[r])}if(l){e.writeShort(l);for(r=0;r<T;r++)l&1<<r&&e.writeShort(n.persistant[r])}if(c){e.writeShort(c);for(r=0;r<N;r++)c&1<<r&&e.writeShort(n.powerups[r])}if(h){e.writeShort(h);for(r=0;r<C;r++)h&1<<r&&e.writeShort(n.ammo[r])}}function vt(e,t,n){var r,i,s,o,u,a,f;t||(t=pt),t.clone(n),i=e.readByte();for(r=0;r<i;r++)s=e.readByte(),o=ht[s],f=ot(o.bits),st(n,o.path,e[f]());var l=e.readByte();if(l&1){var c=e.readShort();for(r=0;r<x;r++)c&1<<r&&(n.stats[r]=e.readShort())}if(l&2){var h=e.readShort();for(r=0;r<T;r++)h&1<<r&&(n.persistant[r]=e.readShort())}if(l&4){var p=e.readShort();for(r=0;r<N;r++)p&1<<r&&(n.powerups[r]=e.readShort())}if(l&8){var d=e.readShort();for(r=0;r<C;r++)d&1<<r&&(n.ammo[r]=e.readShort())}}function gt(e,t,n,r){var i,s,o,u,a,f;if(n===null){if(t===null)return;e.writeShort(t.number),e.writeByte(1);return}if(n.number<0||n.number>=h)throw new Error("WriteDeltaEntityState: Bad entity number: ",n.number);s=0;for(i=0;i<mt.length;i++)o=mt[i],u=it(t,o.path),a=it(n,o.path),u!==a&&s++;if(s===0){if(!r)return;e.writeShort(n.number),e.writeByte(0);return}e.writeShort(n.number),e.writeByte(2),e.writeByte(s);for(i=0;i<mt.length;i++){o=mt[i],u=it(t,o.path),a=it(n,o.path);if(u===a)continue;f=ut(o.bits),e.writeByte(i),e[f](it(n,o.path))}}function yt(e,t,n,r){var i,s,o,u,a,f,l;if(r<0||r>=h)throw new Error("Bad delta entity number: ",r);var c=e.readByte(),p=c&1,d=c&2;if(p){n.reset(),n.number=h-1;return}t.clone(n),n.number=r;if(!d)return;s=e.readByte();for(i=0;i<s;i++)o=e.readByte(),u=mt[o],l=ot(u.bits),st(n,u.path,e[l]())}var t=.1005,n=64,r=64,i=16777215,s={ARCHIVE:1,CHEAT:2,USERINFO:4,SERVERINFO:8,SYSTEMINFO:16,LATCH:32},o=65536,u=1,a=2,f=4,l=10,c=32,h=1024,p=256,d=256,v=h-1,m=h-2,g=h-2,y={NAD:0,LOOPBACK:1,IP:2},b={CLIENT:0,SERVER:1},w=function(e,t,n){this.type=e,this.ip=t,this.port=n},E={ATTACK:1,TALK:2,USE_HOLDABLE:4,GESTURE:8,WALKING:16,AFFIRMATIVE:32,NEGATIVE:64,GETFLAG:128,GUARDBASE:256,PATROL:512,FOLLOWME:1024,ANY:2048},S=function(){this.serverTime=0,this.angles=[0,0,0],this.forwardmove=0,this.rightmove=0,this.upmove=0,this.buttons=0,this.weapon=0};S.prototype.clone=function(e){return typeof e=="undefined"&&(e=new S),e.serverTime=this.serverTime,vec3.set(this.angles,e.angles),e.forwardmove=this.forwardmove,e.rightmove=this.rightmove,e.upmove=this.upmove,e.buttons=this.buttons,e.weapon=this.weapon,e};var x=16,T=16,N=16,C=16,k=2,L=6,A=function(){this.clientNum=0,this.commandTime=0,this.pm_type=0,this.pm_flags=0,this.origin=[0,0,0],this.velocity=[0,0,0],this.viewangles=[0,0,0],this.viewheight=0,this.delta_angles=[0,0,0],this.speed=0,this.gravity=0,this.groundEntityNum=v,this.bobCycle=0,this.weapon=0,this.weaponState=0,this.weaponTime=0,this.legsTimer=0,this.legsAnim=0,this.torsoTimer=0,this.torsoAnim=0,this.movementDir=0,this.damageEvent=0,this.damageYaw=0,this.damagePitch=0,this.damageCount=0,this.stats=new Array(x),this.persistant=new Array(T),this.powerups=new Array(N),this.ammo=new Array(C),this.eFlags=0,this.eventSequence=0,this.events=new Array(k),this.eventParms=new Array(k),this.externalEvent=0,this.externalEventParm=0,this.externalEventTime=0,this.ping=0,this.jumppad_ent=0,this.jumppad_frame=0,this.pmove_framecount=0,this.entityEventSequence=0;for(var e=0;e<x;e++)this.stats[e]=0;for(var e=0;e<T;e++)this.persistant[e]=0;for(var e=0;e<N;e++)this.powerups[e]=0;for(var e=0;e<C;e++)this.ammo[e]=0};A.prototype.clone=function(e){typeof e=="undefined"&&(e=new A),e.clientNum=this.clientNum,e.commandTime=this.commandTime,e.pm_type=this.pm_type,e.pm_flags=this.pm_flags,vec3.set(this.origin,e.origin),vec3.set(this.velocity,e.velocity),vec3.set(this.viewangles,e.viewangles),e.viewheight=this.viewheight,vec3.set(this.delta_angles,e.delta_angles),e.speed=this.speed,e.gravity=this.gravity,e.groundEntityNum=this.groundEntityNum,e.bobCycle=this.bobCycle,e.weapon=this.weapon,e.weaponState=this.weaponState,e.weaponTime=this.weaponTime,e.legsTimer=this.legsTimer,e.legsAnim=this.legsAnim,e.torsoTimer=this.torsoTimer,e.torsoAnim=this.torsoAnim,e.movementDir=this.movementDir,e.damageEvent=this.damageEvent,e.damageYaw=this.damageYaw,e.damagePitch=this.damagePitch,e.damageCount=this.damageCount;for(var t=0;t<x;t++)e.stats[t]=this.stats[t];for(var t=0;t<T;t++)e.persistant[t]=this.persistant[t];for(var t=0;t<N;t++)e.powerups[t]=this.powerups[t];for(var t=0;t<C;t++)e.ammo[t]=this.ammo[t];e.eFlags=this.eFlags,e.eventSequence=this.eventSequence;for(var t=0;t<k;t++)e.events[t]=this.events[t],e.eventParms[t]=this.eventParms[t];return e.externalEvent=this.externalEvent,e.externalEventParm=this.externalEventParm,e.externalEventTime=this.externalEventTime,e.jumppad_ent=this.jumppad_ent,e.jumppad_frame=this.jumppad_frame,e.pmove_framecount=this.pmove_framecount,e.entityEventSequence=this.entityEventSequence,e};var O={STATIONARY:0,INTERPOLATE:1,LINEAR:2,LINEAR_STOP:3,SINE:4,GRAVITY:5},M=function(){this.trType=0,this.trTime=0,this.trDuration=0,this.trBase=[0,0,0],this.trDelta=[0,0,0]};M.prototype.clone=function(e){return typeof e=="undefined"&&(e=new M),e.trType=this.trType,e.trTime=this.trTime,e.trDuration=this.trDuration,vec3.set(this.trBase,e.trBase),vec3.set(this.trDelta,e.trDelta),e};var _=function(){this.origin=[0,0,0],this.axis=[[0,0,0],[0,0,0],[0,0,0]],this.viewOrigin=[0,0,0],this.modelMatrix=mat4.create()};_.prototype.clone=function(e){return typeof e=="undefined"&&(e=new _),vec3.set(this.origin,e.origin),vec3.set(this.axis[0],e.axis[0]),vec3.set(this.axis[1],e.axis[1]),vec3.set(this.axis[2],e.axis[2]),vec3.set(this.viewOrigin,e.viewOrigin),mat4.set(this.modelMatrix,e.modelMatrix),e};var D=function(){this.reset()};D.prototype.reset=function(){this.number=0,this.eType=0,this.eFlags=0,this.pos=new M,this.apos=new M,this.time=0,this.time2=0,this.origin=[0,0,0],this.origin2=[0,0,0],this.angles=[0,0,0],this.angles2=[0,0,0],this.otherEntityNum=0,this.otherEntityNum2=0,this.groundEntityNum=v,this.constantLight=0,this.loopSound=0,this.modelIndex=0,this.modelIndex2=0,this.clientNum=0,this.frame=0,this.solid=0,this.event=0,this.eventParm=0,this.powerups=0,this.weapon=0,this.legsAnim=0,this.torsoAnim=0,this.generic1=0},D.prototype.clone=function(e){return typeof e=="undefined"&&(e=new D),e.number=this.number,e.eType=this.eType,e.eFlags=this.eFlags,this.pos.clone(e.pos),this.apos.clone(e.apos),e.time=this.time,e.time2=this.time2,vec3.set(this.origin,e.origin),vec3.set(this.origin2,e.origin2),vec3.set(this.angles,e.angles),vec3.set(this.angles2,e.angles2),e.otherEntityNum=this.otherEntityNum,e.otherEntityNum2=this.otherEntityNum2,e.groundEntityNum=this.groundEntityNum,e.constantLight=this.constantLight,e.loopSound=this.loopSound,e.modelIndex=this.modelIndex,e.modelIndex2=this.modelIndex2,e.clientNum=this.clientNum,e.frame=this.frame,e.solid=this.solid,e.event=this.event,e.eventParm=this.eventParm,e.powerups=this.powerups,e.weapon=this.weapon,e.legsAnim=this.legsAnim,e.torsoAnim=this.torsoAnim,e.generic1=this.generic1,e};var P={ENTITIES:0,SHADERS:1,PLANES:2,NODES:3,LEAFS:4,LEAFSURFACES:5,LEAFBRUSHES:6,MODELS:7,BRUSHES:8,BRUSHSIDES:9,DRAWVERTS:10,DRAWINDEXES:11,FOGS:12,SURFACES:13,LIGHTMAPS:14,LIGHTGRID:15,VISIBILITY:16,NUM_LUMPS:17},H={BAD:0,PLANAR:1,PATCH:2,TRIANGLE_SOUP:3,FLARE:4},B=function(){this.fileofs=0,this.filelen=0},j=function(){this.ident=null,this.version=0,this.lumps=new Array(P.NUM_LUMPS);for(var e=0;e<P.NUM_LUMPS;e++)this.lumps[e]=new B},F=function(){this.mins=[0,0,0],this.maxs=[0,0,0],this.firstSurface=0,this.numSurfaces=0,this.firstBrush=0,this.numBrushes=0};F.size=40;var I=function(){this.shaderName=null,this.surfaceFlags=0,this.contents=0};I.size=72;var q=function(){this.normal=[0,0,0],this.dist=0};q.size=16;var R=function(){this.planeNum=0,this.childrenNum=[0,0],this.mins=[0,0,0],this.maxs=[0,0,0]};R.size=36;var U=function(){this.cluster=0,this.area=0,this.mins=[0,0,0],this.maxs=[0,0,0],this.firstLeafSurface=0,this.numLeafSurfaces=0,this.firstLeafBrush=0,this.numLeafBrushes=0};U.size=48;var z=function(){this.planeNum=0,this.shader=0};z.size=8;var W=function(){this.side=0,this.numsides=0,this.shader=0};W.size=12;var X=function(){this.shader=null,this.brushNum=0,this.visibleSide=0};X.size=72;var V=function(){this.pos=[0,0,0],this.texCoord=[0,0],this.lmCoord=[0,0],this.normal=[0,0,0],this.color=[0,0,0,0]};V.size=44;var $=function(){this.shaderNum=0,this.fogNum=0,this.surfaceType=0,this.vertex=0,this.vertCount=0,this.meshVert=0,this.meshVertCount=0,this.lightmapNum=0,this.lmStart=[0,0],this.lmSize=[0,0],this.lmOrigin=[0,0,0],this.lmVecs=[[0,0,0],[0,0,0],[0,0,0]],this.patchWidth=0,this.patchHeight=0};$.size=104;var J={NODAMAGE:1,SLICK:2,SKY:4,LADDER:8,NOIMPACT:16,NOMARKS:32,FLESH:64,NODRAW:128,HINT:256,SKIP:512,NOLIGHTMAP:1024,POINTLIGHT:2048,METALSTEPS:4096,NOSTEPS:8192,NONSOLID:16384,LIGHTFILTER:32768,ALPHASHADOW:65536,NODLIGHT:131072,DUST:262144},K={SOLID:1,LAVA:8,SLIME:16,WATER:32,FOG:64,NOTTEAM1:128,NOTTEAM2:256,NOBOTCLIP:512,AREAPORTAL:32768,PLAYERCLIP:65536,MONSTERCLIP:131072,TELEPORTER:262144,JUMPPAD:524288,CLUSTERPORTAL:1048576,DONOTENTER:2097152,BOTCLIP:4194304,MOVER:8388608,ORIGIN:16777216,BODY:33554432,CORPSE:67108864,DETAIL:134217728,STRUCTURAL:268435456,TRANSLUCENT:536870912,TRIGGER:1073741824,NODROP:2147483648},Q={ATBASE:0,TAKEN:1,TAKEN_RED:2,TAKEN_BLUE:3,DROPPED:4},Y=0,Z=1,et=2,tt=3,nt=4,at=new S,ft=[{path:rt("angles[0]"),bits:tt},{path:rt("angles[1]"),bits:tt},{path:rt("angles[2]"),bits:tt},{path:rt("forwardmove"),bits:et},{path:rt("rightmove"),bits:et},{path:rt("upmove"),bits:et},{path:rt("buttons"),bits:tt},{path:rt("weapon"),bits:et}],ht=[{path:rt("commandTime"),bits:nt},{path:rt("origin[0]"),bits:Y},{path:rt("origin[1]"),bits:Y},{path:rt("bobCycle"),bits:et},{path:rt("velocity[0]"),bits:Y},{path:rt("velocity[1]"),bits:Y},{path:rt("viewangles[1]"),bits:Y},{path:rt("viewangles[0]"),bits:Y},{path:rt("weaponTime"),bits:tt},{path:rt("origin[2]"),bits:Y},{path:rt("velocity[2]"),bits:Y},{path:rt("legsTimer"),bits:et},{path:rt("pm_time"),bits:tt},{path:rt("eventSequence"),bits:tt},{path:rt("torsoAnim"),bits:et},{path:rt("movementDir"),bits:et},{path:rt("events[0]"),bits:et},{path:rt("legsAnim"),bits:et},{path:rt("events[1]"),bits:et},{path:rt("pm_flags"),bits:tt},{path:rt("groundEntityNum"),bits:tt},{path:rt("weaponState"),bits:et},{path:rt("eFlags"),bits:tt},{path:rt("externalEvent"),bits:tt},{path:rt("gravity"),bits:tt},{path:rt("speed"),bits:tt},{path:rt("delta_angles[1]"),bits:tt},{path:rt("externalEventParm"),bits:et},{path:rt("viewheight"),bits:et},{path:rt("damageEvent"),bits:et},{path:rt("damageYaw"),bits:et},{path:rt("damagePitch"),bits:et},{path:rt("damageCount"),bits:et},{path:rt("generic1"),bits:et},{path:rt("pm_type"),bits:et},{path:rt("delta_angles[0]"),bits:tt},{path:rt("delta_angles[2]"),bits:tt},{path:rt("torsoTimer"),bits:tt},{path:rt("eventParms[0]"),bits:et},{path:rt("eventParms[1]"),bits:et},{path:rt("clientNum"),bits:et},{path:rt("weapon"),bits:et},{path:rt("viewangles[2]"),bits:Y},{path:rt("jumppad_ent"),bits:tt},{path:rt("loopSound"),bits:tt}],pt=new A,mt=[{path:rt("pos.trTime"),bits:nt},{path:rt("pos.trBase[0]"),bits:Y},{path:rt("pos.trBase[1]"),bits:Y},{path:rt("pos.trDelta[0]"),bits:Y},{path:rt("pos.trDelta[1]"),bits:Y},{path:rt("pos.trBase[2]"),bits:Y},{path:rt("apos.trBase[1]"),bits:Y},{path:rt("pos.trDelta[2]"),bits:Y},{path:rt("apos.trBase[0]"),bits:Y},{path:rt("event"),bits:tt},{path:rt("angles2[1]"),bits:Y},{path:rt("eType"),bits:et},{path:rt("torsoAnim"),bits:et},{path:rt("eventParm"),bits:et},{path:rt("legsAnim"),bits:et},{path:rt("groundEntityNum"),bits:tt},{path:rt("pos.trType"),bits:et},{path:rt("eFlags"),bits:nt},{path:rt("otherEntityNum"),bits:tt},{path:rt("weapon"),bits:et},{path:rt("clientNum"),bits:et},{path:rt("angles[1]"),bits:Y},{path:rt("pos.trDuration"),bits:nt},{path:rt("apos.trType"),bits:et},{path:rt("origin[0]"),bits:Y},{path:rt("origin[1]"),bits:Y},{path:rt("origin[2]"),bits:Y},{path:rt("solid"),bits:nt},{path:rt("powerups"),bits:tt},{path:rt("modelIndex"),bits:et},{path:rt("otherEntityNum2"),bits:tt},{path:rt("loopSound"),bits:et},{path:rt("generic1"),bits:et},{path:rt("origin2[2]"),bits:Y},{path:rt("origin2[0]"),bits:Y},{path:rt("origin2[1]"),bits:Y},{path:rt("modelIndex2"),bits:et},{path:rt("angles[0]"),bits:Y},{path:rt("time"),bits:nt},{path:rt("apos.trTime"),bits:nt},{path:rt("apos.trDuration"),bits:nt},{path:rt("apos.trBase[2]"),bits:Y},{path:rt("apos.trDelta[0]"),bits:Y},{path:rt("apos.trDelta[1]"),bits:Y},{path:rt("apos.trDelta[2]"),bits:Y},{path:rt("time2"),bits:nt},{path:rt("angles[2]"),bits:Y},{path:rt("angles2[0]"),bits:Y},{path:rt("angles2[2]"),bits:Y},{path:rt("constantLight"),bits:nt},{path:rt("frame"),bits:tt}];return{GAME_VERSION:t,MAX_QPATH:n,CMD_BACKUP:r,SOLID_BMODEL:i,SNAPFLAG_RATE_DELAYED:u,SNAPFLAG_NOT_ACTIVE:a,SNAPFLAG_SERVERCOUNT:f,GENTITYNUM_BITS:l,MAX_CLIENTS:c,MAX_GENTITIES:h,MAX_MODELS:p,MAX_SOUNDS:d,ENTITYNUM_NONE:v,ENTITYNUM_WORLD:m,ENTITYNUM_MAX_NORMAL:g,MAX_STATS:x,MAX_PERSISTANT:T,MAX_POWERUPS:N,MAX_WEAPONS:C,MAX_PS_EVENTS:k,PMOVEFRAMECOUNTBITS:L,CVF:s,BUTTON:E,TR:O,SURF:J,CONTENTS:K,FLAG:Q,PlayerState:A,Trajectory:M,Orientation:_,EntityState:D,NetAdrType:y,NetSrc:b,NetAdr:w,UserCmd:S,Lumps:P,MapSurfaceType:H,lumps_t:B,dheader_t:j,dmodel_t:F,dshader_t:I,dplane_t:q,dnode_t:R,dleaf_t:U,dbrushside_t:z,dbrush_t:W,dfog_t:X,drawVert_t:V,dsurface_t:$,atob64:G,WriteDeltaUsercmd:lt,ReadDeltaUsercmd:ct,WriteDeltaPlayerState:dt,ReadDeltaPlayerState:vt,WriteDeltaEntityState:gt,ReadDeltaEntityState:yt}}),function(e){var t;t=function(){function u(t,n,i,s){var o;t==null&&(t=0),n==null&&(n=r.BIG_ENDIAN),i==null&&(i=!1),s==null&&(s=!1),this._buffer=null,this._raw=null,this._view=null,this._order=!!n,this._implicitGrowth=!!s,this._index=0,o=e(t,i),o||(o=new ArrayBuffer(t)),this.buffer=o}var e,t,n,r,i,s,o=this;return u.LITTLE_ENDIAN=!0,u.BIG_ENDIAN=!1,r=u,t=function(e,t){return Object.defineProperty(u.prototype,e,{get:t,enumerable:!0,configurable:!0})},i=function(e,t){return Object.defineProperty(u.prototype,e,{set:t,enumerable:!0,configurable:!0})},u.prototype._sanitizeIndex=function(){this._index<0&&(this._index=0);if(this._index>this.length)return this._index=this.length},e=function(e,t){t==null&&(t=!1);if(e.byteLength!=null)return e.buffer!=null?t?e.buffer.slice(0):e.buffer:t?e.slice(0):e;if(e.length==null)return null;try{return(new Uint8Array(e)).buffer}catch(n){return null}},t("buffer",function(){return this._buffer}),i("buffer",function(e){return this._buffer=e,this._raw=new Uint8Array(this._buffer),this._view=new DataView(this._buffer),this._sanitizeIndex()}),t("raw",function(){return this._raw}),t("view",function(){return this._view}),t("length",function(){return this._buffer.byteLength}),t("byteLength",function(){return this.length}),t("order",function(){return this._order}),i("order",function(e){return this._order=!!e}),t("implicitGrowth",function(){return this._implicitGrowth}),i("implicitGrowth",function(e){return this._implicitGrowth=!!e}),t("index",function(){return this._index}),i("index",function(e){if(e<0||e>this.length)throw new RangeError("Invalid index "+e+", should be between 0 and "+this.length);return this._index=e}),u.prototype.front=function(){return this._index=0,this},u.prototype.end=function(){return this._index=this.length,this},u.prototype.seek=function(e){return e==null&&(e=1),this.index+=e,this},t("available",function(){return this.length-this._index}),n=function(e,t){return function(n){var r;n==null&&(n=this._order);if(t>this.available)throw new Error("Cannot read "+t+" byte(s), "+this.available+" available");return r=this._view[e](this._index,n),this._index+=t,r}},s=function(e,t){return function(n,r){var i;r==null&&(r=this._order),i=this.available;if(t>i){if(!this._implicitGrowth)throw new Error("Cannot write "+n+" using "+t+" byte(s), "+i+" available");this.append(t-i)}return this._view[e](this._index,n,r),this._index+=t,this}},u.prototype.readByte=n("getInt8",1),u.prototype.readUnsignedByte=n("getUint8",1),u.prototype.readShort=n("getInt16",2),u.prototype.readUnsignedShort=n("getUint16",2),u.prototype.readInt=n("getInt32",4),u.prototype.readUnsignedInt=n("getUint32",4),u.prototype.readFloat=n("getFloat32",4),u.prototype.readDouble=n("getFloat64",8),u.prototype.writeByte=s("setInt8",1),u.prototype.writeUnsignedByte=s("setUint8",1),u.prototype.writeShort=s("setInt16",2),u.prototype.writeUnsignedShort=s("setUint16",2),u.prototype.writeInt=s("setInt32",4),u.prototype.writeUnsignedInt=s("setUint32",4),u.prototype.writeFloat=s("setFloat32",4),u.prototype.writeDouble=s("setFloat64",8),u.prototype.read=function(e){var t;e==null&&(e=this.available);if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(e<=0)throw new RangeError("Invalid number of bytes "+e);return t=new r(this._buffer.slice(this._index,this._index+e)),this._index+=e,t},u.prototype.write=function(t){var n,r,i;if(t instanceof Uint8Array)i=t;else{r=e(t);if(!r)throw new TypeError("Cannot write "+t+", not a sequence");i=new Uint8Array(r)}n=this.available;if(i.byteLength>n){if(!this._implicitGrowth)throw new Error("Cannot write "+t+" using "+i.byteLength+" byte(s), "+this.available+" available");this.append(i.byteLength-n)}return this._raw.set(i,this._index),this._index+=i.byteLength,this},u.prototype.readString=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;e==null&&(e=this.available);if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(e<=0)throw new RangeError("Invalid number of bytes "+e);h=this._raw,u=[],s=0,t=n=r=i=null,p=this._index+e;while(this._index<p){t=h[this._index];if(t<128)u[s++]=t,this._index++;else{if(t<194)throw new Error("Unexpected continuation byte");if(t<224){n=h[this._index+1];if(n<128||n>191)throw new Error("Bad continuation byte");u[s++]=((t&31)<<6)+(n&63),this._index+=2}else if(t<240){n=h[this._index+1];if(n<128||n>191)throw new Error("Bad continuation byte");r=h[this._index+2];if(r<128||r>191)throw new Error("Bad continuation byte");u[s++]=((t&15)<<12)+((n&63)<<6)+(r&63),this._index+=3}else{if(!(t<245))throw new Error("Illegal byte");n=h[this._index+1];if(n<128||n>191)throw new Error("Bad continuation byte");r=h[this._index+2];if(r<128||r>191)throw new Error("Bad continuation byte");i=h[this._index+3];if(i<128||i>191)throw new Error("Bad continuation byte");a=((t&7)<<18)+((n&63)<<12)+((r&63)<<6)+(i&63),a-=65536,u[s++]=55296+((a&1047552)>>>10),u[s++]=56320+(a&1023),this._index+=4}}}c=65536,l=u.length;if(l<c)return String.fromCharCode.apply(String,u);o=[],f=0;while(f<l)o.push(String.fromCharCode.apply(String,u.slice(f,f+c))),f+=c;return o.join("")},u.prototype.writeString=function(e){var t,n,r,i,s,o,u;n=[],u=e.length,o=0,t=0;while(o<u){r=e.charCodeAt(o);if(r<=127)n[t++]=r;else if(r<=2047)n[t++]=192|(r&1984)>>>6,n[t++]=128|r&63;else if(r<=55295||r>=57344&&r<=65535)n[t++]=224|(r&61440)>>>12,n[t++]=128|(r&4032)>>>6,n[t++]=128|r&63;else{if(o===u-1)throw new Error("Unpaired surrogate "+e[o]+" (index "+o+")");s=e.charCodeAt(++o);if(r<55296||r>56319||s<56320||s>57343)throw new Error("Unpaired surrogate "+e[o]+" (index "+o+")");i=((r&1023)<<10)+(s&1023)+65536,n[t++]=240|(i&1835008)>>>18,n[t++]=128|(i&258048)>>>12,n[t++]=128|(i&4032)>>>6,n[t++]=128|i&63}++o}return this.write(n),n.length},u.prototype.readUTFChars=u.prototype.readString,u.prototype.writeUTFChars=u.prototype.writeString,u.prototype.readCString=function(){var e,t,n,r;e=this._raw,n=e.length,t=this._index;while(e[t]!==0&&t<n)++t;return n=t-this._index,n>0?(r=this.readString(n),this.readByte(),r):null},u.prototype.writeCString=function(e){var t;return t=this.writeString(e),this.writeByte(0),++t},u.prototype.readASCIIString=function(e){var t,n,r,i,s;if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(e<=0)throw new RangeError("Invalid number of bytes "+e);t=0,i=[];while(t<e)n=this.readByte(),n!==0&&(i[t]=n),t++;r=65536;if(e<r)return String.fromCharCode.apply(String,i);s=[],t=0;while(t<e)s.push(String.fromCharCode.apply(String,i.slice(t,t+r))),t+=r;return s.join("")},u.prototype.writeASCIIString=function(e,t){var n,r,i,s;n=this._raw,r=0,i=t||e.length,s=[];while(r<i)s[r++]=r<e.length?e.charCodeAt(r):0;return this.write(s),i},u.prototype.prepend=function(e){var t;if(e<=0)throw new RangeError("Invalid number of bytes "+e);return t=new Uint8Array(this.length+e),t.set(this._raw,e),this._index+=e,this.buffer=t.buffer,this},u.prototype.append=function(e){var t;if(e<=0)throw new RangeError("Invalid number of bytes "+e);return t=new Uint8Array(this.length+e),t.set(this._raw,0),this.buffer=t.buffer,this},u.prototype.clip=function(e,t){var n;return e==null&&(e=this._index),t==null&&(t=this.length),e<0&&(e=this.length+e),n=this._buffer.slice(e,t),this._index-=e,this.buffer=n,this},u.prototype.slice=function(e,t){var n;return e==null&&(e=0),t==null&&(t=this.length),n=new r(this._buffer.slice(e,t)),n},u.prototype.clone=function(){var e;return e=new r(this._buffer.slice(0)),e.index=this._index,e},u.prototype.reverse=function(){return Array.prototype.reverse.call(this._raw),this._index=0,this},u.prototype.toArray=function(){return Array.prototype.slice.call(this._raw,0)},u.prototype.toString=function(){var e;return e=this._order===r.BIG_ENDIAN?"big-endian":"little-endian","[ByteBuffer; Order: "+e+"; Length: "+this.length+"; Index: "+this._index+"; Available: "+this.available+"]"},u.prototype.toHex=function(e){return e==null&&(e=" "),Array.prototype.map.call(this._raw,function(e){return("00"+e.toString(16).toUpperCase()).slice(-2)}).join(e)},u.prototype.toASCII=function(e,t,n){var r;return e==null&&(e=" "),t==null&&(t=!0),n==null&&(n="�"),r=t?" ":"",Array.prototype.map.call(this._raw,function(e){return e<32||e>126?r+n:r+String.fromCharCode(e)}).join(e)},u}.call(this),typeof define=="function"&&define.amd?define("ByteBuffer",[],function(){return t}):e.ByteBuffer=t}(this),define("game/bg",["glmatrix","common/qmath","common/sh"],function(e,t,n){function r(e){function et(e){r.Error(h.DROP,e)}function tt(e,t,n){e.events[e.eventSequence&o-1]=t,e.eventParms[e.eventSequence&o-1]=n,e.eventSequence++}function nt(e,n){e.pm_type===O.INTERMISSION||e.pm_type===O.SPECTATOR?n.eType=z.INVISIBLE:e.stats[B.HEALTH]<=d?n.eType=z.INVISIBLE:n.eType=z.PLAYER,n.number=e.clientNum,n.pos.trType=f.INTERPOLATE,vec3.set(e.origin,n.pos.trBase),vec3.set(e.velocity,n.pos.trDelta),n.apos.trType=f.INTERPOLATE,vec3.set(e.viewangles,n.apos.trBase),n.angles2[t.YAW]=e.movementDir,n.legsAnim=e.legsAnim,n.torsoAnim=e.torsoAnim,n.clientNum=e.clientNum,n.eFlags=e.eFlags,e.stats[B.HEALTH]<=0?n.eFlags|=W.DEAD:n.eFlags&=~W.DEAD;if(e.externalEvent)n.event=e.externalEvent,n.eventParm=e.externalEventParm;else if(e.entityEventSequence<e.eventSequence){e.entityEventSequence<e.eventSequence-o&&(e.entityEventSequence=e.eventSequence-o);var r=e.entityEventSequence&o-1;n.event=e.events[r]|(e.entityEventSequence&3)<<8,n.eventParm=e.eventParms[r],e.entityEventSequence++}n.weapon=e.weapon,n.groundEntityNum=e.groundEntityNum,n.powerups=0;for(var i=0;i<s;i++)e.powerups[i]&&(n.powerups|=1<<i);n.loopSound=e.loopSound,n.generic1=e.generic1}function rt(e,t,n){var i,s;switch(e.trType){case f.STATIONARY:case f.INTERPOLATE:vec3.set(e.trBase,n);break;case f.LINEAR:i=(t-e.trTime)*.001,vec3.add(e.trBase,vec3.scale(e.trDelta,i,[0,0,0]),n);break;case f.SINE:i=(t-e.trTime)/e.trDuration,s=Math.sin(i*Math.PI*2),vec3.add(e.trBase,vec3.scale(e.trDelta,s,[0,0,0]),n);break;case f.LINEAR_STOP:t>e.trTime+e.trDuration&&(t=e.trTime+e.trDuration),i=(t-e.trTime)*.001,i<0&&(i=0),vec3.add(e.trBase,vec3.scale(e.trDelta,i,[0,0,0]),n);break;case f.GRAVITY:i=(t-e.trTime)*.001,vec3.add(e.trBase,vec3.scale(e.trDelta,i,[0,0,0]),n),n[2]-=.5*p*i*i;break;default:r.Error(h.DROP,"EvaluateTrajectory: unknown trType: "+e.trType)}}function it(e,t,n){var i,s;switch(e.trType){case f.STATIONARY:case f.INTERPOLATE:n[0]=n[1]=n[2]=0;break;case f.LINEAR:vec3.set(e.trDelta,n);break;case f.SINE:i=(t-e.trTime)/e.trDuration,s=Math.cos(i*Math.PI*2),s*=.5,vec3.scale(e.trDelta,s,n);break;case f.LINEAR_STOP:if(t>e.trTime+e.trDuration){n[0]=n[1]=n[2]=0;return}vec3.set(e.trDelta,n);break;case f.GRAVITY:i=(t-e.trTime)*.001,vec3.set(e.trDelta,n),n[2]-=p*i;break;default:r.Error(h.DROP,"EvaluateTrajectoryDelta: unknown trType: "+e.trType)}}function st(e,n){if(e.pm_type!==O.NORMAL)return;if(e.powerups[F.FLIGHT])return;if(e.jumppad_ent!==n.number){var r=[0,0,0];t.VectorToAngles(n.origin2,r);var i=Math.abs(t.AngleNormalize180(r[t.PITCH])),s=i<45?0:1;tt(e,K.JUMP_PAD,s)}e.jumppad_ent=n.number,e.jumppad_frame=e.pmove_framecount,vec3.set(n.origin2,e.velocity)}function ot(e,t,n){(t.modelIndex<1||t.modelIndex>=on.length)&&r.Error(h.DROPPED,"CanItemBeGrabbed: index out of range");var i=on[t.modelIndex];switch(i.giType){case P.WEAPON:return!0;case P.AMMO:if(n.ammo[i.giTag]>=200)return!1;return!0;case P.ARMOR:if(n.stats[B.ARMOR]>=n.stats[B.MAX_HEALTH]*2)return!1;return!0;case P.HEALTH:if(i.quantity==5||i.quantity==100)return n.stats[B.HEALTH]>=n.stats[B.MAX_HEALTH]*2?!1:!0;if(n.stats[B.HEALTH]>=n.stats[B.MAX_HEALTH])return!1;return!0;case P.POWERUP:return!0;case P.TEAM:if(e==_.CTF)if(n.persistant[R.TEAM]==I.RED){if(i.giTag==F.BLUEFLAG||i.giTag==F.REDFLAG&&t.modelIndex2||i.giTag==F.REDFLAG&&n.powerups[F.BLUEFLAG])return!0}else if(n.persistant[R.TEAM]==I.BLUE)if(i.giTag==F.REDFLAG||i.giTag==F.BLUEFLAG&&t.modelIndex2||i.giTag==F.BLUEFLAG&&n.powerups[F.REDFLAG])return!0;return!1;case P.HOLDABLE:if(n.stats[B.HOLDABLE_ITEM])return!1;return!0;case P.BAD:et(h.DROP,"CanItemBeGrabbed: IT.BAD");default:}return!1}function ut(e,t,n){var r=[0,0,0];return rt(t.pos,n,r),e.origin[0]-r[0]>44||e.origin[0]-r[0]<-50||e.origin[1]-r[1]>36||e.origin[1]-r[1]<-36||e.origin[2]-r[2]>36||e.origin[2]-r[2]<-36?!1:!0}function Ct(e){var t=e.ps,n=e.cmd,r=n.serverTime;if(r<t.commandTime)return;r>t.commandTime+1e3&&(t.commandTime=r-1e3),t.pmove_framecount=t.pmove_framecount+1&(1<<u)-1;while(t.commandTime!==n.serverTime){var i=r-t.commandTime;i>66&&(i=66),n.serverTime=t.commandTime+i,kt(e),e.ps.pm_flags&M.JUMP_HELD&&(e.cmd.upmove=20)}}function kt(e){ft=e;var n=ft.ps,r=ft.cmd;at.reset(),at.msec=r.serverTime-n.commandTime,at.msec<1?at.msec=1:at.msec>200&&(at.msec=200),n.commandTime=r.serverTime,at.frameTime=at.msec*.001;if(Math.abs(r.forwardmove)>64||Math.abs(r.rightmove)>64)r.buttons&=~a.WALKING;!(n.pm_flags&M.RESPAWNED)&&!(n.pm_flags&M.NO_ATTACK)&&n.pm_type!==O.INTERMISSION&&n.pm_type!==O.NOCLIP&&r.buttons&a.ATTACK&&n.ammo[n.weapon]?n.eFlags|=W.FIRING:n.eFlags&=~W.FIRING,n.stats[B.HEALTH]>0&&!(r.buttons&(a.ATTACK|a.USE_HOLDABLE))&&(n.pm_flags&=~M.RESPAWNED),Xt(n,r),t.AnglesToVectors(n.viewangles,at.forward,at.right,at.up);if(Math.abs(r.forwardmove)>64||Math.abs(r.rightmove)>64)r.buttons&=~a.WALKING;ft.cmd.upmove<10&&(n.pm_flags&=~M.JUMP_HELD);if(r.forwardmove<0)n.pm_flags|=M.BACKWARDS_RUN;else if(ft.cmd.forwardmove>0||r.forwardmove===0&&r.rightmove)n.pm_flags&=~M.BACKWARDS_RUN;n.pm_type>=O.DEAD&&(r.forwardmove=0,r.rightmove=0,r.upmove=0);if(ft.ps.pm_type===O.SPECTATOR){At(),Ht(),Vt();return}if(ft.ps.pm_type===O.NOCLIP){Bt(),Vt();return}if(ft.ps.pm_type==O.INTERMISSION||ft.ps.pm_type==O.SPINTERMISSION)return;At(),Mt(),n.pm_type===O.DEAD&&Pt(),Vt(),at.walking?Ft():jt(),Mt(),$t(),Qt(),Gt(),ft=null}function Lt(e,t){var n=Math.abs(e.forwardmove);Math.abs(e.rightmove)>n&&(n=Math.abs(e.rightmove)),Math.abs(e.upmove)>n&&(n=Math.abs(e.upmove));if(!n)return 0;var r=Math.sqrt(e.forwardmove*e.forwardmove+e.rightmove*e.rightmove+e.upmove*e.upmove),i=t*n/(127*r);return i}function At(){var e=ft.ps;ft.mins[0]=-15,ft.mins[1]=-15,ft.maxs[0]=15,ft.maxs[1]=15,ft.mins[2]=E;if(ft.pm_type===O.DEAD){ft.maxs[2]=-8,e.viewheight=T;return}if(ft.cmd.upmove<0)e.pm_flags|=M.DUCKED;else if(e.pm_flags&M.DUCKED){ft.maxs[2]=32;var t=ft.trace(e.origin,e.origin,ft.mins,ft.maxs,e.clientNum,ft.tracemask);t.allSolid||(e.pm_flags&=~M.DUCKED)}e.pm_flags&M.DUCKED?(ft.maxs[2]=16,e.viewheight=x):(ft.maxs[2]=32,e.viewheight=S)}function Ot(){var e=ft.ps;return ft.cmd.upmove<10?!1:e.pm_flags&M.JUMP_HELD?(ft.cmd.upmove=0,!1):(at.groundPlane=!1,at.walking=!1,e.pm_flags|=M.JUMP_HELD,e.groundEntityNum=i,e.velocity[2]=Nt,Zt(K.JUMP),ft.cmd.forwardmove>=0?(sn(Y.LEGS_JUMP),e.pm_flags&=~M.BACKWARDS_JUMP):(sn(Y.LEGS_JUMPB),e.pm_flags|=M.BACKWARDS_JUMP),!0)}function Mt(){var e=ft.ps,t=[e.origin[0],e.origin[1],e.origin[2]-.25],n=ft.trace(e.origin,t,ft.mins,ft.maxs,e.clientNum,ft.tracemask);at.groundTrace=n;if(n.allSolid&&!_t(n))return;if(n.fraction===1){Dt();return}if(e.velocity[2]>0&&vec3.dot(e.velocity,n.plane.normal)>10){ft.cmd.forwardmove>=0?(sn(Y.LEGS_JUMP),e.pm_flags&=~M.BACKWARDS_JUMP):(sn(Y.LEGS_JUMPB),e.pm_flags|=M.BACKWARDS_JUMP),e.groundEntityNum=i,at.groundPlane=!1,at.walking=!1;return}if(n.plane.normal[2]<ct){e.groundEntityNum=i,at.groundPlane=!0,at.walking=!1;return}e.groundEntityNum=n.entityNum,at.groundPlane=!0,at.walking=!0}function _t(e){var t=ft.ps,n=[0,0,0],r;for(var s=-1;s<=1;s++)for(var o=-1;o<=1;o++)for(var u=-1;u<=1;u++){vec3.set(t.origin,n),n[0]+=s,n[1]+=o,n[2]+=u,r=ft.trace(n,n,ft.mins,ft.maxs,t.clientNum,ft.tracemask);if(!r.allSolid)return r.clone(e),!0}return t.groundEntityNum=i,at.groundPlane=!1,at.walking=!1,!1}function Dt(){var e=ft.ps;if(e.groundEntityNum!==i){var t=vec3.set(e.origin,[0,0,0]);t[2]-=64;var n=ft.trace(e.origin,t,ft.mins,ft.maxs,e.clientNum,ft.tracemask);n.fraction===1&&(ft.cmd.forwardmove>=0?(sn(Y.LEGS_JUMP),e.pm_flags&=~M.BACKWARDS_JUMP):(sn(Y.LEGS_JUMPB),e.pm_flags|=M.BACKWARDS_JUMP))}e.groundEntityNum=i,at.groundPlane=!1,at.walking=!1}function Pt(){if(!at.walking)return;var e=ft.ps,t=vec3.length(e.velocity);t-=20,t<=0?e.velocity[0]=e.velocity[1]=e.velocity[2]=0:(vec3.normalize(e.velocity),vec3.scale(e.velocity,t))}function Ht(){var e=ft.ps,t=ft.cmd;qt(!0);var n=Lt(t,e.speed),r=[0,0,0];for(var i=0;i<3;i++)r[i]=n*at.forward[i]*t.forwardmove+n*at.right[i]*t.rightmove;r[2]+=t.upmove;var s=vec3.length(r),o=vec3.normalize(r,[0,0,0]);Rt(o,s,wt),Wt(!1)}function Bt(){var e=ft.ps,n=ft.cmd;e.viewheight=S;var r=vec3.length(e.velocity);if(r<1)vec3.set(t.vec3origin,e.velocity);else{var i=Et*1.5,s=r<dt?dt:r,o=s*i*at.frameTime,u=r-o;u<0&&(u=0),u/=r,vec3.scale(e.velocity,u)}var a=Lt(n,e.speed),f=[0,0,0];for(var l=0;l<3;l++)f[l]=at.forward[l]*n.forwardmove+at.right[l]*n.rightmove;f[2]+=n.upmove;var c=vec3.length(f)*a,h=vec3.normalize(f,[0,0,0]);Rt(h,c,gt),vec3.add(e.origin,vec3.scale(e.velocity,at.frameTime,[0,0,0]))}function jt(){var e=ft.ps,t=ft.cmd;qt(),It(),at.forward[2]=0,at.right[2]=0,vec3.normalize(at.forward),vec3.normalize(at.right);var n=Lt(t,e.speed),r=[0,0,0];for(var i=0;i<2;i++)r[i]=at.forward[i]*t.forwardmove+at.right[i]*t.rightmove;r[2]=0;var s=vec3.length(r)*n,o=vec3.normalize(r,[0,0,0]);Rt(o,s,yt),at.groundPlane&&(e.velocity=Ut(e.velocity,at.groundTrace.plane.normal,pt)),Wt(!0)}function Ft(){var e=ft.ps,t=ft.cmd;if(Ot()){jt();return}qt(),It(),at.forward[2]=0,at.right[2]=0,at.forward=Ut(at.forward,at.groundTrace.plane.normal,pt),at.right=Ut(at.right,at.groundTrace.plane.normal,pt),vec3.normalize(at.forward),vec3.normalize(at.right);var n=Lt(t,e.speed),r=[0,0,0];for(var i=0;i<3;i++)r[i]=at.forward[i]*t.forwardmove+at.right[i]*t.rightmove;var s=vec3.length(r),o=vec3.normalize(r,[0,0,0]);s*=n;var u=gt;if(at.groundTrace.surfaceFlags&l.SLICK||e.pm_flags&M.TIME_KNOCKBACK)u=yt;Rt(o,s,u);if(at.groundTrace.surfaceFlags&l.SLICK||e.pm_flags&M.TIME_KNOCKBACK)e.velocity[2]-=e.gravity*at.frameTime;var a=vec3.length(e.velocity);e.velocity=Ut(e.velocity,at.groundTrace.plane.normal,pt),vec3.normalize(e.velocity),vec3.scale(e.velocity,a);if(!e.velocity[0]&&!e.velocity[1])return;Wt(!1)}function It(){var e=ft.ps;ft.cmd.forwardmove||ft.cmd.rightmove?ft.cmd.rightmove===0&&ft.cmd.forwardmove>0?e.movementDir=0:ft.cmd.rightmove<0&&ft.cmd.forwardmove>0?e.movementDir=1:ft.cmd.rightmove<0&&ft.cmd.forwardmove===0?e.movementDir=2:ft.cmd.rightmove<0&&ft.cmd.forwardmove<0?e.movementDir=3:ft.cmd.rightmove===0&&ft.cmd.forwardmove<0?e.movementDir=4:ft.cmd.rightmove>0&&ft.cmd.forwardmove<0?e.movementDir=5:ft.cmd.rightmove>0&&ft.cmd.forwardmove===0?e.movementDir=6:ft.cmd.rightmove>0&&ft.cmd.forwardmove>0&&(e.movementDir=7):e.movementDir===2?e.movementDir=1:e.movementDir===6&&(e.movementDir=7)}function qt(e){var t=ft.ps,n=vec3.set(t.velocity,[0,0,0]);at.walking&&(n[2]=0);var r=vec3.length(n);if(r<1){t.velocity[0]=0,t.velocity[1]=0;return}var i=0;if(at.walking&&!(at.groundTrace.surfaceFlags&l.SLICK)&&!(t.pm_flags&M.TIME_KNOCKBACK)){var s=r<dt?dt:r;i+=s*Et*at.frameTime}e&&(i+=r*xt*at.frameTime);var o=r-i;o<0&&(o=0),o/=r,vec3.scale(t.velocity,o)}function Rt(e,t,n){var r=ft.ps,i=vec3.dot(r.velocity,e),s=t-i;if(s<=0)return;var o=n*at.frameTime*t;o>s&&(o=s),vec3.add(r.velocity,vec3.scale(e,o,[0,0,0]))}function Ut(e,t,n){var r=vec3.dot(e,t);r<0?r*=n:r/=n;var i=vec3.scale(t,r,[0,0,0]);return vec3.subtract(e,i,[0,0,0])}function zt(e){var t=ft.ps,n=[0,0,0],r=at.frameTime,i=[],s=4,o=[0,0,0];e&&(vec3.set(t.velocity,n),n[2]-=t.gravity*r,t.velocity[2]=(t.velocity[2]+n[2])*.5,at.groundPlane&&(t.velocity=Ut(t.velocity,at.groundTrace.plane.normal,pt))),at.groundPlane&&i.push(vec3.set(at.groundTrace.plane.normal,[0,0,0])),i.push(vec3.normalize(t.velocity,[0,0,0]));for(var u=0;u<s;u++){vec3.add(t.origin,vec3.scale(t.velocity,r,[0,0,0]),o);var a=ft.trace(t.origin,o,ft.mins,ft.maxs,t.clientNum,ft.tracemask);if(a.allSolid)return t.velocity[2]=0,!1;a.fraction>0&&vec3.set(a.endPos,t.origin);if(a.fraction===1)break;r-=r*a.fraction;if(i.length>=lt)return t.velocity=[0,0,0],!1;for(var f=0;f<i.length;f++)if(vec3.dot(a.plane.normal,i[f])>.99){vec3.add(t.velocity,a.plane.normal);break}if(f<i.length)continue;i.push(vec3.set(a.plane.normal,[0,0,0]));for(var f=0;f<i.length;++f){var l=vec3.dot(t.velocity,i[f]);if(l>=.1)continue;var c=Ut(t.velocity,i[f],pt),h=Ut(n,i[f],pt);for(var p=0;p<i.length;p++){if(p===f)continue;if(vec3.dot(c,i[p])>=.1)continue;c=Ut(c,i[p],pt),h=Ut(h,i[p],pt);if(vec3.dot(c,i[f])>=0)continue;var d=vec3.cross(i[f],i[p],[0,0,0]);vec3.normalize(d);var v=vec3.dot(d,t.velocity);vec3.scale(d,v,c),vec3.cross(i[f],i[p],d),vec3.normalize(d),v=vec3.dot(d,n),vec3.scale(d,v,h);for(var m=0;m<i.length;m++){if(m==f||m==p)continue;if(vec3.dot(c,i[m])>=.1)continue;return t.velocity=[0,0,0],!1}}vec3.set(c,t.velocity),vec3.set(h,n);break}}return e&&vec3.set(n,t.velocity),u===0}function Wt(e){var t=ft.ps,n=vec3.set(t.origin,[0,0,0]),r=vec3.set(t.velocity,[0,0,0]);if(zt(e))return;var i=[0,0,1],s=vec3.set(n,[0,0,0]);s[2]-=ht;var o=ft.trace(n,s,ft.mins,ft.maxs,t.clientNum,ft.tracemask);if(t.velocity[2]>0&&(o.fraction===1||vec3.dot(o.plane.normal,i)<.7))return;vec3.set(n,i),i[2]+=ht,o=ft.trace(n,i,ft.mins,ft.maxs,t.clientNum,ft.tracemask);if(o.allSolid)return;vec3.set(o.endPos,t.origin),vec3.set(r,t.velocity),zt(e);var u=o.endPos[2]-n[2];vec3.set(t.origin,s),s[2]-=u,o=ft.trace(t.origin,s,ft.mins,ft.maxs,t.clientNum,ft.tracemask),o.allSolid||vec3.set(o.endPos,t.origin),o.fraction<1&&(t.velocity=Ut(t.velocity,o.plane.normal,pt));var a=t.origin[2]-n[2];a>2&&(a<7?Zt(K.STEP_4):a<11?Zt(K.STEP_8):a<15?Zt(K.STEP_12):Zt(K.STEP_16))}function Xt(e,n){if(e.pm_type===O.INTERMISSION||e.pm_type===O.SPINTERMISSION)return;if(e.pm_type!==O.SPECTATOR&&e.stats[B.HEALTH]<=0)return;for(var r=0;r<3;r++){var i=n.angles[r]+e.delta_angles[r]&65535;i>32767&&(i-=65535),r===t.PITCH&&(i>16e3?(e.delta_angles[r]=16e3-n.angles[r],i=16e3):i<-16e3&&(e.delta_angles[r]=-16e3-n.angles[r],i=-16e3)),e.viewangles[r]=t.ShortToAngle(i)}}function Vt(){var e=ft.ps;e.pm_time&&(at.msec>=e.pm_time?(e.pm_flags&=~M.ALL_TIMES,e.pm_time=0):e.pm_time-=at.msec)}function $t(){var e=ft.ps;if(e.pm_flags&M.RESPAWNED)return;if(ft.ps.persistant[R.SPECTATOR_STATE]!==q.NOT)return;if(e.pm_type===O.DEAD){e.weapon=j.NONE;return}e.weaponTime>0&&(e.weaponTime-=at.msec),(e.weaponTime<=0||e.weaponState!==D.FIRING)&&e.weapon!==ft.cmd.weapon&&Jt(ft.cmd.weapon);if(e.weaponTime>0)return;if(e.weaponState===D.DROPPING){Kt();return}if(e.weaponState===D.RAISING){e.weaponState=D.READY,e.weapon===j.GAUNTLET?en(Y.TORSO_STAND2):en(Y.TORSO_STAND);return}if(e.pm_flags&M.NO_ATTACK)return;if(!(ft.cmd.buttons&a.ATTACK)){e.weaponTime=0,e.weaponState=D.READY;return}if(e.weapon===j.GAUNTLET){if(!ft.gauntletHit){e.weaponTime=0,e.weaponState=D.READY;return}en(Y.TORSO_ATTACK2)}else en(Y.TORSO_ATTACK);e.weaponState=D.FIRING;if(!e.ammo[e.weapon]){Zt(K.NOAMMO),e.weaponTime+=500;return}e.ammo[e.weapon]!==-1&&e.ammo[e.weapon]--,Zt(K.FIRE_WEAPON);var t=0;switch(e.weapon){case j.GAUNTLET:t=400;break;case j.LIGHTNING:t=50;break;case j.SHOTGUN:t=1e3;break;case j.MACHINEGUN:t=100;break;case j.GRENADE_LAUNCHER:t=800;break;case j.ROCKET_LAUNCHER:t=800;break;case j.PLASMAGUN:t=100;break;case j.RAILGUN:t=1500;break;case j.BFG:t=200;break;case j.GRAPPLING_HOOK:t=400;break;default:t=400}e.powerups[F.HASTE]&&(t/=1.3),e.weaponTime+=t}function Jt(e){var t=ft.ps;if(e<=j.NONE||e>=j.NUM_WEAPONS)return;if(!(t.stats[B.WEAPONS]&1<<e))return;if(t.weaponState==D.DROPPING)return;Zt(K.CHANGE_WEAPON),t.weaponState=D.DROPPING,t.weaponTime+=200,en(Y.TORSO_DROP)}function Kt(){var e=ft.ps,t=ft.cmd.weapon;if(t<j.NONE||t>=j.NUM_WEAPONS)t=j.NONE;e.stats[B.WEAPONS]&1<<t||(t=j.NONE),e.weapon=t,e.weaponState=D.RAISING,e.weaponTime+=250,en(Y.TORSO_RAISE)}function Qt(){var e=ft.ps;e.weaponState===D.READY&&(e.weapon==j.GAUNTLET?rn(Y.TORSO_STAND2):rn(Y.TORSO_STAND))}function Gt(){var e=ft.ps;ft.xyspeed=Math.sqrt(e.velocity[0]*e.velocity[0]+e.velocity[1]*e.velocity[1]);if(e.groundEntityNum===i){ft.waterlevel>1&&nn(Y.LEGS_SWIM);return}if(!ft.cmd.forwardmove&&!ft.cmd.rightmove){ft.xyspeed<5&&(e.bobCycle=0,e.pm_flags&M.DUCKED?nn(Y.LEGS_IDLECR):nn(Y.LEGS_IDLE));return}var t=!1,n=0;e.pm_flags&M.DUCKED?(n=.5,e.pm_flags&M.BACKWARDS_RUN?nn(Y.LEGS_BACKCR):nn(Y.LEGS_WALKCR)):ft.cmd.buttons&a.WALKING?(n=.3,e.pm_flags&M.BACKWARDS_RUN?nn(Y.LEGS_BACKWALK):nn(Y.LEGS_WALK)):(n=.4,e.pm_flags&M.BACKWARDS_RUN?nn(Y.LEGS_BACK):nn(Y.LEGS_RUN),t=!0);var r=e.bobCycle;e.bobCycle=parseInt(r+n*at.msec,10)%256,(r+64^e.bobCycle+64)&128&&t&&!ft.noFootsteps&&Zt(Yt())}function Yt(){return at.groundTrace.surfaceFlags&l.NOSTEPS?0:at.groundTrace.surfaceFlags&l.METALSTEPS?K.FOOTSTEP_METAL:K.FOOTSTEP}function Zt(e){tt(ft.ps,e,0)}function en(e){var t=ft.ps;if(t.pm_type>=O.DEAD)return;t.torsoAnim=t.torsoAnim&G^G|e}function tn(e){var t=ft.ps;if(t.pm_type>=O.DEAD)return;if(t.legsTimer>0)return;t.legsAnim=t.legsAnim&G^G|e}function nn(e){var t=ft.ps;if((t.legsAnim&~G)===e)return;if(t.legsTimer>0)return;tn(e)}function rn(e){var t=ft.ps;if((t.torsoAnim&~G)===e)return;if(t.torsoTimer>0)return;en(e)}function sn(e){var t=ft.ps;t.legsTimer=0,tn(e)}var r=e.com,i=n.ENTITYNUM_NONE,s=n.MAX_POWERUPS,o=n.MAX_PS_EVENTS,u=n.PMOVEFRAMECOUNTBITS,a=n.BUTTON,f=n.TR,l=n.SURF,c=n.CONTENTS,h=r.ERR,p=800,d=-40,v=.66,m=16384,g=700,y=11,b=768,w=-9999,E=-24,S=26,x=12,T=-16,N=23,C=function(){this.reset()};C.prototype.reset=function(){this.forward=[0,0,0],this.right=[0,0,0],this.up=[0,0,0],this.frameTime=0,this.msec=0,this.walking=!1,this.groundPlane=!1,this.groundTrace=null,this.impactSpeed=0,this.previous_origin=[0,0,0],this.previous_velocity=[0,0,0],this.previous_waterlevel=0};var k=function(){this.ps=null,this.cmd=new n.UserCmd,this.mins=[0,0,0],this.maxs=[0,0,0],this.tracemask=0,this.gauntletHit=!1,this.xyspeed=0,this.watertype=0,this.waterlevel=0,this.trace=null},L=function(e,t,n,r,i,s,o,u,a,f){this.classname=e,this.pickupSound=t,this.models=n,this.icon=r,this.pickupName=i,this.quantity=s,this.giType=o,this.giTag=u,this.precache=a,this.sounds=f},A=function(){this.firstFrame=0,this.numFrames=0,this.loopFrames=0,this.frameLerp=0,this.initialLerp=0,this.reversed=!1,this.flipflop=!1},O={NORMAL:0,NOCLIP:1,SPECTATOR:2,DEAD:3,FREEZE:4,INTERMISSION:5,SPINTERMISSION:6},M={DUCKED:1,JUMP_HELD:2,NO_ATTACK:4,BACKWARDS_JUMP:8,BACKWARDS_RUN:16,TIME_LAND:32,TIME_KNOCKBACK:64,TIME_WATERJUMP:256,RESPAWNED:512,USE_ITEM_HELD:1024,GRAPPLE_PULL:2048,FOLLOW:4096,SCOREBOARD:8192,INVULEXPAND:16384,ALL_TIMES:352},_={FFA:0,TOURNAMENT:1,SINGLE_PLAYER:2,TEAM:3,CTF:4,NFCTF:5,CLANARENA:6,MAX_GAME_TYPE:7},D={READY:0,RAISING:1,DROPPING:2,FIRING:3},P={BAD:0,WEAPON:1,AMMO:2,ARMOR:3,HEALTH:4,POWERUP:5,HOLDABLE:6,PERSISTANT_POWERUP:7,TEAM:8},H={ALL:-1,SOLID:c.SOLID,PLAYERSOLID:c.SOLID|c.PLAYERCLIP|c.BODY,DEADSOLID:c.SOLID|c.PLAYERCLIP,WATER:c.WATER|c.LAVA|c.SLIME,OPAQUE:c.SOLID|c.SLIME|c.LAVA,SHOT:c.SOLID|c.BODY|c.CORPSE},B={HEALTH:0,HOLDABLE_ITEM:1,WEAPONS:2,ARMOR:3,DEAD_YAW:4,CLIENTS_READY:5,MAX_HEALTH:6},j={NONE:0,GAUNTLET:1,MACHINEGUN:2,SHOTGUN:3,GRENADE_LAUNCHER:4,ROCKET_LAUNCHER:5,LIGHTNING:6,RAILGUN:7,PLASMAGUN:8,BFG:9,GRAPPLING_HOOK:10,NUM_WEAPONS:11},F={NONE:0,QUAD:1,BATTLESUIT:2,HASTE:3,INVIS:4,REGEN:5,FLIGHT:6,REDFLAG:7,BLUEFLAG:8,NEUTRALFLAG:9,NUM_POWERUPS:10},I={FREE:0,RED:1,BLUE:2,SPECTATOR:3,NUM_TEAMS:4},q={NOT:0,FREE:1,FOLLOW:2,SCOREBOARD:3},R={SCORE:0,HITS:1,RANK:2,TEAM:3,SPECTATOR_STATE:4,SPAWN_COUNT:5,PLAYEREVENTS:6,ATTACKER:7,ATTACKEE_ARMOR:8,KILLED:9,IMPRESSIVE_COUNT:10,EXCELLENT_COUNT:11,DEFEND_COUNT:12,ASSIST_COUNT:13,GAUNTLET_FRAG_COUNT:14,CAPTURES:15},U={DENIEDREWARD:1,GAUNTLETREWARD:2,HOLYSHIT:4},z={GENERAL:0,PLAYER:1,ITEM:2,MISSILE:3,MOVER:4,BEAM:5,PORTAL:6,SPEAKER:7,PUSH_TRIGGER:8,TELEPORT_TRIGGER:9,INVISIBLE:10,GRAPPLE:11,TEAM:12,EVENTS:13},W={DEAD:1,TELEPORT_BIT:4,AWARD_EXCELLENT:8,PLAYER_EVENT:16,BOUNCE:16,BOUNCE_HALF:32,AWARD_GAUNTLET:64,NODRAW:128,FIRING:256,KAMIKAZE:512,MOVER_STOP:1024,AWARD_CAP:2048,TALK:4096,CONNECTION:8192,VOTED:16384,AWARD_IMPRESSIVE:32768,AWARD_DEFEND:65536,AWARD_ASSIST:131072,AWARD_DENIED:262144,TEAMVOTED:524288},X=256,V=512,$=X|V,J=300,K={NONE:0,FOOTSTEP:1,FOOTSTEP_METAL:2,FOOTSPLASH:3,FOOTWADE:4,SWIM:5,STEP_4:6,STEP_8:7,STEP_12:8,STEP_16:9,FALL_SHORT:10,FALL_MEDIUM:11,FALL_FAR:12,JUMP_PAD:13,JUMP:14,WATER_TOUCH:15,WATER_LEAVE:16,WATER_UNDER:17,WATER_CLEAR:18,ITEM_PICKUP:19,GLOBAL_ITEM_PICKUP:20,NOAMMO:21,CHANGE_WEAPON:22,FIRE_WEAPON:23,USE_ITEM0:24,USE_ITEM1:25,USE_ITEM2:26,USE_ITEM3:27,USE_ITEM4:28,USE_ITEM5:29,USE_ITEM6:30,USE_ITEM7:31,USE_ITEM8:32,USE_ITEM9:33,USE_ITEM10:34,USE_ITEM11:35,USE_ITEM12:36,USE_ITEM13:37,USE_ITEM14:38,USE_ITEM15:39,ITEM_RESPAWN:40,ITEM_POP:41,PLAYER_TELEPORT_IN:42,PLAYER_TELEPORT_OUT:43,GRENADE_BOUNCE:44,GENERAL_SOUND:45,GLOBAL_SOUND:46,GLOBAL_TEAM_SOUND:47,BULLET_HIT_FLESH:48,BULLET_HIT_WALL:49,MISSILE_HIT:50,MISSILE_MISS:51,MISSILE_MISS_METAL:52,RAILTRAIL:53,SHOTGUN:54,BULLET:55,PAIN:56,DEATH1:57,DEATH2:58,DEATH3:59,OBITUARY:60,POWERUP_QUAD:61,POWERUP_BATTLESUIT:62,POWERUP_REGEN:63,GIB_PLAYER:64,SCOREPLUM:65,DEBUG_LINE:66,STOPLOOPINGSOUND:67,TAUNT:68,TAUNT_YES:69,TAUNT_NO:70,TAUNT_FOLLOWME:71,TAUNT_GETFLAG:72,TAUNT_GUARDBASE:73,TAUNT_PATROL:74},Q={RED_CAPTURE:0,BLUE_CAPTURE:1,RED_RETURN:2,BLUE_RETURN:3,RED_TAKEN:4,BLUE_TAKEN:5,REDOBELISK_ATTACKED:6,BLUEOBELISK_ATTACKED:7,REDTEAM_SCORED:8,BLUETEAM_SCORED:9,REDTEAM_TOOK_LEAD:10,BLUETEAM_TOOK_LEAD:11,TEAMS_ARE_TIED:12,KAMIKAZE:13},G=128,Y={BOTH_DEATH1:0,BOTH_DEAD1:1,BOTH_DEATH2:2,BOTH_DEAD2:3,BOTH_DEATH3:4,BOTH_DEAD3:5,TORSO_GESTURE:6,TORSO_ATTACK:7,TORSO_ATTACK2:8,TORSO_DROP:9,TORSO_RAISE:10,TORSO_STAND:11,TORSO_STAND2:12,LEGS_WALKCR:13,LEGS_WALK:14,LEGS_RUN:15,LEGS_BACK:16,LEGS_SWIM:17,LEGS_JUMP:18,LEGS_LAND:19,LEGS_JUMPB:20,LEGS_LANDB:21,LEGS_IDLE:22,LEGS_IDLECR:23,LEGS_TURN:24,TORSO_GETFLAG:25,TORSO_GUARDBASE:26,TORSO_PATROL:27,TORSO_FOLLOWME:28,TORSO_AFFIRMATIVE:29,TORSO_NEGATIVE:30,MAX:31,LEGS_BACKCR:32,LEGS_BACKWALK:33,FLAG_RUN:34,FLAG_STAND:35,FLAG_STAND2RUN:36,MAX_TOTALANIMATIONS:37},Z={UNKNOWN:0,SHOTGUN:1,GAUNTLET:2,MACHINEGUN:3,GRENADE:4,GRENADE_SPLASH:5,ROCKET:6,ROCKET_SPLASH:7,PLASMA:8,PLASMA_SPLASH:9,RAILGUN:10,LIGHTNING:11,BFG:12,BFG_SPLASH:13,WATER:14,SLIME:15,LAVA:16,CRUSH:17,TELEFRAG:18,FALLING:19,SUICIDE:20,TARGET_LASER:21,TRIGGER_HURT:22,GRAPPLE:23},at=new C,ft=null,lt=5,ct=.7,ht=18,pt=1.001,dt=100,vt=.25,mt=.5,gt=10,yt=1,bt=4,wt=8,Et=6,St=1,xt=3,Tt=5,Nt=270,on=[new L,new L("item_armor_shard","sound/misc/ar1_pkup",["models/powerups/armor/shard.md3"],"icons/iconr_shard","Armor Shard",5,P.ARMOR,0),new L("item_armor_combat","sound/misc/ar2_pkup",["models/powerups/armor/armor_yel.md3"],"icons/iconr_yellow","Armor",50,P.ARMOR,0),new L("item_armor_body","sound/misc/ar2_pkup",["models/powerups/armor/armor_red.md3"],"icons/iconr_red","Heavy Armor",100,P.ARMOR,0),new L("item_health_small","sound/items/s_health",["models/powerups/health/small_cross.md3","models/powerups/health/small_sphere.md3"],"icons/iconh_green","5 Health",5,P.HEALTH,0),new L("item_health","sound/items/n_health",["models/powerups/health/medium_cross.md3","models/powerups/health/medium_sphere.md3"],"icons/iconh_yellow","25 Health",25,P.HEALTH,0),new L("item_health_large","sound/items/l_health",["models/powerups/health/large_cross.md3","models/powerups/health/large_sphere.md3"],"icons/iconh_red","50 Health",50,P.HEALTH,0),new L("item_health_mega","sound/items/m_health",["models/powerups/health/mega_cross.md3","models/powerups/health/mega_sphere.md3"],"icons/iconh_mega","Mega Health",100,P.HEALTH,0),new L("weapon_gauntlet","sound/misc/w_pkup",["models/weapons2/gauntlet/gauntlet.md3"],"icons/iconw_gauntlet","Gauntlet",0,P.WEAPON,j.GAUNTLET),new L("weapon_shotgun","sound/misc/w_pkup",["models/weapons2/shotgun/shotgun.md3"],"icons/iconw_shotgun","Shotgun",10,P.WEAPON,j.SHOTGUN),new L("weapon_machinegun","sound/misc/w_pkup",["models/weapons2/machinegun/machinegun.md3"],"icons/iconw_machinegun","Machinegun",40,P.WEAPON,j.MACHINEGUN),new L("weapon_grenadelauncher","sound/misc/w_pkup",["models/weapons2/grenadel/grenadel.md3"],"icons/iconw_grenade","Grenade Launcher",10,P.WEAPON,j.GRENADE_LAUNCHER,undefined,["sound/weapons/grenade/hgrenb1a","sound/weapons/grenade/hgrenb2a"]),new L("weapon_rocketlauncher","sound/misc/w_pkup",["models/weapons2/rocketl/rocketl.md3"],"icons/iconw_rocket","Rocket Launcher",10,P.WEAPON,j.ROCKET_LAUNCHER),new L("weapon_lightning","sound/misc/w_pkup",["models/weapons2/lightning/lightning.md3"],"icons/iconw_lightning","Lightning Gun",100,P.WEAPON,j.LIGHTNING),new L("weapon_railgun","sound/misc/w_pkup",["models/weapons2/railgun/railgun.md3"],"icons/iconw_railgun","Railgun",10,P.WEAPON,j.RAILGUN),new L("weapon_plasmagun","sound/misc/w_pkup",["models/weapons2/plasma/plasma.md3"],"icons/iconw_plasma","Plasma Gun",50,P.WEAPON,j.PLASMAGUN),new L("weapon_bfg","sound/misc/w_pkup",["models/weapons2/bfg/bfg.md3"],"icons/iconw_bfg","BFG10K",20,P.WEAPON,j.BFG),new L("weapon_grapplinghook","sound/misc/w_pkup",["models/weapons2/grapple/grapple.md3"],"icons/iconw_grapple","Grappling Hook",0,P.WEAPON,j.GRAPPLING_HOOK),new L("ammo_shells","sound/misc/am_pkup",["models/powerups/ammo/shotgunam.md3"],"icons/icona_shotgun","Shells",10,P.AMMO,j.SHOTGUN),new L("ammo_bullets","sound/misc/am_pkup",["models/powerups/ammo/machinegunam.md3"],"icons/icona_machinegun","Bullets",50,P.AMMO,j.MACHINEGUN),new L("ammo_grenades","sound/misc/am_pkup",["models/powerups/ammo/grenadeam.md3"],"icons/icona_grenade","Grenades",5,P.AMMO,j.GRENADE_LAUNCHER),new L("ammo_cells","sound/misc/am_pkup",["models/powerups/ammo/plasmaam.md3"],"icons/icona_plasma","Cells",30,P.AMMO,j.PLASMAGUN),new L("ammo_lightning","sound/misc/am_pkup",["models/powerups/ammo/lightningam.md3"],"icons/icona_lightning","Lightning",60,P.AMMO,j.LIGHTNING),new L("ammo_rockets","sound/misc/am_pkup",["models/powerups/ammo/rocketam.md3"],"icons/icona_rocket","Rockets",5,P.AMMO,j.ROCKET_LAUNCHER),new L("ammo_slugs","sound/misc/am_pkup",["models/powerups/ammo/railgunam.md3"],"icons/icona_railgun","Slugs",10,P.AMMO,j.RAILGUN),new L("ammo_bfg","sound/misc/am_pkup",["models/powerups/ammo/bfgam.md3"],"icons/icona_bfg","Bfg Ammo",15,P.AMMO,j.BFG),new L("item_quad","sound/items/quaddamage",["models/powerups/instant/quad.md3","models/powerups/instant/quad_ring.md3"],"icons/quad","Quad Damage",30,P.POWERUP,F.QUAD,undefined,["sound/items/damage2","sound/items/damage3"]),new L("team_CTF_redflag",null,["models/flags/r_flag.md3"],"icons/iconf_red1","Red Flag",0,P.TEAM,F.REDFLAG),new L("team_CTF_blueflag",null,["models/flags/b_flag.md3"],"icons/iconf_blu1","Blue Flag",0,P.TEAM,F.BLUEFLAG),new L("team_CTF_neutralflag",null,["models/flags/n_flag.md3"],"icons/iconf_neutral1","Neutral Flag",0,P.TEAM,F.NEUTRALFLAG),new L("item_redcube","sound/misc/am_pkup.wav",["models/powerups/orb/r_orb.md3"],"icons/iconh_rorb","Red Cube",0,P.TEAM,0),new L("item_bluecube","sound/misc/am_pkup.wav",["models/powerups/orb/b_orb.md3"],"icons/iconh_borb","Blue Cube",0,P.TEAM,0)];return{DEFAULT_GRAVITY:p,GIB_HEALTH:d,ARMOR_PROTECTION:v,RANK_TIED_FLAG:m,DEFAULT_SHOTGUN_SPREAD:g,DEFAULT_SHOTGUN_COUNT:y,LIGHTNING_RANGE:b,SCORE_NOT_PRESENT:w,DEFAULT_VIEWHEIGHT:S,CROUCH_VIEWHEIGHT:x,CS_FLAGSTATUS:N,ANIM_TOGGLEBIT:G,EV_EVENT_BIT1:X,EV_EVENT_BIT2:V,EV_EVENT_BITS:$,EVENT_VALID_MSEC:J,PM:O,PMF:M,GT:_,WS:D,IT:P,MASK:H,STAT:B,WP:j,PW:F,TEAM:I,SPECTATOR:q,PERS:R,PLAYEREVENTS:U,ET:z,EF:W,EV:K,GTS:Q,ANIM:Y,MOD:Z,PmoveInfo:k,Animation:A,ItemList:on,Pmove:Ct,UpdateViewAngles:Xt,AddPredictableEventToPlayerstate:tt,PlayerStateToEntityState:nt,EvaluateTrajectory:rt,EvaluateTrajectoryDelta:it,TouchJumpPad:st,CanItemBeGrabbed:ot,PlayerTouchesItem:ut}}return{CreateInstance:function(e){return new r(e)}}}),define("game/gm",["underscore","glmatrix","common/qmath","common/sh","game/bg"],function(_,glmatrix,QMath,sh,bg_mod){function Game(imp){function log(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"GM:"),Function.apply.call(console.log,console,e)}function error(e){com.Error(ERR.DROP,e)}function Init(e){log("Initializing"),level=new LevelLocals,level.time=e,level.startTime=e,gms||(gms=new GameStatic),g_gametype=com.AddCvar("g_gametype",0,CVF.SERVERINFO|CVF.LATCH),g_forcearena=com.AddCvar("g_forcearena",0,CVF.SERVERINFO|CVF.LATCH),g_maxGameClients=com.AddCvar("g_maxGameClients",0,CVF.SERVERINFO|CVF.LATCH|CVF.ARCHIVE),g_fraglimit=com.AddCvar("g_fraglimit",20,CVF.SERVERINFO|CVF.ARCHIVE|CVF.NORESTART),g_timelimit=com.AddCvar("g_timelimit",0,CVF.SERVERINFO|CVF.ARCHIVE|CVF.NORESTART),g_capturelimit=com.AddCvar("g_capturelimit",8,CVF.SERVERINFO|CVF.ARCHIVE|CVF.NORESTART),g_synchronousClients=com.AddCvar("g_synchronousClients",0,CVF.SYSTEMINFO),g_friendlyFire=com.AddCvar("g_friendlyFire",0,CVF.ARCHIVE),g_teamAutoJoin=com.AddCvar("g_teamAutoJoin",1,CVF.ARCHIVE),g_teamForceBalance=com.AddCvar("g_teamForceBalance",0,CVF.ARCHIVE),g_warmup=com.AddCvar("g_warmup",10,CVF.ARCHIVE),g_doWarmup=com.AddCvar("g_doWarmup",1,CVF.ARCHIVE),g_speed=com.AddCvar("g_speed",320),g_gravity=com.AddCvar("g_gravity",800),g_knockback=com.AddCvar("g_knockback",1e3),g_quadfactor=com.AddCvar("g_quadfactor",3),g_weaponRespawn=com.AddCvar("g_weaponrespawn",5),g_weaponTeamRespawn=com.AddCvar("g_weaponTeamRespawn",30),g_forcerespawn=com.AddCvar("g_forcerespawn",20),g_inactivity=com.AddCvar("g_inactivity",0),g_motd=com.AddCvar("g_motd",""),g_blood=com.AddCvar("g_blood",1),InitWorldSession(),level.maxclients=com.GetCvarVal("sv_maxClients"),sv.LocateGameData(level.gentities,level.clients),InitBodyQueue(),SpawnAllEntitiesFromDefs(),ChainTeams(),gms.warmupDisabled||ChangeWarmupState(-1),gms.warmupDisabled=!1}function Shutdown(){WriteSessionData()}function Frame(e){if(level.restarted){console.log("level restarted ignoring");return}level.framenum++,level.previousTime=level.time,level.time=e;for(var t=0;t<MAX_GENTITIES;t++){var n=level.gentities[t];if(!n.inuse)continue;if(level.time-n.eventTime>EVENT_VALID_MSEC){n.s.event&&(n.s.event=0,n.client&&(n.client.ps.externalEvent=0));if(n.freeAfterEvent){FreeEntity(n);continue}n.unlinkAfterEvent&&(n.unlinkAfterEvent=!1,sv.UnlinkEntity(n))}if(n.freeAfterEvent)continue;if(!n.linked&&n.neverFree)continue;if(n.s.eType===ET.MISSILE){RunMissile(n);continue}if(n.s.eType===ET.MOVER){RunMover(n);continue}if(t<level.maxclients){RunClient(n);continue}RunEntity(n)}for(var t=0;t<level.maxclients;t++){var n=level.gentities[t];n.inuse&&ClientEndFrame(n)}CheckWarmup(),CheckTournament(),CheckMatchRules(),CheckExitRules()}function ChangeWarmupState(e){if(!g_doWarmup()&&g_gametype()!==GT.CLANARENA)return;level.warmupTime=e,sv.SetConfigstring("warmup",level.warmupTime)}function CheckWarmup(){if(level.numPlayingClients===0)return;if(g_gametype()===GT.TOURNAMENT){if(level.numPlayingClients!==2){level.warmupTime!==-1&&ChangeWarmupState(-1);return}if(level.warmupTime===0)return;if(level.warmupTime<0){if(level.numPlayingClients===2){var e=0;g_warmup()>1&&(e=level.time+(g_warmup()-1)*1e3),ChangeWarmupState(e)}return}if(level.time>level.warmupTime){level.restarted=!0,gms.warmupDisabled=!0,com.ExecuteBuffer("map_restart 0");return}}else{var t=new Array(TEAM.NUM_TEAMS),n=!1;if(g_gametype()>GT.TEAM){t[TEAM.BLUE]=TeamCount(TEAM.BLUE,null),t[TEAM.RED]=TeamCount(TEAM.RED,null);if(t[TEAM.RED]<1||t[TEAM.BLUE]<1)n=!0}else level.numPlayingClients<2&&(n=!0);if(n){level.warmupTime!==-1&&ChangeWarmupState(-1);return}if(level.warmupTime===0)return;if(level.warmupTime<0){var e=0;g_warmup()>1&&(e=level.time+(g_warmup()-1)*1e3),ChangeWarmupState(e);return}if(level.time>level.warmupTime){g_gametype()===GT.CLANARENA?(ChangeWarmupState(0),StartMatch()):(level.restarted=!0,gms.warmupDisabled=!0,com.ExecuteBuffer("map_restart 0"));return}}}function CheckTournament(){g_gametype()===GT.TOURNAMENT&&level.numPlayingClients<2&&AddTournamentPlayer()}function CheckMatchRules(){if(g_gametype()!==GT.CLANARENA)return;if(level.warmupTime!==0)return;if(level.matchRestartTime){level.time>level.matchRestartTime&&RestartMatch();return}var e=new Array(TEAM.NUM_TEAMS);e[TEAM.RED]=TeamAliveCount(null,TEAM.RED),e[TEAM.BLUE]=TeamAliveCount(null,TEAM.BLUE),!e[TEAM.RED]&&!e[TEAM.BLUE]?EndMatch(null):e[TEAM.RED]?e[TEAM.BLUE]||EndMatch(TEAM.RED):EndMatch(TEAM.BLUE)}function StartMatch(){for(var e=0;e<level.maxclients;e++){var t=level.gentities[e];if(!t.inuse)continue;var n=t.client;if(n.sess.sessionTeam===TEAM.SPECTATOR)continue;n.ps.pm_type===PM.DEAD&&ClientSpawn(t)}}function EndMatch(e){log("EndMatch"),e===null?(level.teamScores[TEAM.RED]+=1,level.teamScores[TEAM.BLUE]+=1):level.teamScores[e]+=1,level.matchRestartTime=level.time+5e3}function RestartMatch(){level.matchRestartTime=0,ChangeWarmupState(-1);for(var e=0;e<level.maxclients;e++){var t=level.gentities[e];if(!t.inuse)continue;var n=t.client;if(n.sess.sessionTeam===TEAM.SPECTATOR)continue;n.sess.spectatorState=SPECTATOR.NOT,ClientSpawn(t)}}function CheckExitRules(){if(level.intermissiontime){CheckIntermissionExit();return}if(level.intermissionQueued){level.time-level.intermissionQueued>=INTERMISSION_DELAY_TIME&&(level.intermissionQueued=0,BeginIntermission());return}if(ScoreIsTied())return;if(g_timelimit()&&!level.warmupTime&&level.time-level.startTime>=g_timelimit()*6e4){sv.SendServerCommand(null,"print","Timelimit hit."),LogExit("Timelimit hit.");return}if(g_gametype()<GT.CTF&&g_fraglimit()){if(level.teamScores[TEAM.RED]>=g_fraglimit()){sv.SendServerCommand(null,"print","Red hit the fraglimit."),LogExit("Fraglimit hit.");return}if(level.teamScores[TEAM.BLUE]>=g_fraglimit()){sv.SendServerCommand(null,"print","Blue hit the fraglimit."),LogExit("Fraglimit hit.");return}for(var e=0;e<level.maxclients;e++){var t=level.clients[e];if(t.pers.connected!==CON.CONNECTED)continue;if(t.sess.sessionTeam!==TEAM.FREE)continue;if(t.ps.persistant[PERS.SCORE]>=g_fraglimit()){sv.SendServerCommand(null,t.pers.netname+" hit the fraglimit."),LogExit("Fraglimit hit.");return}}}if(g_gametype()>=GT.CTF&&g_gametype()!==GT.CLANARENA&&g_capturelimit()){if(level.teamScores[TEAM.RED]>=g_capturelimit()){sv.SendServerCommand(null,"print","Red hit the capturelimit."),LogExit("Capturelimit hit.");return}if(level.teamScores[TEAM.BLUE]>=g_capturelimit()){sv.SendServerCommand(null,"print","Blue hit the capturelimit."),LogExit("Capturelimit hit.");return}}}function CheckIntermissionExit(){var e=0,t=0,n=0,r=0;for(var i=0;i<level.maxclients;i++){var s=level.clients[i];if(s.pers.connected!==CON.CONNECTED)continue;if(level.gentities[s.ps.clientNum].svFlags&SVF.BOT)continue;r++,s.readyToExit?(e++,i<16&&(n|=1<<i)):t++}for(var i=0;i<level.maxclients;i++){var s=level.clients[i];if(s.pers.connected!==CON.CONNECTED)continue;s.ps.stats[STAT.CLIENTS_READY]=n}if(level.time<level.intermissiontime+5e3)return;if(r>0){if(!e){level.readyToExit=!1;return}if(!t){ExitLevel();return}}level.readyToExit||(level.readyToExit=!0,level.exitTime=level.time);if(level.time<level.exitTime+1e4)return;ExitLevel()}function BeginIntermission(){if(level.intermissiontime)return;g_gametype()===GT.TOURNAMENT&&AdjustTournamentScores(),level.intermissiontime=level.time;for(var e=0;e<level.maxclients;e++){var t=level.gentities[e];if(!t.inuse)continue;t.health<=0&&ClientRespawn(t),MoveClientToIntermission(t)}SendScoreboardMessageToAllClients()}function ScoreIsTied(){if(level.numPlayingClients<2)return!1;if(g_gametype()>=GT.TEAM)return level.teamScores[TEAM.RED]===level.teamScores[TEAM.BLUE];var e=level.clients[level.sortedClients[0]].ps.persistant[PERS.SCORE],t=level.clients[level.sortedClients[1]].ps.persistant[PERS.SCORE];return e==t}function MoveClientToIntermission(e){e.client.sess.spectatorState===SPECTATOR.FOLLOW&&StopFollowing(e);var t=[0,0,0],n=[0,0,0];SelectIntermissionSpawnPoint(t,n,client.sess.arena),vec3.set(t,e.s.origin),vec3.set(t,e.client.ps.origin),vec3.set(n,e.client.ps.viewangles),e.client.ps.pm_type=PM.INTERMISSION,e.client.ps.eFlags=0,e.s.eFlags=0,e.s.eType=ET.GENERAL,e.s.modelIndex=0,e.s.loopSound=0,e.s.event=0,e.contents=0}function SendScoreboardMessageToAllClients(){for(var e=0;e<level.maxclients;e++)level.clients[e].pers.connected===CON.CONNECTED&&DeathmatchScoreboardMessage(level.gentities[e])}function ExitLevel(){level.changemap=null,level.intermissiontime=0,level.teamScores[TEAM.RED]=0,level.teamScores[TEAM.BLUE]=0;for(var e=0;e<level.maxclients;e++){var t=level.clients[e];if(t.pers.connected!==CON.CONNECTED)continue;t.ps.persistant[PERS.SCORE]=0}WriteSessionData();for(var e=0;e<level.maxclients;e++)level.clients[e].pers.connected==CON.CONNECTED&&(level.clients[e].pers.connected=CON.CONNECTING)}function LogExit(e){var t,n;level.intermissionQueued=level.time,sv.SetConfigstring("intermission",1)}function CalculateRanks(){var e,t,n;level.follow1=-1,level.follow2=-1,level.numConnectedClients=0,level.numNonSpectatorClients=0,level.numPlayingClients=0,level.numVotingClients=0;for(var r=0;r<level.numteamVotingClients.length;r++)level.numteamVotingClients[r]=0;for(var r=0;r<level.maxclients;r++)level.clients[r].pers.connected!==CON.DISCONNECTED&&(level.sortedClients[level.numConnectedClients]=r,level.numConnectedClients+=1,level.clients[r].sess.sessionTeam!==TEAM.SPECTATOR&&(level.numNonSpectatorClients+=1,level.clients[r].pers.connected===CON.CONNECTED&&(level.numPlayingClients+=1,level.gentities[r].svFlags&SVF.BOT||(level.numVotingClients+=1,level.clients[r].sess.sessionTeam==TEAM.RED?level.numteamVotingClients[0]+=1:level.clients[r].sess.sessionTeam==TEAM.BLUE&&(level.numteamVotingClients[1]+=1)),level.follow1===-1?level.follow1=r:level.follow2===-1&&(level.follow2=r))));level.sortedClients.sort(SortRanks);if(g_gametype()>=GT.TEAM)for(var r=0;r<level.numConnectedClients;r++){var i=level.clients[level.sortedClients[r]];level.teamScores[TEAM.RED]===level.teamScores[TEAM.BLUE]?i.ps.persistant[PERS.RANK]=2:level.teamScores[TEAM.RED]>level.teamScores[TEAM.BLUE]?i.ps.persistant[PERS.RANK]=0:i.ps.persistant[PERS.RANK]=1}else{e=-1,t=0;for(var r=0;r<level.numPlayingClients;r++){var i=level.clients[level.sortedClients[r]];n=i.ps.persistant[PERS.SCORE],r===0||n!==t?(e=r,level.clients[level.sortedClients[r]].ps.persistant[PERS.RANK]=e):(level.clients[level.sortedClients[r-1]].ps.persistant[PERS.RANK]=e|RANK_TIED_FLAG,level.clients[level.sortedClients[r]].ps.persistant[PERS.RANK]=e|RANK_TIED_FLAG),t=n}}g_gametype()>=GT.TEAM?(sv.SetConfigstring("scores1",level.teamScores[TEAM.RED]),sv.SetConfigstring("scores2",level.teamScores[TEAM.BLUE])):level.numConnectedClients===0?(sv.SetConfigstring("scores1",SCORE_NOT_PRESENT),sv.SetConfigstring("scores2",SCORE_NOT_PRESENT)):level.numConnectedClients===1?(sv.SetConfigstring("scores1",level.clients[level.sortedClients[0]].ps.persistant[PERS.SCORE]),sv.SetConfigstring("scores2",SCORE_NOT_PRESENT)):(sv.SetConfigstring("scores1",level.clients[level.sortedClients[0]].ps.persistant[PERS.SCORE]),sv.SetConfigstring("scores2",level.clients[level.sortedClients[1]].ps.persistant[PERS.SCORE])),CheckExitRules(),level.intermissiontime&&SendScoreboardMessageToAllClients()}function SortRanks(e,t){var n=level.clients[e],r=level.clients[t];return n.sess.spectatorState===SPECTATOR.SCOREBOARD||n.sess.spectatorClient<0?1:r.sess.spectatorState===SPECTATOR.SCOREBOARD||r.sess.spectatorClient<0?-1:n.pers.connected===CON.CONNECTING?1:r.pers.connected===CON.CONNECTING?-1:n.sess.sessionTeam==TEAM.SPECTATOR&&r.sess.sessionTeam==TEAM.SPECTATOR?n.sess.spectatorNum>r.sess.spectatorNum?-1:n.sess.spectatorNum<r.sess.spectatorNum?1:0:n.sess.sessionTeam==TEAM.SPECTATOR?1:r.sess.sessionTeam==TEAM.SPECTATOR?-1:n.ps.persistant[PERS.SCORE]>r.ps.persistant[PERS.SCORE]?-1:n.ps.persistant[PERS.SCORE]<r.ps.persistant[PERS.SCORE]?1:0}function BGExports(){return{com:{ERR:com.ERR,Error:com.Error}}}function RunClient(e){if(!g_synchronousClients())return;e.client.pers.cmd.serverTime=level.time,ClientThink_real(e)}function ClientThink(e){var t=level.gentities[e];sv.GetUserCmd(e,t.client.pers.cmd),t.client.lastCmdTime=level.time;if(g_synchronousClients())return;ClientThink_real(t)}function ClientThink_real(e){var t=e.client,n=t.pers.cmd;n.serverTime>level.time+200&&(n.serverTime=level.time+200),n.serverTime<level.time-1e3&&(n.serverTime=level.time-1e3);var r=n.serverTime-t.ps.commandTime;if(r<1)return;if(level.intermissiontime){ClientIntermissionThink(t);return}if(t.sess.spectatorState!==SPECTATOR.NOT){if(t.sess.spectatorState===SPECTATOR.SCOREBOARD)return;ClientSpectatorThink(e,n);return}level.time>t.rewardTime&&(t.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP)),t.noclip?t.ps.pm_type=PM.NOCLIP:t.ps.stats[STAT.HEALTH]<=0?t.ps.pm_type=PM.DEAD:t.ps.pm_type=PM.NORMAL,t.ps.gravity=g_gravity(),t.ps.speed=g_speed(),t.ps.powerups[PW.HASTE]&&(t.ps.speed*=1.3),g_gametype()===GT.CLANARENA&&(level.warmupTime!==0?t.ps.pm_flags|=PMF.NO_ATTACK:t.ps.pm_flags&=~PMF.NO_ATTACK);var i=t.ps.eventSequence,s=new bg.PmoveInfo;s.ps=t.ps,n.clone(s.cmd),s.trace=sv.Trace,s.ps.pm_type===PM.DEAD?s.tracemask=MASK.PLAYERSOLID&~CONTENTS.BODY:s.tracemask=MASK.PLAYERSOLID,t.ps.weapon===WP.GAUNTLET&&!(n.buttons&BUTTON.TALK)&&n.buttons&BUTTON.ATTACK&&t.ps.weaponTime<=0&&(s.gauntletHit=CheckGauntletAttack(e)),e.flags&GFL.FORCE_GESTURE&&(e.flags&=~GFL.FORCE_GESTURE,e.client.pers.cmd.buttons|=BUTTON.GESTURE),vec3.set(t.ps.origin,t.oldOrigin),bg.Pmove(s),e.client.ps.eventSequence!==i&&(e.eventTime=level.time),bg.PlayerStateToEntityState(t.ps,e.s),vec3.set(e.s.pos.trBase,e.currentOrigin),vec3.set(s.mins,e.mins),vec3.set(s.maxs,e.maxs),e.waterlevel=s.waterlevel,e.watertype=s.watertype,ClientEvents(e,i),sv.LinkEntity(e),e.client.noclip||TouchTriggers(e),vec3.set(t.ps.origin,e.currentOrigin);if(t.ps.pm_type===PM.DEAD){if(level.time>t.respawnTime){if(g_forcerespawn()>0&&level.time-t.respawnTime>g_forcerespawn()*1e3){ClientRespawn(e);return}n.buttons&(BUTTON.ATTACK|BUTTON.USE_HOLDABLE)&&ClientRespawn(e)}return}}function ClientIntermissionThink(e){e.ps.eFlags&=~EF.TALK,e.ps.eFlags&=~EF.FIRING,e.oldbuttons=e.buttons,e.buttons=e.pers.cmd.buttons,e.buttons&(BUTTON.ATTACK|BUTTON.USE_HOLDABLE)&(e.oldbuttons^e.buttons)&&(e.readyToExit=1)}function ClientSpectatorThink(e,t){var n=e.client;if(n.sess.spectatorState!==SPECTATOR.FOLLOW){n.ps.pm_type=PM.SPECTATOR,n.ps.speed=400;var r=new bg.PmoveInfo;r.ps=n.ps,t.clone(r.cmd),r.tracemask=MASK.PLAYERSOLID&~CONTENTS.BODY,r.trace=sv.Trace,bg.Pmove(r),vec3.set(n.ps.origin,e.s.origin),TouchTriggers(e),sv.UnlinkEntity(e)}}function ClientEvents(e,t){var n=e.client;t<n.ps.eventSequence-MAX_PS_EVENTS&&(t=n.ps.eventSequence-MAX_PS_EVENTS);for(var r=t;r<n.ps.eventSequence;r++){var i=n.ps.events[r&MAX_PS_EVENTS-1];switch(i){case EV.FIRE_WEAPON:FireWeapon(e);break;default:}}}function ClientEndFrame(e){var t=e.client;if(t.sess.spectatorState!==SPECTATOR.NOT){SpectatorClientEndFrame(e);return}for(var n=0;n<MAX_POWERUPS;n++)t.ps.powerups[n]<level.time&&(t.ps.powerups[n]=0);if(level.intermissiontime)return;WorldEffects(e),DamageFeedback(e),level.time-t.lastCmdTime>1e3?t.ps.eFlags|=EF.CONNECTION:t.ps.eFlags&=~EF.CONNECTION,t.ps.stats[STAT.HEALTH]=e.health,SetClientSound(e),bg.PlayerStateToEntityState(t.ps,e.s)}function SpectatorClientEndFrame(e){if(e.client.sess.spectatorState===SPECTATOR.FOLLOW){var t=e.client.sess.spectatorClient;t===-1?t=level.follow1:t===-2&&(t=level.follow2);if(t>=0){var n=level.clients[t];if(n.pers.connected===CON.CONNECTED&&n.sess.spectatorState===SPECTATOR.NOT){var r=n.ps.eFlags&~(EF.VOTED|EF.TEAMVOTED)|e.client.ps.eFlags&(EF.VOTED|EF.TEAMVOTED);e.client.ps=cl.ps,e.client.ps.pm_flags|=PMF.FOLLOW,e.client.ps.eFlags=r;return}e.client.sess.spectatorClient>=0&&(e.client.sess.spectatorState=SPECTATOR.FREE,ClientBegin(e.s.number))}}e.client.sess.spectatorState===SPECTATOR.SCOREBOARD?e.client.ps.pm_flags|=PMF.SCOREBOARD:e.client.ps.pm_flags&=~PMF.SCOREBOARD}function DamageFeedback(e){var t=e.client;if(t.ps.pm_type===PM.DEAD)return;var n=t.damage_blood+t.damage_armor;if(n===0)return;n>255&&(n=255);if(t.damage_fromWorld)t.ps.damagePitch=255,t.ps.damageYaw=255,t.damage_fromWorld=!1;else{var r=[0,0,0];QMath.VectorToAngles(t.damage_from,r),t.ps.damagePitch=r[QMath.PITCH]/360*256,t.ps.damageYaw=r[QMath.YAW]/360*256}level.time>e.painDebounceTime&&!(e.flags&GFL.GODMODE)&&(e.painDebounceTime=level.time+700,AddEvent(e,EV.PAIN,e.health),t.ps.damageEvent++),t.ps.damageCount=n,t.damage_blood=0,t.damage_armor=0,t.damage_knockback=0}function WorldEffects(e){if(e.client.noclip){e.client.airOutTime=level.time+12e3;return}var t=e.waterlevel,n=e.client.ps.powerups[PW.BATTLESUIT]>level.time;t===3?(n&&(e.client.airOutTime=level.time+1e4),e.client.airOutTime<level.time&&(e.client.airOutTime+=1e3,e.health>0&&(e.damage+=2,e.damage>15&&(e.damage=15),e.painDebounceTime=level.time+200,Damage(e,null,null,null,null,e.damage,DAMAGE.NO_ARMOR,MOD.WATER)))):(e.client.airOutTime=level.time+12e3,e.damage=2),t&&e.watertype&(CONTENTS.LAVA|CONTENTS.SLIME)&&e.health>0&&e.painDebounceTime<=level.time&&(n?AddEvent(e,EV.POWERUP_BATTLESUIT,0):(e.watertype&CONTENTS.LAVA&&Damage(e,null,null,null,null,30*t,0,MOD.LAVA),e.watertype&CONTENTS.SLIME&&Damage(e,null,null,null,null,10*t,0,MOD.SLIME)))}function SetClientSound(e){}function TouchTriggers(e){if(!e.client)return;if(e.client.pm_type===PM.DEAD)return;var t=e.client.ps,n=[40,40,52],r=[0,0,0],i=[0,0,0];vec3.subtract(t.origin,n,r),vec3.add(t.origin,n,i);var s=sv.FindEntitiesInBox(r,i);vec3.add(t.origin,e.mins,r),vec3.add(t.origin,e.maxs,i);for(var o=0;o<s.length;o++){var u=level.gentities[s[o]];if(!u.touch)continue;if(!(u.contents&CONTENTS.TRIGGER))continue;if(u.s.eType===ET.ITEM){if(!bg.PlayerTouchesItem(e.client.ps,u.s,level.time))continue}else if(!sv.EntityContact(r,i,u))continue;u.touch.call(this,u,e)}t.jumppad_frame!=t.pmove_framecount&&(t.jumppad_frame=0,t.jumppad_ent=0)}function ClientConnect(e,t){var n=level.gentities[e]=new GameEntity,r=level.clients[e]=new GameClient,i=sv.GetUserinfo(e);return n.inuse=!0,n.s.number=e,n.client=r,r.ps.clientNum=e,r.pers.connected=CON.CONNECTING,(t||level.newSession)&&InitSessionData(r,i),ReadSessionData(r),ClientUserinfoChanged(e),t&&sv.SendServerCommand(null,"print",r.pers.netname+" connected"),g_gametype()>=GT.TEAM&&r.sess.sessionTeam!==TEAM.SPECTATOR&&BroadcastTeamChange(null,r),CalculateRanks(),null}function ClientUserinfoChanged(e){var t=level.gentities[e],n=t.client,r=sv.GetUserinfo(e);n.pers.netname=r.name;var i={name:n.pers.netname};sv.SetConfigstring("player"+e,i),log("ClientUserinfoChanged: "+e+" "+JSON.stringify(i))}function ClientBegin(e){var t=level.gentities[e],n=level.clients[e];t.linked&&sv.UnlinkEntity(t),t.touch=0,t.pain=0,n.pers.connected=CON.CONNECTED,n.pers.enterTime=level.time,n.pers.teamState.state=TEAM_STATE.BEGIN,ClientSpawn(t),n.sess.sessionTeam!==TEAM.SPECTATOR&&g_gametype()!==GT.TOURNAMENT&&sv.SendServerCommand(null,"print",n.pers.netname+" entered the game"),CalculateRanks()}function ClientSpawn(e){var t=e.client,n=e.client.ps,r=[0,0,0],i=[0,0,0],s;t.sess.spectatorState!==SPECTATOR.NOT?s=SelectSpectatorSpawnPoint(r,i,t.sess.arena):s=SelectSpawnPoint(t.ps.origin,r,i,t.sess.arena),t.pers.teamState.state=TEAM_STATE.ACTIVE;var o=e.client.ps.eFlags&(EF.TELEPORT_BIT|EF.VOTED|EF.TEAMVOTED);o^=EF.TELEPORT_BIT;var u=t.pers.clone(),a=t.sess.clone(),f=new Array(MAX_PERSISTANT);for(var l=0;l<MAX_PERSISTANT;l++)f[l]=t.ps.persistant[l];var c=t.ps.ping,h=t.accuracy_hits,p=t.accuracy_shots,d=t.ps.eventSequence;t.reset(),u.clone(t.pers),a.clone(t.sess);for(var l=0;l<MAX_PERSISTANT;l++)t.ps.persistant[l]=f[l];t.ps.ping=c,t.accuracy_hits=h,t.accuracy_shots=p,t.ps.clientNum=e.s.number,t.ps.eventSequence=d,t.lastkilled_client=-1,t.ps.persistant[PERS.SPAWN_COUNT]++,t.ps.persistant[PERS.TEAM]=t.sess.sessionTeam,t.ps.persistant[PERS.SPECTATOR_STATE]=t.sess.spectatorState,t.airOutTime=level.time+12e3,t.pers.maxHealth=100,t.ps.stats[STAT.MAX_HEALTH]=t.pers.maxHealth,t.ps.eFlags=o,e.s.groundEntityNum=ENTITYNUM_NONE,e.client=level.clients[e.s.number],e.takeDamage=!0,e.inuse=!0,e.classname="player",e.contents=CONTENTS.BODY,e.clipmask=MASK.PLAYERSOLID,e.die=PlayerDie,e.waterlevel=0,e.watertype=0,e.flags=0,vec3.set(playerMins,e.mins),vec3.set(playerMaxs,e.maxs),g_gametype()===GT.CLANARENA?(t.ps.stats[STAT.WEAPONS]=1<<WP.GAUNTLET,t.ps.stats[STAT.WEAPONS]|=1<<WP.MACHINEGUN,t.ps.stats[STAT.WEAPONS]|=1<<WP.SHOTGUN,t.ps.stats[STAT.WEAPONS]|=1<<WP.GRENADE_LAUNCHER,t.ps.stats[STAT.WEAPONS]|=1<<WP.ROCKET_LAUNCHER,t.ps.stats[STAT.WEAPONS]|=1<<WP.LIGHTNING,t.ps.stats[STAT.WEAPONS]|=1<<WP.RAILGUN,t.ps.stats[STAT.WEAPONS]|=1<<WP.PLASMAGUN,t.ps.ammo[WP.GAUNTLET]=-1,t.ps.ammo[WP.MACHINEGUN]=-1,t.ps.ammo[WP.SHOTGUN]=-1,t.ps.ammo[WP.GRENADE_LAUNCHER]=-1,t.ps.ammo[WP.ROCKET_LAUNCHER]=-1,t.ps.ammo[WP.LIGHTNING]=-1,t.ps.ammo[WP.RAILGUN]=-1,t.ps.ammo[WP.PLASMAGUN]=-1,t.ps.weapon=WP.ROCKET_LAUNCHER,e.health=t.ps.stats[STAT.HEALTH]=t.ps.stats[STAT.MAX_HEALTH],t.ps.stats[STAT.ARMOR]=t.ps.stats[STAT.MAX_HEALTH]):(t.ps.stats[STAT.WEAPONS]|=1<<WP.GAUNTLET,t.ps.ammo[WP.GAUNTLET]=-1,t.ps.ammo[WP.GRAPPLING_HOOK]=-1,t.ps.stats[STAT.WEAPONS]=1<<WP.MACHINEGUN,g_gametype()===GT.TEAM?t.ps.ammo[WP.MACHINEGUN]=50:t.ps.ammo[WP.MACHINEGUN]=100,t.ps.weapon=WP.MACHINEGUN,e.health=t.ps.stats[STAT.HEALTH]=t.ps.stats[STAT.MAX_HEALTH]+25),t.ps.weaponState=WS.READY,SetOrigin(e,r),vec3.set(r,t.ps.origin),SetClientViewAngle(e,i),sv.GetUserCmd(t.ps.clientNum,e.client.pers.cmd),t.ps.pm_flags|=PMF.RESPAWNED,t.ps.pm_flags|=PMF.TIME_KNOCKBACK,t.ps.pm_time=100,t.respawnTime=level.time,t.inactivityTime=level.time+g_inactivity()*1e3,t.ps.torsoAnim=ANIM.TORSO_STAND,t.ps.legsAnim=ANIM.LEGS_IDLE;if(!level.intermissiontime){if(e.client.sess.spectatorState===SPECTATOR.NOT){KillBox(e),UseTargets(s,e);if(g_gametype()!==GT.CLANARENA)for(var l=WP.NUM_WEAPONS-1;l>0;l--)if(t.ps.stats[STAT.WEAPONS]&1<<l){t.ps.weapon=l;break}vec3.set(e.client.ps.origin,e.currentOrigin);var v=TempEntity(e.client.ps.origin,EV.PLAYER_TELEPORT_IN);v.s.clientNum=e.s.clientNum,sv.LinkEntity(e)}}else MoveClientToIntermission(e);t.ps.commandTime=level.time-100,t.pers.cmd.serverTime=level.time,ClientThink(t.ps.clientNum),ClientEndFrame(e),bg.PlayerStateToEntityState(t.ps,e.s)}function ClientRespawn(e){CopyToBodyQueue(e),ClientSpawn(e)}function ClientDisconnect(e){var t=level.gentities[e];if(!t.client||t.client.pers.connected==CON.DISCONNECTED)return;log("ClientDisconnect: "+e),sv.UnlinkEntity(t),t.s.modelIndex=0,t.classname="disconnected",t.client.pers.connected=CON.DISCONNECTED,t.client.ps.persistant[PERS.TEAM]=TEAM.FREE,t.client.ps.persistant[PERS.SPECTATOR_STATE]=SPECTATOR.NOT,t.client.sess.sessionTeam=TEAM.FREE,sv.SetConfigstring("player"+e,null),CalculateRanks()}function SetClientViewAngle(e,t){for(var n=0;n<3;n++){var r=QMath.AngleToShort(t[n]);e.client.ps.delta_angles[n]=r-e.client.pers.cmd.angles[n]}vec3.set(t,e.s.angles),vec3.set(e.s.angles,e.client.ps.viewangles)}function SetArena(e,t){var n=e.client,r=n.sess.sessionTeam;n.sess.arena=t,g_teamAutoJoin()?n.sess.sessionTeam=PickTeam(n.sess.arena,null):n.sess.sessionTeam=TEAM.SPECTATOR,BroadcastTeamChange(r,n),ClientUserinfoChanged(clientNum),ClientBegin(e.s.number)}function SetTeam(e,t){var n=e.client,r=e.s.number,i,s=SPECTATOR.NOT,o=0;t==="scoreboard"||t==="score"?(i=TEAM.SPECTATOR,s=SPECTATOR.SCOREBOARD):t==="follow1"?(i=TEAM.SPECTATOR,s=SPECTATOR.FOLLOW,o=-1):t==="follow2"?(i=TEAM.SPECTATOR,s=SPECTATOR.FOLLOW,o=-2):t==="spectator"||t==="s"?(i=TEAM.SPECTATOR,s=SPECTATOR.FREE):g_gametype()>=GT.TEAM?(s=SPECTATOR.NOT,t==="red"||t==="r"?i=TEAM.RED:t==="blue"||t==="b"?i=TEAM.BLUE:i=PickTeam(n.sess.arena,r)):i=TEAM.FREE,g_gametype()===GT.TOURNAMENT&&level.numNonSpectatorClients>=2?i=TEAM.SPECTATOR:g_maxGameClients()>0&&level.numNonSpectatorClients>=g_maxGameClients()&&(i=TEAM.SPECTATOR);var u=n.sess.sessionTeam;if(i===u&&i!==TEAM.SPECTATOR)return;n.ps.pm_type===PM.DEAD&&CopyToBodyQueue(e),n.pers.teamState.state=TEAM_STATE.BEGIN,u!==TEAM.SPECTATOR&&(e.flags&=~GFL.GODMODE,n.ps.stats[STAT.HEALTH]=e.health=0,PlayerDie(e,e,e,1e5,MOD.SUICIDE)),i===TEAM.SPECTATOR&&u!==i,n.sess.sessionTeam=i,n.sess.spectatorState=s,n.sess.spectatorClient=o,n.sess.teamLeader=!1;if(i===TEAM.RED||i==TEAM.BLUE){var a=TeamLeader(i);a==-1&&SetTeamLeader(r,i)}(u===TEAM.RED||u===TEAM.BLUE)&&CheckTeamLeader(u),BroadcastTeamChange(u,n),ClientUserinfoChanged(r),ClientBegin(r)}function GetClientPlayerstate(e){var t=level.clients[e];return t.ps}function SelectSpawnPoint_compare(e,t){return e.dist>t.dist?-1:e.dist<t.dist?1:0}function SelectSpawnPoint(e,t,n,r){var i=FindEntity({classname:"info_player_deathmatch"}),s=[],o;for(var u=0;u<i.length;u++){o=i[u];if(SpotWouldTelefrag(o))continue;if(o.flags&GFL.NO_HUMANS)continue;if(g_gametype()===GT.CLANARENA&&o.arena!==r)continue;var a=vec3.subtract(o.s.origin,e,[0,0,0]),f=vec3.length(a);s.push({dist:f,spot:o})}s.sort(SelectSpawnPoint_compare);var l=Math.floor(Math.random()*(s.length/2));return o=s[l].spot,vec3.set(o.s.origin,t),t[2]+=9,vec3.set(o.s.angles,n),o}function SpotWouldTelefrag(e){var t=vec3.add(e.s.origin,playerMins,[0,0,0]),n=vec3.add(e.s.origin,playerMaxs,[0,0,0]),r=sv.FindEntitiesInBox(t,n);for(var i=0;i<r.length;i++){var s=level.gentities[r[i]];if(s.client)return!0}return!1}function SelectSpectatorSpawnPoint(e,t,n){return SelectIntermissionSpawnPoint(e,t,n)}function SelectIntermissionSpawnPoint(e,t,n){var r,i,s=[0,0,0],o=FindEntity({classname:"info_player_intermission"}),u;if(!o.length)u=SelectSpawnPoint(QMath.vec3origin,e,t,n);else{var a;for(a=0;a<o.length;a++){u=o[a];if(g_gametype()===GT.CLANARENA&&u.arena===n)break}a===o.length&&(u=o[0]),vec3.set(u.s.origin,e),vec3.set(u.s.angles,t);if(u.target){var i=PickTarget(u.target);if(i){var s=vec3.subtract(i.s.origin,e,[0,0,0]);QMath.VectorToAngles(s,t)}}}return u}function InitBodyQueue(){level.bodyQueueIndex=0;for(var e=0;e<BODY_QUEUE_SIZE;e++){var t=SpawnEntity();t.classname="bodyqueue",t.neverFree=!0,level.bodyQueue[e]=t}}function CopyToBodyQueue(e){sv.UnlinkEntity(e);var t=level.bodyQueue[level.bodyQueueIndex];level.bodyQueueIndex=(level.bodyQueueIndex+1)%BODY_QUEUE_SIZE;var n=t.s.number;e.s.clone(t.s),t.s.eFlags=EF.DEAD,t.s.powerups=0,t.s.loopSound=0,t.s.number=n,t.timestamp=level.time,t.physicsObject=!0,t.physicsBounce=0,t.s.groundEntityNum===ENTITYNUM_NONE?(t.s.pos.trType=TR.GRAVITY,t.s.pos.trTime=level.time,vec3.set(e.client.ps.velocity,t.s.pos.trDelta)):t.s.pos.trType=TR.STATIONARY,t.s.event=0;switch(t.s.legsAnim&~ANIM_TOGGLEBIT){case ANIM.BOTH_DEATH1:case ANIM.BOTH_DEAD1:t.s.torsoAnim=t.s.legsAnim=ANIM.BOTH_DEAD1;break;case ANIM.BOTH_DEATH2:case ANIM.BOTH_DEAD2:t.s.torsoAnim=t.s.legsAnim=ANIM.BOTH_DEAD2;break;case ANIM.BOTH_DEATH3:case ANIM.BOTH_DEAD3:default:t.s.torsoAnim=t.s.legsAnim=ANIM.BOTH_DEAD3}t.svFlags=e.svFlags,vec3.set(e.mins,t.mins),vec3.set(e.maxs,t.maxs),vec3.set(e.absmin,t.absmin),vec3.set(e.absmax,t.absmax),t.clipmask=CONTENTS.SOLID|CONTENTS.PLAYERCLIP,t.contents=CONTENTS.CORPSE,t.ownerNum=e.s.number,t.nextthink=level.time+5e3,t.think=BodySink,t.die=BodyDie,e.health<=GIB_HEALTH?t.takeDamage=!1:t.takeDamage=!0,vec3.set(t.s.pos.trBase,t.currentOrigin),sv.LinkEntity(t)}function BodySink(e){if(level.time-e.timestamp>6500){sv.UnlinkEntity(e),e.physicsObject=!1;return}e.nextthink=level.time+100,e.s.pos.trBase[2]-=1}function BodyDie(e,t,n,r,i){if(e.health>GIB_HEALTH)return;GibEntity(e,0)}function ClientCommand(e,t){var n=level.gentities[e];if(!n.client||n.client.pers.connected!==CON.CONNECTED)return;if(t.type==="score"){ClientCmdScore(n);return}if(t.type==="ccmd"){var r=t.val,i=r[0];i==="noclip"?ClientCmdNoclip(n):i==="team"&&ClientCmdTeam(n,r[1])}}function ClientCmdScore(e){DeathmatchScoreboardMessage(e)}function DeathmatchScoreboardMessage(e){var t=level.numConnectedClients,n={red:level.teamScores[TEAM.RED],blue:level.teamScores[TEAM.BLUE],scores:[]};for(var r=0;r<t;r++){var i=level.sortedClients[r],s=level.clients[i],o=-1;s.pers.connected!==CON.CONNECTING&&(o=s.ps.ping<999?s.ps.ping:999);var u=0;s.accuracy_shots&&(u=s.accuracy_hits*100/s.accuracy_shots);var a=s.ps.persistant[PERS.RANK]===0&&s.ps.persistant[PERS.KILLED]===0?1:0;n.scores.push({clientNum:i,score:s.ps.persistant[PERS.SCORE],ping:o,time:(level.time-s.pers.enterTime)/6e4,powerups:level.gentities[level.sortedClients[r]].s.powerups,accuracy:u,impressive:s.ps.persistant[PERS.IMPRESSIVE_COUNT],excellent:s.ps.persistant[PERS.EXCELLENT_COUNT],gauntlet:s.ps.persistant[PERS.GAUNTLET_FRAG_COUNT],defend:s.ps.persistant[PERS.DEFEND_COUNT],assist:s.ps.persistant[PERS.ASSIST_COUNT],perfect:a,captures:s.ps.persistant[PERS.CAPTURES]})}sv.SendServerCommand(e.s.number,"scores",n)}function ClientCmdNoclip(e){console.log("GOT NOCLIP CMD"),e.client.noclip=!e.client.noclip;var t="noclip ON";e.client.noclip||(t="noclip OFF"),sv.SendServerCommand(e.s.number,"print",t)}function ClientCmdTeam(e,t){if(!t){var n=e.client.sess.sessionTeam;switch(n){case TEAM.BLUE:sv.SendServerCommand(e.s.number,"print","Blue team");break;case TEAM.RED:sv.SendServerCommand(e.s.number,"print","Red team");break;case TEAM.FREE:sv.SendServerCommand(e.s.number,"print","Free team");break;case TEAM.SPECTATOR:sv.SendServerCommand(e.s.number,"print","Spectator team")}return}if(e.client.switchTeamTime>level.time){sv.SendServerCommand(e.s.number,"print","May not switch teams more than once per 5 seconds.");return}g_gametype()===GT.TOURNAMENT&&e.client.sess.sessionTeam===TEAM.FREE&&e.client.sess.losses++,SetTeam(e,t),e.client.switchTeamTime=level.time+5e3}function Damage(e,t,n,r,i,s,o,u){if(!e.takeDamage)return;if(level.intermissionQueued)return;t||(t=level.gentities[ENTITYNUM_WORLD]),n||(n=level.gentities[ENTITYNUM_WORLD]);if(e.s.eType===ET.MOVER){e.use&&e.moverState==MOVER.POS1&&e.use(e,t,n);return}var a=e.client;if(a&&a.noclip)return;r?vec3.normalize(r):o|=DAMAGE.NO_KNOCKBACK;var f=s;f>200&&(f=200),e.flags&GFL.NO_KNOCKBACK&&(f=0),o&DAMAGE.NO_KNOCKBACK&&(f=0);if(f&&e.client){var l=200,c=vec3.scale(r,g_knockback()*f/l,[0,0,0]);vec3.add(e.client.ps.velocity,c);if(!e.client.ps.pm_time){var h=f*2;h<50?h=50:h>200&&(h=200),e.client.ps.pm_time=h,e.client.ps.pm_flags|=PMF.TIME_KNOCKBACK}}if(a&&a.ps.powerups[PW.BATTLESUIT]){AddEvent(e,EV.POWERUP_BATTLESUIT,0);if(o&DAMAGE.RADIUS||u===MOD.FALLING)return;s*=.5}n.client&&a&&e!==n&&e.health>0&&e.s.eType!==ET.MISSILE&&e.s.eType!==ET.GENERAL&&(OnSameTeam(e,n)?n.client.ps.persistant[PERS.HITS]--:n.client.ps.persistant[PERS.HITS]++,n.client.ps.persistant[PERS.ATTACKEE_ARMOR]=e.health<<8|a.ps.stats[STAT.ARMOR]),e===n&&(s*=.5),s<1&&(s=1),g_gametype()===GT.CLANARENA&&e===n&&t.classname==="rocket"&&(s=0);var p=s,d=CheckArmor(e,p,o);p-=d,a&&(n?a.ps.persistant[PERS.ATTACKER]=n.s.number:a.ps.persistant[PERS.ATTACKER]=ENTITYNUM_WORLD,a.damage_armor+=d,a.damage_blood+=p,a.damage_knockback+=f,r?(vec3.set(r,a.damage_from),a.damage_fromWorld=!1):(vec3.set(e.currentOrigin,a.damage_from),a.damage_fromWorld=!0)),e.client&&(e.client.lasthurt_client=n.s.number,e.client.lasthurt_mod=u);if(p){e.health=e.health-p,e.client&&(e.client.ps.stats[STAT.HEALTH]=e.health);if(e.health<=0){a&&(e.flags|=GFL.NO_KNOCKBACK),e.health<-999&&(e.health=-999),e.enemy=n,e.die(e,t,n,p,u);return}e.pain&&e.pain(e,n,p)}}function RadiusDamage(e,t,n,r,i,s,o){var u=[0,0,0],a=[0,0,0],f=[0,0,0],l=!1;i<1&&(i=1);for(var c=0;c<3;c++)a[c]=e[c]-i,f[c]=e[c]+i;var h=sv.FindEntitiesInBox(a,f);for(var p=0;p<h.length;p++){var d=level.gentities[h[p]];if(d===s)continue;if(!d.takeDamage)continue;for(var c=0;c<3;c++)e[c]<d.absmin[c]?u[c]=d.absmin[c]-e[c]:e[c]>d.absmax[c]?u[c]=e[c]-d.absmax[c]:u[c]=0;var v=vec3.length(u);if(v>=i)continue;var m=r*(1-v/i);if(CanDamage(d,e)){LogAccuracyHit(d,n)&&(l=!0);var g=vec3.subtract(d.currentOrigin,e,[0,0,0]);g[2]+=24,Damage(d,t,n,g,e,m,DAMAGE.RADIUS,o)}}return l}function CanDamage(e,t){var n=vec3.add(e.absmin,e.absmax,[0,0,0]);vec3.scale(n,.5);var r=vec3.set(n,[0,0,0]),i=sv.Trace(t,r,QMath.vec3origin,QMath.vec3origin,ENTITYNUM_NONE,MASK.SOLID);return i.fraction===1||i.entityNum===e.s.number?!0:(vec3.set(n,r),r[0]+=15,r[1]+=15,i=sv.Trace(t,r,QMath.vec3origin,QMath.vec3origin,ENTITYNUM_NONE,MASK.SOLID),i.fraction===1?!0:(vec3.set(n,r),r[0]+=15,r[1]-=15,i=sv.Trace(t,r,QMath.vec3origin,QMath.vec3origin,ENTITYNUM_NONE,MASK.SOLID),i.fraction===1?!0:(vec3.set(n,r),r[0]-=15,r[1]+=15,i=sv.Trace(t,r,QMath.vec3origin,QMath.vec3origin,ENTITYNUM_NONE,MASK.SOLID),i.fraction===1?!0:(vec3.set(n,r),r[0]-=15,r[1]-=15,i=sv.Trace(t,r,QMath.vec3origin,QMath.vec3origin,ENTITYNUM_NONE,MASK.SOLID),i.fraction===1?!0:!1))))}function PlayerDie(e,t,n,r,i){if(e.client.ps.pm_type===PM.DEAD)return;if(level.intermissiontime)return;e.client.ps.pm_type=PM.DEAD;var s,o;n&&(s=n.s.number,n.client?o=n.client.pers.netname:o="<non-client>");if(s===undefined||s<0||s>=MAX_CLIENTS)s=ENTITYNUM_WORLD,o="<world>";log("Kill:",s,e.s.number,i,",",o,"killed",e.client.pers.netname);var u=TempEntity(e.currentOrigin,EV.OBITUARY);u.s.eventParm=i,u.s.otherEntityNum=e.s.number,u.s.otherEntityNum2=s,u.svFlags=SVF.BROADCAST,e.enemy=n,e.client.ps.persistant[PERS.KILLED]++,n&&n.client?(n.client.lastkilled_client=e.s.number,n==e||OnSameTeam(e,n)?AddScore(n,e.currentOrigin,-1):(AddScore(n,e.currentOrigin,1),i===MOD.GAUNTLET&&(n.client.ps.persistant[PERS.GAUNTLET_FRAG_COUNT]++,n.client.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP),n.client.ps.eFlags|=EF.AWARD_GAUNTLET,n.client.rewardTime=level.time+REWARD_SPRITE_TIME,e.client.ps.persistant[PERS.PLAYEREVENTS]^=PLAYEREVENTS.GAUNTLETREWARD),level.time-n.client.lastKillTime<CARNAGE_REWARD_TIME&&(n.client.ps.persistant[PERS.EXCELLENT_COUNT]++,n.client.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP),n.client.ps.eFlags|=EF.AWARD_EXCELLENT,n.client.rewardTime=level.time+REWARD_SPRITE_TIME),n.client.lastKillTime=level.time)):AddScore(e,e.currentOrigin,-1),i===MOD.SUICIDE&&(e.client.ps.powerups[PW.NEUTRALFLAG]?(Team_ReturnFlag(TEAM.FREE),e.client.ps.powerups[PW.NEUTRALFLAG]=0):e.client.ps.powerups[PW.REDFLAG]?(Team_ReturnFlag(TEAM.RED),e.client.ps.powerups[PW.REDFLAG]=0):e.client.ps.powerups[PW.BLUEFLAG]&&(Team_ReturnFlag(TEAM.BLUE),e.client.ps.powerups[PW.BLUEFLAG]=0)),ClientCmdScore(e);for(var a=0;a<level.maxclients;a++){var f=level.clients[a];if(f.pers.connected!==CON.CONNECTED)continue;if(f.sess.sessionTeam!==TEAM.SPECTATOR)continue;f.sess.spectatorClient===e.s.number&&ClientCmdScore(level.gentities[a])}e.takeDamage=!0,e.s.weapon=WP.NONE,e.s.powerups=0,e.contents=CONTENTS.CORPSE,e.s.angles[0]=0,e.s.angles[2]=0,LookAtKiller(e,t,n),vec3.set(e.s.angles,e.client.ps.viewangles),e.s.loopSound=0,e.maxs[2]=-8,e.client.respawnTime=level.time+1700;for(var a=0;a<MAX_POWERUPS;a++)e.client.ps.powerups[a]=0;var l;switch(deathAnim){case 0:l=ANIM.BOTH_DEATH1;break;case 1:l=ANIM.BOTH_DEATH2;break;case 2:default:l=ANIM.BOTH_DEATH3}e.health<=GIB_HEALTH&&(e.health=GIB_HEALTH+1),e.client.ps.legsAnim=e.client.ps.legsAnim&ANIM_TOGGLEBIT^ANIM_TOGGLEBIT|l,e.client.ps.torsoAnim=e.client.ps.torsoAnim&ANIM_TOGGLEBIT^ANIM_TOGGLEBIT|l,AddEvent(e,EV.DEATH1+a,s),deathAnim=(deathAnim+1)%3,sv.LinkEntity(e),g_gametype()===GT.CLANARENA&&!level.warmupTime&&(e.client.sess.spectatorState=SPECTATOR.FREE,ClientRespawn(e))}function LookAtKiller(e,t,n){var r=[0,0,0];if(n&&n!==e)vec3.subtract(n.s.pos.trBase,e.s.pos.trBase,r);else{if(!t||t===e){e.client.ps.stats[STAT.DEAD_YAW]=e.s.angles[QMath.YAW];return}vec3.subtract(t.s.pos.trBase,e.s.pos.trBase,r)}e.client.ps.stats[STAT.DEAD_YAW]=VecToYaw(r)}function GibEntity(e,t){AddEvent(e,EV.GIB_PLAYER,t),e.takeDamage=!1,e.s.eType=ET.INVISIBLE,e.contents=0}function VecToYaw(e){var t;return e[QMath.YAW]===0&&e[QMath.PITCH]===0?t=0:(e[QMath.PITCH]?t=Math.atan2(e[QMath.YAW],e[QMath.PITCH])*180/Math.PI:e[QMath.YAW]>0?t=90:t=270,t<0&&(t+=360)),t}function LogAccuracyHit(e,t){return e.takeDamage?e===t?!1:e.client?t.client?e.client.ps.stats[STAT.HEALTH]<=0?!1:OnSameTeam(e,t)?!1:!0:!1:!1:!1}function CheckArmor(e,t,n){if(!t)return 0;if(n&DAMAGE.NO_ARMOR)return 0;var r=e.client;if(!r)return 0;var i=r.ps.stats[STAT.ARMOR],s=Math.ceil(t*ARMOR_PROTECTION);return s>=i&&(s=i),s?(r.ps.stats[STAT.ARMOR]-=s,s):0}function AddScore(e,t,n){if(!e.client)return;if(level.warmupTime)return;ScorePlum(e,t,n),e.client.ps.persistant[PERS.SCORE]+=n,g_gametype()===GT.TEAM&&(level.teamScores[e.client.ps.persistant[PERS.TEAM]]+=n),CalculateRanks()}function ScorePlum(e,t,n){var r=TempEntity(t,EV.SCOREPLUM);r.svFlags|=SVF.SINGLECLIENT,r.singleClient=e.s.number,r.s.otherEntityNum=e.s.number,r.s.time=n}function TossClientItems(e){var t,n,r;t=e.s.weapon;if(t===WP.MACHINEGUN||t===WP.GRAPPLING_HOOK)e.client.ps.weaponstate===WS.DROPPING&&(t=e.client.pers.cmd.weapon),e.client.ps.stats[STAT.WEAPONS]&1<<t||(t=WP.NONE)}function SpawnEntity(){for(var e=MAX_CLIENTS;e<MAX_GENTITIES;e++){var t=level.gentities[e];if(t.inuse)continue;if(t.freeTime>level.startTime+2e3&&level.time-t.freeTime<1e3)continue;return t.reset(),t.s.number=e,t.inuse=!0,t}error("Game entities is full")}function FreeEntity(e){sv.UnlinkEntity(e);if(e.neverFree)return;e.classname="freed",e.freeTime=level.time,e.inuse=!1}function TempEntity(e,t){var n=SpawnEntity();return n.s.eType=ET.EVENTS+t,n.classname="tempEntity",n.eventTime=level.time,n.freeAfterEvent=!0,SetOrigin(n,e),sv.LinkEntity(n),n}function FindEntity(e){var t=[];for(var n=0;n<level.gentities.length;n++){var r=level.gentities[n];if(!r.inuse)continue;var i=!0;for(var s in e){var o=e[s];if(r[s]!==o){i=!1;break}}i&&t.push(r)}return t}function RunEntity(e){var t=e.nextthink;if(t<=0)return;if(t>level.time)return;e.nextthink=0,e.think||error("NULL ent->think"),e.think.call(this,e)}function PickTarget(e){if(!e)return log("PickTarget called with NULL targetname"),null;var t=FindEntity({targetName:e});return t.length?t[Math.floor(Math.random()*t.length)]:(log("PickTarget: target "+e+" not found"),null)}function UseTargets(e,t){if(!e)return;if(!e.target)return;var n=FindEntity({targetName:e.target});for(var r=0;r<n.length;r++){var i=n[r];i==e?log("WARNING: Entity used itself."):i.use&&i.use(i,e,t);if(!e.inuse){log("Entity was removed while using targets.");return}}}function SpawnAllEntitiesFromDefs(){var e=sv.GetEntityDefs();for(var t=0;t<e.length;t++){var n=e[t];SpawnEntityFromDef(n)}}function SpawnEntityFromDef(e){var t=SpawnEntity();level.spawnVars=e;for(var n in e){if(!e.hasOwnProperty(n))continue;ParseField(t,n,e[n])}if(g_gametype()>=GT.TEAM){var r=SpawnInt("notteam",0);if(r){sv.LinkEntity(t),sv.AdjustAreaPortalState(t,!0),FreeEntity(t);return}}else{var i=SpawnInt("notfree",0);if(i){sv.LinkEntity(t),sv.AdjustAreaPortalState(t,!0),FreeEntity(t);return}}var s=SpawnString("gametype",null);if(s!==null&&g_gametype()>=GT.FFA&&g_gametype()<GT.MAX_GAME_TYPE){var o=GametypeNames[g_gametype()];if(s!==o){sv.LinkEntity(t),sv.AdjustAreaPortalState(t,!0),FreeEntity(t);return}}for(var u=1;u<bg.ItemList.length;u++){var a=bg.ItemList[u];if(a.classname===t.classname){SpawnItem(t,a);return}}t.spawn=spawnFuncs[t.classname];if(!t.spawn){FreeEntity(t);return}t.spawn.call(this,t)}function ParseField(ent,key,value){var fi=fields[key];if(!fi)return;var out;switch(fi.type){case"vector":value.replace(/(.+) (.+) (.+)/,function(e,t,n,r){out=[parseFloat(t),parseFloat(n),parseFloat(r)]});break;case"int":out=parseInt(value,10);break;case"float":out=parseFloat(value);break;case"anglehack":out=[0,parseFloat(value),0];break;default:out=value}if(!fi.aliases)ent[key]=out;else for(var i=0;i<fi.aliases.length;i++){var alias=fi.aliases[i];eval("ent."+alias+" = out;")}}function SpawnString(e,t){return typeof level.spawnVars[e]!="undefined"?level.spawnVars[e]:t}function SpawnFloat(e,t){var n=SpawnString(e,t);return parseFloat(n)}function SpawnInt(e,t){var n=SpawnString(e,t);return parseInt(n,10)}function SpawnVector(e,t){var n=[0,0,0],r=SpawnString(e,t);return r.replace(/(.+) (.+) (.+)/,function(e,t,r,i){n[0]=parseFloat(t),n[1]=parseFloat(t),n[2]=parseFloat(t)}),n}function ChainTeams(){var e=0,t=0;for(var n=1;n<MAX_GENTITIES;n++){var r=level.gentities[n];if(!r.inuse)continue;if(!r.team)continue;if(r.flags&GFL.TEAMSLAVE)continue;r.teammaster=r,e++,t++;for(var i=n+1;i<MAX_GENTITIES;i++){var s=level.gentities[i];if(!s.inuse)continue;if(!s.team)continue;if(s.flags&GFL.TEAMSLAVE)continue;r.team===s.team&&(t++,s.teamchain=r.teamchain,r.teamchain=s,s.teammaster=r,s.flags|=GFL.TEAMSLAVE,s.targetname&&(r.targetname=s.targetname,s.targetname=null))}}log(e,"teams with",t,"entities")}function SetOrigin(e,t){vec3.set(t,e.s.pos.trBase),e.s.pos.trType=TR.STATIONARY,e.s.pos.trTime=0,e.s.pos.trDuration=0,vec3.set([0,0,0],e.s.pos.trDelta),vec3.set(t,e.currentOrigin)}function SetMovedir(e,t){vec3.equal(e,VEC_UP)?vec3.set(MOVEDIR_UP,t):vec3.equal(e,VEC_DOWN)?vec3.set(MOVEDIR_DOWN,t):QMath.AnglesToVectors(e,t,null,null),e[0]=e[1]=e[2]=0}function KillBox(e){var t=vec3.add(e.client.ps.origin,e.mins,[0,0,0]),n=vec3.add(e.client.ps.origin,e.maxs,[0,0,0]),r=sv.FindEntitiesInBox(t,n);for(var i=0;i<r.length;i++){var s=level.gentities[r[i]];if(!s.client)continue;Damage(s,e,e,null,null,1e5,DAMAGE.NO_PROTECTION,MOD.TELEFRAG)}}function AddPredictableEvent(e,t,n){if(!e.client)return;bg.AddPredictableEventToPlayerstate(e.client.ps,t,n)}function AddEvent(e,t,n){var r;if(!t){log("AddEvent: zero event added for entity",e.s.number);return}e.client?(r=e.client.ps.externalEvent&EV_EVENT_BITS,r=r+EV_EVENT_BIT1&EV_EVENT_BITS,e.client.ps.externalEvent=t|r,e.client.ps.externalEventParm=n,e.client.ps.externalEventTime=level.time):(r=e.s.event&EV_EVENT_BITS,r=r+EV_EVENT_BIT1&EV_EVENT_BITS,e.s.event=t|r,e.s.eventParm=n),e.eventTime=level.time}function SpawnItem(e,t){e.item=t,e.nextthink=level.time+FRAMETIME*2,e.think=FinishSpawningItem,e.physicsBounce=.5}function BounceItem(e,t){var n,r,i}function FinishSpawningItem(e){var t=bg.ItemList.indexOf(e.item);vec3.set([-ITEM_RADIUS,-ITEM_RADIUS,-ITEM_RADIUS],e.mins),vec3.set([ITEM_RADIUS,ITEM_RADIUS,ITEM_RADIUS],e.maxs),e.s.eType=ET.ITEM,e.s.modelIndex=t,e.s.modelIndex2=0,e.contents=CONTENTS.TRIGGER,e.touch=TouchItem;if(e.spawnflags&1)SetOrigin(e,e.s.origin);else{var n=[e.s.origin[0],e.s.origin[1],e.s.origin[2]-4096],r=sv.Trace(e.s.origin,n,e.mins,e.maxs,e.s.number,MASK.SOLID);if(r.startSolid){log("FinishSpawningItem:",e.classname,"startsolid at",e.s.origin[0],e.s.origin[1],e.s.origin[2]),FreeEntity(e);return}e.s.groundEntityNum=r.entityNum,SetOrigin(e,r.endPos)}if(e.flags&GFL.TEAMSLAVE||e.targetName){e.s.eFlags|=EF.NODRAW,e.contents=0;return}if(e.item.giType===IT.POWERUP){var i=45+QMath.crandom()*15;e.s.eFlags|=EF.NODRAW,e.contents=0,e.nextthink=level.time+i*1e3,e.think=RespawnItem;return}sv.LinkEntity(e)}function RespawnItem(e){if(e.team){e.teammaster||error("RespawnItem: bad teammaster");var t,n,r=e.teammaster;for(t=0,e=r;e;e=e.teamchain,t++);n=Math.floor(Math.random()*t);for(t=0,e=r;t<n;e=e.teamchain,t++);}e.contents=CONTENTS.TRIGGER,e.s.eFlags&=~EF.NODRAW,e.svFlags&=~SVF.NOCLIENT,sv.LinkEntity(e);if(e.item.giType===IT.POWERUP){var i;e.speed?i=TempEntity(e.s.pos.trBase,EV.GENERAL_SOUND):i=TempEntity(e.s.pos.trBase,EV.GLOBAL_SOUND),i.svFlags|=SVF.BROADCAST}if(e.item.giType===IT.HOLDABLE){var i;e.speed?i=TempEntity(e.s.pos.trBase,EV.GENERAL_SOUND):i=TempEntity(e.s.pos.trBase,EV.GLOBAL_SOUND),i.svFlags|=SVF.BROADCAST}AddEvent(e,EV.ITEM_RESPAWN,0),e.nextthink=0}function TouchItem(e,t){if(!t.client)return;if(t.health<1)return;if(!bg.CanItemBeGrabbed(g_gametype(),e.s,t.client.ps))return;var n=!0,r;switch(e.item.giType){case IT.WEAPON:r=PickupWeapon(e,t);break;case IT.AMMO:r=PickupAmmo(e,t);break;case IT.ARMOR:r=PickupArmor(e,t);break;case IT.HEALTH:r=PickupHealth(e,t);break;case IT.POWERUP:r=PickupPowerup(e,t),n=!1;break;case IT.TEAM:r=PickupTeam(e,t);break;case IT.HOLDABLE:r=PickupHoldable(e,t);break;default:return}if(!r)return;n?AddPredictableEvent(t,EV.ITEM_PICKUP,e.s.modelIndex):AddEvent(t,EV.ITEM_PICKUP,e.s.modelIndex);if(e.item.giType===IT.POWERUP||e.item.giType===IT.TEAM){var i;e.speed?(i=TempEntity(e.s.pos.trBase,EV.GLOBAL_ITEM_PICKUP),i.s.eventParm=e.s.modelIndex,i.svFlags|=SVF.SINGLECLIENT,i.singleClient=t.s.number):(i=TempEntity(e.s.pos.trBase,EV.GLOBAL_ITEM_PICKUP),i.s.eventParm=e.s.modelIndex,i.svFlags|=SVF.BROADCAST)}UseTargets(e,t);if(e.wait===-1){e.svFlags|=SVF.NOCLIENT,e.s.eFlags|=EF.NODRAW,e.contents=0,e.unlinkAfterEvent=!0;return}e.wait&&(r=e.wait),e.random&&(r+=Math.random()*e.random,r<1&&(r=1)),e.flags&GFL.DROPPED_ITEM&&(e.freeAfterEvent=!0),e.svFlags|=SVF.NOCLIENT,e.s.eFlags|=EF.NODRAW,e.contents=0,r<=0?(e.nextthink=0,e.think=0):(e.nextthink=level.time+r*1e3,e.think=RespawnItem),sv.LinkEntity(e)}function PickupWeapon(e,t){var n;return e.count<0?n=0:(e.count?n=e.count:n=e.item.quantity,!(e.flags&GFL.DROPPED_ITEM)&&g_gametype()!==GT.TEAM&&(t.client.ps.ammo[e.item.giTag]<n?n-=t.client.ps.ammo[e.item.giTag]:n=1)),t.client.ps.stats[STAT.WEAPONS]|=1<<e.item.giTag,AddAmmo(t,e.item.giTag,n),g_gametype()===GT.TEAM?g_weaponTeamRespawn():g_weaponRespawn()}function PickupAmmo(e,t){var n;return e.count?n=e.count:n=e.item.quantity,AddAmmo(t,e.item.giTag,n),RESPAWN.AMMO}function AddAmmo(e,t,n){e.client.ps.ammo[t]+=n,e.client.ps.ammo[t]>200&&(e.client.ps.ammo[t]=200)}function PickupArmor(e,t){return t.client.ps.stats[STAT.ARMOR]+=e.item.quantity,t.client.ps.stats[STAT.ARMOR]>t.client.ps.stats[STAT.MAX_HEALTH]*2&&(t.client.ps.stats[STAT.ARMOR]=t.client.ps.stats[STAT.MAX_HEALTH]*2),RESPAWN.ARMOR}function PickupHealth(e,t){var n,r;return e.item.quantity!=5&&e.item.quantity!=100?n=t.client.ps.stats[STAT.MAX_HEALTH]:n=t.client.ps.stats[STAT.MAX_HEALTH]*2,e.count?r=e.count:r=e.item.quantity,t.health+=r,t.health>n&&(t.health=n),t.client.ps.stats[STAT.HEALTH]=t.health,e.item.quantity==100?RESPAWN.MEGAHEALTH:RESPAWN.HEALTH}function PickupPowerup(e,t){t.client.ps.powerups[e.item.giTag]||(t.client.ps.powerups[e.item.giTag]=level.time-level.time%1e3);var n;e.count?n=e.count:n=e.item.quantity,t.client.ps.powerups[e.item.giTag]+=n*1e3;for(var r=0;r<MAX_CLIENTS;r++){var i=level.clients[r];if(i===t.client)continue;if(i.pers.connected===CON.DISCONNECTED)continue;if(i.ps.pm_type===PM.DEAD)continue;if(g_gametype()>=GT.TEAM&&t.client.sess.sessionTeam===i.sess.sessionTeam)continue;var s=vec3.subtract(e.s.pos.trBase,i.ps.origin,[0,0,0]),o=vec3.normalize(s);if(o>192)continue;var u=[0,0,0];QMath.AnglesToVectors(i.ps.viewangles,u,null,null);if(vec3.dot(s,u)<.4)continue;var a=sv.Trace(i.ps.origin,e.s.pos.trBase,null,null,ENTITYNUM_NONE,CONTENTS.SOLID);if(a.fraction!==1)continue;i.ps.persistant[PERS.PLAYEREVENTS]^=PLAYEREVENTS.DENIEDREWARD}return RESPAWN.POWERUP}function PickupHoldable(e,t){return RESPAWN.HOLDABLE}function LaunchItem(e,t,n){var r=SpawnEntity();r.s.eType=ET.ITEM,r.s.modelindex=bg.ItemList.indexOf(e),r.s.modelindex2=1,r.classname=e.classname,r.item=e,VectorSet(r.mins,-ITEM_RADIUS,-ITEM_RADIUS,-ITEM_RADIUS),VectorSet(r.maxs,ITEM_RADIUS,ITEM_RADIUS,ITEM_RADIUS),r.contents=CONTENTS.TRIGGER,r.touch=TouchItem,SetOrigin(r,t),r.s.pos.trType=TR.GRAVITY,r.s.pos.trTime=level.time,vec3.set(n,r.s.pos.trDelta),r.s.eFlags|=EF.BOUNCE_HALF;if(g_gametype()!=GT.CTF&&g_gametype()!=GT.NFCTF||e.giType!=IT.TEAM)r.think=FreeEntity,r.nextthink=level.time+3e4;return r.flags=GFL.DROPPED_ITEM,sv.LinkEntity(r),r}function Drop_Item(e,t,n){var r=[0,0,0],i=[0,0,0];return vec3.set(e.s.apos.trBase,i),i[QMath.YAW]+=n,i[QMath.PITCH]=0,QMath.AnglesToVectors(i,r,null,null),vec3.scale(r,150,r),r[2]+=200+QMath.crandom()*50,LaunchItem(t,e.s.pos.trBase,r)}function Use_Item(e,t,n){RespawnItem(e)}function TeleportPlayer(e,t,n){var r=n[0]>999999;if(e.client.sess.spectatorState===SPECTATOR.NOT){var i=TempEntity(e.client.ps.origin,EV.PLAYER_TELEPORT_OUT);i.s.clientNum=e.s.clientNum,i=TempEntity(t,EV.PLAYER_TELEPORT_IN),i.s.clientNum=e.s.clientNum}sv.UnlinkEntity(e),vec3.set(t,e.client.ps.origin),e.client.ps.origin[2]+=1,r||(QMath.AnglesToVectors(n,e.client.ps.velocity,null,null),vec3.scale(e.client.ps.velocity,400),e.client.ps.pm_time=160,e.client.ps.pm_flags|=PMF.TIME_KNOCKBACK,SetClientViewAngle(e,n)),e.client.ps.eFlags^=EF.TELEPORT_BIT,e.client.sess.spectatorState===SPECTATOR.NOT&&KillBox(e),bg.PlayerStateToEntityState(e.client.ps,e.s),vec3.set(e.client.ps.origin,e.currentOrigin),e.client.sess.spectatorState===SPECTATOR.NOT&&sv.LinkEntity(e)}function RunMissile(e){var t=[0,0,0];bg.EvaluateTrajectory(e.s.pos,level.time,t);var n=sv.Trace(e.currentOrigin,t,e.mins,e.maxs,e.ownerNum,e.clipmask);n.startSolid||n.allSolid?(n=sv.Trace(e.currentOrigin,e.currentOrigin,e.mins,e.maxs,e.ownerNum,e.clipmask),n.fraction=0):vec3.set(n.endPos,e.currentOrigin),sv.LinkEntity(e);if(n.fraction!==1){if(n.surfaceFlags&SURF.NOIMPACT){FreeEntity(e);return}MissileImpact(e,n);if(e.s.eType!==ET.MISSILE)return}RunEntity(e)}function MissileImpact(e,t){var n=level.gentities[t.entityNum],r=!1;if(!n.takeDamage&&e.s.eFlags&(EF.BOUNCE|EF.BOUNCE_HALF)){BounceMissile(e,t),AddEvent(e,EV.GRENADE_BOUNCE,0);return}if(n.takeDamage&&e.damage){var i=[0,0,0];LogAccuracyHit(n,level.gentities[e.ownerNum])&&(level.gentities[e.ownerNum].client.accuracy_hits++,r=!0),bg.EvaluateTrajectoryDelta(e.s.pos,level.time,i),vec3.length(i)===0&&(i[2]=1),Damage(n,e,level.gentities[e.ownerNum],i,e.s.origin,e.damage,0,e.methodOfDeath)}n.takeDamage&&n.client?(AddEvent(e,EV.MISSILE_HIT,QMath.DirToByte(t.plane.normal)),e.s.otherEntityNum=n.s.number):t.surfaceFlags&SURF.METALSTEPS?AddEvent(e,EV.MISSILE_MISS_METAL,QMath.DirToByte(t.plane.normal)):AddEvent(e,EV.MISSILE_MISS,QMath.DirToByte(t.plane.normal)),e.freeAfterEvent=!0,e.s.eType=ET.GENERAL,SetOrigin(e,t.endPos),e.splashDamage&&RadiusDamage(t.endPos,e,e.parent,e.splashDamage,e.splashRadius,n,e.splashMethodOfDeath)&&(r||level.gentities[e.ownerNum].client.accuracy_hits++),sv.LinkEntity(e)}function BounceMissile(e,t){var n=[0,0,0],r,i;i=level.previousTime+(level.time-level.previousTime)*t.fraction,bg.EvaluateTrajectoryDelta(e.s.pos,i,n),r=vec3.dot(n,t.plane.normal),vec3.add(n,vec3.scale(t.plane.normal,-2*r,[0,0,0]),e.s.pos.trDelta);if(e.s.eFlags&EF.BOUNCE_HALF){vec3.scale(e.s.pos.trDelta,.65,e.s.pos.trDelta);if(t.plane.normal[2]>.2&&vec3.length(e.s.pos.trDelta)<40){SetOrigin(e,t.endPos),e.s.time=level.time/4;return}}vec3.add(e.currentOrigin,t.plane.normal,e.currentOrigin),vec3.set(e.currentOrigin,e.s.pos.trBase),e.s.pos.trTime=level.time}function ExplodeMissile(e){var t=[0,0,0],n=[0,0,1];bg.EvaluateTrajectory(e.s.pos,level.time,t),SetOrigin(e,t),e.s.eType=ET.GENERAL,e.freeAfterEvent=!0,AddEvent(e,EV.MISSILE_MISS,QMath.DirToByte(n)),e.splashDamage&&RadiusDamage(e.currentOrigin,e,e.parent,e.splashDamage,e.splashRadius,e,e.splashMethodOfDeath)&&level.gentities[e.ownerNum].client.accuracy_hits++,sv.LinkEntity(e)}function FireRocket(e,t,n){var r=SpawnEntity();return r.classname="rocket",r.nextthink=level.time+15e3,r.think=ExplodeMissile,r.s.eType=ET.MISSILE,r.svFlags=SVF.USE_CURRENT_ORIGIN,r.s.weapon=WP.ROCKET_LAUNCHER,r.ownerNum=e.s.number,r.parent=e,r.damage=100,r.splashDamage=100,r.splashRadius=120,r.methodOfDeath=MOD.ROCKET,r.splashMethodOfDeath=MOD.ROCKET_SPLASH,r.clipmask=MASK.SHOT,r.s.pos.trType=TR.LINEAR,r.s.pos.trTime=level.time-MISSILE_PRESTEP_TIME,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,900,r.s.pos.trDelta),vec3.set(t,r.currentOrigin),r}function FireGrenade(e,t,n){var r=SpawnEntity();return r.classname="grenade",r.nextthink=level.time+2500,r.think=ExplodeMissile,r.s.eType=ET.MISSILE,r.svFlags=SVF.USE_CURRENT_ORIGIN,r.s.weapon=WP.GRENADE_LAUNCHER,r.s.eFlags=EF.BOUNCE_HALF,r.ownerNum=e.s.number,r.parent=e,r.damage=100,r.splashDamage=100,r.splashRadius=150,r.methodOfDeath=MOD.GRENADE,r.splashMethodOfDeath=MOD.GRENADE_SPLASH,r.clipmask=MASK.SHOT,r.s.pos.trType=TR.GRAVITY,r.s.pos.trTime=level.time-MISSILE_PRESTEP_TIME,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,700,r.s.pos.trDelta),vec3.set(t,r.currentOrigin),r}function FirePlasma(e,t,n){var r=SpawnEntity();return r.classname="plasma",r.nextthink=level.time+1e4,r.think=ExplodeMissile,r.s.eType=ET.MISSILE,r.svFlags=SVF.USE_CURRENT_ORIGIN,r.s.weapon=WP.PLASMAGUN,r.ownerNum=e.s.number,r.parent=e,r.damage=20,r.splashDamage=15,r.splashRadius=20,r.methodOfDeath=MOD.PLASMA,r.splashMethodOfDeath=MOD.PLASMA_SPLASH,r.clipmask=MASK.SHOT,r.s.pos.trType=TR.LINEAR,r.s.pos.trTime=level.time-MISSILE_PRESTEP_TIME,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,2e3,r.s.pos.trDelta),vec3.set(t,r.currentOrigin),r}function FireBFG(e,t,n){var r=SpawnEntity();return r.classname="bfg",r.nextthink=level.time+1e4,r.think=ExplodeMissile,r.s.eType=ET.MISSILE,r.svFlags=SVF.USE_CURRENT_ORIGIN,r.s.weapon=WP.BFG,r.ownerNum=e.s.number,r.parent=e,r.damage=100,r.splashDamage=100,r.splashRadius=120,r.methodOfDeath=MOD.BFG,r.splashMethodOfDeath=MOD.BFG_SPLASH,r.clipmask=MASK.SHOT,r.s.pos.trType=TR.LINEAR,r.s.pos.trTime=level.time-MISSILE_PRESTEP_TIME,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,2e3,r.s.pos.trDelta),vec3.set(t,r.currentOrigin),r}function InitMover(e){e.use=UseBinaryMover,e.reached=ReachedBinaryMover,e.moverState=MOVER.POS1,e.svFlags=SVF.USE_CURRENT_ORIGIN,e.s.eType=ET.MOVER,vec3.set(e.pos1,e.currentOrigin),sv.LinkEntity(e),e.s.pos.trType=TR.STATIONARY,vec3.set(e.pos1,e.s.pos.trBase);var t=vec3.subtract(e.pos2,e.pos1,[0,0,0]),n=vec3.length(t);e.speed||(e.speed=100),vec3.scale(t,e.speed,e.s.pos.trDelta),e.s.pos.trDuration=n*1e3/e.speed,e.s.pos.trDuration<=0&&(e.s.pos.trDuration=1)}function RunMover(e){if(e.flags&GFL.TEAMSLAVE)return;(e.s.pos.trType!==TR.STATIONARY||e.s.apos.trType!==TR.STATIONARY)&&RunMoverTeam(e),RunEntity(e)}function RunMoverTeam(e){var t,n,r=[0,0,0],i=[0,0,0],s=[0,0,0],o=[0,0,0];for(t=e;t;t=t.teamchain){bg.EvaluateTrajectory(t.s.pos,level.time,s),bg.EvaluateTrajectory(t.s.apos,level.time,o),vec3.subtract(s,t.currentOrigin,r),vec3.subtract(o,t.currentAngles,i);var u=MoverPush(t,r,i);if(n)break}if(t){for(t=e;t;t=t.teamchain)t.s.pos.trTime+=level.time-level.previousTime,t.s.apos.trTime+=level.time-level.previousTime,bg.EvaluateTrajectory(t.s.pos,level.time,t.currentOrigin),bg.EvaluateTrajectory(t.s.apos,level.time,t.currentAngles),sv.LinkEntity(t);e.blocked&&e.blocked(e,n);return}for(t=e;t;t=t.teamchain)t.s.pos.trType===TR.LINEAR_STOP&&level.time>=t.s.pos.trTime+t.s.pos.trDuration&&t.reached&&t.reached(t)}function MoverPush(e,t,n){var r,i,s=[0,0,0],o=[0,0,0],u=[0,0,0],a=[0,0,0];if(e.currentAngles[0]||e.currentAngles[1]||e.currentAngles[2]||n[0]||n[1]||n[2]){var f=QMath.RadiusFromBounds(e.mins,e.maxs);for(r=0;r<3;r++)s[r]=e.currentOrigin[r]+t[r]-f,o[r]=e.currentOrigin[r]+t[r]+f,u[r]=s[r]-t[r],a[r]=o[r]-t[r]}else{for(r=0;r<3;r++)s[r]=e.absmin[r]+t[r],o[r]=e.absmax[r]+t[r];vec3.set(e.absmin,u),vec3.set(e.absmax,a);for(r=0;r<3;r++)t[r]>0?a[r]+=t[r]:u[r]+=t[r]}sv.UnlinkEntity(e);var l=sv.FindEntitiesInBox(u,a);return vec3.add(e.currentOrigin,t),vec3.add(e.currentAngles,n),sv.LinkEntity(e),null}function SetMoverState(e,t,n){var r=[0,0,0],i;e.moverState=t,e.s.pos.trTime=n;switch(t){case MOVER.POS1:vec3.set(e.pos1,e.s.pos.trBase),e.s.pos.trType=TR.STATIONARY;break;case MOVER.POS2:vec3.set(e.pos2,e.s.pos.trBase),e.s.pos.trType=TR.STATIONARY;break;case MOVER.ONETOTWO:vec3.set(e.pos1,e.s.pos.trBase),vec3.subtract(e.pos2,e.pos1,r),i=1e3/e.s.pos.trDuration,vec3.scale(r,i,e.s.pos.trDelta),e.s.pos.trType=TR.LINEAR_STOP;break;case MOVER.TWOTOONE:vec3.set(e.pos2,e.s.pos.trBase),vec3.subtract(e.pos1,e.pos2,r),i=1e3/e.s.pos.trDuration,vec3.scale(r,i,e.s.pos.trDelta),e.s.pos.trType=TR.LINEAR_STOP}bg.EvaluateTrajectory(e.s.pos,level.time,e.currentOrigin),sv.LinkEntity(e)}function UseBinaryMover(e,t,n){var r,i;if(e.flags&GFL.TEAMSLAVE){UseBinaryMover(e.teammaster,t,n);return}e.activator=n;if(e.moverState===MOVER.POS1){MatchTeam(e,MOVER.ONETOTWO,level.time+50),e.sound1to2&&AddEvent(e,EV.GENERAL_SOUND,e.sound1to2),e.s.loopSound=e.soundLoop,(e.teammaster===e||!e.teammaster)&&sv.AdjustAreaPortalState(e,!0);return}if(e.moverState===MOVER.POS2){e.nextthink=level.time+e.wait;return}if(e.moverState===MOVER.TWOTOONE){r=e.s.pos.trDuration,i=level.time-e.s.pos.trTime,i>r&&(i=r),MatchTeam(e,MOVER.ONETOTWO,level.time-(r-i)),e.sound1to2&&AddEvent(e,EV.GENERAL_SOUND,e.sound1to2);return}if(e.moverState===MOVER.ONETOTWO){r=e.s.pos.trDuration,i=level.time-e.s.pos.trTime,i>r&&(i=r),MatchTeam(e,MOVER.TWOTOONE,level.time-(r-i)),e.sound2to1&&AddEvent(e,EV.GENERAL_SOUND,e.sound2to1);return}}function ReachedBinaryMover(e){e.s.loopSound=e.soundLoop,e.moverState===MOVER.ONETOTWO?(SetMoverState(e,MOVER.POS2,level.time),e.soundPos2&&AddEvent(e,EV.GENERAL_SOUND,e.soundPos2),e.think=ReturnToPos1,e.nextthink=level.time+e.wait,e.activator||(e.activator=e),UseTargets(e,e.activator)):e.moverState===MOVER.TWOTOONE?(SetMoverState(e,MOVER.POS1,level.time),e.soundPos1&&AddEvent(e,EV.GENERAL_SOUND,e.soundPos1),(e.teammaster===e||!e.teammaster)&&sv.AdjustAreaPortalState(e,!1)):error("ReachedBinaryMover: bad moverState")}function MatchTeam(e,t,n){for(var r=e;r;r=r.teamchain)SetMoverState(r,t,n)}function ReturnToPos1(e){MatchTeam(e,MOVER.TWOTOONE,level.time),e.s.loopSound=e.soundLoop,e.sound2to1&&AddEvent(e,EV.GENERAL_SOUND,e.sound2to1)}function InitSessionData(e,t){var n=e.sess;if(g_gametype()>=GT.TEAM)g_gametype()===GT.CLANARENA&&(n.arena=g_forcearena()),g_teamAutoJoin()?(n.sessionTeam=PickTeam(n.arena,null),BroadcastTeamChange(null,e)):n.sessionTeam=TEAM.SPECTATOR;else{var r=t.team;if(r==="s")n.sessionTeam=TEAM.SPECTATOR;else switch(g_gametype()){default:case GT.FFA:g_maxGameClients()>0&&level.numNonSpectatorClients>=g_maxGameClients()?n.sessionTeam=TEAM.SPECTATOR:n.sessionTeam=TEAM.FREE;break;case GT.TOURNAMENT:level.numNonSpectatorClients>=2?n.sessionTeam=TEAM.SPECTATOR:n.sessionTeam=TEAM.FREE}}n.sessionTeam===TEAM.SPECTATOR?n.spectatorState=SPECTATOR.FREE:n.spectatorState=SPECTATOR.NOT,WriteClientSessionData(e)}function ReadSessionData(e){var t="session"+e.ps.clientNum,n=com.GetCvarVal(t);n=JSON.parse(n),e.sess.arena=n.arena,e.sess.sessionTeam=n.sessionTeam,e.sess.spectatorNum=n.spectatorNum,e.sess.spectatorState=n.spectatorState,e.sess.spectatorClient=n.spectatorClient,e.sess.wins=n.wins,e.sess.losses=n.losses,e.sess.teamLeader=n.teamLeader}function WriteClientSessionData(e){var t="session"+e.ps.clientNum,n=JSON.stringify(e.sess);com.SetCvarVal(t,n)}function InitWorldSession(){var e=parseInt(com.GetCvarVal("session"),10);g_gametype()!==e&&(level.newSession=!0,log("Gametype changed, clearing session data."))}function WriteSessionData(){com.SetCvarVal("session",g_gametype());for(var e=0;e<MAX_CLIENTS;e++)level.clients[e].pers.connected===CON.CONNECTED&&WriteClientSessionData(level.clients[e])}function Team_InitGame(){teamgame.reset();switch(g_gametype()){case GT.CTF:teamgame.redStatus=-1,teamgame.blueStatus=-1,Team_SetFlagStatus(TEAM.RED,FLAG.ATBASE),Team_SetFlagStatus(TEAM.BLUE,FLAG.ATBASE);break;default:}}function Team_SetFlagStatus(e,t){var n=!1;switch(e){case TEAM.RED:teamgame.redStatus!=t&&(teamgame.redStatus=t,n=!0);break;case TEAM.BLUE:teamgame.blueStatus!=t&&(teamgame.blueStatus=t,n=!0);break;case TEAM.FREE:teamgame.flagStatus!=t&&(teamgame.flagStatus=t,n=!0)}if(n){var r=new Array(4);g_gametype()==GT.CTF?(r[0]=ctfFlagStatusRemap[teamgame.redStatus],r[1]=ctfFlagStatusRemap[teamgame.blueStatus],r[2]=0):(r[0]=oneFlagStatusRemap[teamgame.flagStatus],r[1]=0),sv.SetConfigstring("flagstatus",r)}}function OnSameTeam(e,t){return!e.client||!t.client?!1:g_gametype()<GT.TEAM?!1:e.client.sess.sessionTeam===t.client.sess.sessionTeam?!0:!1}function PickupTeam(e,t){var n,r=t.client;if(e.classname==="team_CTF_redflag")n=TEAM.RED;else{if(e.classname!=="team_CTF_blueflag")return 0;n=TEAM.BLUE}return n===r.sess.sessionTeam?Team_TouchOurFlag(e,t,n):Team_TouchEnemyFlag(e,t,n)}function Team_TouchOurFlag(e,t,n){var r,i,s=t.client,o;s.sess.sessionTeam==TEAM.RED?o=PW.BLUEFLAG:o=PW.REDFLAG;if(e.flags&GFL.DROPPED_ITEM)return AddScore(t,e.currentOrigin,CTF_RECOVERY_BONUS),t.client.pers.teamState.flagrecovery++,t.client.pers.teamState.lastreturnedflag=level.time,Team_ReturnFlagSound(Team_ResetFlag(n),n),0;if(!s.ps.powerups[o])return 0;s.ps.powerups[o]=0,teamgame.last_flag_capture=level.time,teamgame.last_capture_team=n,AddTeamScore(e.s.pos.trBase,t.client.sess.sessionTeam,1),Team_ForceGesture(t.client.sess.sessionTeam),t.client.pers.teamState.captures++,t.client.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP),t.client.ps.eFlags|=EF.AWARD_CAP,t.client.rewardTime=level.time+REWARD_SPRITE_TIME,t.client.ps.persistant[PERS.CAPTURES]++,AddScore(t,e.currentOrigin,CTF_CAPTURE_BONUS),Team_CaptureFlagSound(e,n);for(r=0;r<com.GetCvarVal("sv_maxClients");r++){i=level.gentities[r];if(!i.inuse||i==t)continue;i.client.sess.sessionTeam!=s.sess.sessionTeam?i.client.pers.teamState.lasthurtcarrier=-5:i.client.sess.sessionTeam==s.sess.sessionTeam&&(i.client.pers.teamState.lastreturnedflag+CTF_RETURN_FLAG_ASSIST_TIMEOUT>level.time&&(AddScore(i,e.currentOrigin,CTF_RETURN_FLAG_ASSIST_BONUS),t.client.pers.teamState.assists++,i.client.ps.persistant[PERS.ASSIST_COUNT]++,i.client.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP),i.client.ps.eFlags|=EF.AWARD_ASSIST,i.client.rewardTime=level.time+REWARD_SPRITE_TIME),i.client.pers.teamState.lastfraggedcarrier+CTF_FRAG_CARRIER_ASSIST_TIMEOUT>level.time&&(AddScore(i,e.currentOrigin,CTF_FRAG_CARRIER_ASSIST_BONUS),t.client.pers.teamState.assists++,i.client.ps.persistant[PERS.ASSIST_COUNT]++,i.client.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP),i.client.ps.eFlags|=EF.AWARD_ASSIST,i.client.rewardTime=level.time+REWARD_SPRITE_TIME))}return Team_ResetFlags(),CalculateRanks(),0}function Team_TouchEnemyFlag(e,t,n){var r=t.client;return n==TEAM.RED?r.ps.powerups[PW.REDFLAG]=536870911:r.ps.powerups[PW.BLUEFLAG]=536870911,Team_SetFlagStatus(n,FLAG.TAKEN),r.pers.teamState.flagsince=level.time,Team_TakeFlagSound(e,n),-1}function AddTeamScore(e,t,n){var r=TempEntity(e,EV.GLOBAL_TEAM_SOUND);r.svFlags|=SVF.BROADCAST,t===TEAM.RED?level.teamScores[TEAM.RED]+n===level.teamScores[TEAM.BLUE]?r.s.eventParm=GTS.TEAMS_ARE_TIED:level.teamScores[TEAM.RED]<=level.teamScores[TEAM.BLUE]&&level.teamScores[TEAM.RED]+n>level.teamScores[TEAM.BLUE]?r.s.eventParm=GTS.REDTEAM_TOOK_LEAD:r.s.eventParm=GTS.REDTEAM_SCORED:level.teamScores[TEAM.BLUE]+n===level.teamScores[TEAM.RED]?r.s.eventParm=GTS.TEAMS_ARE_TIED:level.teamScores[TEAM.BLUE]<=level.teamScores[TEAM.RED]&&level.teamScores[TEAM.BLUE]+n>level.teamScores[TEAM.RED]?r.s.eventParm=GTS.BLUETEAM_TOOK_LEAD:r.s.eventParm=GTS.BLUETEAM_SCORED,level.teamScores[t]+=n}function Team_ForceGesture(e){var t,n;for(t=0;t<MAX_CLIENTS;t++){n=level.gentities[t];if(!n.inuse)continue;if(!n.client)continue;if(n.client.sess.sessionTeam!=e)continue;n.flags|=GFL.FORCE_GESTURE}}function Team_ResetFlags(){g_gametype()==GT.CTF?(Team_ResetFlag(TEAM.RED),Team_ResetFlag(TEAM.BLUE)):g_gametype()==GT.NFCTF&&Team_ResetFlag(TEAM.FREE)}function Team_ResetFlag(e){var t,n,r;switch(e){case TEAM.RED:t="team_CTF_redflag";break;case TEAM.BLUE:t="team_CTF_blueflag";break;case TEAM.FREE:t="team_CTF_neutralflag";break;default:return null}n=FindEntity({classname:t});for(var i=0;i<n.length;i++)n[i].flags&GFL.DROPPED_ITEM?FreeEntity(n[i]):(r=n[i],RespawnItem(n[i]));return Team_SetFlagStatus(e,FLAG.ATBASE),r}function PickTeam(e,t){var n=new Array(TEAM.NUM_TEAMS);return g_gametype()===GT.CLANARENA&&e===0?TEAM.FREE:(n[TEAM.BLUE]=TeamCount(TEAM.BLUE,t),n[TEAM.RED]=TeamCount(TEAM.RED,t),n[TEAM.BLUE]>n[TEAM.RED]?TEAM.RED:n[TEAM.RED]>n[TEAM.BLUE]?TEAM.BLUE:level.teamScores[TEAM.BLUE]>level.teamScores[TEAM.RED]?TEAM.RED:TEAM.BLUE)}function TeamCount(e,t){var n=0;for(var r=0;r<level.maxclients;r++){if(r===t)continue;var i=level.clients[r];if(i.pers.connected===CON.DISCONNECTED)continue;i.sess.sessionTeam===e&&n++}return n}function TeamAliveCount(e,t){var n=0;for(var r=0;r<level.maxclients;r++){if(r===e)continue;var i=level.clients[r];if(i.pers.connected===CON.DISCONNECTED||i.sess.spectatorState!==SPECTATOR.NOT)continue;i.sess.sessionTeam===t&&n++}return n}function TeamLeader(e){for(var t=0;t<level.maxclients;t++){if(level.clients[t].pers.connected===CON.DISCONNECTED)continue;if(level.clients[t].sess.sessionTeam===e&&level.clients[t].sess.teamLeader)return t}return-1}function CheckTeamLeader(e){var t;for(t=0;t<level.maxclients;t++){var n=level.clients[t];if(n.sess.sessionTeam!==e)continue;if(n.sess.teamLeader)break}if(t>=level.maxclients)for(t=0;t<level.maxclients;t++){var n=level.clients[t];if(n.sess.sessionTeam!==e)continue;level.clients[t].sess.teamLeader=!0;break}}function SetTeamLeader(e,t){var n=level.clients[e];if(n.pers.connected===CON.DISCONNECTED)return;if(n.sess.sessionTeam!==t)return;for(var r=0;r<level.maxclients;r++){if(level.clients[r].sess.sessionTeam!==t)continue;level.clients[r].sess.teamLeader&&(level.clients[r].sess.teamLeader=!1,ClientUserinfoChanged(r))}n.sess.teamLeader=!0,ClientUserinfoChanged(e)}function BroadcastTeamChange(e,t){t.sess.sessionTeam===TEAM.RED?sv.SendServerCommand(null,"cp",t.pers.netname+" joined the red team."):t.sess.sessionTeam===TEAM.BLUE?sv.SendServerCommand(null,"cp",t.pers.netname+" joined the blue team."):t.sess.sessionTeam===TEAM.SPECTATOR&&e!==TEAM.SPECTATOR?sv.SendServerCommand(null,"cp",t.pers.netname+" joined the spectators."):t.sess.sessionTeam===TEAM.FREE&&sv.SendServerCommand(null,"cp",t.pers.netname+" joined the battle.")}function Team_ReturnFlagSound(e,t){if(!e)return;var n=TempEntity(e.s.pos.trBase,EV.GLOBAL_TEAM_SOUND);t==TEAM.BLUE?n.s.eventParm=GTS.RED_RETURN:n.s.eventParm=GTS.BLUE_RETURN,n.svFlags|=SVF.BROADCAST}function Team_TakeFlagSound(e,t){if(!e)return;switch(t){case TEAM.RED:if(teamgame.blueStatus!=FLAG.ATBASE&&teamgame.blueTakenTime>level.time-1e4)return;teamgame.blueTakenTime=level.time;break;case TEAM.BLUE:if(teamgame.redStatus!=FLAG.ATBASE&&teamgame.redTakenTime>level.time-1e4)return;teamgame.redTakenTime=level.time}var n=TempEntity(e.s.pos.trBase,EV.GLOBAL_TEAM_SOUND);t==TEAM.BLUE?n.s.eventParm=GTS.RED_TAKEN:n.s.eventParm=GTS.BLUE_TAKEN,n.svFlags|=SVF.BROADCAST}function Team_CaptureFlagSound(e,t){if(!e)return;var n=TempEntity(e.s.pos.trBase,EV.GLOBAL_TEAM_SOUND);t==TEAM.BLUE?n.s.eventParm=GTS.BLUE_CAPTURE:n.s.eventParm=GTS.RED_CAPTURE,n.svFlags|=SVF.BROADCAST}function InitTrigger(e){vec3.equal(e.s.angles,QMath.vec3origin)||SetMovedir(e.s.angles,e.movedir),sv.SetBrushModel(e,e.model),e.contents=CONTENTS.TRIGGER,e.svFlags=SVF.NOCLIENT}function AimAtTarget(e){var t=vec3.add(e.absmin,e.absmax,[0,0,0]);vec3.scale(t,.5);var n=PickTarget(e.target);if(!n){FreeEntity(e);return}var r=n.s.origin[2]-t[2],i=g_gravity(),s=Math.sqrt(r/(.5*i));if(!s){FreeEntity(e);return}vec3.subtract(n.s.origin,t,e.s.origin2),e.s.origin2[2]=0;var o=vec3.length(e.s.origin2);vec3.normalize(e.s.origin2);var u=o/s;vec3.scale(e.s.origin2,u),e.s.origin2[2]=s*i}function FireWeapon(e){var t=e.client;QMath.AnglesToVectors(t.ps.viewangles,forward,right,up),CalcMuzzlePoint(e,forward,right,up,muzzle);switch(e.s.weapon){case WP.GAUNTLET:break;case WP.LIGHTNING:LightningFire(e);break;case WP.SHOTGUN:ShotgunFire(e);break;case WP.MACHINEGUN:g_gametype()!==GT.TEAM?BulletFire(e,MACHINEGUN_SPREAD,MACHINEGUN_DAMAGE,MOD.MACHINEGUN):BulletFire(e,MACHINEGUN_SPREAD,MACHINEGUN_TEAM_DAMAGE,MOD.MACHINEGUN);break;case WP.GRENADE_LAUNCHER:GrenadeLauncherFire(e);break;case WP.ROCKET_LAUNCHER:RocketLauncherFire(e);break;case WP.PLASMAGUN:PlasmagunFire(e);break;case WP.RAILGUN:RailgunFire(e);break;case WP.BFG:BFGFire(e);break;case WP.GRAPPLING_HOOK:break;default:}}function CheckGauntletAttack(e){if(e.client.noclip)return!1;QMath.AnglesToVectors(e.client.ps.viewangles,forward,right,up),CalcMuzzlePoint(e,forward,right,up,muzzle);var t=vec3.add(vec3.scale(forward,32,[0,0,0]),muzzle),n=sv.Trace(muzzle,t,null,null,e.s.number,MASK.SHOT);if(n.surfaceFlags&SURF.NOIMPACT)return!1;var r=level.gentities[n.entityNum];if(r.takeDamage&&r.client){var i=TempEntity(n.endPos,EV.MISSILE_HIT);i.s.otherEntityNum=r.s.number,i.s.eventParm=QMath.DirToByte(n.plane.normal),i.s.weapon=e.s.weapon}return r.takeDamage?(e.client.ps.powerups[PW.QUAD]&&AddEvent(e,EV.POWERUP_QUAD,0),damage=50,Damage(r,e,e,forward,n.endPos,damage,0,MOD.GAUNTLET),!0):!1}function LightningFire(e){var t=8,n=[0,0,0];for(var r=0;r<10;r++){vec3.add(muzzle,vec3.scale(forward,LIGHTNING_RANGE,[0,0,0]),n);var i=sv.Trace(muzzle,n,null,null,e.s.number,MASK.SHOT);if(i.entityNum===ENTITYNUM_NONE)return;var s=level.gentities[i.entityNum];s.takeDamage&&Damage(s,e,e,forward,i.endPos,t,0,MOD.LIGHTNING);var o;s.takeDamage&&s.client?(o=TempEntity(i.endPos,EV.MISSILE_HIT),o.s.otherEntityNum=s.s.number,o.s.eventParm=QMath.DirToByte(i.plane.normal),o.s.weapon=e.s.weapon,LogAccuracyHit(s,e)&&e.client.accuracy_hits++):i.surfaceFlags&SURF.NOIMPACT||(o=TempEntity(i.endPos,EV.MISSILE_MISS),o.s.eventParm=QMath.DirToByte(i.plane.normal),o.s.weapon=e.s.weapon);break}}function ShotgunPellet(e,t,n){var r=[0,0,0],i=[0,0,0];vec3.set(e,r),vec3.set(t,i);for(var s=0;s<10;s++){var o=sv.Trace(r,i,null,null,n.s.number,MASK.SHOT),u=level.gentities[o.entityNum];if(o.surfaceFlags&SURF.NOIMPACT)return!1;if(u.takeDamage){var a=DEFAULT_SHOTGUN_DAMAGE;Damage(u,n,n,forward,o.endPos,a,0,MOD.SHOTGUN);if(LogAccuracyHit(u,n))return!0}return!1}return!1}function ShotgunPattern(e,t,n,r){var i,s,o=[0,0,0],u=[0,0,0],a=[0,0,0],f=[0,0,0],l=!1;vec3.normalize(t,u),QMath.PerpendicularVector(u,a),vec3.cross(u,a,f);for(var c=0;c<DEFAULT_SHOTGUN_COUNT;c++)i=QMath.crandom()*DEFAULT_SHOTGUN_SPREAD*16,s=QMath.crandom()*DEFAULT_SHOTGUN_SPREAD*16,vec3.add(e,vec3.scale(u,131072,[0,0,0]),o),vec3.add(o,vec3.scale(a,i,[0,0,0])),vec3.add(o,vec3.scale(f,s,[0,0,0])),ShotgunPellet(e,o,r)&&!l&&(l=!0,r.client.accuracy_hits+=1)}function ShotgunFire(e){var t=TempEntity(muzzle,EV.SHOTGUN);vec3.scale(forward,4096,t.s.origin2),t.s.eventParm=Math.floor(Math.random()*65536)&255,t.s.otherEntityNum=e.s.number,ShotgunPattern(t.s.pos.trBase,t.s.origin2,t.s.eventParm,e)}function CalcMuzzlePoint(e,t,n,r,i){vec3.set(e.s.pos.trBase,i),i[2]+=e.client.ps.viewheight,vec3.add(i,vec3.scale(t,14,[0,0,0]))}function BulletFire(e,t,n,r){var i=Math.random()*Math.PI*2,s=Math.sin(i)*QMath.crandom()*t*16;i=Math.cos(i)*QMath.crandom()*t*16;var o=vec3.add(muzzle,vec3.scale(forward,131072,[0,0,0]),[0,0,0]);vec3.add(o,vec3.scale(right,i,[0,0,0])),vec3.add(o,vec3.scale(up,s,[0,0,0]));var u=e.s.number;for(var a=0;a<10;a++){var f=sv.Trace(muzzle,o,null,null,u,MASK.SHOT);if(f.surfaceFlags&SURF.NOIMPACT)return;var l=level.gentities[f.entityNum],c;l.takeDamage&&l.client?(c=TempEntity(f.endPos,EV.BULLET_HIT_FLESH),c.s.eventParm=l.s.number,LogAccuracyHit(l,e)&&e.client.accuracy_hits++):(c=TempEntity(f.endPos,EV.BULLET_HIT_WALL),c.s.eventParm=QMath.DirToByte(f.plane.normal)),c.s.otherEntityNum=e.s.number,l.takeDamage&&Damage(l,e,e,forward,f.endPos,n,0,r);break}}function RocketLauncherFire(e){var t=FireRocket(e,muzzle,forward)}function GrenadeLauncherFire(e){var t;forward[2]+=.2,vec3.normalize(forward),t=FireGrenade(e,muzzle,forward)}function PlasmagunFire(e){var t=FirePlasma(e,muzzle,forward)}function RailgunFire(e){var t=100,n=e.s.number,r=[],i=[0,0,0],s=0,o;vec3.add(muzzle,vec3.scale(forward,8192,[0,0,0]),i);while(r.length<MAX_RAIL_HITS){o=sv.Trace(muzzle,i,null,null,n,MASK.SHOT);if(o.entityNum>=ENTITYNUM_MAX_NORMAL)break;var u=level.gentities[o.entityNum];u.takeDamage&&(LogAccuracyHit(u,e)&&s++,Damage(u,e,e,forward,o.endPos,t,0,MOD.RAILGUN));if(o.contents&CONTENTS.SOLID)break;sv.UnlinkEntity(u),r.push(u)}for(var a=0;a<r.length;a++)sv.LinkEntity(r[a]);var f=TempEntity(o.endPos,EV.RAILTRAIL);f.s.clientNum=e.s.clientNum,vec3.set(muzzle,f.s.origin2),vec3.add(f.s.origin2,vec3.scale(right,4,[0,0,0])),vec3.add(f.s.origin2,vec3.scale(up,-1,[0,0,0])),o.surfaceFlags&SURF.NOIMPACT?f.s.eventParm=255:f.s.eventParm=QMath.DirToByte(o.plane.normal),f.s.clientNum=e.s.clientNum,s===0?e.client.accurateCount=0:(e.client.accurateCount+=s,e.client.accurateCount>=2&&(e.client.accurateCount-=2,e.client.ps.persistant[PERS.IMPRESSIVE_COUNT]++,e.client.ps.eFlags&=~(EF.AWARD_IMPRESSIVE|EF.AWARD_EXCELLENT|EF.AWARD_GAUNTLET|EF.AWARD_ASSIST|EF.AWARD_DEFEND|EF.AWARD_CAP),e.client.ps.eFlags|=EF.AWARD_IMPRESSIVE,e.client.rewardTime=level.time+REWARD_SPRITE_TIME),e.client.accuracy_hits++)}function BFGFire(e){var t=FireBFG(e,muzzle,forward)}function DoorBlocked(e,t){if(!t.client){TempEntity(t.s.origin,EV.ITEM_POP),FreeEntity(t);return}e.damage&&Damage(t,e,e,null,null,e.damage,0,MOD.CRUSH);if(e.spawnflags&4)return;UseBinaryMover(e,e,t)}function DoorSpawnNewTrigger(e){for(var t=e;t;t=t.teamchain)t.takeDamage=!0;var n=vec3.set(e.absmin,[0,0,0]),r=vec3.set(e.absmax,[0,0,0]);for(var t=e.teamchain;t;t=t.teamchain)QMath.AddPointToBounds(t.absmin,n,r),QMath.AddPointToBounds(t.absmax,n,r);var i=0;for(var s=1;s<3;s++)r[s]-n[s]<r[i]-n[i]&&(i=s);r[i]+=120,n[i]-=120;var t=SpawnEntity();t.classname="door_trigger",vec3.set(n,t.mins),vec3.set(r,t.maxs),t.parent=e,t.contents=CONTENTS.TRIGGER,t.touch=DoorTriggerTouch,t.count=i,sv.LinkEntity(t),MatchTeam(e,e.moverState,level.time)}function DoorMatchTeam(e){MatchTeam(e,e.moverState,level.time)}function DoorTriggerTouch(e,t,n){t.client&&t.client.sess.spectatorState!==SPECTATOR.NOT?e.parent.moverState!==MOVER.ONETOTWO&&e.parent.moverState!==MOVER.POS2&&DoorTriggerTouchSpectator(e,t,n):e.parent.moverState!==MOVER.ONETOTWO&&UseBinaryMover(e.parent,e,t)}function DoorTriggerTouchSpectator(e,t,n){var r=e.count,i=e.absmin[r]+100,s=e.absmax[r]-100,o=vec3.set(t.client.ps.origin,[0,0,0]);if(o[r]<i||o[r]>s)return;Math.abs(o[r]-s)<Math.abs(o[r]-i)?o[r]=i-10:o[r]=s+10,TeleportPlayer(t,o,[1e7,0,0])}function TrainSetupTargets(e){var t=FindEntity({targetName:e.target});if(!t.length){log("func_train at",e.absmin,"with an unfound target");return}e.nextTrain=t[0];var n;for(var r=e.nextTrain;r!==n;r=i){n||(n=r);if(!r.target){log("Train corner at",r.s.origin,"without a target");return}t=FindEntity({targetName:r.target});var i;for(var s=0;s<t.length;s++){i=t[s++];if(i.classname==="path_corner")break}r.nextTrain=i}TrainReached(e)}function TrainReached(e){var t=e.nextTrain;if(!t||!t.nextTrain)return;UseTargets(t,null),e.nextTrain=t.nextTrain,vec3.set(t.s.origin,e.pos1),vec3.set(t.nextTrain.s.origin,e.pos2);var n=t.speed?t.speed:e.speed;n<1&&(n=1);var r=vec3.subtract(e.pos2,e.pos1,[0,0,0]),i=vec3.length(r);e.s.pos.trDuration=i*1e3/n,e.svFlags&=~SVF.NOCLIENT,e.s.pos.trDuration<1&&(e.s.pos.trDuration=1,e.svFlags|=SVF.NOCLIENT),e.s.loopSound=t.soundLoop,SetMoverState(e,MOVER.ONETOTWO,level.time),t.wait&&(e.nextthink=level.time+t.wait*1e3,e.think=TrainBeginMoving,e.s.pos.trType=TR.STATIONARY)}function TrainBeginMoving(e){e.s.pos.trTime=level.time,e.s.pos.trType=TR.LINEAR_STOP}function PortalLocateCamera(e){var t=PickTarget(e.target);if(!t){log("Couldn't find target for misc_partal_surface"),FreeEntity(e);return}e.ownerNum=t.s.number,t.spawnflags&1?e.s.frame=25:t.spawnflags&2&&(e.s.frame=75),t.spawnflags&4?e.s.powerups=0:e.s.powerups=1,e.s.clientNum=t.s.clientNum,vec3.set(t.s.origin,e.s.origin2);var n=[0,0,0],r=PickTarget(t.target);r?(vec3.subtract(r.s.origin,t.s.origin,n),vec3.normalize(n)):SetMovedir(t.s.angles,n),e.s.eventParm=QMath.DirToByte(n)}function PushUse(e,t,n){if(!n.client)return;if(n.client.ps.pm_type!==PM.NORMAL)return;if(n.client.ps.powerups[PW.FLIGHT])return;vec3.set(e.s.origin2,n.client.ps.velocity)}function TeleporterUse(e,t,n){if(!n.client)return;var r=PickTarget(e.target);if(!r){log("Couldn't find teleporter destination");return}TeleportPlayer(n,r.s.origin,r.s.angles)}function HurtTouch(e,t){if(e.timestamp>level.time)return;e.spawnflags&16?e.timestamp=level.time+1e3:e.timestamp=level.time+FRAMETIME,ClientSpawn(t)}function HurtUse(e,t,n){e.linked?sv.UnlinkEntity(e):sv.LinkEntity(e)}function PushTouch(e,t){if(!t.client)return;bg.TouchJumpPad(t.client.ps,e.s)}function TeleportTouch(e,t){if(!t.client)return;if(t.client.ps.pm_type===PM.DEAD)return;if(g_gametype()===GT.CLANARENA&&e.arena!==0){SetArena(t,e.arena);return}var n=PickTarget(e.target);if(!n){log("Couldn't find teleporter destination"),FreeEntity(e);return}TeleportPlayer(t,n.s.origin,n.s.angles)}var sys=imp.sys,com=imp.com,sv=imp.sv,bg=bg_mod.CreateInstance(BGExports()),MAX_CLIENTS=sh.MAX_CLIENTS,MAX_GENTITIES=sh.MAX_GENTITIES,MAX_PERSISTANT=sh.MAX_PERSISTANT,MAX_POWERUPS=sh.MAX_POWERUPS,MAX_PS_EVENTS=sh.MAX_PS_EVENTS,ENTITYNUM_NONE=sh.ENTITYNUM_NONE,ENTITYNUM_WORLD=sh.ENTITYNUM_WORLD,ENTITYNUM_MAX_NORMAL=sh.ENTITYNUM_MAX_NORMAL,GIB_HEALTH=bg.GIB_HEALTH,ARMOR_PROTECTION=bg.ARMOR_PROTECTION,RANK_TIED_FLAG=bg.RANK_TIED_FLAG,DEFAULT_SHOTGUN_SPREAD=bg.DEFAULT_SHOTGUN_SPREAD,DEFAULT_SHOTGUN_COUNT=bg.DEFAULT_SHOTGUN_COUNT,LIGHTNING_RANGE=bg.LIGHTNING_RANGE,SCORE_NOT_PRESENT=bg.SCORE_NOT_PRESENT,ANIM_TOGGLEBIT=bg.ANIM_TOGGLEBIT,EV_EVENT_BIT1=bg.EV_EVENT_BIT1,EV_EVENT_BIT2=bg.EV_EVENT_BIT2,EV_EVENT_BITS=bg.EV_EVENT_BITS,EVENT_VALID_MSEC=bg.EVENT_VALID_MSEC,CVF=sh.CVF,BUTTON=sh.BUTTON,TR=sh.TR,SURF=sh.SURF,CONTENTS=sh.CONTENTS,FLAG=sh.FLAG,ERR=com.ERR,PM=bg.PM,PMF=bg.PMF,GT=bg.GT,WS=bg.WS,IT=bg.IT,MASK=bg.MASK,STAT=bg.STAT,WP=bg.WP,PW=bg.PW,TEAM=bg.TEAM,SPECTATOR=bg.SPECTATOR,PERS=bg.PERS,PLAYEREVENTS=bg.PLAYEREVENTS,ET=bg.ET,EF=bg.EF,EV=bg.EV,GTS=bg.GTS,ANIM=bg.ANIM,MOD=bg.MOD,BODY_QUEUE_SIZE=8,FRAMETIME=100,ITEM_RADIUS=15,CARNAGE_REWARD_TIME=3e3,REWARD_SPRITE_TIME=2e3,INTERMISSION_DELAY_TIME=1e3,SP_INTERMISSION_DELAY_TIME=5e3,DAMAGE={RADIUS:1,NO_ARMOR:2,NO_KNOCKBACK:4,NO_PROTECTION:8},GFL={GODMODE:16,NOTARGET:32,TEAMSLAVE:1024,NO_KNOCKBACK:2048,DROPPED_ITEM:4096,NO_BOTS:8192,NO_HUMANS:16384,FORCE_GESTURE:32768},MOVER={POS1:0,POS2:1,ONETOTWO:2,TWOTOONE:3},CON={DISCONNECTED:0,CONNECTING:1,CONNECTED:2},TEAM_STATE={BEGIN:0,ACTIVE:1},LevelLocals=function(){this.clients=new Array(MAX_CLIENTS),this.gentities=new Array(MAX_GENTITIES),this.gentitySize=0,this.num_entities=0,this.warmupTime=0,this.maxclients=0,this.framenum=0,this.previousTime=0,this.time=0,this.startTime=0,this.teamScores=new Array(TEAM.NUM_TEAMS),this.lastTeamLocationTime=0,this.newSession=!1,this.restarted=!1,this.numConnectedClients=0,this.numNonSpectatorClients=0,this.numPlayingClients=0,this.sortedClients=new Array(MAX_CLIENTS),this.numVotingClients=0,this.numteamVotingClients=new Array(2),this.spawnVars=null,this.matchRestartTime=0,this.intermissionQueued=0,this.intermissiontime=0,this.readyToExit=!1,this.exitTime=0,this.bodyQueue=new Array(BODY_QUEUE_SIZE),this.bodyQueueIndex=0;for(var e=0;e<MAX_CLIENTS;e++)this.clients[e]=new GameClient;for(var e=0;e<MAX_GENTITIES;e++)this.gentities[e]=new GameEntity},GameStatic=function(){this.warmupDisabled=!1},SVF={NOCLIENT:1,BOT:2,BROADCAST:8,PORTAL:32,USE_CURRENT_ORIGIN:64,SINGLECLIENT:128,NOTSINGLECLIENT:256},GameEntity=function(){this.reset()};GameEntity.prototype.reset=function(){this.s=new sh.EntityState,this.linked=!1,this.svFlags=0,this.singleClient=0,this.bmodel=!1,this.mins=[0,0,0],this.maxs=[0,0,0],this.contents=0,this.absmin=[0,0,0],this.absmax=[0,0,0],this.currentOrigin=[0,0,0],this.currentAngles=[0,0,0],this.client=null,this.ownerNum=ENTITYNUM_NONE,this.parent=null,this.inuse=!1,this.classname="noclass",this.spawnflags=0,this.arena=0,this.freeTime=0,this.eventTime=0,this.freeAfterEvent=!1,this.unlinkAfterEvent=!1,this.neverFree=!1,this.model=null,this.model2=null,this.physicsObject=!1,this.physicsBounce=0,this.clipmask=0,this.moverState=0,this.soundPos1=0,this.sound1to2=0,this.sound2to1=0,this.soundPos2=0,this.soundLoop=0,this.nextTrain=null,this.prevTrain=null,this.pos1=[0,0,0],this.pos2=[0,0,0],this.target=null,this.targetName=null,this.team=null,this.targetShaderName=null,this.targetShaderNewName=null,this.targetEnt=null,this.speed=0,this.wait=0,this.movedir=[0,0,0],this.nextthink=0,this.think=null,this.timestamp=0,this.painDebounceTime=0,this.flyDebounceTime=0,this.health=0,this.takeDamage=!1,this.damage=0,this.splashDamage=0,this.splashRadius=0,this.methodOfDeath=0,this.splashMethodOfDeath=0,this.count=0,this.chain=null,this.enemy=null,this.activator=null,this.teamchain=null,this.teammaster=null,this.watertype=0,this.waterlevel=0,this.noise_index=0,this.wait=0,this.random=0};var GameClient=function(){this.reset()};GameClient.prototype.reset=function(){this.ps=new sh.PlayerState,this.pers=new ClientPersistant,this.sess=new ClientSession,this.readyToExit=!1,this.noclip=!1,this.lastCmdTime=0,this.oldOrigin=[0,0,0],this.damage_armor=0,this.damage_blood=0,this.damage_knockback=0,this.damage_from=[0,0,0],this.damage_fromWorld=!1,this.impressive_count=0,this.accuracy_shots=0,this.accuracy_hits=0,this.lastkilled_client=0,this.lasthurt_mod=0,this.respawnTime=0,this.inactivityTime=0,this.inactivityWarning=0,this.rewardTime=0,this.lastKillTime=0,this.airOutTime=0,this.switchTeamTime=0};var PlayerTeamState=function(){this.state=TEAM_STATE.BEGIN,this.captures=0,this.basedefense=0,this.carrierdefense=0,this.flagrecovery=0,this.fragcarrier=0,this.assists=0,this.lasthurtcarrier=0,this.lastreturnedflag=0,this.flagsince=0,this.lastfraggedcarrier=0},ClientPersistant=function(){this.connected=0,this.cmd=new sh.UserCmd,this.localClient=!1,this.initialSpawn=!1,this.predictItemPickup=!1,this.pmoveFixed=!1,this.netname=null,this.maxHealth=0,this.enterTime=0,this.teamState=new PlayerTeamState,this.voteCount=0,this.teamVoteCount=0,this.teamInfo=!1};ClientPersistant.prototype.clone=function(e){return typeof e=="undefined"&&(e=new ClientPersistant),e.connected=this.connected,e.cmd=this.cmd,e.localClient=this.localClient,e.initialSpawn=this.initialSpawn,e.predictItemPickup=this.predictItemPickup,e.pmoveFixed=this.pmoveFixed,e.netname=this.netname,e.maxHealth=this.maxHealth,e.enterTime=this.enterTime,e.teamState=this.teamState,e.voteCount=this.voteCount,e.teamVoteCount=this.teamVoteCount,e.teamInfo=this.teamInfo,e};var ClientSession=function(){this.arena=0,this.sessionTeam=TEAM.FREE,this.spectatorNum=0,this.spectatorState=SPECTATOR.NOT,this.spectatorClient=0,this.wins=0,this.losses=0,this.teamLeader=!1};ClientSession.prototype.clone=function(e){return typeof e=="undefined"&&(e=new ClientSession),e.arena=this.arena,e.sessionTeam=this.sessionTeam,e.spectatorNum=this.spectatorNum,e.spectatorState=this.spectatorState,e.spectatorClient=this.spectatorClient,e.wins=this.wins,e.losses=this.losses,e.teamLeader=this.teamLeader,e};var level,gms,g_gametype,g_forcearena,g_maxGameClients,g_fraglimit,g_timelimit,g_capturelimit,g_synchronousClients,g_friendlyFire,g_teamAutoJoin,g_teamForceBalance,g_warmup,g_doWarmup,g_speed,g_gravity,g_knockback,g_quadfactor,g_weaponRespawn,g_weaponTeamRespawn,g_forcerespawn,g_inactivity,g_motd,g_blood,playerMins=[-15,-15,-24],playerMaxs=[15,15,32],deathAnim=0,spawnFuncs={},fields={angle:{type:"anglehack",aliases:["s.angles"]},angles:{type:"vector",aliases:["s.angles"]},arena:{type:"int"},classname:{},count:{type:"int"},dmg:{type:"int",aliases:["damage"]},health:{type:"int"},message:{},model:{},model2:{},origin:{type:"vector",aliases:["currentOrigin","s.origin","s.pos.trBase"]},random:{type:"float"},spawnflags:{type:"int"},speed:{type:"float"},target:{},targetname:{aliases:["targetName"]},team:{},wait:{type:"float"}},GametypeNames=[];GametypeNames[GT.FFA]="ffa",GametypeNames[GT.TOURNAMENT]="tournament",GametypeNames[GT.SINGLE_PLAYER]="single",GametypeNames[GT.TEAM]="team",GametypeNames[GT.CTF]="ctf";var VEC_UP=[0,-1,0],MOVEDIR_UP=[0,0,1],VEC_DOWN=[0,-2,0],MOVEDIR_DOWN=[0,0,-1],RESPAWN={ARMOR:25,HEALTH:35,AMMO:40,HOLDABLE:60,MEGAHEALTH:35,POWERUP:120},MISSILE_PRESTEP_TIME=50,CTF_CAPTURE_BONUS=5,CTF_TEAM_BONUS=0,CTF_RECOVERY_BONUS=1,CTF_FLAG_BONUS=0,CTF_FRAG_CARRIER_BONUS=2,CTF_FLAG_RETURN_TIME=4e4,CTF_CARRIER_DANGER_PROTECT_BONUS=2,CTF_CARRIER_PROTECT_BONUS=1,CTF_FLAG_DEFENSE_BONUS=1,CTF_RETURN_FLAG_ASSIST_BONUS=1,CTF_FRAG_CARRIER_ASSIST_BONUS=2,CTF_TARGET_PROTECT_RADIUS=1e3,CTF_ATTACKER_PROTECT_RADIUS=1e3,CTF_CARRIER_DANGER_PROTECT_TIMEOUT=8e3,CTF_FRAG_CARRIER_ASSIST_TIMEOUT=1e4,CTF_RETURN_FLAG_ASSIST_TIMEOUT=1e4,CTF_GRAPPLE_SPEED=750,CTF_GRAPPLE_PULL_SPEED=750,OVERLOAD_ATTACK_BASE_SOUND_TIME=2e4,teamgame_t=function(){this.reset()};teamgame_t.prototype.reset=function(){this.last_flag_capture=0,this.last_capture_team=0,this.redStatus=0,this.blueStatus=0,this.flagStatus=0,this.redTakenTime=0,this.blueTakenTime=0,this.redObeliskAttackedTime=0,this.blueObeliskAttackedTime=0};var teamgame=new teamgame_t,ctfFlagStatusRemap=[0,1,"*","*",2],oneFlagStatusRemap=[0,1,2,3,4],MACHINEGUN_SPREAD=200,MACHINEGUN_DAMAGE=7,MACHINEGUN_TEAM_DAMAGE=5,forward=[0,0,0],right=[0,0,0],up=[0,0,0],muzzle=[0,0,0],DEFAULT_SHOTGUN_DAMAGE=10,MAX_RAIL_HITS=4;spawnFuncs.func_door=function(e){e.blocked=DoorBlocked,e.speed||(e.speed=400),e.wait||(e.wait=2),e.wait*=1e3;var t=SpawnFloat("lip",8);e.damage=SpawnInt("dmg",2),vec3.set(e.s.origin,e.pos1),sv.SetBrushModel(e,e.model),SetMovedir(e.s.angles,e.movedir);var n=[Math.abs(e.movedir[0]),Math.abs(e.movedir[1]),Math.abs(e.movedir[2])],r=vec3.subtract(e.maxs,e.mins,[0,0,0]),i=vec3.dot(n,r)-t;vec3.add(e.pos1,vec3.scale(e.movedir,i,[0,0,0]),e.pos2);if(e.spawnflags&1){var s=vec3.set(e.pos2,[0,0,0]);vec3.set(e.s.origin,e.pos2),vec3.set(s,e.pos1)}InitMover(e),e.nextthink=level.time+FRAMETIME;if(!(e.flags&GFL.TEAMSLAVE)){var o=SpawnInt("health",0);o&&(e.takeDamage=!0),e.targetName||o?e.think=DoorMatchTeam:e.think=DoorSpawnNewTrigger}},spawnFuncs.func_static=function(e){sv.SetBrushModel(e,e.model),InitMover(e),vec3.set(e.s.origin,e.s.pos.trBase),vec3.set(e.s.origin,e.currentOrigin)};var TRAIN_START_ON=1,TRAIN_TOGGLE=2,TRAIN_BLOCK_STOPS=4;return spawnFuncs.func_train=function(e){console.log("SPAWANING func_train"),e.s.angles[0]=e.s.angles[1]=e.s.angles[2]=0,e.spawnflags&TRAIN_BLOCK_STOPS?e.damage=0:e.damage||(e.damage=2),e.speed||(e.speed=100);if(!e.target){log("func_train without a target at",e.absmin),FreeEntity(e);return}sv.SetBrushModel(e,e.model),InitMover(e),e.reached=TrainReached,e.nextthink=level.time+FRAMETIME,e.think=TrainSetupTargets},spawnFuncs.info_notnull=function(e){SetOrigin(e,e.s.origin)},spawnFuncs.info_player_deathmatch=function(e){},spawnFuncs.info_player_intermission=function(e){},spawnFuncs.misc_portal_camera=function(e){e.mins[0]=e.mins[1]=e.mins[2]=0,e.maxs[0]=e.maxs[1]=e.maxs[2]=0,sv.LinkEntity(e);var t=SpawnFloat("roll",0);e.s.clientNum=t/360*256},spawnFuncs.misc_portal_surface=function(e){e.mins[0]=e.mins[1]=e.mins[2]=0,e.maxs[0]=e.maxs[1]=e.maxs[2]=0,sv.LinkEntity(e),e.svFlags=SVF.PORTAL,e.s.eType=ET.PORTAL,e.target?(e.think=PortalLocateCamera,e.nextthink=level.time+100):vec3.set(e.s.origin,e.s.origin2)},spawnFuncs.misc_teleporter_dest=function(e){SetOrigin(e,e.s.origin)},spawnFuncs.path_corner=function(e){if(!e.targetname){log("path_corner with no targetname at",e.s.origin),FreeEntity(e);return}},spawnFuncs.target_position=function(e){SetOrigin(e,e.s.origin)},spawnFuncs.target_push=function(e){e.speed||(e.speed=1e3),SetMovedir(e.s.angles,e.s.origin2),vec3.scale(e.s.origin2,e.speed),e.target&&(vec3.set(e.s.origin,e.absmin),vec3.set(e.s.origin,e.absmax),e.think=AimAtTarget,e.nextthink=level.time+FRAMETIME),e.use=PushUse},spawnFuncs.target_teleporter=function(e){e.targetName||log("Untargeted",e.classname,"at",e.s.origin),e.use=TeleporterUse},spawnFuncs.trigger_hurt=function(e){InitTrigger(e),e.touch=HurtTouch,e.use=HurtUse,e.damage||(e.damage=5),e.spawnflags&1?sv.UnlinkEntity(e):sv.LinkEntity(e)},spawnFuncs.trigger_push=function(e){InitTrigger(e),e.svFlags&=~SVF.NOCLIENT,e.s.eType=ET.PUSH_TRIGGER,e.touch=PushTouch,e.think=AimAtTarget,e.nextthink=level.time+FRAMETIME,sv.LinkEntity(e)},spawnFuncs.trigger_teleport=function(e){InitTrigger(e),e.spawnflags&1?e.svFlags|=SVF.NOCLIENT:e.svFlags&=~SVF.NOCLIENT,e.s.eType=ET.TELEPORT_TRIGGER,e.touch=TeleportTouch,sv.LinkEntity(e)},spawnFuncs.worldspawn=function(e){sv.SetConfigstring("levelStartTime",level.startTime);var t=SpawnString("music","");t=t.replace("\\","/").replace(/\.[^\/.]+$/,""),sv.SetConfigstring("music",t);var n=SpawnString("message","");sv.SetConfigstring("message",n),level.gentities[ENTITYNUM_WORLD].s.number=ENTITYNUM_WORLD,level.gentities[ENTITYNUM_WORLD].ownerNum=ENTITYNUM_NONE,level.gentities[ENTITYNUM_WORLD].classname="worldspawn",level.gentities[ENTITYNUM_NONE].s.number=ENTITYNUM_NONE,level.gentities[ENTITYNUM_NONE].ownerNum=ENTITYNUM_NONE,level.gentities[ENTITYNUM_NONE].classname="nothing"},{SVF:SVF,Init:Init,Shutdown:Shutdown,Frame:Frame,ClientConnect:ClientConnect,ClientUserinfoChanged:ClientUserinfoChanged,ClientBegin:ClientBegin,ClientThink:ClientThink,ClientDisconnect:ClientDisconnect,ClientCommand:ClientCommand,GetClientPlayerstate:GetClientPlayerstate}}return{CreateInstance:function(e){return new Game(e)}}}),define("clipmap/cm",["underscore","glmatrix","ByteBuffer","common/sh","common/qmath"],function(e,t,n,r,i){function s(e){function W(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"CM:"),Function.apply.call(console.log,console,e)}function V(e,i){W("Initializing"),W("Loading map for "+e),X=new p,t.ReadFile("maps/"+e+".bsp","binary",function(e,t){if(e)throw e;var s=new n(t,n.LITTLE_ENDIAN),o=new r.dheader_t;o.ident=s.readASCIIString(4),o.version=s.readInt();for(var u=0;u<r.Lumps.NUM_LUMPS;u++)o.lumps[u].fileofs=s.readInt(),o.lumps[u].filelen=s.readInt();if(o.ident!=="IBSP"&&o.version!==46)return;$(t,o.lumps[r.Lumps.SHADERS]),J(t,o.lumps[r.Lumps.LEAFS]),K(t,o.lumps[r.Lumps.LEAFBRUSHES]),Q(t,o.lumps[r.Lumps.LEAFSURFACES]),G(t,o.lumps[r.Lumps.PLANES]),Y(t,o.lumps[r.Lumps.BRUSHSIDES]),Z(t,o.lumps[r.Lumps.BRUSHES]),et(t,o.lumps[r.Lumps.MODELS]),tt(t,o.lumps[r.Lumps.NODES]),nt(t,o.lumps[r.Lumps.ENTITIES]),rt(t,o.lumps[r.Lumps.VISIBILITY]),it(t,o.lumps[r.Lumps.SURFACES],o.lumps[r.Lumps.DRAWVERTS]),ht(),fn(),i&&i()})}function $(e,t){var i=new n(e,n.LITTLE_ENDIAN);i.index=t.fileofs;var s=X.shaders=new Array(t.filelen/r.dshader_t.size);for(var u=0;u<s.length;u++){var a=s[u]=new r.dshader_t;a.shaderName=i.readASCIIString(o),a.surfaceFlags=i.readInt(),a.contents=i.readInt()}}function J(e,t){var i=new n(e,n.LITTLE_ENDIAN);i.index=t.fileofs;var s=t.filelen/r.dleaf_t.size,o=X.leafs=new Array(s),u=0;for(var a=0;a<s;a++){var f=o[a]=new m;f.cluster=i.readInt(),f.area=i.readInt(),i.index+=24,f.firstLeafSurface=i.readInt(),f.numLeafSurfaces=i.readInt(),f.firstLeafBrush=i.readInt(),f.numLeafBrushes=i.readInt(),f.area>=u&&(u=f.area+1)}X.areas=new Array(u),X.areaPortals=new Array(u*u);for(var a=0;a<u;a++)X.areas[a]=new b;for(var a=0;a<u*u;a++)X.areaPortals[a]=0}function K(e,t){var r=new n(e,n.LITTLE_ENDIAN);r.index=t.fileofs;var i=t.filelen/4,s=X.leafBrushes=new Array(i);for(var o=0;o<s.length;o++)s[o]=r.readInt()}function Q(e,t){var r=new n(e,n.LITTLE_ENDIAN);r.index=t.fileofs;var i=X.leafSurfaces=new Array(t.filelen/4);for(var s=0;s<i.length;s++)i[s]=r.readInt()}function G(e,t){var s=new n(e,n.LITTLE_ENDIAN);s.index=t.fileofs;var o=t.filelen/r.dplane_t.size,u=X.planes=new Array(o);for(var a=0;a<o;a++){var f=u[a]=new i.Plane;f.normal=[s.readFloat(),s.readFloat(),s.readFloat()],f.dist=s.readFloat(),f.signbits=i.GetPlaneSignbits(f.normal),f.type=i.PlaneTypeForNormal(f.normal)}}function Y(e,t){var i=X.planes,s=new n(e,n.LITTLE_ENDIAN);s.index=t.fileofs;var o=t.filelen/r.dbrushside_t.size,u=X.brushSides=new Array(o);for(var a=0;a<o;a++){var f=u[a]=new g,l=s.readInt(),c=s.readInt();f.plane=i[l],f.shaderNum=c,f.surfaceFlags=X.shaders[c].surfaceFlags}}function Z(e,t){var i=X.shaders,s=X.brushSides,o=new n(e,n.LITTLE_ENDIAN);o.index=t.fileofs;var u=t.filelen/r.dbrush_t.size,a=X.brushes=new Array(u);for(var f=0;f<u;f++){var l=a[f]=new y;l.firstSide=o.readInt(),l.numSides=o.readInt(),l.shaderNum=o.readInt(),l.bounds=[[-X.brushSides[l.firstSide+0].plane.dist,-X.brushSides[l.firstSide+2].plane.dist,-X.brushSides[l.firstSide+4].plane.dist],[X.brushSides[l.firstSide+1].plane.dist,X.brushSides[l.firstSide+3].plane.dist,X.brushSides[l.firstSide+5].plane.dist]],l.contents=i[l.shaderNum].contents}}function et(e,t){var i=new n(e,n.LITTLE_ENDIAN);i.index=t.fileofs;var s=X.models=new Array(t.filelen/r.dmodel_t.size);for(var o=0;o<s.length;o++){var u=s[o]=new v;u.mins=[i.readFloat()-1,i.readFloat()-1,i.readFloat()-1],u.maxs=[i.readFloat()+1,i.readFloat()+1,i.readFloat()+1];var a=i.readInt(),f=i.readInt(),l=i.readInt(),c=i.readInt();if(o===0)continue;var h=u.leaf;h.numLeafBrushes=c,h.firstLeafBrush=X.leafBrushes.length;for(var p=0;p<c;p++)X.leafBrushes.push(l+p);h.numLeafSurfaces=f,h.firstLeafSurface=X.leafSurfaces.length;for(var p=0;p<f;p++)X.leafSurfaces.push(a+p)}}function tt(e,t){var i=X.planes,s=new n(e,n.LITTLE_ENDIAN);s.index=t.fileofs;var o=X.nodes=new Array(t.filelen/r.dnode_t.size);for(var u=0;u<o.length;u++){var a=o[u]=new d;a.planeNum=s.readInt(),a.childrenNum=[s.readInt(),s.readInt()],s.index+=24}}function nt(e,t){var r=new n(e,n.LITTLE_ENDIAN);r.index=t.fileofs;var i=r.readASCIIString(t.filelen),s=X.entities=[];i.replace(/\{([^}]*)\}/mg,function(e,t){var n={classname:"unknown"};t.replace(/"(.+)" "(.+)"$/mg,function(e,t,r){n[t]=r}),s.push(n)})}function rt(e,t){var r=new n(e,n.LITTLE_ENDIAN);r.index=t.fileofs,X.numClusters=r.readInt(),X.clusterBytes=r.readInt();var i=X.numClusters*X.clusterBytes;X.vis=new Uint8Array(i);for(var s=0;s<i;s++)X.vis[s]=r.readUnsignedByte()}function it(e,t,i){var o=new n(e,n.LITTLE_ENDIAN),u=t.filelen/r.dsurface_t.size;X.surfaces=new Array(u);var f,l,c,h,p=new r.dsurface_t,d=new Array(L);for(var v=0;v<L;v++)d[v]=[0,0,0];var m=t.fileofs;for(var v=0;v<u;v++){o.index=m,p.shaderNum=o.readInt(),p.fogNum=o.readInt(),p.surfaceType=o.readInt(),p.vertex=o.readInt(),p.vertCount=o.readInt(),p.meshVert=o.readInt(),p.meshVertCount=o.readInt(),p.lightmapNum=o.readInt(),p.lmStart=[o.readInt(),o.readInt()],p.lmSize=[o.readInt(),o.readInt()],p.lmOrigin=[o.readFloat(),o.readFloat(),o.readFloat()],p.lmVecs=[[o.readFloat(),o.readFloat(),o.readFloat()],[o.readFloat(),o.readFloat(),o.readFloat()],[o.readFloat(),o.readFloat(),o.readFloat()]],p.patchWidth=o.readInt(),p.patchHeight=o.readInt();if(p.surfaceType!==r.MapSurfaceType.PATCH)continue;X.surfaces[v]=f=new F,m=o.index,l=p.patchWidth,c=p.patchHeight,h=l*c,h>L&&s.Error(a.DROP,"ParseMesh: MAX_PATCH_VERTS");for(var g=0;g<h;g++)o.index=i.fileofs+(p.vertex+g)*r.drawVert_t.size,d[g][0]=o.readFloat(),d[g][1]=o.readFloat(),d[g][2]=o.readFloat();f.contents=X.shaders[p.shaderNum].contents,f.surfaceFlags=X.shaders[p.shaderNum].surfaceFlags,f.pc=Nt(l,c,d)}}function ht(){ft=new v,ft.leaf.numLeafBrushes=1,ft.leaf.firstLeafBrush=X.leafBrushes.length,X.leafBrushes.push(X.brushes.length),lt=new y,lt.firstSide=X.brushSides.length,lt.numSides=ot,lt.contents=u.BODY,X.brushes.push(lt),ct=new Array(at);for(var e=0;e<at;e++){var t=ct[e]=new i.Plane;X.planes.push(t)}for(var e=0;e<6;e++){var n=e&1,s=new r.dbrushside_t;s.plane=ct[e*2+n],s.surfaceFlags=0;var o=ct[e*2];o.type=e>>1,o.normal[0]=o.normal[1]=o.normal[2]=0,o.normal[e>>1]=1,o.signbits=0,o=ct[e*2+1],o.type=3+(e>>1),o.normal[0]=o.normal[1]=o.normal[2]=0,o.normal[e>>1]=-1,o.signbits=i.GetPlaneSignbits(o.normal),X.brushSides.push(s)}}function pt(e){return(e<0||e>=X.models.length)&&s.Error(a.DROP,"GetInlineModel: bad number"),e}function dt(e,t,n){return vec3.set(e,ft.mins),vec3.set(t,ft.maxs),n?c:(ct[0].dist=t[0],ct[1].dist=-t[0],ct[2].dist=e[0],ct[3].dist=-e[0],ct[4].dist=t[1],ct[5].dist=-t[1],ct[6].dist=e[1],ct[7].dist=-e[1],ct[8].dist=t[2],ct[9].dist=-t[2],ct[10].dist=e[2],ct[11].dist=-e[2],vec3.set(e,lt.bounds[0]),vec3.set(t,lt.bounds[1]),l)}function vt(e,t,n){var r=mt(e);vec3.set(r.mins,t),vec3.set(r.maxs,n)}function mt(e){e<0&&s.Error(a.DROP,"ClipHandleToModel: bad handle "+e);if(e<X.models.length)return X.models[e];if(e===l)return ft;s.Error(a.DROP,"ClipHandleToModel: bad handle "+X.models.length+" < "+e)}function gt(e){return(e<0||e>=X.leafs.length)&&s.Error(a.DROP,"LeafCluster: bad number"),X.leafs[e].cluster}function yt(e){return(e<0||e>=X.leafs.length)&&s.Error(a.DROP,"LeafArea: bad number"),X.leafs[e].area}function Tt(e,t,n,r){var i=[0,0,0],s=[0,0,0];return vec3.subtract(n,t,i),vec3.subtract(r,t,s),vec3.cross(s,i,e),vec3.normalize(e),vec3.length(e)===0?!1:(e[3]=vec3.dot(t,e),!0)}function Nt(e,t,n){(e<=2||t<=2||!n)&&s.Error(a.DROP,"GeneratePatchFacets: bad parameters"),(!(e&1)||!(t&1))&&s.Error(a.DROP,"GeneratePatchFacets: even sizes are invalid for quadratic meshes"),(e>O||t>O)&&s.Error(a.DROP,"GeneratePatchFacets: source is > MAX_GRID_SIZE");var r=new j;r.width=e,r.height=t,r.wrapWidth=!1,r.wrapHeight=!1;for(var o=0;o<e;o++)for(var u=0;u<t;u++)vec3.set(n[u*e+o],r.points[o][u]);Ct(r),kt(r),Ot(r),Dt(r),Ct(r),kt(r),Ot(r);var f=new B;i.ClearBounds(f.bounds[0],f.bounds[1]);for(var o=0;o<r.width;o++)for(var u=0;u<r.height;u++)i.AddPointToBounds(r.points[o][u],f.bounds[0],f.bounds[1]);return Bt(r,f),f.bounds[0][0]-=1,f.bounds[0][1]-=1,f.bounds[0][2]-=1,f.bounds[1][0]+=1,f.bounds[1][1]+=1,f.bounds[1][2]+=1,xt.push(f),f}function Ct(e){var t,n;for(t=0;t<e.height;t++){for(n=0;n<3;n++){var r=e.points[0][t][n]-e.points[e.width-1][t][n];if(r<-D||r>D)break}if(n!=3)break}t===e.height?e.wrapWidth=!0:e.wrapWidth=!1}function kt(e){var t,n,r,i=[0,0,0],s=[0,0,0],o=[0,0,0];for(t=0;t<e.width-2;){for(n=0;n<e.height;n++)if(Lt(e.points[t][n],e.points[t+1][n],e.points[t+2][n]))break;if(n===e.height){for(n=0;n<e.height;n++)for(r=t+2;r<e.width;r++)vec3.set(e.points[r][n],e.points[r-1][n]);e.width--,t++;continue}for(n=0;n<e.height;n++){vec3.set(e.points[t][n],i),vec3.set(e.points[t+1][n],s),vec3.set(e.points[t+2][n],o);for(r=e.width-1;r>t+1;r--)vec3.set(e.points[r][n],e.points[r+2][n]);At(i,s,o,e.points[t+1][n],e.points[t+2][n],e.points[t+3][n])}e.width+=2}}function Lt(e,t,n){var r=[0,0,0],i=[0,0,0],s=[0,0,0];for(var o=0;o<3;o++)i[o]=.5*(e[o]+n[o]);for(var o=0;o<3;o++)r[o]=.5*(.5*(e[o]+t[o])+.5*(t[o]+n[o]));vec3.subtract(r,i,s);var u=vec3.length(s);return u>=M}function At(e,t,n,r,i,s){for(var o=0;o<3;o++)r[o]=.5*(e[o]+t[o]),s[o]=.5*(t[o]+n[o]),i[o]=.5*(r[o]+s[o])}function Ot(e){var t,n,r;for(t=0;t<e.width-1;t++){for(n=0;n<e.height;n++)if(!_t(e.points[t][n],e.points[t+1][n]))break;if(n!==e.height)continue;for(n=0;n<e.height;n++)for(r=t+2;r<e.width;r++)vec3.set(e.points[r][n],e.points[r-1][n]);e.width--,t--}}function _t(e,t){var n=e[0]-t[0];return n<-Mt||n>Mt?!1:(n=e[1]-t[1],n<-Mt||n>Mt?!1:(n=e[2]-t[2],n<-Mt||n>Mt?!1:!0))}function Dt(e){var t,n,r,i=[0,0,0],s=!1;if(e.width>e.height)for(t=0;t<e.height;t++)for(n=t+1;n<e.width;n++)n<e.height?(vec3.set(e.points[t][n],i),vec3.set(e.points[n][t],e.points[t][n]),vec3.set(i,e.points[n][t])):vec3.set(e.points[n][t],e.points[t][n]);else for(t=0;t<e.width;t++)for(n=t+1;n<e.height;n++)n<e.width?(vec3.set(e.points[n][t],i),vec3.set(e.points[t][n],e.points[n][t]),vec3.set(i,e.points[t][n])):vec3.set(e.points[t][n],e.points[n][t]);r=e.width,e.width=e.height,e.height=r,s=e.wrapWidth,e.wrapWidth=e.wrapHeight,e.wrapHeight=s}function Bt(e,t){var n,r,i,o,u,f=[0,0,0,0],l=[0,0,0,0],c=new Array(O);for(n=0;n<O;n++){c[n]=new Array(O);for(r=0;r<O;r++)c[n][r]=new Array(2)}for(n=0;n<e.width-1;n++)for(r=0;r<e.height-1;r++)i=e.points[n][r],o=e.points[n+1][r],u=e.points[n+1][r+1],c[n][r][0]=jt(t,i,o,u),i=e.points[n+1][r+1],o=e.points[n][r+1],u=e.points[n][r],c[n][r][1]=jt(t,i,o,u);for(n=0;n<e.width-1;n++)for(r=0;r<e.height-1;r++){f[bt]=-1,r>0?f[bt]=c[n][r-1][1]:e.wrapHeight&&(f[bt]=c[n][e.height-2][1]),l[bt]=f[bt]==c[n][r][0];if(f[bt]==-1||l[bt])f[bt]=Ft(t,e,c,n,r,0);f[Et]=-1,r<e.height-2?f[Et]=c[n][r+1][0]:e.wrapHeight&&(f[Et]=c[n][0][0]),l[Et]=f[Et]==c[n][r][1];if(f[Et]==-1||l[Et])f[Et]=Ft(t,e,c,n,r,2);f[St]=-1,n>0?f[St]=c[n-1][r][0]:e.wrapWidth&&(f[St]=c[e.width-2][r][0]),l[St]=f[St]==c[n][r][1];if(f[St]==-1||l[St])f[St]=Ft(t,e,c,n,r,3);f[wt]=-1,n<e.width-2?f[wt]=c[n+1][r][1]:e.wrapWidth&&(f[wt]=c[0][r][1]),l[wt]=f[wt]==c[n][r][0];if(f[wt]==-1||l[wt])f[wt]=Ft(t,e,c,n,r,1);t.facets.length>=k&&s.Error(a.DROP,"MAX_FACETS");var h=new H;if(c[n][r][0]===c[n][r][1]){if(c[n][r][0]===-1)continue;h.surfacePlane=c[n][r][0],h.numBorders=4,h.borderPlanes[0]=f[bt],h.borderNoAdjust[0]=l[bt],h.borderPlanes[1]=f[wt],h.borderNoAdjust[1]=l[wt],h.borderPlanes[2]=f[Et],h.borderNoAdjust[2]=l[Et],h.borderPlanes[3]=f[St],h.borderNoAdjust[3]=l[St],qt(t,h,e,c,n,r,-1),Ut(t,h)&&(zt(t,h),t.facets.push(h))}else h.surfacePlane=c[n][r][0],h.numBorders=3,h.borderPlanes[0]=f[bt],h.borderNoAdjust[0]=l[bt],h.borderPlanes[1]=f[wt],h.borderNoAdjust[1]=l[wt],h.borderPlanes[2]=c[n][r][1],h.borderPlanes[2]===-1&&(h.borderPlanes[2]=f[Et],h.borderPlanes[2]===-1&&(h.borderPlanes[2]=Ft(t,e,c,n,r,4))),qt(t,h,e,c,n,r,0),Ut(t,h)&&(zt(t,h),t.facets.push(h)),t.facets.length>=k&&s.Error(a.DROP,"MAX_FACETS"),h=h=new H,h.surfacePlane=c[n][r][1],h.numBorders=3,h.borderPlanes[0]=f[Et],h.borderNoAdjust[0]=l[Et],h.borderPlanes[1]=f[St],h.borderNoAdjust[1]=l[St],h.borderPlanes[2]=c[n][r][0],h.borderPlanes[2]===-1&&(h.borderPlanes[2]=f[bt],h.borderPlanes[2]===-1&&(h.borderPlanes[2]=Ft(t,e,c,n,r,5))),qt(t,h,e,c,n,r,1),Ut(t,h)&&(zt(t,h),t.facets.push(h))}}function jt(e,t,n,r){var o=[0,0,0,0];if(!Tt(o,t,n,r))return-1;var u;for(var f=0;f<e.planes.length;f++){var l=e.planes[f];if(vec3.dot(o,l.plane)<0)continue;u=vec3.dot(t,l.plane)-l.plane[3];if(u<-_||u>_)continue;u=vec3.dot(n,l.plane)-l.plane[3];if(u<-_||u>_)continue;u=vec3.dot(r,l.plane)-l.plane[3];if(u<-_||u>_)continue;return f}e.planes.length>=A&&s.Error(a.DROP,"MAX_PATCH_PLANES");var c=e.planes.length,l=new P;return vec4.set(o,l.plane),l.signbits=i.GetPlaneSignbits(o),e.planes.push(l),c}function Ft(e,t,n,r,i,o){var u,f,l,c,h=[0,0,0];switch(o){case 0:return u=t.points[r][i],f=t.points[r+1][i],l=It(n,r,i,0),c=e.planes[l],vec3.add(u,vec3.scale(c.plane,4,[0,0,0]),h),jt(e,u,f,h);case 2:return u=t.points[r][i+1],f=t.points[r+1][i+1],l=It(n,r,i,1),c=e.planes[l],vec3.add(u,vec3.scale(c.plane,4,[0,0,0]),h),jt(e,f,u,h);case 3:return u=t.points[r][i],f=t.points[r][i+1],l=It(n,r,i,1),c=e.planes[l],vec3.add(u,vec3.scale(c.plane,4,[0,0,0]),h),jt(e,f,u,h);case 1:return u=t.points[r+1][i],f=t.points[r+1][i+1],l=It(n,r,i,0),c=e.planes[l],vec3.add(u,vec3.scale(c.plane,4,[0,0,0]),h),jt(e,u,f,h);case 4:return u=t.points[r+1][i+1],f=t.points[r][i],l=It(n,r,i,0),c=e.planes[l],vec3.add(u,vec3.scale(c.plane,4,[0,0,0]),h),jt(e,u,f,h);case 5:return u=t.points[r][i],f=t.points[r+1][i+1],l=It(n,r,i,1),c=e.planes[l],vec3.add(u,vec3.scale(c.plane,4,[0,0,0]),h),jt(e,u,f,h)}return s.Error(a.DROP,"EdgePlaneNum: bad k"),-1}function It(e,t,n,r){var i=e[t][n][r];return i!==-1?i:(i=e[t][n][r^1],i!==-1?i:(W("WARNING: GridPlane unresolvable"),-1))}function qt(e,t,n,r,i,o,u){var f=[null,null,null,null],l;switch(u){case-1:f[0]=n.points[i][o],f[1]=n.points[i+1][o],f[2]=n.points[i+1][o+1],f[3]=n.points[i][o+1],l=4;break;case 0:f[0]=n.points[i][o],f[1]=n.points[i+1][o],f[2]=n.points[i+1][o+1],l=3;break;case 1:f[0]=n.points[i+1][o+1],f[1]=n.points[i][o+1],f[2]=n.points[i][o],l=3;break;default:s.Error(a.FATAL,"SetBorderInward: bad parameter"),l=0}for(var c=0;c<t.numBorders;c++){var h=0,p=0;for(var d=0;d<l;d++){var v=Rt(e,f[d],t.borderPlanes[c]);v===S?h++:v===x&&p++}h&&!p?t.borderInward[c]=!0:p&&!h?t.borderInward[c]=!1:!h&&!p?t.borderPlanes[c]=-1:(W("WARNING: SetBorderInward: mixed plane sides"),t.borderInward[c]=!1)}}function Rt(e,t,n){if(n===-1)return T;var r=e.planes[n],i=vec3.dot(t,r.plane)-r.plane[3];return i>_?S:i<-_?x:T}function Ut(e,t){var n,r=[0,0,0,0],i=[[0,0,0],[0,0,0]];if(t.surfacePlane===-1)return!1;vec4.set(e.planes[t.surfacePlane].plane,r);var s=Yt(r,r[3]);for(n=0;n<t.numBorders;n++){if(t.borderPlanes[n]===-1)return!1;vec4.set(e.planes[t.borderPlanes[n]].plane,r),t.borderInward[n]||(vec3.subtract([0,0,0],r,r),r[3]=-r[3]);if(!en(s,r,r[3],.1))return!1}Zt(s,i[0],i[1]);for(n=0;n<3;n++){if(i[1][n]-i[0][n]>C)return!1;if(i[0][n]>=C)return!1;if(i[1][n]<=-C)return!1}return!0}function zt(e,t){var n,r,i,s,o,u,a,f=[!1],l=[0,0,0,0],c=[0,0,0,0],h=[0,0,0],p=[0,0,0],d=[0,0,0],v=[0,0,0];vec4.set(e.planes[t.surfacePlane].plane,l);var m=Yt(l,l[3]);for(r=0;r<t.numBorders;r++){if(t.borderPlanes[r]===t.surfacePlane)continue;vec4.set(e.planes[t.borderPlanes[r]].plane,l),t.borderInward[r]||(vec3.subtract([0,0,0],l,l),l[3]=-l[3]);if(!en(m,l,l[3],.1))return}Zt(m,h,p),a=0;for(o=0;o<3;o++)for(u=-1;u<=1;u+=2,a++){l[0]=l[1]=l[2]=0,l[o]=u,u==1?l[3]=p[o]:l[3]=-h[o];if(Wt(e.planes[t.surfacePlane],l,f))continue;for(n=0;n<t.numBorders;n++)if(Wt(e.planes[t.borderPlanes[n]],l,f))break;n===t.numBorders&&(t.numBorders>26&&W("ERROR: too many bevels"),t.borderPlanes[t.numBorders]=Vt(e,l,f),t.borderNoAdjust[t.numBorders]=0,t.borderInward[t.numBorders]=f[0],t.numBorders++)}for(r=0;r<m.p.length;r++){i=(r+1)%m.p.length,vec3.subtract(m.p[r],m.p[i],d),vec3.normalize(d);if(vec3.length(d)<.5)continue;Xt(d);for(i=0;i<3;i++)if(d[i]==-1||d[i]==1)break;if(i<3)continue;for(o=0;o<3;o++)for(u=-1;u<=1;u+=2){v[0]=v[1]=v[2]=0,v[o]=u,vec3.cross(d,v,l),vec3.normalize(l);if(vec3.length(l)<.5)continue;l[3]=vec3.dot(m.p[r],l);for(s=0;s<m.p.length;s++){var g=vec3.dot(m.p[s],l)-l[3];if(g>.1)break}if(s<m.p.length)continue;if(Wt(e.planes[t.surfacePlane],l,f))continue;for(n=0;n<t.numBorders;n++)if(Wt(e.planes[t.borderPlanes[n]],l,f))break;if(n===t.numBorders){t.numBorders>26&&W("ERROR: too many bevels"),t.borderPlanes[t.numBorders]=Vt(e,l,f);for(i=0;i<t.numBorders;i++)t.borderPlanes[t.numBorders]==t.borderPlanes[i]&&W("WARNING: bevel plane already used");t.borderNoAdjust[t.numBorders]=0,t.borderInward[t.numBorders]=f[0];var y=m.clone();vec4.set(e.planes[t.borderPlanes[t.numBorders]].plane,c),t.borderInward[t.numBorders]||(vec3.negate(c),c[3]=-c[3]);if(!en(y,c,c[3],.1)){W("WARNING: AddFacetBevels... invalid bevel");continue}t.numBorders++}}}t.borderPlanes[t.numBorders]=t.surfacePlane,t.borderNoAdjust[t.numBorders]=0,t.borderInward[t.numBorders]=!0,t.numBorders++}function Wt(e,t,n){if(Math.abs(e.plane[0]-t[0])<Pt&&Math.abs(e.plane[1]-t[1])<Pt&&Math.abs(e.plane[2]-t[2])<Pt&&Math.abs(e.plane[3]-t[3])<Ht)return n[0]=!1,!0;var r=[0,0,0,0];return vec3.negate(t,r),r[3]=-t[3],Math.abs(e.plane[0]-r[0])<Pt&&Math.abs(e.plane[1]-r[1])<Pt&&Math.abs(e.plane[2]-r[2])<Pt&&Math.abs(e.plane[3]-r[3])<Ht?(n[0]=!0,!0):!1}function Xt(e){for(var t=0;t<3;t++){if(Math.abs(e[t]-1)<Pt){e[0]=e[1]=e[2]=0,e[t]=1;break}if(Math.abs(e[t]+1)<Pt){e[0]=e[1]=e[2]=0,e[t]=-1;break}}}function Vt(e,t,n){for(var r=0;r<e.planes.length;r++)if(Wt(e.planes[r],t,n))return r;e.planes.length===A&&s.Error(a.DROP,"MAX_PATCH_PLANES");var o=e.planes.length,u=new P;return vec4.set(t,u.plane),u.signbits=i.GetPlaneSignbits(t),e.planes.push(u),n[0]=!1,o}function $t(e,t){var n,r,s,o,u,a,f=new Kt,l=[0,0,0,0],c=[0,0,0,0],p=[0,0,0],d=[0,0,0];if(!i.BoundsIntersect(e.bounds[0],e.bounds[1],t.bounds[0],t.bounds[1],h))return;if(e.isPoint){Jt(e,t);return}for(var n=0;n<t.facets.length;n++){var v=t.facets[n];f.enterFrac=-1,f.leaveFrac=1,f.hit=!1,s=-1,a=t.planes[v.surfacePlane],vec3.set(a.plane,l),l[3]=a.plane[3],e.sphere.use?(l[3]+=e.sphere.radius,u=vec3.dot(l,e.sphere.offset),u>0?(vec3.subtract(e.start,e.sphere.offset,p),vec3.subtract(e.end,e.sphere.offset,d)):(vec3.add(e.start,e.sphere.offset,p),vec3.add(e.end,e.sphere.offset,d))):(o=vec3.dot(e.offsets[a.signbits],l),l[3]-=o,vec3.set(e.start,p),vec3.set(e.end,d));if(!Qt(l,p,d,f))continue;f.hit&&vec4.set(l,c);for(r=0;r<v.numBorders;r++){a=t.planes[v.borderPlanes[r]],v.borderInward[r]?(vec3.negate(a.plane,l),l[3]=-a.plane[3]):(vec3.set(a.plane,l),l[3]=a.plane[3]),e.sphere.use?(l[3]+=e.sphere.radius,u=vec3.dot(l,e.sphere.offset),u>0?(vec3.subtract(e.start,e.sphere.offset,p),vec3.subtract(e.end,e.sphere.offset,d)):(vec3.add(e.start,e.sphere.offset,p),vec3.add(e.end,e.sphere.offset,d))):(o=vec3.dot(e.offsets[a.signbits],l),l[3]+=Math.abs(o),vec3.set(e.start,p),vec3.set(e.end,d));if(!Qt(l,p,d,f))break;f.hit&&(s=r,vec4.set(l,c))}if(r<v.numBorders)continue;if(s===v.numBorders-1)continue;f.enterFrac<f.leaveFrac&&f.enterFrac>=0&&f.enterFrac<e.trace.fraction&&(f.enterFrac<0&&(f.enterFrac=0),e.trace.fraction=f.enterFrac,vec3.set(c,e.trace.plane.normal),e.trace.plane.dist=c[3])}}function Jt(e,t){var n,r,i,s=new Array(A),o=new Array(A),u,a,f,l;if(!e.isPoint)return;for(n=0;n<t.planes.length;n++){var c=t.planes[n];a=vec3.dot(e.offsets[c.signbits],c.plane),f=vec3.dot(e.start,c.plane)-c.plane[3]+a,l=vec3.dot(e.end,c.plane)-c.plane[3]+a,f<=0?s[n]=!1:s[n]=!0,f===l?o[n]=99999:(o[n]=f/(f-l),o[n]<=0&&(o[n]=99999))}for(n=0;n<t.facets.length;n++){var p=t.facets[n];if(!s[p.surfacePlane])continue;u=o[p.surfacePlane];if(u<0)continue;if(u>e.trace.fraction)continue;for(r=0;r<p.numBorders;r++){i=p.borderPlanes[r];if(s[i]^p.borderInward[r]){if(o[i]>u)break}else if(o[i]<u)break}if(r===p.numBorders){var c=t.planes[p.surfacePlane];a=vec3.dot(e.offsets[c.signbits],c.plane),f=vec3.dot(e.start,c.plane)-c.plane[3]+a,l=vec3.dot(e.end,c.plane)-c.plane[3]+a,e.trace.fraction=(f-h)/(f-l),e.trace.fraction<0&&(e.trace.fraction=0),vec3.set(c.plane,e.trace.plane.normal),e.trace.plane.dist=c.plane[3]}}}function Qt(e,t,n,r){var i,s=vec3.dot(t,e)-e[3],o=vec3.dot(n,e)-e[3];return r.hit=!1,s>0&&(o>=h||o>=s)?!1:s<=0&&o<=0?!0:(s>o?(i=(s-h)/(s-o),i<0&&(i=0),i>r.enterFrac&&(r.enterFrac=i,r.hit=!0)):(i=(s+h)/(s-o),i>1&&(i=1),i<r.leaveFrac&&(r.leaveFrac=i)),!0)}function Gt(e){var t=[0,0,0,0],n=[-15,-15,-28],r=[15,15,28],i=[0,0,0],s=[0,0,0],o=2;for(var u=0;u<xt.length;u++){var a=xt[u];for(var f=0;f<a.facets.length;f++){var l=a.facets[f];for(var c=0;c<l.numBorders+1;c++){var h,p;c<l.numBorders?(h=l.borderPlanes[c],p=l.borderInward[c]):(h=l.surfacePlane,p=!1),vec4.set(a.planes[h].plane,t),p&&(vec3.subtract([0,0,0],t,t),t[3]=-t[3]),t[3]+=o;for(y=0;y<3;y++)t[y]>0?i[y]=r[y]:i[y]=n[y];vec3.negate(t,s),t[3]+=Math.abs(vec3.dot(i,s));var d=Yt(t,t[3]);for(var v=0;v<l.numBorders+1;v++){var m,g;v<l.numBorders?(m=l.borderPlanes[v],g=l.borderInward[v]):(m=l.surfacePlane,g=!1);if(m===h)continue;vec4.set(a.planes[m].plane,t),g||(vec3.subtract([0,0,0],t,t),t[3]=-t[3]),t[3]-=o;for(var y=0;y<3;y++)t[y]>0?i[y]=r[y]:i[y]=n[y];vec3.negate(t,s),t[3]-=Math.abs(vec3.dot(i,s));if(!en(d,t,t[3],.1))break}v===l.numBorders+1&&e(d.p)}}}}function Yt(e,t){var n=-C,r,i=-1;for(var o=0;o<3;o++)r=Math.abs(e[o]),r>n&&(i=o,n=r);i===-1&&s.Error(a.DROP,"BaseWindingForPlane: no axis found");var u=[0,0,0],f=[0,0,0],l=[0,0,0];switch(i){case 0:case 1:u[2]=1;break;case 2:u[0]=1}var r=vec3.dot(u,e);vec3.add(u,vec3.scale(e,-r,[0,0,0])),vec3.normalize(u),vec3.scale(e,t,f),vec3.cross(u,e,l),vec3.scale(u,C),vec3.scale(l,C);var c=new w;return c.p[0]=vec3.subtract(f,l,[0,0,0]),vec3.add(c.p[0],u,c.p[0]),c.p[1]=vec3.add(f,l,[0,0,0]),vec3.add(c.p[1],u,c.p[1]),c.p[2]=vec3.add(f,l,[0,0,0]),vec3.subtract(c.p[2],u,c.p[2]),c.p[3]=vec3.subtract(f,l,[0,0,0]),vec3.subtract(c.p[3],u,c.p[3]),c}function Zt(e,t,n){var r;t[0]=t[1]=t[2]=C,n[0]=n[1]=n[2]=-C;for(var i=0;i<e.p.length;i++)for(var s=0;s<3;s++)r=e.p[i][s],r<t[s]&&(t[s]=r),r>n[s]&&(n[s]=r)}function en(e,t,n,r){var i,o,u,f,l,c=new Array(E+4),h=new Array(E+4),p=[0,0,0],d=[0,0,0],v=e.clone();for(i=0;i<v.p.length;i++)u=c[i]=vec3.dot(v.p[i],t)-n,u>r?h[i]=S:u<-r?h[i]=x:h[i]=T,p[h[i]]++;h[i]=h[0],c[i]=c[0];if(!p[S])return!1;if(!p[x])return!0;var m=new w,g=v.p.length+4;for(i=0;i<v.p.length;i++){f=v.p[i];if(h[i]===T){m.p.push(vec3.set(f,[0,0,0]));continue}h[i]===S&&m.p.push(vec3.set(f,[0,0,0]));if(h[i+1]===T||h[i+1]===h[i])continue;l=v.p[(i+1)%v.p.length],u=c[i]/(c[i]-c[i+1]);for(var o=0;o<3;o++)t[o]===1?d[o]=n:t[o]===-1?d[o]=-n:d[o]=f[o]+u*(l[o]-f[o]);m.p.push(vec3.set(d,[0,0,0]))}return m.p.length>g&&s.Error(a.DROP,"ClipWinding: points exceeded estimate"),m.p.length>E&&s.Error(a.DROP,"ClipWinding: MAX_POINTS_ON_WINDING"),m.clone(e),!0}function tn(e,t){if(!X.vis||e===t||e==-1)return!0;var n=e*X.clusterBytes;return(X.vis[n+(t>>3)]&1<<(t&7))!==0}function nn(e,t,n,r){for(;;){if(r<0){var s=-1-r;X.leafs[s].cluster!==-1&&(e.lastLeaf=s);if(e.count>=e.maxCount)return;e.list[e.count++]=s;return}var o=X.nodes[r],u=i.BoxOnPlaneSide(t,n,X.planes[o.planeNum]);u===1?r=o.childrenNum[0]:u===2?r=o.childrenNum[1]:(nn(e,t,n,o.childrenNum[0]),r=o.childrenNum[1])}}function rn(e,t,n,r){var i=new R;return i.list=n,i.maxCount=r,X.checkcount++,nn(i,e,t,0),i}function sn(e,t){var n;while(t>=0){var r=X.nodes[t],i=X.planes[r.planeNum];i.type<3?n=e[i.type]-i.dist:n=vec3.dot(i.normal,e)-i.dist,n<0?t=r.childrenNum[1]:t=r.childrenNum[0]}return-1-t}function on(e){return X.nodes.length?sn(e,0):0}function un(e,t){var n,r,i,s,o,u,a,f,l;return a}function an(e,t){var n=X.areas[e];if(n.floodvalid===X.floodvalid){if(n.floodnum===t)return;s.Error(a.DROP,"FloodArea_r: reflooded")}n.floodnum=t,n.floodvalid=X.floodvalid;var r=e*X.areas.length;for(var i=0;i<X.areas.length;i++)X.areaPortals[r+i]>0&&an(i,t)}function fn(){X.floodvalid++;var e=0;for(var t=0;t<X.areas.length;t++){var n=X.areas[t];if(n.floodvalid===X.floodvalid)continue;e++,an(t,e)}}function ln(e,t,n){if(e<0||t<0)return;(e>=X.areas.length||t>=X.areas.length)&&s.Error(a.DROP,"ChangeAreaPortalState: bad area number"),n?(X.areaPortals[e*X.numAreas+t]++,X.areaPortals[t*X.numAreas+e]++):(X.areaPortals[e*X.numAreas+t]--,X.areaPortals[t*X.numAreas+e]--,X.areaPortals[t*X.numAreas+e]<0&&s.Error(a.DROP,"AdjustAreaPortalState: negative reference count")),fn()}function cn(e,t){return e<0||t<0?!1:((e>=X.areas.length||t>=X.areas.length)&&s.Error(a.DROP,"area >= cm.numAreas"),X.areas[e].floodnum===X.areas[t].floodnum?!0:!1)}function hn(e,t){for(var n=0;n<3;n++)for(var r=0;r<3;r++)t[n][r]=e[r][n]}function pn(e,t){if(!t.numSides)return;if(e.bounds[0][0]>t.bounds[1][0]||e.bounds[0][1]>t.bounds[1][1]||e.bounds[0][2]>t.bounds[1][2]||e.bounds[1][0]<t.bounds[0][0]||e.bounds[1][1]<t.bounds[0][1]||e.bounds[1][2]<t.bounds[0][2])return;if(e.sphere.use)for(var n=6;n<t.numSides;n++){var r=X.brushSides[t.firstSide+n],i=r.plane,s=i.dist+e.sphere.radius,o=[0,0,0],u=vec3.dot(i.normal,e.sphere.offset);u>0?vec3.subtract(e.start,e.sphere.offset,o):vec3.add(e.start,e.sphere.offset,o);var a=vec3.dot(o,i.normal)-s;if(a>0)return}else for(var n=6;n<t.numSides;n++){var r=X.brushSides[t.firstSide+n],i=r.plane,s=i.dist-vec3.dot(e.offsets[i.signbits],i.normal),a=vec3.dot(e.start,i.normal)-s;if(a>0)return}e.trace.startSolid=e.trace.allSolid=!0,e.trace.fraction=0,e.trace.contents=t.contents}function dn(e,t){var n=X.brushes,r=X.leafBrushes;for(var i=0;i<t.numLeafBrushes;i++){var s=r[t.firstLeafBrush+i],o=n[s];if(o.checkcount===X.checkcount)continue;o.checkcount=X.checkcount;if(!(o.contents&e.contents))continue;pn(e,o);if(e.trace.allSolid)return}}function mn(e){var t=X.leafs,n=vec3.add(e.start,e.size[0],[0,0,0]),r=vec3.add(e.start,e.size[1],[0,0,0]);vec3.add(n,[-1,-1,-1]),vec3.add(r,[1,1,1]);var i=new R;i.list=vn,i.maxCount=q,X.checkcount++,nn(i,n,r,0),X.checkcount++;for(var s=0;s<i.count;s++){dn(e,t[i.list[s]]);if(e.trace.allSolid)break}}function gn(e,t,n,r,i,s){var o=X.brushes,u=X.leafs,a=X.leafBrushes,f=X.nodes,l=X.planes;if(e.trace.fraction<=n)return;if(t<0){yn(e,u[-(t+1)]);return}var c=f[t],p=l[c.planeNum],d,v,m;p.type<3?(d=i[p.type]-p.dist,v=s[p.type]-p.dist,m=e.extents[p.type]):(d=vec3.dot(p.normal,i)-p.dist,v=vec3.dot(p.normal,s)-p.dist,e.isPoint?m=0:m=2048);if(d>=m+1&&v>=m+1){gn(e,c.childrenNum[0],n,r,i,s);return}if(d<-m-1&&v<-m-1){gn(e,c.childrenNum[1],n,r,i,s);return}var g,y,b,w;d<v?(g=1/(d-v),y=1,w=(d+m+h)*g,b=(d-m+h)*g):d>v?(g=1/(d-v),y=0,w=(d-m-h)*g,b=(d+m+h)*g):(y=0,b=1,w=0);var E=[0,0,0],S;b<0?b=0:b>1&&(b=1),S=n+(r-n)*b,E[0]=i[0]+b*(s[0]-i[0]),E[1]=i[1]+b*(s[1]-i[1]),E[2]=i[2]+b*(s[2]-i[2]),gn(e,c.childrenNum[y],n,S,i,E),w<0&&(w=0),w>1&&(w=1),S=n+(r-n)*w,E[0]=i[0]+w*(s[0]-i[0]),E[1]=i[1]+w*(s[1]-i[1]),E[2]=i[2]+w*(s[2]-i[2]),gn(e,c.childrenNum[y^1],S,r,E,s)}function yn(e,t){var n,r=X.brushes,s=X.leafBrushes;for(n=0;n<t.numLeafBrushes;n++){var o=s[t.firstLeafBrush+n],u=r[o];if(u.checkcount===X.checkcount)continue;u.checkcount=X.checkcount;if(!(u.contents&e.contents))continue;if(!i.BoundsIntersect(e.bounds[0],e.bounds[1],u.bounds[0],u.bounds[1],h))continue;bn(e,u);if(!e.trace.fraction)return}for(n=0;n<t.numLeafSurfaces;n++){var a=X.surfaces[X.leafSurfaces[t.firstLeafSurface+n]];if(!a)continue;if(a.checkcount===X.checkcount)continue;a.checkcount=X.checkcount;if(!(a.contents&e.contents))continue;wn(e,a);if(!e.trace.fraction)return}}function bn(e,t){var n=X.brushSides,r=X.shaders,i=e.trace,s,o,u=!1,a=!1,f=-1,l=1;if(!t.numSides)return;if(e.sphere.use)for(var c=0;c<t.numSides;c++){var p=X.brushSides[t.firstSide+c],d=p.plane,v=d.dist+e.sphere.radius,m=[0,0,0],g=[0,0,0],y=vec3.dot(d.normal,e.sphere.offset);y>0?(vec3.subtract(e.start,e.sphere.offset,m),vec3.subtract(e.end,e.sphere.offset,g)):(vec3.add(e.start,e.sphere.offset,m),vec3.add(e.end,e.sphere.offset,g));var b=vec3.dot(m,d.normal)-v,w=vec3.dot(g,d.normal)-v;w>0&&(u=!0),b>0&&(a=!0);if(b>0&&(w>=h||w>=b))return;if(b<=0&&w<=0)continue;if(b>w){var E=(b-h)/(b-w);E<0&&(E=0),E>f&&(f=E,o=d,s=p)}else{var E=(b+h)/(b-w);E>1&&(E=1),E<l&&(l=E)}}else for(var c=0;c<t.numSides;c++){var p=X.brushSides[t.firstSide+c],d=p.plane,v=d.dist-vec3.dot(e.offsets[d.signbits],d.normal),b=vec3.dot(e.start,d.normal)-v,w=vec3.dot(e.end,d.normal)-v;w>0&&(u=!0),b>0&&(a=!0);if(b>0&&(w>=h||w>=b))return;if(b<=0&&w<=0)continue;if(b>w){var E=(b-h)/(b-w);E<0&&(E=0),E>f&&(f=E,o=d,s=p)}else{var E=(b+h)/(b-w);E>1&&(E=1),E<l&&(l=E)}}if(!a){e.trace.startSolid=!0,u||(e.trace.allSolid=!0,e.trace.fraction=0,e.trace.contents=t.contents,e.trace.shaderName=r[t.shaderNum].shaderName);return}f<l&&f>-1&&f<e.trace.fraction&&(f<0&&(f=0),e.trace.fraction=f,o.clone(e.trace.plane),e.trace.surfaceFlags=s.surfaceFlags,e.trace.contents=t.contents,e.trace.shaderName=r[t.shaderNum].shaderName)}function wn(e,t){var n=e.trace.fraction;$t(e,t.pc),e.trace.fraction<n&&(e.trace.surfaceFlags=t.surfaceFlags,e.trace.contents=t.contents)}function En(e,t,n,r,i,o,u,f,l){var c=new z,h=c.trace;X.checkcount||(X.checkcount=0),X.checkcount++,n||(n=[0,0,0]),r||(r=[0,0,0]),c.contents=u;var p=[0,0,0];for(var d=0;d<3;d++)p[d]=(n[d]+r[d])*.5,c.size[0][d]=n[d]-p[d],c.size[1][d]=r[d]-p[d],c.start[d]=e[d]+p[d],c.end[d]=t[d]+p[d];l?l.clone(c.sphere):(c.sphere.use=f,c.sphere.radius=c.size[1][0]>c.size[1][2]?c.size[1][2]:c.size[1][0],c.sphere.halfheight=c.size[1][2],vec3.set([0,0,c.size[1][2]-c.sphere.radius],c.sphere.offset)),c.maxOffset=c.size[1][0]+c.size[1][1]+c.size[1][2],c.offsets[0][0]=c.size[0][0],c.offsets[0][1]=c.size[0][1],c.offsets[0][2]=c.size[0][2],c.offsets[1][0]=c.size[1][0],c.offsets[1][1]=c.size[0][1],c.offsets[1][2]=c.size[0][2],c.offsets[2][0]=c.size[0][0],c.offsets[2][1]=c.size[1][1],c.offsets[2][2]=c.size[0][2],c.offsets[3][0]=c.size[1][0],c.offsets[3][1]=c.size[1][1],c.offsets[3][2]=c.size[0][2],c.offsets[4][0]=c.size[0][0],c.offsets[4][1]=c.size[0][1],c.offsets[4][2]=c.size[1][2],c.offsets[5][0]=c.size[1][0],c.offsets[5][1]=c.size[0][1],c.offsets[5][2]=c.size[1][2],c.offsets[6][0]=c.size[0][0],c.offsets[6][1]=c.size[1][1],c.offsets[6][2]=c.size[1][2],c.offsets[7][0]=c.size[1][0],c.offsets[7][1]=c.size[1][1],c.offsets[7][2]=c.size[1][2];if(c.sphere.use)for(var d=0;d<3;d++)c.start[d]<c.end[d]?(c.bounds[0][d]=c.start[d]-Math.abs(c.sphere.offset[d])-c.sphere.radius,c.bounds[1][d]=c.end[d]+Math.abs(c.sphere.offset[d])+c.sphere.radius):(c.bounds[0][d]=c.end[d]-Math.abs(c.sphere.offset[d])-c.sphere.radius,c.bounds[1][d]=c.start[d]+Math.abs(c.sphere.offset[d])+c.sphere.radius);else for(var d=0;d<3;d++)c.start[d]<c.end[d]?(c.bounds[0][d]=c.start[d]+c.size[0][d],c.bounds[1][d]=c.end[d]+c.size[1][d]):(c.bounds[0][d]=c.end[d]+c.size[0][d],c.bounds[1][d]=c.start[d]+c.size[1][d]);var v=i?mt(i):null;e[0]==t[0]&&e[1]==t[1]&&e[2]==t[2]?i?dn(c,v.leaf):mn(c):(c.size[0][0]===0&&c.size[0][1]===0&&c.size[0][2]===0?(c.isPoint=!0,c.extents=[0,0,0]):(c.isPoint=!1,c.extents[0]=c.size[1][0],c.extents[1]=c.size[1][1],c.extents[2]=c.size[1][2]),i?yn(c,v.leaf):gn(c,0,0,1,c.start,c.end));for(var d=0;d<3;d++)c.trace.endPos[d]=e[d]+c.trace.fraction*(t[d]-e[d]);return!c.trace.allSolid&&c.trace.fraction!==1&&vec3.squaredLength(c.trace.plane.normal)<=.9999&&s.Error(a.DROP,"Invalid trace result"),h}function Sn(e,t,n,r,i,s,o){return En(e,t,n,r,i,[0,0,0],s,o,null)}function xn(e,t,n,r,s,o,u,a,f){n||(n=[0,0,0]),r||(r=[0,0,0]);var c=[0,0,0],h=[0,0,0],p=[0,0,0],d=[[0,0,0],[0,0,0]],v=[[0,0,0],[0,0,0],[0,0,0]],m=[[0,0,0],[0,0,0],[0,0,0]];for(var g=0;g<3;g++)p[g]=(n[g]+r[g])*.5,d[0][g]=n[g]-p[g],d[1][g]=r[g]-p[g],c[g]=e[g]+p[g],h[g]=t[g]+p[g];vec3.subtract(c,u),vec3.subtract(h,u);var y=!1;s!==l&&(a[0]||a[1]||a[2])&&(y=!0);var b=d[1][0],w=d[1][2],E=new U;E.use=f,E.radius=b>w?w:b,E.halfheight=w;var S=w-E.radius;y?(i.AnglesToAxis(a,v),i.RotatePoint(c,v),i.RotatePoint(h,v),E.offset[0]=v[0][2]*S,E.offset[1]=-v[1][2]*S,E.offset[2]=v[2][2]*S):vec3.set([0,0,S],E.offset);var x=En(c,h,d[0],d[1],s,u,o,f,E);return y&&x.fraction!==1&&(hn(v,m),i.RotatePoint(x.plane.normal,m)),x.endPos[0]=e[0]+x.fraction*(t[0]-e[0]),x.endPos[1]=e[1]+x.fraction*(t[1]-e[1]),x.endPos[2]=e[2]+x.fraction*(t[2]-e[2]),x}var t=e.sys,s=e.com,o=r.MAX_QPATH,u=r.CONTENTS,a=s.ERR,f=256,l=255,c=254,h=.125,p=function(){this.shaders=null,this.brushes=null,this.brushSides=null,this.models=null,this.leafs=null,this.leafBrushes=null,this.leafSurfaces=null,this.nodes=null,this.planes=null,this.shaders=null,this.entities=null,this.surfaces=null,this.visibility=null,this.numClusters=0,this.clusterBytes=0,this.areas=null,this.areaPortals=null,this.floodvalid=0},d=function(){this.planeNum=0,this.childrenNum=[0,0]},v=function(){this.mins=[0,0,0],this.maxs=[0,0,0],this.leaf=new m},m=function(){this.cluster=0,this.area=0,this.firstLeafSurface=0,this.numLeafSurfaces=0,this.firstLeafBrush=0,this.numLeafBrushes=0},g=function(){this.plane=null,this.surfaceFlags=0,this.shaderNum=0},y=function(){this.shaderNum=0,this.contents=0,this.bounds=[[0,0,0],[0,0,0]],this.firstSide=0,this.numSides=0,this.checkcount=0},b=function(){this.floodnum=0,this.floodvalid=0},w=function(){this.p=[]};w.prototype.clone=function(e){typeof e=="undefined"&&(e=new w),e.p=new Array(this.p.length);for(var t=0;t<this.p.length;t++)e.p[t]=vec3.set(this.p[t],[0,0,0]);return e};var E=64,S=0,x=1,T=2,N=3,C=65535,k=1024,L=1024,A=2048,O=129,M=16,_=.1,D=.1,P=function(){this.plane=[0,0,0,0],this.signbits=0},H=function(){this.surfacePlane=0,this.numBorders=0,this.borderPlanes=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.borderInward=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.borderNoAdjust=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1]},B=function(){this.bounds=[[0,0,0],[0,0,0]],this.planes=[],this.facets=[]},j=function(){this.width=0,this.height=0,this.wrapWidth=0,this.wrapHeight=0,this.points=new Array(O);for(var e=0;e<O;e++){this.points[e]=new Array(O);for(var t=0;t<O;t++)this.points[e][t]=[0,0,0]}},F=function(){this.checkcount=0,this.surfaceFlags=0,this.contents=0,this.pc=null},I=function(){this.allSolid=!1,this.startSolid=!1,this.fraction=1,this.endPos=[0,0,0],this.plane=new i.Plane,this.surfaceFlags=0,this.contents=0,this.entityNum=0,this.shaderName=null};I.prototype.clone=function(e){return typeof e=="undefined"&&(e=new I),e.allSolid=this.allSolid,e.startSolid=this.startSolid,e.fraction=this.fraction,vec3.set(this.endPos,e.endPos),this.plane.clone(e.plane),e.surfaceFlags=this.surfaceFlags,e.contents=this.contents,e.entityNum=this.entityNum,e.shaderName=this.shaderName,e};var q=1024,R=function(){this.list=null,this.count=0,this.maxCount=0,this.lastLeaf=0},U=function(){this.use=!1,this.radius=0,this.halfheight=0,this.offset=[0,0,0]};U.prototype.clone=function(e){typeof e=="undefined"&&(e=new U),e.use=this.use,e.radius=this.radius,e.halfheight=this.halfheight,vec3.set(this.offset,e.offset)};var z=function(){this.trace=new I,this.start=[0,0,0],this.end=[0,0,0],this.size=[[0,0,0],[0,0,0]],this.offsets=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],this.maxOffset=0,this.extents=[0,0,0],this.bounds=[[0,0,0],[0,0,0]],this.contents=0,this.isPoint=!1,this.sphere=new U},X,st=1,ot=6,ut=2,at=12,ft=null,lt=null,ct=null,bt=0,wt=1,Et=2,St=3,xt=[],Mt=.1,Pt=1e-4,Ht=.02,Kt=function(){this.enterFrac=0,this.leaveFrac=0,this.hit=!1},vn=new Uint32Array(q);return{LoadMap:V,EntityDefs:function(){return X.entities},InlineModel:pt,TempBoxModel:dt,ModelBounds:vt,LeafArea:yt,LeafCluster:gt,ClusterVisible:tn,BoxLeafnums:rn,PointLeafnum:on,AdjustAreaPortalState:ln,AreasConnected:cn,BoxTrace:Sn,TransformedBoxTrace:xn,EmitCollisionSurfaces:Gt}}return{CreateInstance:function(e){return new s(e)}}}),define("server/sv",["underscore","ByteBuffer","common/qmath","common/sh","game/gm","clipmap/cm"],function(e,t,n,r,i,s){function o(o){function V(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"SV:"),Function.apply.call(console.log,console,e)}function $(e,t){V("Initializing"),j=e,B=t,F=new O,I||(I=new L),q=a.AddCvar("sv_serverid",0,E.SYSTEMINFO),R=a.AddCvar("sv_mapname","nomap",E.SERVERINFO),U=a.AddCvar("sv_maxClients",8,E.SERVERINFO|E.LATCH|E.ARCHIVE),z=a.AddCvar("sv_fps",20),W=a.AddCvar("sv_timeout",200),X=a.AddCvar("sv_zombietime",2),kt()}function J(){}function K(){var e=z(),t=1e3/e;return t<1&&(t=1),t}function Q(e){if(!I.initialized)return;var t=K();F.timeResidual+=e;if(F.restartTime&&F.time>=F.restartTime){F.restartTime=0,a.ExecuteBuffer("map_restart 0");return}a.cvarModifiedFlags&E.SERVERINFO&&(it("serverInfo",a.GetCvarValues(E.SERVERINFO)),a.cvarModifiedFlags&=~E.SERVERINFO),a.cvarModifiedFlags&E.SYSTEMINFO&&(it("systemInfo",a.GetCvarValues(E.SYSTEMINFO)),a.cvarModifiedFlags&=~E.SYSTEMINFO),G();var n=0;while(F.timeResidual>=t)F.timeResidual-=t,I.time+=t,F.time+=t,l.Frame(F.time),n++;Y(),n>0&&Jt()}function G(){for(var e=0;e<U();e++){var t=I.clients[e];if(t.state!==D.ACTIVE){t.ping=999;continue}if(!t.gentity){t.ping=999;continue}var n=0,r=0;for(var i=0;i<y;i++){if(t.frames[i].messageAcked<=0)continue;var s=t.frames[i].messageAcked-t.frames[i].messageSent;n+=s,r++}r?(t.ping=Math.floor(n/r),t.ping>999&&(t.ping=999)):t.ping=999;var o=l.GetClientPlayerstate(e);o.ping=t.ping}}function Y(){var e=I.time-1e3*W(),t=I.time-1e3*X();for(var n=0;n<U();n++){var r=I.clients[n];if(r.state===D.FREE)continue;r.lastPacketTime>I.time&&(r.lastPacketTime=I.time);if(r.state===D.ZOMBIE&&r.lastPacketTime<t){V("Going from CS_ZOMBIE to CS_FREE for client",n),r.state=D.FREE;continue}r.state>=D.CONNECTED&&r.lastPacketTime<e&&(vt(r,"timed out"),r.state=D.FREE)}}function Z(e,n){if(!I.initialized)return;var r=new t(n,t.LITTLE_ENDIAN);if(n.byteLength>4&&r.view.getInt32(0,!!t.LITTLE_ENDIAN)===-1){et(e,r);return}for(var i=0;i<I.clients.length;i++){var s=I.clients[i];if(s.state===D.FREE)continue;if(s.netchan.socket!==e)continue;a.NetchanProcess(s,r)&&(s.lastPacketTime=I.time,Tt(s,r));return}}function et(e,t){t.readInt();var n=t.readCString();n.indexOf("connect")===0&&dt(e,n.substr(8))}function tt(e){V("Spawning new server for",e,"at",a.frameTime),I.initialized=!1,Mt(),B||(j.MapLoading(),j.ShutdownSubsystems(),j.ShutdownCGame(),j.InitSubsystems()),I.snapFlagServerBit^=p;var t=F.time;F=new O,f.LoadMap(e,function(){R(e),F.serverId=F.restartedServerId=a.frameTime,q(F.serverId),Zt(),F.state=A.LOADING,Ot();for(var t=0;t<3;t++)l.Frame(F.time),F.time+=100,I.time+=100;nt();for(var t=0;t<U();t++){var n=I.clients[t];if(!n||n.state<D.CONNECTED)continue;n.gentity=null;var r=l.ClientConnect(t,!1);r&&vt(n,r),n.state=D.CONNECTED}l.Frame(F.time),F.time+=100,I.time+=100,it("systemInfo",a.GetCvarValues(E.SYSTEMINFO)),it("serverInfo",a.GetCvarValues(E.SERVERINFO)),F.state=A.GAME,I.initialized=!0})}function nt(){for(var e=0;e<v;e++){var t=F.svEntities[e],n=Pt(t);if(!n.linked)continue;n.s.clone(F.svEntities[e].baseline)}}function rt(e){return F.configstrings[e]}function it(t,n){if(e.isEqual(n,F.configstrings[t]))return;F.configstrings[t]=n;if(F.state===A.GAME||F.restarting)for(var r=0;r<U();r++){var i=I.clients[r];if(i.state<D.ACTIVE){i.state===D.PRIMED&&(i.csUpdated[t]=!0);continue}st(i,t)}}function st(e,t){at(e,"cs",{k:t,v:F.configstrings[t]})}function ot(e){for(var t in F.configstrings){if(!F.configstrings.hasOwnProperty(t))continue;if(!e.csUpdated[t])continue;st(e,t),e.csUpdated[t]=!1}}function ut(e){return(e<0||e>=d)&&a.Error(x.DROP,"GetUserinfo: bad index "+e),I.clients[e].userinfo}function at(e,t,n){if(e!==null){ft(e,t,n);return}for(var r=0;r<U();r++)ft(I.clients[r],t,n)}function ft(e,t,n){if(e.state<D.PRIMED)return;e.reliableSequence++;var r={type:t,val:n};if(e.reliableSequence-e.reliableAcknowledge===b+1){V("----- pending server commands -----");for(var i=e.reliableAcknowledge+1;i<=e.reliableSequence;i++)V("cmd",i,e.reliableCommands[i%b]);V("cmd",i,r),vt(e,"Server command overflow");return}e.reliableCommands[e.reliableSequence%b]=r}function lt(){return{sys:u,com:a}}function ct(){return{sys:{ReadFile:u.ReadFile},com:{ERR:a.ERR,Error:a.Error}}}function ht(){return{sys:{GetMilliseconds:u.GetMilliseconds,ReadFile:u.ReadFile},com:{ERR:a.ERR,Error:a.Error,ExecuteBuffer:a.ExecuteBuffer,AddCmd:a.AddCmd,AddCvar:a.AddCvar,GetCvarVal:a.GetCvarVal,SetCvarVal:a.SetCvarVal},sv:{LocateGameData:Ht,GetUserCmd:Bt,AdjustAreaPortalState:It,EntityContact:qt,GetConfigstring:rt,SetConfigstring:it,GetUserinfo:ut,SendServerCommand:jt,SetBrushModel:Ft,LinkEntity:rn,UnlinkEntity:sn,FindEntitiesInBox:on,GetEntityDefs:f.EntityDefs,SnapVector:f.SnapVector,Trace:fn}}}function pt(e){for(var t=0;t<I.clients.length;t++){var n=I.clients[t];if(n.state===D.FREE)continue;if(n.netchan.socket===e){vt(n,"disconnected");return}}}function dt(e,t){if(!I.initialized)return;V("A client is connecting");var n;for(var i=0;i<d;i++)if(I.clients[i].state===D.FREE){n=i;break}if(n===undefined){V("Rejected a connection.");return}var s=I.clients[n];s.reset(),s.netchan=a.NetchanSetup(r.NetSrc.SERVER,e),s.userinfo=JSON.parse(t);var o=l.ClientConnect(n,!0);if(o)return;wt(s),V("Going from CS_FREE to CS_CONNECTED for ",n),s.state=D.CONNECTED,s.lastSnapshotTime=I.time,s.lastPacketTime=I.time,a.NetchanPrint(s.netchan,"connectResponse"),s.gamestateMessageNum=-1}function vt(e,t){if(e.state===D.ZOMBIE)return;var n=Et(e);l.ClientDisconnect(n),e.state=D.ZOMBIE}function mt(e,t){var n=I.clients.indexOf(e);e.state=D.ACTIVE,ot(e),e.deltaMessage=-1,e.lastSnapshotTime=0,e.gentity=_t(n),t?t.clone(e.lastUserCmd):e.lastUserCmd=new r.UserCmd,l.ClientBegin(n)}function gt(e,t,n){n?e.deltaMessage=e.messageAcknowledge:e.deltaMessage=-1;var i=t.readByte(t);if(i<1){V("UserMove cmd count < 1");return}var s=[];for(var o=0;o<i;o++){var u=new r.UserCmd;r.ReadDeltaUsercmd(t,null,u),s.push(u)}e.frames[e.messageAcknowledge%y].messageAcked=I.time,e.state===D.PRIMED&&mt(e,u);if(e.state!==D.ACTIVE){e.deltaMessage=-1;return}for(var o=0;o<s.length;o++){var u=s[o];if(u.serverTime>s[s.length-1].serverTime)continue;if(u.serverTime<=e.lastUserCmd.serverTime)return;yt(e,u)}}function yt(e,t){var n=Et(e);t.clone(e.lastUserCmd),l.ClientThink(n)}function bt(e){e.state=D.PRIMED,e.gamestateMessageNum=e.netchan.outgoingSequence;var n=new t(I.msgBuffer,t.LITTLE_ENDIAN);n.writeInt(e.lastClientCommand),n.writeByte(N.gamestate),n.writeInt(e.reliableSequence);for(var i in F.configstrings){if(!F.configstrings.hasOwnProperty(i))continue;n.writeByte(N.configstring),n.writeCString(JSON.stringify({k:i,v:F.configstrings[i]}))}var s=new r.EntityState;for(var o=0;o<v;o++){var u=F.svEntities[o].baseline;if(!u.number)continue;n.writeByte(N.baseline),r.WriteDeltaEntityState(n,s,u,!0)}n.writeByte(N.EOF),n.writeInt(Et(e)),a.NetchanSend(e.netchan,n.buffer,n.index)}function wt(e){e.name=e.userinfo.name;var t=20;t<1?t=1:t>z()&&(t=z()),t=1e3/t,t!=e.snapshotMsec&&(e.lastSnapshotTime=0,e.snapshotMsec=t)}function Et(e){return I.clients.indexOf(e)}function St(e,t){e.userinfo=t,wt(e);var n=Et(e);l.ClientUserinfoChanged(n)}function xt(e){vt(e,"disconnected")}function Tt(e,t){var n=t.readInt();e.messageAcknowledge=t.readInt();if(e.messageAcknowledge<0)return;e.reliableAcknowledge=t.readInt();if(e.reliableAcknowledge<e.reliableSequence-b){e.reliableAcknowledge=e.reliableSequence;return}if(n!==F.serverId){if(n>=F.restartedServerId&&n<F.serverId)return;e.messageAcknowledge>e.gamestateMessageNum&&bt(e);return}e.oldServerTime&&n===q()&&(e.oldServerTime=0);var r;for(;;){r=t.readUnsignedByte();if(r===T.EOF)break;if(r!==T.clientCommand)break;if(!Nt(e,t))return;if(e.state===D.ZOMBIE)return}switch(r){case T.move:gt(e,t,!0);break;case T.moveNoDelta:gt(e,t,!1)}}function Nt(e,t){var n=t.readInt(),r=JSON.parse(t.readCString());return e.lastClientCommand>=n?!0:n>e.lastClientCommand+1?(V("Client",e.name,"lost",n-e.lastClientCommand,"clientCommands"),vt(e,"Lost reliable commands"),!1):(e.nextReliableTime=I.time+1e3,Ct(e,r),e.lastClientCommand=n,!0)}function Ct(e,t){t.type==="userinfo"?St(e,t.val):t.type==="disconnect"&&xt(e);if(F.state===A.GAME&&(e.state===D.ACTIVE||e.state===D.PRIMED)){var n=Et(e);l.ClientCommand(n,t)}}function kt(){a.AddCmd("map",Lt),a.AddCmd("map_restart",At),a.AddCmd("sectorlist",Yt)}function Lt(e){tt(e)}function At(e){if(a.frameTime===q())return;if(F.restartTime)return;var t=typeof e!="undefined"?parseInt(e,10):5;if(t&&!a.GetCvarVal("g_doWarmup")){F.restartTime=F.time+t*1e3,it("warmup",F.restartTime);return}if(a.RelatchCvar("sv_maxClients")){V("Restart map is doing a hard restart - sv_maxClients changed."),tt(R());return}I.snapFlagServerBit^=p,F.serverId=a.frameTime,q(F.serverId);for(var n=0;n<U();n++)I.clients[n].state===D.PRIMED&&(I.clients[n].oldServerTime=F.restartTime);F.state=A.LOADING,F.restarting=!0,Mt(),Ot();for(var n=0;n<3;n++)l.Frame(F.time),F.time+=100,I.time+=100;F.state=A.GAME,F.restarting=!1;for(var n=0;n<U();n++){var r=I.clients[n];if(r.state<D.CONNECTED)continue;ft(r,"map_restart");var i=l.ClientConnect(n,!1);if(i){vt(r,i),V("MapRestart: dropped client",n,"- denied!");continue}r.state===D.ACTIVE?mt(r,r.lastUserCmd):mt(r,null)}l.Frame(F.time),F.time+=100,I.time+=100}function Ot(){I.gameInitialized=!0,l.Init(F.time)}function Mt(){if(!I.gameInitialized)return;I.gameInitialized=!1,l.Shutdown()}function _t(e){return F.gameEntities[e]}function Dt(e){var t=e.s.number;return(!e||t<0||t>=v)&&a.Error(x.DROP,"SvEntityForSharedEntity: bad game entity"),F.svEntities[t]}function Pt(e){var t=F.svEntities.indexOf(e);return(!e||t<0||t>=v)&&a.Error(x.DROP,"SharedEntityForSvEntity: bad sv entity"),_t(t)}function Ht(e,t){F.gameEntities=e,F.gameClients=t}function Bt(e,t){(e<0||e>=d)&&a.Error(x.DROP,"GetUsercmd: bad clientNum: "+e),I.clients[e].lastUserCmd.clone(t)}function jt(e,t,n){e===null?at(null,t,n):((e<0||e>=d)&&a.Error(x.DROP,"GetUsercmd: bad clientNum: "+e),at(I.clients[e],t,n))}function Ft(e,t){t||a.Error(x.DROP,"SV: SetBrushModel: null"),t.charAt(0)!=="*"&&a.Error(x.DROP,"SV: SetBrushModel: "+t+"isn't a brush model"),e.s.modelIndex=parseInt(t.substr(1),10);var n=f.InlineModel(e.s.modelIndex);f.ModelBounds(n,e.mins,e.maxs),e.bmodel=!0,e.contents=-1}function It(e,t){var n=Dt(e);if(n.areanum2===-1)return;f.AdjustAreaPortalState(n.areanum,n.areanum2,t)}function qt(e,t,r){var i=r.currentOrigin,s=r.currentAngles,o=cn(r),u=f.TransformedBoxTrace(n.vec3origin,n.vec3origin,e,t,o,-1,i,s,!1);return u.startSolid}function Rt(e,t){var n=e.gentity;if(!n||e.state===D.ZOMBIE)return!1;F.snapshotCounter++;var r=e.frames[e.netchan.outgoingSequence%y],i=Et(e),s=l.GetClientPlayerstate(i);s.clone(r.ps);var o=F.svEntities[i];o.snapshotCounter=F.snapshotCounter;var u=[];Ut(r.ps.origin,r,u,!1),r.numEntities=0,r.firstEntity=I.nextSnapshotEntities;for(var a=0;a<u.length;a++){var f=_t(u[a]),c=I.snapshotEntities[I.nextSnapshotEntities%C];f.s.clone(c),I.nextSnapshotEntities++,r.numEntities++}return!0}function Ut(e,t,n,r){var i=f.PointLeafnum(e),s=f.LeafArea(i),o=f.LeafCluster(i);for(var u=0;u<v;u++){var c=_t(u);if(!c||!c.linked)continue;c.s.number!==u&&a.Error(x.DROP,"Entity number does not match.. WTF"+c.s.number+", "+u);if(c.svFlags&l.SVF.NOCLIENT)continue;if(c.svFlags&l.SVF.SINGLECLIENT&&c.singleClient!==t.ps.clientNum)continue;if(c.svFlags&l.SVF.NOTSINGLECLIENT&&c.singleClient===t.ps.clientNum)continue;var h=Dt(c);if(h.snapshotCounter===F.snapshotCounter)continue;if(c.svFlags&l.SVF.BROADCAST){zt(h,c,n);continue}if(!f.AreasConnected(s,h.areanum)&&!f.AreasConnected(s,h.areanum2))continue;if(!h.numClusters)continue;var p=0,d=0;for(p=0;p<h.numClusters;p++){d=h.clusternums[p];if(f.ClusterVisible(o,d))break}if(p===h.numClusters){if(!h.lastCluster)continue;for(;d<=h.lastCluster;d++)if(f.ClusterVisible(o,d))break;if(d===h.lastCluster)continue}zt(h,c,n)}}function zt(e,t,n){if(e.snapshotCounter===F.snapshotCounter)return;e.snapshotCounter=F.snapshotCounter,n.push(t.s.number)}function Wt(e){if(!Rt(e))return;var n=new t(I.msgBuffer,t.LITTLE_ENDIAN);n.writeInt(e.lastClientCommand),Xt(e,n),Vt(e,n),e.frames[e.netchan.outgoingSequence%y].messageSent=I.time,e.frames[e.netchan.outgoingSequence%y].messageAcked=-1,a.NetchanSend(e.netchan,n.buffer,n.index)}function Xt(e,t){for(var n=e.reliableAcknowledge+1;n<=e.reliableSequence;n++){var r=e.reliableCommands[n%b];t.writeByte(N.serverCommand),t.writeInt(n),t.writeCString(JSON.stringify(r))}}function Vt(e,t){var n=e.frames[e.netchan.outgoingSequence%y],i=null,s=0;e.deltaMessage<=0||e.state!==D.ACTIVE?(i=null,s=0):e.netchan.outgoingSequence-e.deltaMessage>=y-3?(i=null,s=0):(i=e.frames[e.deltaMessage%y],s=e.netchan.outgoingSequence-e.deltaMessage,i.firstEntity<=I.nextSnapshotEntities-I.numSnapshotEntities&&(V(e.name,": Delta request from out of date entities."),i=null,s=0)),t.writeUnsignedByte(N.snapshot);var o=F.time;e.oldServerTime&&(o=F.time+e.oldServerTime),t.writeInt(o),t.writeByte(s);var u=I.snapFlagServerBit;e.state!==D.ACTIVE&&(u|=h),t.writeInt(u),r.WriteDeltaPlayerState(t,i?i.ps:null,n.ps),$t(t,i,n)}function $t(e,t,n){var i,s,o,u,a,f,l;l=t?t.numEntities:0,i=null,s=null,o=0,u=0;while(u<n.numEntities||o<l){u>=n.numEntities?f=9999:(s=I.snapshotEntities[(n.firstEntity+u)%C],f=s.number),o>=l?a=9999:(i=I.snapshotEntities[(t.firstEntity+o)%C],a=i.number);if(f===a){r.WriteDeltaEntityState(e,i,s,!1),o++,u++;continue}if(f<a){r.WriteDeltaEntityState(e,F.svEntities[f].baseline,s,!0),u++;continue}if(f>a){r.WriteDeltaEntityState(e,i,null,!0),o++;continue}}e.writeShort(v-1)}function Jt(){for(var e=0;e<I.clients.length;e++){var t=I.clients[e];if(!t)continue;if(!t.state)continue;if(I.time-t.lastSnapshotTime<t.snapshotMsec)continue;Wt(t),t.lastSnapshotTime=I.time}}function Yt(){for(var t=0;t<Qt.length;t++){var n=Qt[t];V("sector "+t+": "+e.keys(n.entities).length+" entities")}}function Zt(){Qt=[];var e=f.InlineModel(0),t=[0,0,0],n=[0,0,0];f.ModelBounds(e,t,n),en(0,t,n)}function en(e,t,n){var r=Qt[Qt.length]=new Gt;if(e===Kt)return r.axis=-1,r.children[0]=r.children[1]=null,r;var i=vec3.subtract(n,t,[0,0,0]);i[0]>i[1]?r.axis=0:r.axis=1;var s=vec3.set(t,[0,0,0]),o=vec3.set(t,[0,0,0]),u=vec3.set(n,[0,0,0]),a=vec3.set(n,[0,0,0]);return r.dist=.5*(n[r.axis]+t[r.axis]),u[r.axis]=o[r.axis]=r.dist,r.children[0]=en(e+1,o,a),r.children[1]=en(e+1,s,u),r}function rn(e){var t,r,i,s=Dt(e);s.worldSector&&sn(e),e.bmodel?e.s.solid=c:e.contents&(S.SOLID|S.BODY)?(t=e.maxs[0],t<1?t=1:t>255&&(t=255),r=-e.mins[2],r<1?r=1:r>255&&(r=255),i=e.maxs[2]+32,i<1?i=1:i>255&&(i=255),e.s.solid=i<<16|r<<8|t):e.s.solid=0;var o=e.currentOrigin,u=e.currentAngles;if(e.bmodel&&(u[0]||u[1]||u[2])){var a=n.RadiusFromBounds(e.mins,e.maxs);for(t=0;t<3;t++)e.absmin[t]=o[t]-a,e.absmax[t]=o[t]+a}else vec3.add(o,e.mins,e.absmin),vec3.add(o,e.maxs,e.absmax);e.absmin[0]-=1,e.absmin[1]-=1,e.absmin[2]-=1,e.absmax[0]+=1,e.absmax[1]+=1,e.absmax[2]+=1,s.numClusters=0,s.lastCluster=0,s.areanum=-1,s.areanum2=-1;var l=f.BoxLeafnums(e.absmin,e.absmax,nn,tn);if(!l.count)return;for(t=0;t<l.count;t++){var h=f.LeafArea(nn[t]);if(h===-1)continue;s.areanum!==-1&&s.areanum!==h?s.areanum2=h:s.areanum=h}s.numClusters=0;for(t=0;t<l.count;t++){var p=f.LeafCluster(nn[t]);if(p===-1)continue;s.clusternums[s.numClusters++]=p;if(s.numClusters===k)break}t!==l.count&&(s.lastCluster=f.LeafCluster(l.lastLeaf));var d=Qt[0];for(;;){if(d.axis==-1)break;if(e.absmin[d.axis]>d.dist)d=d.children[0];else{if(!(e.absmax[d.axis]<d.dist))break;d=d.children[1]}}e.linked=!0,s.worldSector=d,d.entities[e.s.number]=s}function sn(e){var t=Dt(e),n=t.worldSector;if(!n)return;e.linked=!1,delete n.entities[e.s.number],t.worldSector=null}function on(e,t){var n=[],r=function(i){for(var s in i.entities){if(!i.entities.hasOwnProperty(s))continue;var o=i.entities[s],u=Pt(o);if(u.absmin[0]>t[0]||u.absmin[1]>t[1]||u.absmin[2]>t[2]||u.absmax[0]<e[0]||u.absmax[1]<e[1]||u.absmax[2]<e[2])continue;n.push(u.s.number)}if(i.axis==-1)return;t[i.axis]>i.dist&&r(i.children[0]),e[i.axis]<i.dist&&r(i.children[1])};return r(Qt[0]),n}function fn(e,t,n,r,i,s,o){n||(n=[0,0,0]),r||(r=[0,0,0]),an.trace=f.BoxTrace(e,t,n,r,0,s,o),an.trace.entityNum=an.trace.fraction!==1?g:m;if(an.trace.fraction===0)return an.trace;an.contentmask=s,vec3.set(e,an.start),vec3.set(t,an.end),vec3.set(n,an.mins),vec3.set(r,an.maxs),an.passEntityNum=i,an.capsule=o;for(var u=0;u<3;u++)t[u]>e[u]?(an.boxmins[u]=an.start[u]+an.mins[u]-1,an.boxmaxs[u]=an.end[u]+an.maxs[u]+1):(an.boxmins[u]=an.end[u]+an.mins[u]-1,an.boxmaxs[u]=an.start[u]+an.maxs[u]+1);return ln(an),an.trace}function ln(e){var t=[0,0,0],n=[0,0,0],r=-1,i=on(e.boxmins,e.boxmaxs);e.passEntityNum!==m&&(r=_t(e.passEntityNum).ownerNum,r===m&&(r=-1));for(var s=0;s<i.length;s++){if(e.trace.allSolid)return;var o=_t(i[s]);if(e.passEntityNum!==m){if(i[s]===e.passEntityNum)continue;if(o.ownerNum===e.passEntityNum)continue;if(o.ownerNum===r)continue}if(!(e.contentmask&o.contents))continue;var u=cn(o);vec3.set(o.currentOrigin,t),vec3.set(o.currentAngles,n),o.bmodel||(n[0]=n[1]=n[2]=0);var a=f.TransformedBoxTrace(e.start,e.end,e.mins,e.maxs,u,e.contentmask,t,n,e.capsule);a.allSolid?(e.trace.allSolid=!0,a.entityNum=o.s.number):a.startSolid&&(e.trace.startSolid=!0,a.entityNum=o.s.number);if(a.fraction<e.trace.fraction){var l=e.trace.startSolid;a.entityNum=o.s.number,e.trace=a,e.trace.startSolid|=l}}}function cn(e){return e.bmodel?f.InlineModel(e.s.modelIndex):f.TempBoxModel(e.mins,e.maxs,!1)}var u=o.sys,a=o.com,f=s.CreateInstance(ct()),l=i.CreateInstance(ht()),c=r.SOLID_BMODEL,h=r.SNAPFLAG_NOT_ACTIVE,p=r.SNAPFLAG_SERVERCOUNT,d=r.MAX_CLIENTS,v=r.MAX_GENTITIES,m=r.ENTITYNUM_NONE,g=r.ENTITYNUM_WORLD,y=a.PACKET_BACKUP,b=a.MAX_RELIABLE_COMMANDS,w=a.MAX_MSGLEN,E=r.CVF,S=r.CONTENTS,x=a.ERR,T=a.CLM,N=a.SVM,C=d*y*64,k=16,L=function(){this.initialized=!1,this.gameInitialized=!1,this.time=0,this.snapFlagServerBit=0,this.clients=new Array(d),this.nextSnapshotEntities=0,this.snapshotEntities=new Array(C),this.msgBuffer=new ArrayBuffer(w);var e;for(e=0;e<d;e++)this.clients[e]=new P;for(e=0;e<C;e++)this.snapshotEntities[e]=new r.EntityState},A={DEAD:0,LOADING:1,GAME:2},O=function(){this.state=A.DEAD,this.restarting=!1,this.serverId=0,this.restartedServerId=0,this.snapshotCounter=0,this.time=0,this.restartTime=0,this.timeResidual=0,this.configstrings={},this.svEntities=new Array(v),this.gameEntities=null,this.gameClients=null;for(var e=0;e<v;e++)this.svEntities[e]=new M},M=function(){this.worldSector=null,this.baseline=new r.EntityState,this.numClusters=0,this.clusternums=new Array(k),this.lastCluster=0,this.areanum=0,this.areanum2=0,this.snapshotCounter=0},D={FREE:0,ZOMBIE:1,CONNECTED:2,PRIMED:3,ACTIVE:4},P=function(){this.reset()};P.prototype.reset=function(){this.state=D.FREE,this.userinfo={},this.messageAcknowledge=0,this.reliableCommands=new Array(b),this.reliableSequence=0,this.reliableAcknowledge=0,this.gamestateMessageNum=-1,this.lastUserCmd=new r.UserCmd,this.lastMessageNum=0,this.lastClientCommand=0,this.name=null,this.deltaMessage=-1,this.nextReliableTime=0,this.lastSnapshotTime=0,this.snapshotMsec=0,this.frames=new Array(y),this.netchan=null,this.oldServerTime=0,this.csUpdated={};for(var e=0;e<y;e++)this.frames[e]=new H};var H=function(){this.ps=new r.PlayerState,this.numEntities=0,this.firstEntity=0},B,j,F,I,q,R,U,z,W,X,Kt=4,Qt,Gt=function(){this.axis=0,this.dist=0,this.children=[null,null],this.entities={}},tn=128,nn=new Uint32Array(tn),un=function(){this.boxmins=[0,0,0],this.boxmaxs=[0,0,0],this.mins=[0,0,0],this.maxs=[0,0,0],this.start=[0,0,0],this.end=[0,0,0],this.trace=null,this.passEntityNum=0,this.contentmask=0,this.capsule=0},an=new un;return{Init:$,Shutdown:J,Frame:Q,PacketEvent:Z,SocketClosed:pt}}return{CreateInstance:function(e){return new o(e)}}}),define("client/cl",[],function(){return{CreateInstance:function(){}}}),define("common/com",["underscore","ByteBuffer","common/sh","server/sv","client/cl"],function(e,t,n,r,i){function g(){y("exec",w),y("+debugtest",function(){window.debugtest=!0}),y("-debugtest",function(){window.debugtest=!1})}function y(e,t){m[e]=t}function b(e){return m[e]}function w(e,t){if(!e){console.log("Enter a filename to execeute.");return}W("Executing",e),H.ReadFile(e,"utf8",function(n,r){if(n){W("Failed to execute '"+e+"'"),t&&t(n);return}r=r.replace(/^\s+|\s+$/g,"");var i=r.split(/\r\n|\r|\n/);for(var s=0;s<i.length;s++)G(i[s]);t&&t()})}function x(){y("set",T),y("unset",N),y("echo",C)}function T(e,t){var n=L(e);n(t)}function N(e,t){var n=L(e);n(n.defaultValue)}function C(e){var t=A(e);if(!t)return;W(e,"is:",t(),", default:",t.defaultValue)}function L(e,t,n){var r=A(e);return r?(typeof t!="undefined"&&(r.defaultValue=t),typeof n!="undefined"&&(r.flags=n),_(e),r):(r=E[e]=new k(t,n),r)}function A(e){return E[e]}function O(e){var t=A(e);return t?t():null}function M(e,t){T(e,t)}function _(e){var t=A(e);return t?t.latchedValue===t.currentValue?!1:(t.latchedValue=t.currentValue,!0):!1}function D(e){var t={};for(var n in E){if(!E.hasOwnProperty(n))continue;var r=E[n];if(!(r.flags&e))continue;t[n]=r()}return t}function P(e){for(var t in E){if(!E.hasOwnProperty(t))continue;var n=E[t];if(!(n.flags&s.ARCHIVE))continue;e+="set "+t+" "+n()+"\n"}return e}function W(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"COM:"),Function.apply.call(console.log,console,e)}function X(e,t){throw e===u.DISCONNECT&&(console.error("Server disconnected"),B.Shutdown(),j.Disconnect()),e===u.DROP&&(console.error("Server crashed:",t),B.Shutdown(),j.Disconnect()),new Error}function V(e,t){H=e,j=i.CreateInstance(tt()),B=r.CreateInstance(tt()),F=t,I=[],q=R=H.GetMilliseconds(),U=!1,z=!1,x(),g(),F||j.Init(),B.Init(j,F),Z(),U=!0}function $(){R=q,q=H.GetMilliseconds();var e=q-R;Y(),J(),B.Frame(e),F||j.Frame(e)}function J(){var e=I.shift();while(e){switch(e.type){case a.CLMSG:j.PacketEvent(e.buffer);break;case a.SVMSG:B.PacketEvent(e.socket,e.buffer);break;case a.NETSVSOCKCLOSE:B.SocketClosed(e.socket);break;case a.KEY:e.pressed?j.KeyDownEvent(e.time,e.keyName):j.KeyUpEvent(e.time,e.keyName);break;case a.MOUSE:j.MouseMoveEvent(e.time,e.deltaX,e.deltaY)}e=I.shift()}}function K(e){e.time=H.GetMilliseconds(),I.push(e)}function G(e){var t=[],n;while(n=Q.exec(e))t.push(n[1]||n[2]);var r=b(t[0]);if(r){r.apply(this,t.slice(1));return}if(r===null){j.ForwardCommandToServer(t);return}W("Unknown command '"+t[0]+"'")}function Y(){if(!U||!z)return;if(!(S&s.ARCHIVE))return;S&=~s.ARCHIVE,et()}function Z(){w("default.cfg",function(){w("q3config.cfg",function(){z=!0,S&=~s.ARCHIVE})})}function et(e){var t="q3config.cfg",n="unbindall\n";n=j.WriteBindings(n),n=P(n),console.log("Saving config to",t),H.WriteFile(t,n,"utf8",e)}function tt(){var e={com:{MAX_MAP_AREA_BYTES:o,PACKET_BACKUP:f,MAX_PACKET_USERCMDS:l,MAX_RELIABLE_COMMANDS:c,MAX_MSGLEN:h,ERR:u,CLM:p,SVM:d,Error:X,ExecuteBuffer:G,LoadConfig:Z,SaveConfig:et,AddCvar:L,GetCvarVal:O,SetCvarVal:M,RelatchCvar:_,GetCvarValues:D,AddCmd:y,GetCmd:b,NetchanSetup:ot,NetchanDestroy:ut,NetchanSend:ft,NetchanPrint:lt,NetchanProcess:ct},sys:H};return Object.defineProperty(e.com,"frameTime",{get:function(){return q}}),Object.defineProperty(e.com,"cvarModifiedFlags",{get:function(){return S},set:function(e){S=e}}),e}function ot(e,t){var r=new v,i,s;return t.type!==undefined?(i=t,i.type===n.NetAdrType.LOOPBACK?s={remoteAddress:i}:s=H.NetConnectToServer(i)):(s=t,i=s.remoteAddress),r.src=e,r.addr=i,r.socket=s,r}function ut(e){e.addr.type===n.NetAdrType.LOOPBACK?K({type:a.SVSOCKCLOSE,socket:e.socket}):H.NetClose(e.socket)}function at(e,t,r){var i=it[e.src];t=t.slice(0,r),i.msgs[i.send++%rt]=t,K({type:e.src===n.NetSrc.CLIENT?a.SVMSG:a.CLMSG,socket:e.socket,addr:e.addr,buffer:t,length:r})}function ft(e,r,i){var s=new t(st,t.LITTLE_ENDIAN),o=new Uint8Array(r);s.writeInt(e.outgoingSequence++);for(var u=0;u<i;u++)s.writeUnsignedByte(o[u]);if(e.addr.type===n.NetAdrType.LOOPBACK){at(e,s.buffer,s.index);return}H.NetSend(e.socket,s.buffer,s.index)}function lt(e,r){var i=new t(st,t.LITTLE_ENDIAN);i.writeInt(-1),i.writeCString(r);if(e.addr.type===n.NetAdrType.LOOPBACK){at(e,i.buffer,i.index);return}H.NetSend(e.socket,i.buffer,i.index)}function ct(e,t){var n=t.readInt();return e.incomingSequence=n,!0}var s=n.CVF,o=32,u={FATAL:0,DROP:1,DISCONNECT:2},a={CLMSG:0,SVMSG:1,SVSOCKCLOSE:2,KEY:3,MOUSE:4},f=32,l=32,c=64,h=16384,p={bad:0,move:1,moveNoDelta:2,clientCommand:3,EOF:4},d={bad:0,gamestate:1,configstring:2,baseline:3,serverCommand:4,snapshot:5,EOF:6},v=function(){this.src=0,this.remoteAddress=null,this.socket=null,this.incomingSequence=0,this.outgoingSequence=1},m={},E={},S=0,k=function(e,t){e=typeof e=="undefined"?0:e,t=typeof t=="undefined"?0:t;var n=function(e){if(!arguments.length)return t&s.LATCH?n.latchedValue:n.currentValue;var r=n.currentValue;isNaN(e)?n.currentValue=e:n.currentValue=+e,S|=n.flags};return n.defaultValue=e,n.currentValue=e,n.latchedValue=e,n.flags=t,n},H,B,j,F,I,q,R,U,z,Q=/([^"\s]+)|"([^"]+)"/g,nt=1400,rt=16,it=[{msgs:new Array(rt),send:0},{msgs:new Array(rt),send:0}],st=new ArrayBuffer(h);return{PACKET_BACKUP:f,SE:a,Init:V,Frame:$,ExecuteBuffer:G,QueueEvent:K,NetchanSetup:ot}}),define("system/dedicated/sys",["underscore","glmatrix","common/sh","common/com"],function(e,t,n,r){function l(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"SYS:"),Function.apply.call(console.log,console,e)}function c(e){console.error(e),process.exit(0)}function h(e,t,n){f=e,l("Starting dedicated server for version",i),setMatrixArrayType(Array),r.Init(w(),!0),T(t),p(n),d(),setInterval(function(){r.Frame()},10)}function p(e){var t=u.createServer(function(e){e.write("Welcome!\n");var t=a.createInterface({input:e,output:e,terminal:!0});t.setPrompt("quakejs> "),t.prompt(),t.on("line",function(e){r.ExecuteBuffer(e),t.prompt()}).on("close",function(){console.log("Have a great day!")})});t.listen(e,function(){l(new Date,"Rcon server is listening on port",e)})}function d(){var e=process.argv.slice(2);for(var t=0;t<e.length;t++){var n=e[t];if(n.indexOf("--exec")===0){var i=n.substr(7);r.ExecuteBuffer(i)}}}function v(){c("Should not happen")}function m(){c("Should not happen")}function g(){c("Should not happen")}function b(){var e=process.hrtime();return y||(y=e[0]*1e3+parseInt(e[1]/1e6,10)),e[0]*1e3+parseInt(e[1]/1e6,10)-y}function w(){return{Error:c,GetMilliseconds:b,ReadFile:S,GetGLContext:m,GetUIContext:g,NetCreateServer:T,NetConnectToServer:N,NetSend:C,NetClose:k}}function S(e,t,n){var r=t==="binary";e=f+"/"+e+"?v="+i,console.log("ReadFile",e),E.get(e,function(e){e.on("close",function(e){n(e)});if(r){var t=e.headers["content-length"],i=new Uint8Array(t),s=0;e.on("data",function(e){for(var t=0,n=e.length;t<n;t++)i[s++]=e[t]}).on("end",function(){n(null,i)})}else{var o="";e.on("data",function(e){o+=e}).on("end",function(){n(null,o)})}})}function T(e){var t=E.createServer(),n=new x({httpServer:t,autoAcceptConnections:!1});n.on("request",function(e){var t=e.accept("quakejs",e.origin);l(new Date,"Connection accepted."),r.QueueEvent({type:s.NETSVCONNECT,socket:t}),t.on("message",function(e){var n=e.binaryData,i=new ArrayBuffer(n.length),o=new Uint8Array(i);for(var u=0;u<n.length;++u)o[u]=n[u];r.QueueEvent({type:s.SVMSG,socket:t,buffer:i})}),t.on("close",function(e,n){r.QueueEvent({type:s.NETSVSOCKCLOSE,socket:t})})}),t.listen(e,function(){l(new Date,"Game server is listening on port",e)})}function N(e){c("Should not happen")}function C(e,t,n){var r=new Buffer(n),i=new Uint8Array(t);for(var s=0;s<n;++s)r[s]=i[s];e.sendBytes(r)}function k(e){e.close()}var i=n.GAME_VERSION,s=r.SE,o={us:{"default":{8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"command",92:"_91",93:"select",96:"num0",97:"num1",98:"num2",99:"num3",100:"num4",101:"num5",102:"num6",103:"num7",104:"num8",105:"num9",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shifted:{48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",107:"+",109:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'}}},u=require("net"),a=require("readline"),f,y,E=require("http"),E=require("http"),x=require("websocket").server;return{Init:h}});