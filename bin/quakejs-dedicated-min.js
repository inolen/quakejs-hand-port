//     Underscore.js 1.4.1
//     http://underscorejs.org
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore may be freely distributed under the MIT license.

/*
 * Copyright (c) 2012 Brandon Jones, Colin MacKenzie IV
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any damages
 * arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 *
 *    1. The origin of this software must not be misrepresented; you must not
 *    claim that you wrote the original software. If you use this software
 *    in a product, an acknowledgment in the product documentation would be
 *    appreciated but is not required.
 *
 *    2. Altered source versions must be plainly marked as such, and must not
 *    be misrepresented as being the original software.
 *
 *    3. This notice may not be removed or altered from any source
 *    distribution.
 */

/**
 * ByteBuffer v0.0.1
 * Copyright (c) 2012 Tim Kurvers <http://moonsphere.net>
 *
 * Wrapper for ArrayBuffer/DataView maintaining index and default endianness.
 * Supports arbitrary reading/writing, implicit growth, clipping, cloning and
 * reversing as well as UTF-8 characters and NULL-terminated C-strings.
 *
 * The contents of this file are subject to the MIT License, under which
 * this library is licensed. See the LICENSE file for the full license.
 */

(function(){var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.concat,f=r.unshift,l=i.toString,c=i.hasOwnProperty,h=r.forEach,p=r.map,d=r.reduce,v=r.reduceRight,m=r.filter,g=r.every,y=r.some,b=r.indexOf,w=r.lastIndexOf,E=Array.isArray,S=Object.keys,x=s.bind,T=function(e){if(e instanceof T)return e;if(!(this instanceof T))return new T(e);this._wrapped=e};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=T),exports._=T):e._=T,T.VERSION="1.4.1";var N=T.each=T.forEach=function(e,t,r){if(h&&e.forEach===h)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(t.call(r,e[i],i,e)===n)return}else for(var o in e)if(T.has(e,o)&&t.call(r,e[o],o,e)===n)return};T.map=T.collect=function(e,t,n){var r=[];return p&&e.map===p?e.map(t,n):(N(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),r)},T.reduce=T.foldl=T.inject=function(e,t,n,r){var i=arguments.length>2;if(d&&e.reduce===d)return r&&(t=T.bind(t,r)),i?e.reduce(t,n):e.reduce(t);N(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},T.reduceRight=T.foldr=function(e,t,n,r){var i=arguments.length>2;if(v&&e.reduceRight===v)return r&&(t=T.bind(t,r)),arguments.length>2?e.reduceRight(t,n):e.reduceRight(t);var s=e.length;if(s!==+s){var o=T.keys(e);s=o.length}N(e,function(u,a,f){a=o?o[--s]:--s,i?n=t.call(r,n,e[a],a,f):(n=e[a],i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},T.find=T.detect=function(e,t,n){var r;return C(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},T.filter=T.select=function(e,t,n){var r=[];return m&&e.filter===m?e.filter(t,n):(N(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},T.reject=function(e,t,n){var r=[];return N(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r},T.every=T.all=function(e,t,r){t||(t=T.identity);var i=!0;return g&&e.every===g?e.every(t,r):(N(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var C=T.some=T.any=function(e,t,r){t||(t=T.identity);var i=!1;return y&&e.some===y?e.some(t,r):(N(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};T.contains=T.include=function(e,t){var n=!1;return b&&e.indexOf===b?e.indexOf(t)!=-1:(n=C(e,function(e){return e===t}),n)},T.invoke=function(e,t){var n=u.call(arguments,2);return T.map(e,function(e){return(T.isFunction(t)?t:e[t]).apply(e,n)})},T.pluck=function(e,t){return T.map(e,function(e){return e[t]})},T.where=function(e,t){return T.isEmpty(t)?[]:T.filter(e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},T.max=function(e,t,n){if(!t&&T.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.max.apply(Math,e);if(!t&&T.isEmpty(e))return-Infinity;var r={computed:-Infinity};return N(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},T.min=function(e,t,n){if(!t&&T.isArray(e)&&e[0]===+e[0]&&e.length<65535)return Math.min.apply(Math,e);if(!t&&T.isEmpty(e))return Infinity;var r={computed:Infinity};return N(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},T.shuffle=function(e){var t,n=0,r=[];return N(e,function(e){t=T.random(n++),r[n-1]=r[t],r[t]=e}),r};var k=function(e){return T.isFunction(e)?e:function(t){return t[e]}};T.sortBy=function(e,t,n){var r=k(t);return T.pluck(T.map(e,function(e,t,i){return{value:e,index:t,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||n===void 0)return 1;if(n<r||r===void 0)return-1}return e.index<t.index?-1:1}),"value")};var L=function(e,t,n,r){var i={},s=k(t);return N(e,function(t,o){var u=s.call(n,t,o,e);r(i,u,t)}),i};T.groupBy=function(e,t,n){return L(e,t,n,function(e,t,n){(T.has(e,t)?e[t]:e[t]=[]).push(n)})},T.countBy=function(e,t,n){return L(e,t,n,function(e,t,n){T.has(e,t)||(e[t]=0),e[t]++})},T.sortedIndex=function(e,t,n,r){n=n==null?T.identity:k(n);var i=n.call(r,t),s=0,o=e.length;while(s<o){var u=s+o>>>1;n.call(r,e[u])<i?s=u+1:o=u}return s},T.toArray=function(e){return e?e.length===+e.length?u.call(e):T.values(e):[]},T.size=function(e){return e.length===+e.length?e.length:T.keys(e).length},T.first=T.head=T.take=function(e,t,n){return t!=null&&!n?u.call(e,0,t):e[0]},T.initial=function(e,t,n){return u.call(e,0,e.length-(t==null||n?1:t))},T.last=function(e,t,n){return t!=null&&!n?u.call(e,Math.max(e.length-t,0)):e[e.length-1]},T.rest=T.tail=T.drop=function(e,t,n){return u.call(e,t==null||n?1:t)},T.compact=function(e){return T.filter(e,function(e){return!!e})};var A=function(e,t,n){return N(e,function(e){T.isArray(e)?t?o.apply(n,e):A(e,t,n):n.push(e)}),n};T.flatten=function(e,t){return A(e,t,[])},T.without=function(e){return T.difference(e,u.call(arguments,1))},T.uniq=T.unique=function(e,t,n,r){var i=n?T.map(e,n,r):e,s=[],o=[];return N(i,function(n,r){if(t?!r||o[o.length-1]!==n:!T.contains(o,n))o.push(n),s.push(e[r])}),s},T.union=function(){return T.uniq(a.apply(r,arguments))},T.intersection=function(e){var t=u.call(arguments,1);return T.filter(T.uniq(e),function(e){return T.every(t,function(t){return T.indexOf(t,e)>=0})})},T.difference=function(e){var t=a.apply(r,u.call(arguments,1));return T.filter(e,function(e){return!T.contains(t,e)})},T.zip=function(){var e=u.call(arguments),t=T.max(T.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=T.pluck(e,""+r);return n},T.object=function(e,t){var n={};for(var r=0,i=e.length;r<i;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},T.indexOf=function(e,t,n){var r=0,i=e.length;if(n){if(typeof n!="number")return r=T.sortedIndex(e,t),e[r]===t?r:-1;r=n<0?Math.max(0,i+n):n}if(b&&e.indexOf===b)return e.indexOf(t,n);for(;r<i;r++)if(e[r]===t)return r;return-1},T.lastIndexOf=function(e,t,n){var r=n!=null;if(w&&e.lastIndexOf===w)return r?e.lastIndexOf(t,n):e.lastIndexOf(t);var i=r?n:e.length;while(i--)if(e[i]===t)return i;return-1},T.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var O=function(){};T.bind=function(t,n){var r,i;if(t.bind===x&&x)return x.apply(t,u.call(arguments,1));if(!T.isFunction(t))throw new TypeError;return i=u.call(arguments,2),r=function(){if(this instanceof r){O.prototype=t.prototype;var e=new O,s=t.apply(e,i.concat(u.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(u.call(arguments)))}},T.bindAll=function(e){var t=u.call(arguments,1);return t.length==0&&(t=T.functions(e)),N(t,function(t){e[t]=T.bind(e[t],e)}),e},T.memoize=function(e,t){var n={};return t||(t=T.identity),function(){var r=t.apply(this,arguments);return T.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},T.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},T.defer=function(e){return T.delay.apply(T,[e,1].concat(u.call(arguments,1)))},T.throttle=function(e,t){var n,r,i,s,o,u,a=T.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&(u=e.apply(n,r)),a()};return i||(i=setTimeout(f,t)),s?o=!0:(s=!0,u=e.apply(n,r)),a(),u}},T.debounce=function(e,t,n){var r,i;return function(){var s=this,o=arguments,u=function(){r=null,n||(i=e.apply(s,o))},a=n&&!r;return clearTimeout(r),r=setTimeout(u,t),a&&(i=e.apply(s,o)),i}},T.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments),e=null,n)}},T.wrap=function(e,t){return function(){var n=[e];return o.apply(n,arguments),t.apply(this,n)}},T.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},T.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},T.keys=S||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)T.has(e,n)&&(t[t.length]=n);return t},T.values=function(e){var t=[];for(var n in e)T.has(e,n)&&t.push(e[n]);return t},T.pairs=function(e){var t=[];for(var n in e)T.has(e,n)&&t.push([n,e[n]]);return t},T.invert=function(e){var t={};for(var n in e)T.has(e,n)&&(t[e[n]]=n);return t},T.functions=T.methods=function(e){var t=[];for(var n in e)T.isFunction(e[n])&&t.push(n);return t.sort()},T.extend=function(e){return N(u.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},T.pick=function(e){var t={},n=a.apply(r,u.call(arguments,1));return N(n,function(n){n in e&&(t[n]=e[n])}),t},T.omit=function(e){var t={},n=a.apply(r,u.call(arguments,1));for(var i in e)T.contains(n,i)||(t[i]=e[i]);return t},T.defaults=function(e){return N(u.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},T.clone=function(e){return T.isObject(e)?T.isArray(e)?e.slice():T.extend({},e):e},T.tap=function(e,t){return t(e),e};var M=function(e,t,n,r){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e instanceof T&&(e=e._wrapped),t instanceof T&&(t=t._wrapped);var i=l.call(e);if(i!=l.call(t))return!1;switch(i){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var s=n.length;while(s--)if(n[s]==e)return r[s]==t;n.push(e),r.push(t);var o=0,u=!0;if(i=="[object Array]"){o=e.length,u=o==t.length;if(u)while(o--)if(!(u=M(e[o],t[o],n,r)))break}else{var a=e.constructor,f=t.constructor;if(a!==f&&!(T.isFunction(a)&&a instanceof a&&T.isFunction(f)&&f instanceof f))return!1;for(var c in e)if(T.has(e,c)){o++;if(!(u=T.has(t,c)&&M(e[c],t[c],n,r)))break}if(u){for(c in t)if(T.has(t,c)&&!(o--))break;u=!o}}return n.pop(),r.pop(),u};T.isEqual=function(e,t){return M(e,t,[],[])},T.isEmpty=function(e){if(e==null)return!0;if(T.isArray(e)||T.isString(e))return e.length===0;for(var t in e)if(T.has(e,t))return!1;return!0},T.isElement=function(e){return!!e&&e.nodeType===1},T.isArray=E||function(e){return l.call(e)=="[object Array]"},T.isObject=function(e){return e===Object(e)},N(["Arguments","Function","String","Number","Date","RegExp"],function(e){T["is"+e]=function(t){return l.call(t)=="[object "+e+"]"}}),T.isArguments(arguments)||(T.isArguments=function(e){return!!e&&!!T.has(e,"callee")}),typeof /./!="function"&&(T.isFunction=function(e){return typeof e=="function"}),T.isFinite=function(e){return T.isNumber(e)&&isFinite(e)},T.isNaN=function(e){return T.isNumber(e)&&e!=+e},T.isBoolean=function(e){return e===!0||e===!1||l.call(e)=="[object Boolean]"},T.isNull=function(e){return e===null},T.isUndefined=function(e){return e===void 0},T.has=function(e,t){return c.call(e,t)},T.noConflict=function(){return e._=t,this},T.identity=function(e){return e},T.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},T.random=function(e,t){return t==null&&(t=e,e=0),e+(0|Math.random()*(t-e+1))};var _={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};_.unescape=T.invert(_.escape);var D={escape:new RegExp("["+T.keys(_.escape).join("")+"]","g"),unescape:new RegExp("("+T.keys(_.unescape).join("|")+")","g")};T.each(["escape","unescape"],function(e){T[e]=function(t){return t==null?"":(""+t).replace(D[e],function(t){return _[e][t]})}}),T.result=function(e,t){if(e==null)return null;var n=e[t];return T.isFunction(n)?n.call(e):n},T.mixin=function(e){N(T.functions(e),function(t){var n=T[t]=e[t];T.prototype[t]=function(){var e=[this._wrapped];return o.apply(e,arguments),F.call(this,n.apply(T,e))}})};var P=0;T.uniqueId=function(e){var t=P++;return e?e+t:t},T.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var H=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},j=/\\|'|\r|\n|\t|\u2028|\u2029/g;T.template=function(e,t,n){n=T.defaults({},n,T.templateSettings);var r=new RegExp([(n.escape||H).source,(n.interpolate||H).source,(n.evaluate||H).source].join("|")+"|$","g"),i=0,s="__p+='";e.replace(r,function(t,n,r,o,u){s+=e.slice(i,u).replace(j,function(e){return"\\"+B[e]}),s+=n?"'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":r?"'+\n((__t=("+r+"))==null?'':__t)+\n'":o?"';\n"+o+"\n__p+='":"",i=u+t.length}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{var o=new Function(n.variable||"obj","_",s)}catch(u){throw u.source=s,u}if(t)return o(t,T);var a=function(e){return o.call(this,e,T)};return a.source="function("+(n.variable||"obj")+"){\n"+s+"}",a},T.chain=function(e){return T(e).chain()};var F=function(e){return this._chain?T(e).chain():e};T.mixin(T),N(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];T.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),(e=="shift"||e=="splice")&&n.length===0&&delete n[0],F.call(this,n)}}),N(["concat","join","slice"],function(e){var t=r[e];T.prototype[e]=function(){return F.call(this,t.apply(this._wrapped,arguments))}}),T.extend(T.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),typeof define=="function"&&define.amd&&define("underscore",[],function(){return T})}).call(this),function(e,t){typeof exports=="object"?module.exports=t(global):typeof define=="function"&&define.amd?define("glmatrix",[],function(){return t(e)}):t(e)}(this,function(e){function i(e){return r=e,r}function s(){return r=typeof Float32Array!="undefined"?Float32Array:Array,r}var t=1e-6,n={};(function(){if(typeof Float32Array!="undefined"){var e=new Float32Array(1),t=new Int32Array(e.buffer);n.invsqrt=function(n){var r=n*.5;e[0]=n;var i=1.5;t[0]=1597463007-(t[0]>>1);var s=e[0];return s*(i-r*s*s)}}else n.invsqrt=function(e){return 1/Math.sqrt(e)}})();var r=null;s();var o={};o.create=function(e){var t=new r(3);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):t[0]=t[1]=t[2]=0,t},o.createFrom=function(e,t,n){var i=new r(3);return i[0]=e,i[1]=t,i[2]=n,i},o.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t},o.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n)},o.subtract=function(e,t,n){return!n||e===n?(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e):(n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n)},o.multiply=function(e,t,n){return!n||e===n?(e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e):(n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n)},o.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},o.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e[2]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n)},o.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+r*r+i*i);return s?s===1?(t[0]=n,t[1]=r,t[2]=i,t):(s=1/s,t[0]=n*s,t[1]=r*s,t[2]=i*s,t):(t[0]=0,t[1]=0,t[2]=0,t)},o.cross=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=t[0],u=t[1],a=t[2];return n[0]=i*a-s*u,n[1]=s*o-r*a,n[2]=r*u-i*o,n},o.length=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)},o.squaredLength=function(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},o.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],o=Math.sqrt(r*r+i*i+s*s);return o?(o=1/o,n[0]=r*o,n[1]=i*o,n[2]=s*o,n):(n[0]=0,n[1]=0,n[2]=0,n)},o.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r},o.dist=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)};var u=null,a=new r(4);o.unproject=function(e,t,n,r,i){i||(i=e),u||(u=d.create());var s=u,o=a;return o[0]=(e[0]-r[0])*2/r[2]-1,o[1]=(e[1]-r[1])*2/r[3]-1,o[2]=2*e[2]-1,o[3]=1,d.multiply(n,t,s),d.inverse(s)?(d.multiplyVec4(s,o),o[3]===0?null:(i[0]=o[0]/o[3],i[1]=o[1]/o[3],i[2]=o[2]/o[3],i)):null};var f=o.createFrom(1,0,0),l=o.createFrom(0,1,0),c=o.createFrom(0,0,1),h=o.create();o.rotationTo=function(e,t,n){n||(n=v.create());var r=o.dot(e,t),i=h;if(r>=1)v.set(m,n);else if(r<1e-6-1)o.cross(f,e,i),o.length(i)<1e-6&&o.cross(l,e,i),o.length(i)<1e-6&&o.cross(c,e,i),o.normalize(i),v.fromAngleAxis(Math.PI,i,n);else{var s=Math.sqrt((1+r)*2),u=1/s;o.cross(e,t,i),n[0]=i[0]*u,n[1]=i[1]*u,n[2]=i[2]*u,n[3]=s*.5,v.normalize(n)}return n[3]>1?n[3]=1:n[3]<-1&&(n[3]=-1),n},o.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"};var p={};p.create=function(e){var t=new r(9);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]):t[0]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=0,t},p.createFrom=function(e,t,n,i,s,o,u,a,f){var l=new r(9);return l[0]=e,l[1]=t,l[2]=n,l[3]=i,l[4]=s,l[5]=o,l[6]=u,l[7]=a,l[8]=f,l},p.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*(f*s-o*a)+n*(-f*i+o*u)+r*(a*i-s*u)},p.inverse=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=l*o-u*f,h=-l*s+u*a,d=f*s-o*a,v=n*c+r*h+i*d,m;return v?(m=1/v,t||(t=p.create()),t[0]=c*m,t[1]=(-l*r+i*f)*m,t[2]=(u*r-i*o)*m,t[3]=h*m,t[4]=(l*n-i*a)*m,t[5]=(-u*n+i*s)*m,t[6]=d*m,t[7]=(-f*n+r*a)*m,t[8]=(o*n-r*s)*m,t):null},p.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=t[0],p=t[1],d=t[2],v=t[3],m=t[4],g=t[5],y=t[6],b=t[7],w=t[8];return n[0]=h*r+p*o+d*f,n[1]=h*i+p*u+d*l,n[2]=h*s+p*a+d*c,n[3]=v*r+m*o+g*f,n[4]=v*i+m*u+g*l,n[5]=v*s+m*a+g*c,n[6]=y*r+b*o+w*f,n[7]=y*i+b*u+w*l,n[8]=y*s+b*a+w*c,n},p.multiplyVec2=function(e,t,n){n||(n=t);var r=t[0],i=t[1];return n[0]=r*e[0]+i*e[3]+e[6],n[1]=r*e[1]+i*e[4]+e[7],n},p.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];return n[0]=r*e[0]+i*e[3]+s*e[6],n[1]=r*e[1]+i*e[4]+s*e[7],n[2]=r*e[2]+i*e[5]+s*e[8],n},p.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},p.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t&&Math.abs(e[4]-n[4])<t&&Math.abs(e[5]-n[5])<t&&Math.abs(e[6]-n[6])<t&&Math.abs(e[7]-n[7])<t&&Math.abs(e[8]-n[8])<t},p.identity=function(e){return e||(e=p.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},p.transpose=function(e,t){if(!t||e===t){var n=e[1],r=e[2],i=e[5];return e[1]=e[3],e[2]=e[6],e[3]=n,e[5]=e[7],e[6]=r,e[7]=i,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},p.toMat4=function(e,t){return t||(t=d.create()),t[15]=1,t[14]=0,t[13]=0,t[12]=0,t[11]=0,t[10]=e[8],t[9]=e[7],t[8]=e[6],t[7]=0,t[6]=e[5],t[5]=e[4],t[4]=e[3],t[3]=0,t[2]=e[2],t[1]=e[1],t[0]=e[0],t},p.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"};var d={};d.create=function(e){var t=new r(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},d.createFrom=function(e,t,n,i,s,o,u,a,f,l,c,h,p,d,v,m){var g=new r(16);return g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=s,g[5]=o,g[6]=u,g[7]=a,g[8]=f,g[9]=l,g[10]=c,g[11]=h,g[12]=p,g[13]=d,g[14]=v,g[15]=m,g},d.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},d.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t&&Math.abs(e[4]-n[4])<t&&Math.abs(e[5]-n[5])<t&&Math.abs(e[6]-n[6])<t&&Math.abs(e[7]-n[7])<t&&Math.abs(e[8]-n[8])<t&&Math.abs(e[9]-n[9])<t&&Math.abs(e[10]-n[10])<t&&Math.abs(e[11]-n[11])<t&&Math.abs(e[12]-n[12])<t&&Math.abs(e[13]-n[13])<t&&Math.abs(e[14]-n[14])<t&&Math.abs(e[15]-n[15])<t},d.identity=function(e){return e||(e=d.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},d.transpose=function(e,t){if(!t||e===t){var n=e[1],r=e[2],i=e[3],s=e[6],o=e[7],u=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=n,e[6]=e[9],e[7]=e[13],e[8]=r,e[9]=s,e[11]=e[14],e[12]=i,e[13]=o,e[14]=u,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},d.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m},d.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=e[9],h=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T,M;return O?(M=1/O,t[0]=(u*A-a*L+f*k)*M,t[1]=(-r*A+i*L-s*k)*M,t[2]=(v*x-m*S+g*E)*M,t[3]=(-c*x+h*S-p*E)*M,t[4]=(-o*A+a*C-f*N)*M,t[5]=(n*A-i*C+s*N)*M,t[6]=(-d*x+m*w-g*b)*M,t[7]=(l*x-h*w+p*b)*M,t[8]=(o*L-u*C+f*T)*M,t[9]=(-n*L+r*C-s*T)*M,t[10]=(d*S-v*w+g*y)*M,t[11]=(-l*S+c*w-p*y)*M,t[12]=(-o*k+u*N-a*T)*M,t[13]=(n*k-r*N+i*T)*M,t[14]=(-d*E+v*b-m*y)*M,t[15]=(l*E-c*b+h*y)*M,t):null},d.toRotationMat=function(e,t){return t||(t=d.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},d.toMat3=function(e,t){return t||(t=p.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},d.toInverseMat3=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[4],o=e[5],u=e[6],a=e[8],f=e[9],l=e[10],c=l*o-u*f,h=-l*s+u*a,d=f*s-o*a,v=n*c+r*h+i*d,m;return v?(m=1/v,t||(t=p.create()),t[0]=c*m,t[1]=(-l*r+i*f)*m,t[2]=(u*r-i*o)*m,t[3]=h*m,t[4]=(l*n-i*a)*m,t[5]=(-u*n+i*s)*m,t[6]=d*m,t[7]=(-f*n+r*a)*m,t[8]=(o*n-r*s)*m,t):null},d.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=e[4],a=e[5],f=e[6],l=e[7],c=e[8],h=e[9],p=e[10],d=e[11],v=e[12],m=e[13],g=e[14],y=e[15],b=t[0],w=t[1],E=t[2],S=t[3];return n[0]=b*r+w*u+E*c+S*v,n[1]=b*i+w*a+E*h+S*m,n[2]=b*s+w*f+E*p+S*g,n[3]=b*o+w*l+E*d+S*y,b=t[4],w=t[5],E=t[6],S=t[7],n[4]=b*r+w*u+E*c+S*v,n[5]=b*i+w*a+E*h+S*m,n[6]=b*s+w*f+E*p+S*g,n[7]=b*o+w*l+E*d+S*y,b=t[8],w=t[9],E=t[10],S=t[11],n[8]=b*r+w*u+E*c+S*v,n[9]=b*i+w*a+E*h+S*m,n[10]=b*s+w*f+E*p+S*g,n[11]=b*o+w*l+E*d+S*y,b=t[12],w=t[13],E=t[14],S=t[15],n[12]=b*r+w*u+E*c+S*v,n[13]=b*i+w*a+E*h+S*m,n[14]=b*s+w*f+E*p+S*g,n[15]=b*o+w*l+E*d+S*y,n},d.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12],n[1]=e[1]*r+e[5]*i+e[9]*s+e[13],n[2]=e[2]*r+e[6]*i+e[10]*s+e[14],n},d.multiplyVec4=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2],o=t[3];return n[0]=e[0]*r+e[4]*i+e[8]*s+e[12]*o,n[1]=e[1]*r+e[5]*i+e[9]*s+e[13]*o,n[2]=e[2]*r+e[6]*i+e[10]*s+e[14]*o,n[3]=e[3]*r+e[7]*i+e[11]*s+e[15]*o,n},d.translate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o,u,a,f,l,c,h,p,d,v,m,g;return!n||e===n?(e[12]=e[0]*r+e[4]*i+e[8]*s+e[12],e[13]=e[1]*r+e[5]*i+e[9]*s+e[13],e[14]=e[2]*r+e[6]*i+e[10]*s+e[14],e[15]=e[3]*r+e[7]*i+e[11]*s+e[15],e):(o=e[0],u=e[1],a=e[2],f=e[3],l=e[4],c=e[5],h=e[6],p=e[7],d=e[8],v=e[9],m=e[10],g=e[11],n[0]=o,n[1]=u,n[2]=a,n[3]=f,n[4]=l,n[5]=c,n[6]=h,n[7]=p,n[8]=d,n[9]=v,n[10]=m,n[11]=g,n[12]=o*r+l*i+d*s+e[12],n[13]=u*r+c*i+v*s+e[13],n[14]=a*r+h*i+m*s+e[14],n[15]=f*r+p*i+g*s+e[15],n)},d.scale=function(e,t,n){var r=t[0],i=t[1],s=t[2];return!n||e===n?(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,e[8]*=s,e[9]*=s,e[10]*=s,e[11]*=s,e):(n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*i,n[5]=e[5]*i,n[6]=e[6]*i,n[7]=e[7]*i,n[8]=e[8]*s,n[9]=e[9]*s,n[10]=e[10]*s,n[11]=e[11]*s,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n)},d.rotate=function(e,t,n,r){var i=n[0],s=n[1],o=n[2],u=Math.sqrt(i*i+s*s+o*o),a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M;return u?(u!==1&&(u=1/u,i*=u,s*=u,o*=u),a=Math.sin(t),f=Math.cos(t),l=1-f,c=e[0],h=e[1],p=e[2],d=e[3],v=e[4],m=e[5],g=e[6],y=e[7],b=e[8],w=e[9],E=e[10],S=e[11],x=i*i*l+f,T=s*i*l+o*a,N=o*i*l-s*a,C=i*s*l-o*a,k=s*s*l+f,L=o*s*l+i*a,A=i*o*l+s*a,O=s*o*l-i*a,M=o*o*l+f,r?e!==r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=c*x+v*T+b*N,r[1]=h*x+m*T+w*N,r[2]=p*x+g*T+E*N,r[3]=d*x+y*T+S*N,r[4]=c*C+v*k+b*L,r[5]=h*C+m*k+w*L,r[6]=p*C+g*k+E*L,r[7]=d*C+y*k+S*L,r[8]=c*A+v*O+b*M,r[9]=h*A+m*O+w*M,r[10]=p*A+g*O+E*M,r[11]=d*A+y*O+S*M,r):null},d.rotateX=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11];return n?e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[4]=s*i+f*r,n[5]=o*i+l*r,n[6]=u*i+c*r,n[7]=a*i+h*r,n[8]=s*-r+f*i,n[9]=o*-r+l*i,n[10]=u*-r+c*i,n[11]=a*-r+h*i,n},d.rotateY=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[8],l=e[9],c=e[10],h=e[11];return n?e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*i+f*-r,n[1]=o*i+l*-r,n[2]=u*i+c*-r,n[3]=a*i+h*-r,n[8]=s*r+f*i,n[9]=o*r+l*i,n[10]=u*r+c*i,n[11]=a*r+h*i,n},d.rotateZ=function(e,t,n){var r=Math.sin(t),i=Math.cos(t),s=e[0],o=e[1],u=e[2],a=e[3],f=e[4],l=e[5],c=e[6],h=e[7];return n?e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=s*i+f*r,n[1]=o*i+l*r,n[2]=u*i+c*r,n[3]=a*i+h*r,n[4]=s*-r+f*i,n[5]=o*-r+l*i,n[6]=u*-r+c*i,n[7]=a*-r+h*i,n},d.frustum=function(e,t,n,r,i,s,o){o||(o=d.create());var u=t-e,a=r-n,f=s-i;return o[0]=i*2/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=i*2/a,o[6]=0,o[7]=0,o[8]=(t+e)/u,o[9]=(r+n)/a,o[10]=-(s+i)/f,o[11]=-1,o[12]=0,o[13]=0,o[14]=-(s*i*2)/f,o[15]=0,o},d.perspective=function(e,t,n,r,i){var s=n*Math.tan(e*Math.PI/360),o=s*t;return d.frustum(-o,o,-s,s,n,r,i)},d.ortho=function(e,t,n,r,i,s,o){o||(o=d.create());var u=t-e,a=r-n,f=s-i;return o[0]=2/u,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/a,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/f,o[11]=0,o[12]=-(e+t)/u,o[13]=-(r+n)/a,o[14]=-(s+i)/f,o[15]=1,o},d.lookAt=function(e,t,n,r){r||(r=d.create());var i,s,o,u,a,f,l,c,h,p,v=e[0],m=e[1],g=e[2],y=n[0],b=n[1],w=n[2],E=t[0],S=t[1],x=t[2];return v===E&&m===S&&g===x?d.identity(r):(l=v-E,c=m-S,h=g-x,p=1/Math.sqrt(l*l+c*c+h*h),l*=p,c*=p,h*=p,i=b*h-w*c,s=w*l-y*h,o=y*c-b*l,p=Math.sqrt(i*i+s*s+o*o),p?(p=1/p,i*=p,s*=p,o*=p):(i=0,s=0,o=0),u=c*o-h*s,a=h*i-l*o,f=l*s-c*i,p=Math.sqrt(u*u+a*a+f*f),p?(p=1/p,u*=p,a*=p,f*=p):(u=0,a=0,f=0),r[0]=i,r[1]=u,r[2]=l,r[3]=0,r[4]=s,r[5]=a,r[6]=c,r[7]=0,r[8]=o,r[9]=f,r[10]=h,r[11]=0,r[12]=-(i*v+s*m+o*g),r[13]=-(u*v+a*m+f*g),r[14]=-(l*v+c*m+h*g),r[15]=1,r)},d.fromRotationTranslation=function(e,t,n){n||(n=d.create());var r=e[0],i=e[1],s=e[2],o=e[3],u=r+r,a=i+i,f=s+s,l=r*u,c=r*a,h=r*f,p=i*a,v=i*f,m=s*f,g=o*u,y=o*a,b=o*f;return n[0]=1-(p+m),n[1]=c+b,n[2]=h-y,n[3]=0,n[4]=c-b,n[5]=1-(l+m),n[6]=v+g,n[7]=0,n[8]=h+y,n[9]=v-g,n[10]=1-(l+p),n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1,n},d.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"};var v={};v.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},v.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},v.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},v.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},v.identity=function(e){return e||(e=v.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e};var m=v.identity();v.calculateW=function(e,t){var n=e[0],r=e[1],i=e[2];return!t||e===t?(e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e):(t[0]=n,t[1]=r,t[2]=i,t[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t)},v.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},v.inverse=function(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=n*n+r*r+i*i+s*s,u=o?1/o:0;return!t||e===t?(e[0]*=-u,e[1]*=-u,e[2]*=-u,e[3]*=u,e):(t[0]=-e[0]*u,t[1]=-e[1]*u,t[2]=-e[2]*u,t[3]=e[3]*u,t)},v.conjugate=function(e,t){return!t||e===t?(e[0]*=-1,e[1]*=-1,e[2]*=-1,e):(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t)},v.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},v.normalize=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=Math.sqrt(n*n+r*r+i*i+s*s);return o===0?(t[0]=0,t[1]=0,t[2]=0,t[3]=0,t):(o=1/o,t[0]=n*o,t[1]=r*o,t[2]=i*o,t[3]=s*o,t)},v.add=function(e,t,n){return!n||e===n?(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[3],e):(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n)},v.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=t[0],a=t[1],f=t[2],l=t[3];return n[0]=r*l+o*u+i*f-s*a,n[1]=i*l+o*a+s*u-r*f,n[2]=s*l+o*f+r*a-i*u,n[3]=o*l-r*u-i*a-s*f,n},v.multiplyVec3=function(e,t,n){n||(n=t);var r=t[0],i=t[1],s=t[2],o=e[0],u=e[1],a=e[2],f=e[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return n[0]=l*f+p*-o+c*-a-h*-u,n[1]=c*f+p*-u+h*-o-l*-a,n[2]=h*f+p*-a+l*-u-c*-o,n},v.scale=function(e,t,n){return!n||e===n?(e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e):(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n)},v.toMat3=function(e,t){t||(t=p.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,d=r*a,v=i*a,m=s*o,g=s*u,y=s*a;return t[0]=1-(h+v),t[1]=l+y,t[2]=c-g,t[3]=l-y,t[4]=1-(f+v),t[5]=d+m,t[6]=c+g,t[7]=d-m,t[8]=1-(f+h),t},v.toMat4=function(e,t){t||(t=d.create());var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,v=i*a,m=s*o,g=s*u,y=s*a;return t[0]=1-(h+v),t[1]=l+y,t[2]=c-g,t[3]=0,t[4]=l-y,t[5]=1-(f+v),t[6]=p+m,t[7]=0,t[8]=c+g,t[9]=p-m,t[10]=1-(f+h),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},v.slerp=function(e,t,n,r){r||(r=e);var i=e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],s,o,u,a;return Math.abs(i)>=1?(r!==e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3]),r):(s=Math.acos(i),o=Math.sqrt(1-i*i),Math.abs(o)<.001?(r[0]=e[0]*.5+t[0]*.5,r[1]=e[1]*.5+t[1]*.5,r[2]=e[2]*.5+t[2]*.5,r[3]=e[3]*.5+t[3]*.5,r):(u=Math.sin((1-n)*s)/o,a=Math.sin(n*s)/o,r[0]=e[0]*u+t[0]*a,r[1]=e[1]*u+t[1]*a,r[2]=e[2]*u+t[2]*a,r[3]=e[3]*u+t[3]*a,r))},v.fromRotationMatrix=function(e,t){t||(t=v.create());var n=e[0]+e[4]+e[8],r;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[7]-e[5])*r,t[1]=(e[2]-e[6])*r,t[2]=(e[3]-e[1])*r;else{var i=v.fromRotationMatrix.s_iNext=v.fromRotationMatrix.s_iNext||[1,2,0],s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);var o=i[s],u=i[o];r=Math.sqrt(e[s*3+s]-e[o*3+o]-e[u*3+u]+1),t[s]=.5*r,r=.5/r,t[3]=(e[u*3+o]-e[o*3+u])*r,t[o]=(e[o*3+s]+e[s*3+o])*r,t[u]=(e[u*3+s]+e[s*3+u])*r}return t},p.toQuat4=v.fromRotationMatrix,function(){var e=p.create();v.fromAxes=function(t,n,r,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=t[0],e[5]=t[1],e[8]=t[2],v.fromRotationMatrix(e,i)}}(),v.identity=function(e){return e||(e=v.create()),e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},v.fromAngleAxis=function(e,t,n){n||(n=v.create());var r=e*.5,i=Math.sin(r);return n[3]=Math.cos(r),n[0]=i*t[0],n[1]=i*t[1],n[2]=i*t[2],n},v.toAngleAxis=function(e,t){t||(t=e);var r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){t[3]=2*Math.acos(e[3]);var i=n.invsqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}else t[3]=0,t[0]=1,t[1]=0,t[2]=0;return t},v.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var g={};g.create=function(e){var t=new r(2);return e?(t[0]=e[0],t[1]=e[1]):(t[0]=0,t[1]=0),t},g.createFrom=function(e,t){var n=new r(2);return n[0]=e,n[1]=t,n},g.add=function(e,t,n){return n||(n=t),n[0]=e[0]+t[0],n[1]=e[1]+t[1],n},g.subtract=function(e,t,n){return n||(n=t),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n},g.multiply=function(e,t,n){return n||(n=t),n[0]=e[0]*t[0],n[1]=e[1]*t[1],n},g.divide=function(e,t,n){return n||(n=t),n[0]=e[0]/t[0],n[1]=e[1]/t[1],n},g.scale=function(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n},g.dist=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)},g.set=function(e,t){return t[0]=e[0],t[1]=e[1],t},g.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t},g.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t},g.normalize=function(e,t){t||(t=e);var n=e[0]*e[0]+e[1]*e[1];return n>0?(n=Math.sqrt(n),t[0]=e[0]/n,t[1]=e[1]/n):t[0]=t[1]=0,t},g.cross=function(e,t,n){var r=e[0]*t[1]-e[1]*t[0];return n?(n[0]=n[1]=0,n[2]=r,n):r},g.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},g.squaredLength=function(e){var t=e[0],n=e[1];return t*t+n*n},g.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},g.direction=function(e,t,n){n||(n=e);var r=e[0]-t[0],i=e[1]-t[1],s=r*r+i*i;return s?(s=1/Math.sqrt(s),n[0]=r*s,n[1]=i*s,n):(n[0]=0,n[1]=0,n[2]=0,n)},g.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r},g.str=function(e){return"["+e[0]+", "+e[1]+"]"};var y={};y.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):t[0]=t[1]=t[2]=t[3]=0,t},y.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},y.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},y.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},y.identity=function(e){return e||(e=y.create()),e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},y.transpose=function(e,t){if(!t||e===t){var n=e[1];return e[1]=e[2],e[2]=n,e}return t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3],t},y.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},y.inverse=function(e,t){t||(t=e);var n=e[0],r=e[1],i=e[2],s=e[3],o=n*s-i*r;return o?(o=1/o,t[0]=s*o,t[1]=-r*o,t[2]=-i*o,t[3]=n*o,t):null},y.multiply=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3];return n[0]=r*t[0]+i*t[2],n[1]=r*t[1]+i*t[3],n[2]=s*t[0]+o*t[2],n[3]=s*t[1]+o*t[3],n},y.rotate=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=Math.sin(t),a=Math.cos(t);return n[0]=r*a+i*u,n[1]=r*-u+i*a,n[2]=s*a+o*u,n[3]=s*-u+o*a,n},y.multiplyVec2=function(e,t,n){n||(n=t);var r=t[0],i=t[1];return n[0]=r*e[0]+i*e[1],n[1]=r*e[2]+i*e[3],n},y.scale=function(e,t,n){n||(n=e);var r=e[0],i=e[1],s=e[2],o=e[3],u=t[0],a=t[1];return n[0]=r*u,n[1]=i*a,n[2]=s*u,n[3]=o*a,n},y.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"};var b={};return b.create=function(e){var t=new r(4);return e?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]):(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t},b.createFrom=function(e,t,n,i){var s=new r(4);return s[0]=e,s[1]=t,s[2]=n,s[3]=i,s},b.add=function(e,t,n){return n||(n=t),n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n},b.subtract=function(e,t,n){return n||(n=t),n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n},b.multiply=function(e,t,n){return n||(n=t),n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n},b.divide=function(e,t,n){return n||(n=t),n[0]=e[0]/t[0],n[1]=e[1]/t[1],n[2]=e[2]/t[2],n[3]=e[3]/t[3],n},b.scale=function(e,t,n){return n||(n=e),n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n},b.set=function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},b.equal=function(e,n){return e===n||Math.abs(e[0]-n[0])<t&&Math.abs(e[1]-n[1])<t&&Math.abs(e[2]-n[2])<t&&Math.abs(e[3]-n[3])<t},b.negate=function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},b.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},b.squaredLength=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i},b.lerp=function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r[3]=e[3]+n*(t[3]-e[3]),r},b.str=function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+"]"},e&&(e.glMatrixArrayType=r,e.MatrixArray=r,e.setMatrixArrayType=i,e.determineMatrixArrayType=s,e.glMath=n,e.vec2=g,e.vec3=o,e.vec4=b,e.mat2=y,e.mat3=p,e.mat4=d,e.quat4=v),{glMatrixArrayType:r,MatrixArray:r,setMatrixArrayType:i,determineMatrixArrayType:s,glMath:n,vec2:g,vec3:o,vec4:b,mat2:y,mat3:p,mat4:d,quat4:v}}),define("common/qmath",["glmatrix"],function(e){function i(e){if(!e)return 0;var t=0,n=0,i;for(var s=0,o=r.length;s<o;s++)i=vec3.dot(e,r[s]),i>n&&(n=i,t=s);return t}function s(e,t){if(e<0||e>=r.length){vec3.create(t);return}vec3.set(r[e],t)}function o(e,t){return Math.random()*(t-e)+e}function u(e,t){return Math.floor(Math.random()*(t-e+1))+e}function a(){return 2*(Math.random()-.5)}function f(e){e[0]=Math.round(e[0]),e[1]=Math.round(e[1]),e[2]=Math.round(e[2])}function l(e,t){var n,r,i=1;for(var n=0,r=0;n<3;n++)Math.abs(e[n])<i&&(r=n,i=Math.abs(e[n]));var s=vec3.create();s[r]=1,X(s,e,t),vec3.normalize(t)}function d(e){return e*Math.PI/180}function v(e){return e*180/Math.PI}function m(e,t){var n=e-t;while(n>180)n-=360;while(n<-180)n+=360;return n}function g(e,t,n){n[0]=m(e[0],t[0]),n[1]=m(e[1],t[1]),n[2]=m(e[2],t[2])}function y(e,t,n){return t-e>180&&(t-=360),t-e<-180&&(t+=360),e+n*(t-e)}function b(e){return e=360/65536*(parseInt(e*(65536/360),10)&65535),e}function w(e){return e=b(e),e>180&&(e-=360),e}function E(e,t,n,r){var i,s,o,u,a,f,l;i=e[h]*(Math.PI*2/360),u=Math.sin(i),l=Math.cos(i),i=e[c]*(Math.PI*2/360),o=Math.sin(i),f=Math.cos(i),i=e[p]*(Math.PI*2/360),s=Math.sin(i),a=Math.cos(i),t&&(t[0]=f*l,t[1]=f*u,t[2]=-o),n&&(n[0]=-1*s*o*l+ -1*a*-u,n[1]=-1*s*o*u+ -1*a*l,n[2]=-1*s*f),r&&(r[0]=a*o*l+ -s*-u,r[1]=a*o*u+ -s*l,r[2]=a*f)}function S(e,t){var n,r,i;e[1]===0&&e[0]===0?(r=0,i=e[2]>0?90:270):(e[0]?r=Math.atan2(e[1],e[0])*180/Math.PI:e[1]>0?r=90:r=270,r<0&&(r+=360),n=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=Math.atan2(e[2],n)*180/Math.PI,i<0&&(i+=360)),t[c]=-i,t[h]=r,t[p]=0}function x(e){return e*65536/360&65535}function T(e){return e*(360/65536)}function N(e){e[0][0]=1,e[0][1]=0,e[0][2]=0,e[1][0]=0,e[1][1]=1,e[1][2]=0,e[2][0]=0,e[2][1]=0,e[2][2]=1}function C(e,t){vec3.set(e[0],t[0]),vec3.set(e[1],t[1]),vec3.set(e[2],t[2])}function k(e,t){E(e,t[0],t[1],t[2]),vec3.negate(t[1])}function L(e,t,n){n[0][0]=e[0][0]*t[0][0]+e[0][1]*t[1][0]+e[0][2]*t[2][0],n[0][1]=e[0][0]*t[0][1]+e[0][1]*t[1][1]+e[0][2]*t[2][1],n[0][2]=e[0][0]*t[0][2]+e[0][1]*t[1][2]+e[0][2]*t[2][2],n[1][0]=e[1][0]*t[0][0]+e[1][1]*t[1][0]+e[1][2]*t[2][0],n[1][1]=e[1][0]*t[0][1]+e[1][1]*t[1][1]+e[1][2]*t[2][1],n[1][2]=e[1][0]*t[0][2]+e[1][1]*t[1][2]+e[1][2]*t[2][2],n[2][0]=e[2][0]*t[0][0]+e[2][1]*t[1][0]+e[2][2]*t[2][0],n[2][1]=e[2][0]*t[0][1]+e[2][1]*t[1][1]+e[2][2]*t[2][1],n[2][2]=e[2][0]*t[0][2]+e[2][1]*t[1][2]+e[2][2]*t[2][2]}function A(e,t){var n=vec3.create(e);e[0]=vec3.dot(t[0],n),e[1]=vec3.dot(t[1],n),e[2]=vec3.dot(t[2],n)}function O(e,t,n,r){var i=mat4.identity();mat4.rotate(i,d(n),t),mat4.multiplyVec3(i,e,r)}function M(e,t){l(e[0],e[1]);if(t){var n=vec3.create(e[1]);O(n,e[0],t,e[1])}vec3.cross(e[0],e[1],e[2])}function R(e){return e[0]==1?_:e[1]==1?D:e[2]==1?P:H}function U(e){var t=0;for(var n=0;n<3;n++)e[n]<0&&(t|=1<<n);return t}function z(e,t){var n=vec3.dot(e,t.normal)-t.dist;return n>I?B:n<-I?j:F}function W(e,t,n){if(n.type<H)return n.dist<=e[n.type]?B:n.dist>=t[n.type]?j:F;var r=[0,0];if(n.signbits<8)for(var i=0;i<3;i++){var s=n.signbits>>i&1;r[s]+=n.normal[i]*t[i],r[s^1]+=n.normal[i]*e[i]}var o=0;return r[0]>=n.dist&&(o=B),r[1]<n.dist&&(o|=j),o}function X(e,t,n){var r=vec3.scale(t,vec3.dot(t,e),vec3.create());vec3.subtract(e,r,n)}function V(e,t,n){var r=new q,i=vec3.subtract(t,e,vec3.create()),s=vec3.subtract(n,e,vec3.create());return vec3.cross(s,i,r.normal),vec3.normalize(r.normal),vec3.length(r.normal)===0?null:(r.dist=vec3.dot(e,r.normal),r.signbits=U(r.normal),r)}function K(e,t){return Math.abs(e.normal[0]-t.normal[0])<$&&Math.abs(e.normal[1]-t.normal[1])<$&&Math.abs(e.normal[2]-t.normal[2])<$&&Math.abs(e.dist-t.dist)<J?!0:!1}function Z(e,t){var n=-Q,r,i=-1;for(var s=0;s<3;s++)r=Math.abs(e[s]),r>n&&(i=s,n=r);i===-1&&com.Error("BaseWindingForPlane: no axis found");var o=vec3.create(),u=vec3.create(),a=vec3.create();switch(i){case 0:case 1:o[2]=1;break;case 2:o[0]=1}var r=vec3.dot(o,e);vec3.add(o,vec3.scale(e,-r,vec3.create())),vec3.normalize(o),vec3.scale(e,t,u),vec3.cross(o,e,a),vec3.scale(o,Q),vec3.scale(a,Q);var f=new Y;return f.p[0]=vec3.subtract(u,a,vec3.create()),vec3.add(f.p[0],o,f.p[0]),f.p[1]=vec3.add(u,a,vec3.create()),vec3.add(f.p[1],o,f.p[1]),f.p[2]=vec3.add(u,a,vec3.create()),vec3.subtract(f.p[2],o,f.p[2]),f.p[3]=vec3.subtract(u,a,vec3.create()),vec3.subtract(f.p[3],o,f.p[3]),f}function et(e,t,n){var r;t[0]=t[1]=t[2]=Q,n[0]=n[1]=n[2]=-Q;for(var i=0;i<e.p.length;i++)for(var s=0;s<3;s++)r=e.p[i][s],r<t[s]&&(t[s]=r),r>n[s]&&(n[s]=r)}function tt(e,t,n,r){var i,s,o,u,a,f=new Array(G+4),l=new Array(G+4),c=vec3.create(),h=vec3.create(),p=e.clone();for(i=0;i<p.p.length;i++)o=f[i]=vec3.dot(p.p[i],t)-n,o>r?l[i]=B:o<-r?l[i]=j:l[i]=F,c[l[i]]++;l[i]=l[0],f[i]=f[0];if(!c[B])return!1;if(!c[j])return!0;var d=new Y,v=p.p.length+4;for(i=0;i<p.p.length;i++){u=p.p[i];if(l[i]===F){d.p.push(vec3.set(u,vec3.create()));continue}l[i]===B&&d.p.push(vec3.set(u,vec3.create()));if(l[i+1]===F||l[i+1]===l[i])continue;a=p.p[(i+1)%p.p.length],o=f[i]/(f[i]-f[i+1]);for(var s=0;s<3;s++)t[s]===1?h[s]=n:t[s]===-1?h[s]=-n:h[s]=u[s]+o*(a[s]-u[s]);d.p.push(vec3.set(h,vec3.create()))}return d.p.length>v&&com.Error("ClipWinding: points exceeded estimate"),d.p.length>G&&com.Error("ClipWinding: MAX_POINTS_ON_WINDING"),d.clone(e),!0}function nt(e,t){var n,r,i=vec3.create();for(var s=0;s<3;s++)n=Math.abs(e[s]),r=Math.abs(t[s]),i[s]=n>r?n:r;return vec3.length(i)}function rt(e,t){e[0]=e[1]=e[2]=99999,t[0]=t[1]=t[2]=-99999}function it(e,t,n){e[0]<t[0]&&(t[0]=e[0]),e[0]>n[0]&&(n[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>n[1]&&(n[1]=e[1]),e[2]<t[2]&&(t[2]=e[2]),e[2]>n[2]&&(n[2]=e[2])}function st(e,t,n,r,i){return i=i||0,t[0]<n[0]-i||t[1]<n[1]-i||t[2]<n[2]-i||e[0]>r[0]+i||e[1]>r[1]+i||e[2]>r[2]+i?!1:!0}function ot(e,t,n){return n[0]>t[0]||n[0]<e[0]||n[1]>t[1]||n[1]<e[1]||n[2]>t[2]||n[2]<e[2]?!1:!0}function at(e,t,n,r){var i=r-n,s=new Array(i),o=[].concat(ut),u=[].concat(ut),a=[].concat(ut),f=[].concat(ut),l=0,c,h=0,p,d=0,v,m=0,g,y;for(y=n;y<r;y++)c=e[y][t]&255,p=e[y][t]>>8&255,v=e[y][t]>>16&255,g=e[y][t]>>24&255^128,o[c]++,u[p]++,a[v]++,f[g]++;for(y=0;y<256;y++)c=l+o[y],p=h+u[y],v=d+a[y],g=m+f[y],o[y]=l,u[y]=h,a[y]=d,f[y]=m,l=c,h=p,d=v,m=g;for(y=n;y<r;y++)c=e[y][t]&255,s[o[c]]=e[y],o[c]++;for(y=0;y<i;y++)p=s[y][t]>>8&255,e[n+u[p]]=s[y],u[p]++;for(y=n;y<r;y++)v=e[y][t]>>16&255,s[a[v]]=e[y],a[v]++;for(y=0;y<i;y++)g=s[y][t]>>24&255^128,e[n+f[g]]=s[y],f[g]++;return e}var t=vec3.create(),n=[vec3.createFrom(1,0,0),vec3.createFrom(0,1,0),vec3.createFrom(0,0,1)],r=[[-0.525731,0,.850651],[-0.442863,.238856,.864188],[-0.295242,0,.955423],[-0.309017,.5,.809017],[-0.16246,.262866,.951056],[0,0,1],[0,.850651,.525731],[-0.147621,.716567,.681718],[.147621,.716567,.681718],[0,.525731,.850651],[.309017,.5,.809017],[.525731,0,.850651],[.295242,0,.955423],[.442863,.238856,.864188],[.16246,.262866,.951056],[-0.681718,.147621,.716567],[-0.809017,.309017,.5],[-0.587785,.425325,.688191],[-0.850651,.525731,0],[-0.864188,.442863,.238856],[-0.716567,.681718,.147621],[-0.688191,.587785,.425325],[-0.5,.809017,.309017],[-0.238856,.864188,.442863],[-0.425325,.688191,.587785],[-0.716567,.681718,-0.147621],[-0.5,.809017,-0.309017],[-0.525731,.850651,0],[0,.850651,-0.525731],[-0.238856,.864188,-0.442863],[0,.955423,-0.295242],[-0.262866,.951056,-0.16246],[0,1,0],[0,.955423,.295242],[-0.262866,.951056,.16246],[.238856,.864188,.442863],[.262866,.951056,.16246],[.5,.809017,.309017],[.238856,.864188,-0.442863],[.262866,.951056,-0.16246],[.5,.809017,-0.309017],[.850651,.525731,0],[.716567,.681718,.147621],[.716567,.681718,-0.147621],[.525731,.850651,0],[.425325,.688191,.587785],[.864188,.442863,.238856],[.688191,.587785,.425325],[.809017,.309017,.5],[.681718,.147621,.716567],[.587785,.425325,.688191],[.955423,.295242,0],[1,0,0],[.951056,.16246,.262866],[.850651,-0.525731,0],[.955423,-0.295242,0],[.864188,-0.442863,.238856],[.951056,-0.16246,.262866],[.809017,-0.309017,.5],[.681718,-0.147621,.716567],[.850651,0,.525731],[.864188,.442863,-0.238856],[.809017,.309017,-0.5],[.951056,.16246,-0.262866],[.525731,0,-0.850651],[.681718,.147621,-0.716567],[.681718,-0.147621,-0.716567],[.850651,0,-0.525731],[.809017,-0.309017,-0.5],[.864188,-0.442863,-0.238856],[.951056,-0.16246,-0.262866],[.147621,.716567,-0.681718],[.309017,.5,-0.809017],[.425325,.688191,-0.587785],[.442863,.238856,-0.864188],[.587785,.425325,-0.688191],[.688191,.587785,-0.425325],[-0.147621,.716567,-0.681718],[-0.309017,.5,-0.809017],[0,.525731,-0.850651],[-0.525731,0,-0.850651],[-0.442863,.238856,-0.864188],[-0.295242,0,-0.955423],[-0.16246,.262866,-0.951056],[0,0,-1],[.295242,0,-0.955423],[.16246,.262866,-0.951056],[-0.442863,-0.238856,-0.864188],[-0.309017,-0.5,-0.809017],[-0.16246,-0.262866,-0.951056],[0,-0.850651,-0.525731],[-0.147621,-0.716567,-0.681718],[.147621,-0.716567,-0.681718],[0,-0.525731,-0.850651],[.309017,-0.5,-0.809017],[.442863,-0.238856,-0.864188],[.16246,-0.262866,-0.951056],[.238856,-0.864188,-0.442863],[.5,-0.809017,-0.309017],[.425325,-0.688191,-0.587785],[.716567,-0.681718,-0.147621],[.688191,-0.587785,-0.425325],[.587785,-0.425325,-0.688191],[0,-0.955423,-0.295242],[0,-1,0],[.262866,-0.951056,-0.16246],[0,-0.850651,.525731],[0,-0.955423,.295242],[.238856,-0.864188,.442863],[.262866,-0.951056,.16246],[.5,-0.809017,.309017],[.716567,-0.681718,.147621],[.525731,-0.850651,0],[-0.238856,-0.864188,-0.442863],[-0.5,-0.809017,-0.309017],[-0.262866,-0.951056,-0.16246],[-0.850651,-0.525731,0],[-0.716567,-0.681718,-0.147621],[-0.716567,-0.681718,.147621],[-0.525731,-0.850651,0],[-0.5,-0.809017,.309017],[-0.238856,-0.864188,.442863],[-0.262866,-0.951056,.16246],[-0.864188,-0.442863,.238856],[-0.809017,-0.309017,.5],[-0.688191,-0.587785,.425325],[-0.681718,-0.147621,.716567],[-0.442863,-0.238856,.864188],[-0.587785,-0.425325,.688191],[-0.309017,-0.5,.809017],[-0.147621,-0.716567,.681718],[-0.425325,-0.688191,.587785],[-0.16246,-0.262866,.951056],[.442863,-0.238856,.864188],[.16246,-0.262866,.951056],[.309017,-0.5,.809017],[.147621,-0.716567,.681718],[0,-0.525731,.850651],[.425325,-0.688191,.587785],[.587785,-0.425325,.688191],[.688191,-0.587785,.425325],[-0.955423,.295242,0],[-0.951056,.16246,.262866],[-1,0,0],[-0.850651,0,.525731],[-0.955423,-0.295242,0],[-0.951056,-0.16246,.262866],[-0.864188,.442863,-0.238856],[-0.951056,.16246,-0.262866],[-0.809017,.309017,-0.5],[-0.864188,-0.442863,-0.238856],[-0.951056,-0.16246,-0.262866],[-0.809017,-0.309017,-0.5],[-0.681718,.147621,-0.716567],[-0.681718,-0.147621,-0.716567],[-0.850651,0,-0.525731],[-0.688191,.587785,-0.425325],[-0.587785,.425325,-0.688191],[-0.425325,.688191,-0.587785],[-0.425325,-0.688191,-0.587785],[-0.587785,-0.425325,-0.688191],[-0.688191,-0.587785,-0.425325]],c=0,h=1,p=2,_=0,D=1,P=2,H=3,B=1,j=2,F=3,I=.1,q=function(){this.normal=vec3.create(),this.dist=0,this.type=0,this.signbits=0};q.prototype.clone=function(e){return typeof e=="undefined"&&(e=new q),vec3.set(this.normal,e.normal),e.dist=this.dist,e.type=this.type,e.signbits=this.signbits,e};var $=1e-4,J=.02,Q=65535,G=64,Y=function(){this.p=[]};Y.prototype.clone=function(e){typeof e=="undefined"&&(e=new Y),e.p=new Array(this.p.length);for(var t=0;t<this.p.length;t++)e.p[t]=vec3.create(this.p[t]);return e};var ut=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];return{vec3origin:t,axisDefault:n,DirToByte:i,ByteToDir:s,rrandom:o,irrandom:u,crandom:a,SnapVector:f,PerpendicularVector:l,PITCH:c,YAW:h,ROLL:p,DEG2RAD:d,RAD2DEG:v,AngleSubtract:m,AnglesSubtract:g,LerpAngle:y,AngleNormalize360:b,AngleNormalize180:w,AnglesToVectors:E,VectorToAngles:S,AngleToShort:x,ShortToAngle:T,AxisClear:N,AxisCopy:C,AnglesToAxis:k,AxisMultiply:L,RotatePoint:A,RotatePointAroundVector:O,RotateAroundDirection:M,PLANE_X:_,PLANE_Y:D,PLANE_Z:P,PLANE_NON_AXIAL:H,SIDE_FRONT:B,SIDE_BACK:j,SIDE_ON:F,Plane:q,PlaneTypeForNormal:R,GetPlaneSignbits:U,PointOnPlaneSide:z,BoxOnPlaneSide:W,ProjectPointOnPlane:X,PlaneFromPoints:V,PlaneEqual:K,MAX_MAP_BOUNDS:Q,BaseWindingForPlane:Z,WindingBounds:et,ChopWindingInPlace:tt,RadiusFromBounds:nt,ClearBounds:rt,AddPointToBounds:it,BoundsIntersect:st,BoundsIntersectPoint:ot,RadixSort:at}}),define("common/qshared",["common/qmath"],function(e){function F(e){var t=65536,n=e.length,r=e.slice||e.subarray,i;if(n<t)i=String.fromCharCode.apply(String,e);else{var s=[],o=0;while(o<n)s.push(String.fromCharCode.apply(String,r.call(e,o,o+t))),o+=t;i=s.join("")}return btoa(i)}function I(e){var t=e.match(/([^\.\[\]]+)/g);return t}function q(e,t){var n,r;for(n=0,r=t.length;n<r-1;n++)e=e[t[n]];return e[t[r-1]]}function R(e,t,n){var r,i;for(r=0,i=t.length;r<i-1;r++)e=e[t[r]];e[t[i-1]]=n}var t=.105,n=64,r=16777215,i={ROM:1,ARCHIVE:2,CHEAT:4,USERINFO:8,SYSTEMINFO:16,SERVERINFO:32,ARENAINFO:64},s=1,o=2,u=4,a=10,f=32,l=1024,c=256,h=256,p=d,d=l-1,v=l-2,m=l-2,g={BAD:0,LOOPBACK:1,IP:2},y={CLIENT:0,SERVER:1},b=function(){this.type=g.BAD,this.ip=null,this.port=0},w={ATTACK:1,TALK:2,USE_HOLDABLE:4,GESTURE:8,WALKING:16,AFFIRMATIVE:32,NEGATIVE:64,GETFLAG:128,GUARDBASE:256,PATROL:512,FOLLOWME:1024,ANY:2048},E=function(){this.serverTime=0,this.angles=vec3.create(),this.forwardmove=0,this.rightmove=0,this.upmove=0,this.buttons=0,this.weapon=0};E.prototype.clone=function(e){return typeof e=="undefined"&&(e=new E),e.serverTime=this.serverTime,vec3.set(this.angles,e.angles),e.forwardmove=this.forwardmove,e.rightmove=this.rightmove,e.upmove=this.upmove,e.buttons=this.buttons,e.weapon=this.weapon,e};var S=function(){this.linked=!1,this.svFlags=0,this.singleClient=0,this.bmodel=!1,this.mins=vec3.create(),this.maxs=vec3.create(),this.contents=0,this.absmin=vec3.create(),this.absmax=vec3.create(),this.currentOrigin=vec3.create(),this.currentAngles=vec3.create(),this.client=null,this.ownerNum=d},x=16,T=16,N=16,C=16,k=2,L=6,A=function(){this.clientNum=0,this.arenaNum=p,this.commandTime=0,this.pm_type=0,this.pm_flags=0,this.origin=vec3.create(),this.velocity=vec3.create(),this.viewangles=vec3.create(),this.viewheight=0,this.delta_angles=vec3.create(),this.speed=0,this.gravity=0,this.groundEntityNum=d,this.bobCycle=0,this.weapon=0,this.weaponState=0,this.weaponTime=0,this.legsTimer=0,this.legsAnim=0,this.torsoTimer=0,this.torsoAnim=0,this.movementDir=0,this.damageEvent=0,this.damageYaw=0,this.damagePitch=0,this.damageCount=0,this.stats=new Array(x),this.persistant=new Array(T),this.powerups=new Array(N),this.ammo=new Array(C),this.eFlags=0,this.eventSequence=0,this.events=new Array(k),this.eventParms=new Array(k),this.externalEvent=0,this.externalEventParm=0,this.externalEventTime=0,this.ping=0,this.jumppad_ent=0,this.jumppad_frame=0,this.pmove_framecount=0,this.entityEventSequence=0;for(var e=0;e<x;e++)this.stats[e]=0;for(var e=0;e<T;e++)this.persistant[e]=0;for(var e=0;e<N;e++)this.powerups[e]=0;for(var e=0;e<C;e++)this.ammo[e]=0};A.prototype.clone=function(e){typeof e=="undefined"&&(e=new A),e.clientNum=this.clientNum,e.arenaNum=this.arenaNum,e.commandTime=this.commandTime,e.pm_type=this.pm_type,e.pm_flags=this.pm_flags,vec3.set(this.origin,e.origin),vec3.set(this.velocity,e.velocity),vec3.set(this.viewangles,e.viewangles),e.viewheight=this.viewheight,vec3.set(this.delta_angles,e.delta_angles),e.speed=this.speed,e.gravity=this.gravity,e.groundEntityNum=this.groundEntityNum,e.bobCycle=this.bobCycle,e.weapon=this.weapon,e.weaponState=this.weaponState,e.weaponTime=this.weaponTime,e.legsTimer=this.legsTimer,e.legsAnim=this.legsAnim,e.torsoTimer=this.torsoTimer,e.torsoAnim=this.torsoAnim,e.movementDir=this.movementDir,e.damageEvent=this.damageEvent,e.damageYaw=this.damageYaw,e.damagePitch=this.damagePitch,e.damageCount=this.damageCount;for(var t=0;t<x;t++)e.stats[t]=this.stats[t];for(var t=0;t<T;t++)e.persistant[t]=this.persistant[t];for(var t=0;t<N;t++)e.powerups[t]=this.powerups[t];for(var t=0;t<C;t++)e.ammo[t]=this.ammo[t];e.eFlags=this.eFlags,e.eventSequence=this.eventSequence;for(var t=0;t<k;t++)e.events[t]=this.events[t],e.eventParms[t]=this.eventParms[t];return e.externalEvent=this.externalEvent,e.externalEventParm=this.externalEventParm,e.externalEventTime=this.externalEventTime,e.jumppad_ent=this.jumppad_ent,e.jumppad_frame=this.jumppad_frame,e.pmove_framecount=this.pmove_framecount,e.entityEventSequence=this.entityEventSequence,e};var O={STATIONARY:0,INTERPOLATE:1,LINEAR:2,LINEAR_STOP:3,SINE:4,GRAVITY:5},M=function(){this.trType=0,this.trTime=0,this.trDuration=0,this.trBase=vec3.create(),this.trDelta=vec3.create()};M.prototype.clone=function(e){return typeof e=="undefined"&&(e=new M),e.trType=this.trType,e.trTime=this.trTime,e.trDuration=this.trDuration,vec3.set(this.trBase,e.trBase),vec3.set(this.trDelta,e.trDelta),e};var _=function(){this.origin=vec3.create(),this.axis=[vec3.create(),vec3.create(),vec3.create()],this.viewOrigin=vec3.create(),this.modelMatrix=mat4.create()};_.prototype.clone=function(e){return typeof e=="undefined"&&(e=new _),vec3.set(this.origin,e.origin),vec3.set(this.axis[0],e.axis[0]),vec3.set(this.axis[1],e.axis[1]),vec3.set(this.axis[2],e.axis[2]),vec3.set(this.viewOrigin,e.viewOrigin),mat4.set(this.modelMatrix,e.modelMatrix),e};var D=function(){this.reset()};D.prototype.reset=function(){this.number=0,this.arenaNum=p,this.eType=0,this.eFlags=0,this.pos=new M,this.apos=new M,this.time=0,this.time2=0,this.origin=vec3.create(),this.origin2=vec3.create(),this.angles=vec3.create(),this.angles2=vec3.create(),this.otherEntityNum=0,this.otherEntityNum2=0,this.groundEntityNum=d,this.constantLight=0,this.loopSound=0,this.modelIndex=0,this.modelIndex2=0,this.clientNum=0,this.frame=0,this.solid=0,this.event=0,this.eventParm=0,this.powerups=0,this.weapon=0,this.legsAnim=0,this.torsoAnim=0,this.generic1=0},D.prototype.clone=function(e){return typeof e=="undefined"&&(e=new D),e.number=this.number,e.arenaNum=this.arenaNum,e.eType=this.eType,e.eFlags=this.eFlags,this.pos.clone(e.pos),this.apos.clone(e.apos),e.time=this.time,e.time2=this.time2,vec3.set(this.origin,e.origin),vec3.set(this.origin2,e.origin2),vec3.set(this.angles,e.angles),vec3.set(this.angles2,e.angles2),e.otherEntityNum=this.otherEntityNum,e.otherEntityNum2=this.otherEntityNum2,e.groundEntityNum=this.groundEntityNum,e.constantLight=this.constantLight,e.loopSound=this.loopSound,e.modelIndex=this.modelIndex,e.modelIndex2=this.modelIndex2,e.clientNum=this.clientNum,e.frame=this.frame,e.solid=this.solid,e.event=this.event,e.eventParm=this.eventParm,e.powerups=this.powerups,e.weapon=this.weapon,e.legsAnim=this.legsAnim,e.torsoAnim=this.torsoAnim,e.generic1=this.generic1,e};var P=function(){this.allSolid=!1,this.startSolid=!1,this.fraction=1,this.endPos=vec3.create(),this.plane=new e.Plane,this.surfaceFlags=0,this.contents=0,this.entityNum=0,this.shaderName=null};P.prototype.reset=function(){this.allSolid=!1,this.startSolid=!1,this.fraction=1,this.endPos[0]=this.endPos[1]=this.endPos[2]=0,this.plane=new e.Plane,this.surfaceFlags=0,this.contents=0,this.entityNum=0,this.shaderName=null},P.prototype.clone=function(e){return typeof e=="undefined"&&(e=new P),e.allSolid=this.allSolid,e.startSolid=this.startSolid,e.fraction=this.fraction,vec3.set(this.endPos,e.endPos),this.plane.clone(e.plane),e.surfaceFlags=this.surfaceFlags,e.contents=this.contents,e.entityNum=this.entityNum,e.shaderName=this.shaderName,e};var H={NODAMAGE:1,SLICK:2,SKY:4,LADDER:8,NOIMPACT:16,NOMARKS:32,FLESH:64,NODRAW:128,HINT:256,SKIP:512,NOLIGHTMAP:1024,POINTLIGHT:2048,METALSTEPS:4096,NOSTEPS:8192,NONSOLID:16384,LIGHTFILTER:32768,ALPHASHADOW:65536,NODLIGHT:131072,DUST:262144},B={SOLID:1,LAVA:8,SLIME:16,WATER:32,FOG:64,NOTTEAM1:128,NOTTEAM2:256,NOBOTCLIP:512,AREAPORTAL:32768,PLAYERCLIP:65536,MONSTERCLIP:131072,TELEPORTER:262144,JUMPPAD:524288,CLUSTERPORTAL:1048576,DONOTENTER:2097152,BOTCLIP:4194304,MOVER:8388608,ORIGIN:16777216,BODY:33554432,CORPSE:67108864,DETAIL:134217728,STRUCTURAL:268435456,TRANSLUCENT:536870912,TRIGGER:1073741824,NODROP:2147483648},j={ATBASE:0,TAKEN:1,TAKEN_RED:2,TAKEN_BLUE:3,DROPPED:4};return{GAME_VERSION:t,CMD_BACKUP:n,SOLID_BMODEL:r,SNAPFLAG_RATE_DELAYED:s,SNAPFLAG_NOT_ACTIVE:o,SNAPFLAG_SERVERCOUNT:u,GENTITYNUM_BITS:a,MAX_CLIENTS:f,MAX_GENTITIES:l,MAX_MODELS:c,MAX_SOUNDS:h,ARENANUM_NONE:p,ENTITYNUM_NONE:d,ENTITYNUM_WORLD:v,ENTITYNUM_MAX_NORMAL:m,MAX_STATS:x,MAX_PERSISTANT:T,MAX_POWERUPS:N,MAX_WEAPONS:C,MAX_PS_EVENTS:k,PMOVEFRAMECOUNTBITS:L,CVAR:i,BUTTON:w,TR:O,SURF:H,CONTENTS:B,FLAG:j,NA:g,NS:y,SharedEntity:S,PlayerState:A,Trajectory:M,Orientation:_,EntityState:D,TraceResults:P,NetAdr:b,UserCmd:E,atob64:F,FTA:I,AGET:q,ASET:R}}),function(e){var t;t=function(){function u(t,n,i,s){var o;t==null&&(t=0),n==null&&(n=r.BIG_ENDIAN),i==null&&(i=!1),s==null&&(s=!1),this._buffer=null,this._raw=null,this._view=null,this._order=!!n,this._implicitGrowth=!!s,this._index=0,o=e(t,i),o||(o=new ArrayBuffer(t)),this.buffer=o}var e,t,n,r,i,s,o=this;return u.LITTLE_ENDIAN=!0,u.BIG_ENDIAN=!1,r=u,t=function(e,t){return Object.defineProperty(u.prototype,e,{get:t,enumerable:!0,configurable:!0})},i=function(e,t){return Object.defineProperty(u.prototype,e,{set:t,enumerable:!0,configurable:!0})},u.prototype._sanitizeIndex=function(){this._index<0&&(this._index=0);if(this._index>this.length)return this._index=this.length},e=function(e,t){t==null&&(t=!1);if(e.byteLength!=null)return e.buffer!=null?t?e.buffer.slice(0):e.buffer:t?e.slice(0):e;if(e.length==null)return null;try{return(new Uint8Array(e)).buffer}catch(n){return null}},t("buffer",function(){return this._buffer}),i("buffer",function(e){return this._buffer=e,this._raw=new Uint8Array(this._buffer),this._view=new DataView(this._buffer),this._sanitizeIndex()}),t("raw",function(){return this._raw}),t("view",function(){return this._view}),t("length",function(){return this._buffer.byteLength}),t("byteLength",function(){return this.length}),t("order",function(){return this._order}),i("order",function(e){return this._order=!!e}),t("implicitGrowth",function(){return this._implicitGrowth}),i("implicitGrowth",function(e){return this._implicitGrowth=!!e}),t("index",function(){return this._index}),i("index",function(e){if(e<0||e>this.length)throw new RangeError("Invalid index "+e+", should be between 0 and "+this.length);return this._index=e}),u.prototype.front=function(){return this._index=0,this},u.prototype.end=function(){return this._index=this.length,this},u.prototype.seek=function(e){return e==null&&(e=1),this.index+=e,this},t("available",function(){return this.length-this._index}),n=function(e,t){return function(n){var r;n==null&&(n=this._order);if(t>this.available)throw new Error("Cannot read "+t+" byte(s), "+this.available+" available");return r=this._view[e](this._index,n),this._index+=t,r}},s=function(e,t){return function(n,r){var i;r==null&&(r=this._order),i=this.available;if(t>i){if(!this._implicitGrowth)throw new Error("Cannot write "+n+" using "+t+" byte(s), "+i+" available");this.append(t-i)}return this._view[e](this._index,n,r),this._index+=t,this}},u.prototype.readByte=n("getInt8",1),u.prototype.readUnsignedByte=n("getUint8",1),u.prototype.readShort=n("getInt16",2),u.prototype.readUnsignedShort=n("getUint16",2),u.prototype.readInt=n("getInt32",4),u.prototype.readUnsignedInt=n("getUint32",4),u.prototype.readFloat=n("getFloat32",4),u.prototype.readDouble=n("getFloat64",8),u.prototype.writeByte=s("setInt8",1),u.prototype.writeUnsignedByte=s("setUint8",1),u.prototype.writeShort=s("setInt16",2),u.prototype.writeUnsignedShort=s("setUint16",2),u.prototype.writeInt=s("setInt32",4),u.prototype.writeUnsignedInt=s("setUint32",4),u.prototype.writeFloat=s("setFloat32",4),u.prototype.writeDouble=s("setFloat64",8),u.prototype.read=function(e){var t;e==null&&(e=this.available);if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(e<=0)throw new RangeError("Invalid number of bytes "+e);return t=new r(this._buffer.slice(this._index,this._index+e)),this._index+=e,t},u.prototype.write=function(t){var n,r,i;if(t instanceof Uint8Array)i=t;else{r=e(t);if(!r)throw new TypeError("Cannot write "+t+", not a sequence");i=new Uint8Array(r)}n=this.available;if(i.byteLength>n){if(!this._implicitGrowth)throw new Error("Cannot write "+t+" using "+i.byteLength+" byte(s), "+this.available+" available");this.append(i.byteLength-n)}return this._raw.set(i,this._index),this._index+=i.byteLength,this},u.prototype.readString=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;e==null&&(e=this.available);if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(e<=0)throw new RangeError("Invalid number of bytes "+e);h=this._raw,u=[],s=0,t=n=r=i=null,p=this._index+e;while(this._index<p){t=h[this._index];if(t<128)u[s++]=t,this._index++;else{if(t<194)throw new Error("Unexpected continuation byte");if(t<224){n=h[this._index+1];if(n<128||n>191)throw new Error("Bad continuation byte");u[s++]=((t&31)<<6)+(n&63),this._index+=2}else if(t<240){n=h[this._index+1];if(n<128||n>191)throw new Error("Bad continuation byte");r=h[this._index+2];if(r<128||r>191)throw new Error("Bad continuation byte");u[s++]=((t&15)<<12)+((n&63)<<6)+(r&63),this._index+=3}else{if(!(t<245))throw new Error("Illegal byte");n=h[this._index+1];if(n<128||n>191)throw new Error("Bad continuation byte");r=h[this._index+2];if(r<128||r>191)throw new Error("Bad continuation byte");i=h[this._index+3];if(i<128||i>191)throw new Error("Bad continuation byte");a=((t&7)<<18)+((n&63)<<12)+((r&63)<<6)+(i&63),a-=65536,u[s++]=55296+((a&1047552)>>>10),u[s++]=56320+(a&1023),this._index+=4}}}c=65536,l=u.length;if(l<c)return String.fromCharCode.apply(String,u);o=[],f=0;while(f<l)o.push(String.fromCharCode.apply(String,u.slice(f,f+c))),f+=c;return o.join("")},u.prototype.writeString=function(e){var t,n,r,i,s,o,u;n=[],u=e.length,o=0,t=0;while(o<u){r=e.charCodeAt(o);if(r<=127)n[t++]=r;else if(r<=2047)n[t++]=192|(r&1984)>>>6,n[t++]=128|r&63;else if(r<=55295||r>=57344&&r<=65535)n[t++]=224|(r&61440)>>>12,n[t++]=128|(r&4032)>>>6,n[t++]=128|r&63;else{if(o===u-1)throw new Error("Unpaired surrogate "+e[o]+" (index "+o+")");s=e.charCodeAt(++o);if(r<55296||r>56319||s<56320||s>57343)throw new Error("Unpaired surrogate "+e[o]+" (index "+o+")");i=((r&1023)<<10)+(s&1023)+65536,n[t++]=240|(i&1835008)>>>18,n[t++]=128|(i&258048)>>>12,n[t++]=128|(i&4032)>>>6,n[t++]=128|i&63}++o}return this.write(n),n.length},u.prototype.readUTFChars=u.prototype.readString,u.prototype.writeUTFChars=u.prototype.writeString,u.prototype.readCString=function(){var e,t,n,r;e=this._raw,n=e.length,t=this._index;while(e[t]!==0&&t<n)++t;return n=t-this._index,n>0?(r=this.readString(n),this.readByte(),r):null},u.prototype.writeCString=function(e){var t;return t=this.writeString(e),this.writeByte(0),++t},u.prototype.readASCIIString=function(e){var t,n,r,i,s,o;if(e>this.available)throw new Error("Cannot read "+e+" byte(s), "+this.available+" available");if(e<=0)throw new RangeError("Invalid number of bytes "+e);t=0,s=[],n=!1;while(t<e)r=this.readByte(),r===0?n=!0:n||s.push(r),t++;e=s.length,i=65536;if(e<i)return String.fromCharCode.apply(String,s);o=[],t=0;while(t<e)o.push(String.fromCharCode.apply(String,s.slice(t,t+i))),t+=i;return o.join("")},u.prototype.writeASCIIString=function(e,t){var n,r,i,s;n=this._raw,r=0,i=t||e.length,s=[];while(r<i)s[r++]=r<e.length?e.charCodeAt(r):0;return this.write(s),i},u.prototype.prepend=function(e){var t;if(e<=0)throw new RangeError("Invalid number of bytes "+e);return t=new Uint8Array(this.length+e),t.set(this._raw,e),this._index+=e,this.buffer=t.buffer,this},u.prototype.append=function(e){var t;if(e<=0)throw new RangeError("Invalid number of bytes "+e);return t=new Uint8Array(this.length+e),t.set(this._raw,0),this.buffer=t.buffer,this},u.prototype.clip=function(e,t){var n;return e==null&&(e=this._index),t==null&&(t=this.length),e<0&&(e=this.length+e),n=this._buffer.slice(e,t),this._index-=e,this.buffer=n,this},u.prototype.slice=function(e,t){var n;return e==null&&(e=0),t==null&&(t=this.length),n=new r(this._buffer.slice(e,t)),n},u.prototype.clone=function(){var e;return e=new r(this._buffer.slice(0)),e.index=this._index,e},u.prototype.reverse=function(){return Array.prototype.reverse.call(this._raw),this._index=0,this},u.prototype.toArray=function(){return Array.prototype.slice.call(this._raw,0)},u.prototype.toString=function(){var e;return e=this._order===r.BIG_ENDIAN?"big-endian":"little-endian","[ByteBuffer; Order: "+e+"; Length: "+this.length+"; Index: "+this._index+"; Available: "+this.available+"]"},u.prototype.toHex=function(e){return e==null&&(e=" "),Array.prototype.map.call(this._raw,function(e){return("00"+e.toString(16).toUpperCase()).slice(-2)}).join(e)},u.prototype.toASCII=function(e,t,n){var r;return e==null&&(e=" "),t==null&&(t=!0),n==null&&(n=""),r=t?" ":"",Array.prototype.map.call(this._raw,function(e){return e<32||e>126?r+n:r+String.fromCharCode(e)}).join(e)},u}.call(this),typeof define=="function"&&define.amd?define("ByteBuffer",[],function(){return t}):e.ByteBuffer=t}(this),define("common/bsp-serializer",["ByteBuffer","common/qmath"],function(e,t){function y(t){var n=new e(t,e.LITTLE_ENDIAN),i=new o;i.ident=n.readASCIIString(4),i.version=n.readInt();for(var u=0;u<r.NUM_LUMPS;u++)i.lumps[u].fileofs=n.readInt(),i.lumps[u].filelen=n.readInt();if(i.ident!=="IBSP"&&i.version!==46)return callback(new Error("Invalid BSP version: "+i.version));var a=new s;return b(a,t,i.lumps[r.ENTITIES]),w(a,t,i.lumps[r.SHADERS]),E(a,t,i.lumps[r.PLANES]),S(a,t,i.lumps[r.NODES]),x(a,t,i.lumps[r.LEAFS]),T(a,t,i.lumps[r.LEAFSURFACES]),N(a,t,i.lumps[r.LEAFBRUSHES]),C(a,t,i.lumps[r.MODELS]),k(a,t,i.lumps[r.BRUSHES]),L(a,t,i.lumps[r.BRUSHSIDES]),A(a,t,i.lumps[r.DRAWVERTS]),O(a,t,i.lumps[r.DRAWINDEXES]),M(a,t,i.lumps[r.FOGS]),_(a,t,i.lumps[r.SURFACES]),D(a,t,i.lumps[r.LIGHTMAPS]),P(a,t,i.lumps[r.LIGHTGRID]),H(a,t,i.lumps[r.VISIBILITY]),a}function b(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=i.readASCIIString(r.filelen),o=t.entities=[];s.replace(/\{([^}]*)\}/mg,function(e,t){var n={classname:"unknown"};t.replace(/"(.+)" "(.+)"$/mg,function(e,t,r){n[t]=r}),o.push(n)});var u=o[0];if(u.classname!=="worldspawn"){error("worldspawn isn't the first entity");return}if(u.gridsize){var a=u.gridsize.split(" ");t.lightGridSize[0]=parseFloat(a[0]),t.lightGridSize[1]=parseFloat(a[1]),t.lightGridSize[2]=parseFloat(a[2])}}function w(t,r,i){var s=new e(r,e.LITTLE_ENDIAN);s.index=i.fileofs;var o=t.shaders=new Array(i.filelen/f.size);for(var u=0;u<o.length;u++){var a=o[u]=new f;a.shaderName=s.readASCIIString(n),a.surfaceFlags=s.readInt(),a.contents=s.readInt()}}function E(n,r,i){var s=new e(r,e.LITTLE_ENDIAN);s.index=i.fileofs;var o=n.planes=new Array(i.filelen/l.size);for(var u=0;u<o.length;u++){var a=o[u]=new t.Plane;a.normal[0]=s.readFloat(),a.normal[1]=s.readFloat(),a.normal[2]=s.readFloat(),a.dist=s.readFloat(),a.signbits=t.GetPlaneSignbits(a.normal),a.type=t.PlaneTypeForNormal(a.normal)}}function S(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.nodes=new Array(r.filelen/c.size);for(var o=0;o<s.length;o++){var u=s[o]=new c;u.planeNum=i.readInt(),u.childrenNum[0]=i.readInt(),u.childrenNum[1]=i.readInt(),u.mins[0]=i.readInt(),u.mins[1]=i.readInt(),u.mins[2]=i.readInt(),u.maxs[0]=i.readInt(),u.maxs[1]=i.readInt(),u.maxs[2]=i.readInt()}}function x(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.leafs=new Array(r.filelen/h.size);for(var o=0;o<s.length;o++){var u=s[o]=new h;u.cluster=i.readInt(),u.area=i.readInt(),u.mins[0]=i.readInt(),u.mins[1]=i.readInt(),u.mins[2]=i.readInt(),u.maxs[0]=i.readInt(),u.maxs[1]=i.readInt(),u.maxs[2]=i.readInt(),u.firstLeafSurface=i.readInt(),u.numLeafSurfaces=i.readInt(),u.firstLeafBrush=i.readInt(),u.numLeafBrushes=i.readInt()}}function T(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.leafSurfaces=new Array(r.filelen/4);for(var o=0;o<s.length;o++)s[o]=i.readInt()}function N(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.leafBrushes=new Array(r.filelen/4);for(var o=0;o<s.length;o++)s[o]=i.readInt()}function C(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.bmodels=new Array(r.filelen/a.size);for(var o=0;o<s.length;o++){var u=s[o]=new a;u.bounds[0][0]=i.readFloat(),u.bounds[0][1]=i.readFloat(),u.bounds[0][2]=i.readFloat(),u.bounds[1][0]=i.readFloat(),u.bounds[1][1]=i.readFloat(),u.bounds[1][2]=i.readFloat(),u.firstSurface=i.readInt(),u.numSurfaces=i.readInt(),u.firstBrush=i.readInt(),u.numBrushes=i.readInt()}}function k(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.brushes=new Array(r.filelen/d.size);for(var o=0;o<s.length;o++){var u=s[o]=new d;u.side=i.readInt(),u.numSides=i.readInt(),u.shaderNum=i.readInt()}}function L(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.brushSides=new Array(r.filelen/p.size);for(var o=0;o<s.length;o++){var u=s[o]=new p;u.planeNum=i.readInt(),u.shaderNum=i.readInt()}}function A(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.verts=new Array(r.filelen/m.size);for(var o=0;o<s.length;o++){var u=s[o]=new m;u.pos[0]=i.readFloat(),u.pos[1]=i.readFloat(),u.pos[2]=i.readFloat(),u.texCoord[0]=i.readFloat(),u.texCoord[1]=i.readFloat(),u.lmCoord[0]=i.readFloat(),u.lmCoord[1]=i.readFloat(),u.normal[0]=i.readFloat(),u.normal[1]=i.readFloat(),u.normal[2]=i.readFloat(),u.color[0]=i.readUnsignedByte(),u.color[1]=i.readUnsignedByte(),u.color[2]=i.readUnsignedByte(),u.color[3]=i.readUnsignedByte()}}function O(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.indexes=new Array(r.filelen/4);for(var o=0;o<s.length;o++)s[o]=i.readInt()}function M(t,r,i){var s=new e(r,e.LITTLE_ENDIAN);s.index=i.fileofs;var o=t.fogs=new Array(i.filelen/v.size);for(var u=0;u<o.length;u++){var a=o[u]=new v;a.shaderName=s.readASCIIString(n),a.brushNum=s.readInt(),a.visibleSide=s.readInt()}}function _(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs;var s=t.surfaces=new Array(r.filelen/g.size);for(var o=0;o<s.length;o++){var u=s[o]=new g;u.shaderNum=i.readInt(),u.fogNum=i.readInt(),u.surfaceType=i.readInt(),u.vertex=i.readInt(),u.vertCount=i.readInt(),u.meshVert=i.readInt(),u.meshVertCount=i.readInt(),u.lightmapNum=i.readInt(),u.lightmapX=i.readInt(),u.lightmapY=i.readInt(),u.lightmapWidth=i.readInt(),u.lightmapHeight=i.readInt(),u.lightmapOrigin[0]=i.readFloat(),u.lightmapOrigin[1]=i.readFloat(),u.lightmapOrigin[2]=i.readFloat(),u.lightmapVecs[0][0]=i.readFloat(),u.lightmapVecs[0][1]=i.readFloat(),u.lightmapVecs[0][2]=i.readFloat(),u.lightmapVecs[1][0]=i.readFloat(),u.lightmapVecs[1][1]=i.readFloat(),u.lightmapVecs[1][2]=i.readFloat(),u.lightmapVecs[2][0]=i.readFloat(),u.lightmapVecs[2][1]=i.readFloat(),u.lightmapVecs[2][2]=i.readFloat(),u.patchWidth=i.readInt(),u.patchHeight=i.readInt()}}function D(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs,t.lightmaps=new Uint8Array(r.filelen);for(var s=0;s<r.filelen;s++)t.lightmaps[s]=i.readUnsignedByte()}function P(t,n,r){t.lightGridInverseSize[0]=1/t.lightGridSize[0],t.lightGridInverseSize[1]=1/t.lightGridSize[1],t.lightGridInverseSize[2]=1/t.lightGridSize[2];var i=t.bmodels[0].bounds[0],s=t.bmodels[0].bounds[1];for(var o=0;o<3;o++){t.lightGridOrigin[o]=t.lightGridSize[o]*Math.ceil(i[o]/t.lightGridSize[o]);var u=t.lightGridSize[o]*Math.floor(s[o]/t.lightGridSize[o]);t.lightGridBounds[o]=(u-t.lightGridOrigin[o])/t.lightGridSize[o]+1}var a=t.lightGridBounds[0]*t.lightGridBounds[1]*t.lightGridBounds[2];if(r.filelen!==a*8){log("WARNING: light grid mismatch",r.filelen,a*8),t.lightGridData=null;return}var f=new e(n,e.LITTLE_ENDIAN);f.index=r.fileofs,t.lightGridData=new Uint8Array(r.filelen);for(var o=0;o<r.filelen;o++)t.lightGridData[o]=f.readUnsignedByte()}function H(t,n,r){var i=new e(n,e.LITTLE_ENDIAN);i.index=r.fileofs,t.numClusters=i.readInt(),t.clusterBytes=i.readInt();var s=t.numClusters*t.clusterBytes;t.vis=new Uint8Array(s);for(var o=0;o<s;o++)t.vis[o]=i.readUnsignedByte()}var n=64,r={ENTITIES:0,SHADERS:1,PLANES:2,NODES:3,LEAFS:4,LEAFSURFACES:5,LEAFBRUSHES:6,MODELS:7,BRUSHES:8,BRUSHSIDES:9,DRAWVERTS:10,DRAWINDEXES:11,FOGS:12,SURFACES:13,LIGHTMAPS:14,LIGHTGRID:15,VISIBILITY:16,NUM_LUMPS:17},i={BAD:0,PLANAR:1,PATCH:2,TRIANGLE_SOUP:3,FLARE:4},s=function(){this.entities={},this.shaders=null,this.planes=null,this.nodes=null,this.leafs=null,this.leafSurfaces=null,this.leafBrushes=null,this.bmodels=null,this.brushes=null,this.brushSides=null,this.verts=null,this.indexes=null,this.fogs=null,this.surfaces=null,this.lightmaps=null,this.lightGridOrigin=vec3.create(),this.lightGridSize=vec3.createFrom(64,64,128),this.lightGridInverseSize=vec3.create(),this.lightGridBounds=vec3.create(),this.lightGridData=null,this.numClusters=0,this.clusterBytes=0,this.vis=null},o=function(){this.ident=null,this.version=0,this.lumps=new Array(r.NUM_LUMPS);for(var e=0;e<r.NUM_LUMPS;e++)this.lumps[e]=new u},u=function(){this.fileofs=0,this.filelen=0},a=function(){this.bounds=[vec3.create(),vec3.create()],this.firstSurface=0,this.numSurfaces=0,this.firstBrush=0,this.numBrushes=0};a.size=40;var f=function(){this.shaderName=null,this.surfaceFlags=0,this.contents=0};f.size=72;var l=function(){this.normal=vec3.create(),this.dist=0};l.size=16;var c=function(){this.planeNum=0,this.childrenNum=[0,0],this.mins=vec3.create(),this.maxs=vec3.create()};c.size=36;var h=function(){this.cluster=0,this.area=0,this.mins=vec3.create(),this.maxs=vec3.create(),this.firstLeafSurface=0,this.numLeafSurfaces=0,this.firstLeafBrush=0,this.numLeafBrushes=0};h.size=48;var p=function(){this.planeNum=0,this.shaderNum=0};p.size=8;var d=function(){this.side=0,this.numSides=0,this.shaderNum=0};d.size=12;var v=function(){this.shaderName=null,this.brushNum=0,this.visibleSide=0};v.size=72;var m=function(){this.pos=vec3.create(),this.texCoord=[0,0],this.lmCoord=[0,0],this.normal=vec3.create(),this.color=[0,0,0,0]};m.size=44;var g=function(){this.shaderNum=0,this.fogNum=0,this.surfaceType=0,this.vertex=0,this.vertCount=0,this.meshVert=0,this.meshVertCount=0,this.lightmapNum=0,this.lightmapX=0,this.lightmapY=0,this.lightmapWidth=0,this.lightmapHeight=0,this.lightmapOrigin=vec3.create(),this.lightmapVecs=[vec3.create(),vec3.create(),vec3.create()],this.patchWidth=0,this.patchHeight=0};return g.size=104,{MST:i,Bsp:s,dmodel_t:a,dshader_t:f,dplane_t:l,dnode_t:c,dleaf_t:h,dbrushside_t:p,dbrush_t:d,dfog_t:v,drawVert_t:m,dsurface_t:g,deserialize:y}}),define("common/cvar",[],function(){function n(e,t){return e=parseInt(e,10),isNaN(e)?t:e}function r(e,t){return e=parseFloat(e),isNaN(e)?t:e}function i(e,t){return e=e.toString(),e===undefined||e===null?t:e}function u(t,n,r){var i=a(t);return i?(typeof n!="undefined"&&(i._defaultValue=n),typeof r!="undefined"&&(i._flags=r),i._latchedValue=i._currentValue,i):(i=e[t]=new s(n,r),i)}function a(t){return e[t]}function f(t){var n={};for(var r in e){if(!e.hasOwnProperty(r))continue;var i=e[r];if(!(i._flags&t))continue;n[r]=i._currentValue}return n}function l(e){return t&e}function c(e){t&=~e}var e={},t=0,s=function(e,t,n){this._defaultValue=typeof e=="undefined"?0:e,this._currentValue=this._defaultValue,this._latchedValue=this._defaultValue,this._flags=typeof t=="undefined"?0:t,this._latched=n};s.prototype.getDefaultValue=function(){return this._defaultValue},s.prototype.at=function(e){return new o(this,e)},s.prototype.modified=function(){return this._latched?this._defaultValue!==this.latchedValue:this._modified?(this._modified=!1,!0):!1},s.prototype.getValue=function(){return this._latched?this._latchedValue:this._currentValue},s.prototype.getAsInt=function(){return n(this.getValue(),this._defaultValue)},s.prototype.getAsFloat=function(){return r(this.getValue(),this._defaultValue)},s.prototype.getAsString=function(){return i(this.getValue(),this._defaultValue)},s.prototype.getFlags=function(){return this._flags},s.prototype.setValue=function(e){this._currentValue=e,t|=this._flags};var o=function(e,t){this._cvar=e,this._index=t};o.prototype.getValue=function(){var e=this._cvar.getAsString(),t=e.split(",");for(var n=0;n<t.length;n++)t[n]=t[n].replace(/^\s*/,"").replace(/\s*$/,"");return t[this._index]===undefined&&t[0]!==undefined?t[0]:t[this._index]},o.prototype.getAsInt=function(){return n(this.getValue(),this._cvar.getDefaultValue())},o.prototype.getAsFloat=function(){return r(this.getValue(),this._cvar.getDefaultValue())},o.prototype.getAsString=function(){return i(this.getValue(),this._cvar.getDefaultValue())};var h={AddCvar:u,GetCvar:a,GetCvarJSON:f,Modified:l,ClearModified:c};return h}),define("clipmap/cm",["underscore","glmatrix","ByteBuffer","common/bsp-serializer","common/qmath","common/qshared"],function(e,t,n,r,i,s){function o(e){function k(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"CM:"),Function.apply.call(console.log,console,e)}function D(e,n,r){(e<=2||n<=2||!r)&&t.Error("GeneratePatchFacets: bad parameters"),(!(e&1)||!(n&1))&&t.Error("GeneratePatchFacets: even sizes are invalid for quadratic meshes"),(e>b||n>b)&&t.Error("GeneratePatchFacets: source is > MAX_GRID_SIZE");var s=new N;s.width=e,s.height=n,s.wrapWidth=!1,s.wrapHeight=!1;for(var o=0;o<e;o++)for(var u=0;u<n;u++)vec3.set(r[u*e+o],s.points[o][u]);P(s),H(s),F(s),R(s),P(s),H(s),F(s);var a=new T;i.ClearBounds(a.bounds[0],a.bounds[1]);for(var o=0;o<s.width;o++)for(var u=0;u<s.height;u++)i.AddPointToBounds(s.points[o][u],a.bounds[0],a.bounds[1]);return U(s,a),a.bounds[0][0]-=1,a.bounds[0][1]-=1,a.bounds[0][2]-=1,a.bounds[1][0]+=1,a.bounds[1][1]+=1,a.bounds[1][2]+=1,_.push(a),a}function P(e){var t,n;for(t=0;t<e.height;t++){for(n=0;n<3;n++){var r=e.points[0][t][n]-e.points[e.width-1][t][n];if(r<-E||r>E)break}if(n!=3)break}t===e.height?e.wrapWidth=!0:e.wrapWidth=!1}function H(e){var t,n,r,i=vec3.create(),s=vec3.create(),o=vec3.create();for(t=0;t<e.width-2;){for(n=0;n<e.height;n++)if(B(e.points[t][n],e.points[t+1][n],e.points[t+2][n]))break;if(n===e.height){for(n=0;n<e.height;n++)for(r=t+2;r<e.width;r++)vec3.set(e.points[r][n],e.points[r-1][n]);e.width--,t++;continue}for(n=0;n<e.height;n++){vec3.set(e.points[t][n],i),vec3.set(e.points[t+1][n],s),vec3.set(e.points[t+2][n],o);for(r=e.width-1;r>t+1;r--)vec3.set(e.points[r][n],e.points[r+2][n]);j(i,s,o,e.points[t+1][n],e.points[t+2][n],e.points[t+3][n])}e.width+=2}}function B(e,t,n){var r=vec3.create(),i=vec3.create(),s=vec3.create();for(var o=0;o<3;o++)i[o]=.5*(e[o]+n[o]);for(var o=0;o<3;o++)r[o]=.5*(.5*(e[o]+t[o])+.5*(t[o]+n[o]));vec3.subtract(r,i,s);var u=vec3.length(s);return u>=w}function j(e,t,n,r,i,s){for(var o=0;o<3;o++)r[o]=.5*(e[o]+t[o]),s[o]=.5*(t[o]+n[o]),i[o]=.5*(r[o]+s[o])}function F(e){var t,n,r;for(t=0;t<e.width-1;t++){for(n=0;n<e.height;n++)if(!q(e.points[t][n],e.points[t+1][n]))break;if(n!==e.height)continue;for(n=0;n<e.height;n++)for(r=t+2;r<e.width;r++)vec3.set(e.points[r][n],e.points[r-1][n]);e.width--,t--}}function q(e,t){var n=e[0]-t[0];return n<-I||n>I?!1:(n=e[1]-t[1],n<-I||n>I?!1:(n=e[2]-t[2],n<-I||n>I?!1:!0))}function R(e){var t,n,r,i=vec3.create(),s=!1;if(e.width>e.height)for(t=0;t<e.height;t++)for(n=t+1;n<e.width;n++)n<e.height?(vec3.set(e.points[t][n],i),vec3.set(e.points[n][t],e.points[t][n]),vec3.set(i,e.points[n][t])):vec3.set(e.points[n][t],e.points[t][n]);else for(t=0;t<e.width;t++)for(n=t+1;n<e.height;n++)n<e.width?(vec3.set(e.points[n][t],i),vec3.set(e.points[t][n],e.points[n][t]),vec3.set(i,e.points[t][n])):vec3.set(e.points[t][n],e.points[n][t]);r=e.width,e.width=e.height,e.height=r,s=e.wrapWidth,e.wrapWidth=e.wrapHeight,e.wrapHeight=s}function U(e,n){var r,i,s,o,u,a=[0,0,0,0],f=[0,0,0,0],l=new Array(b);for(r=0;r<b;r++){l[r]=new Array(b);for(i=0;i<b;i++)l[r][i]=new Array(2)}for(r=0;r<e.width-1;r++)for(i=0;i<e.height-1;i++)s=e.points[r][i],o=e.points[r+1][i],u=e.points[r+1][i+1],l[r][i][0]=z(n,s,o,u),s=e.points[r+1][i+1],o=e.points[r][i+1],u=e.points[r][i],l[r][i][1]=z(n,s,o,u);for(r=0;r<e.width-1;r++)for(i=0;i<e.height-1;i++){a[L]=-1,i>0?a[L]=l[r][i-1][1]:e.wrapHeight&&(a[L]=l[r][e.height-2][1]),f[L]=a[L]==l[r][i][0];if(a[L]==-1||f[L])a[L]=W(n,e,l,r,i,0);a[O]=-1,i<e.height-2?a[O]=l[r][i+1][0]:e.wrapHeight&&(a[O]=l[r][0][0]),f[O]=a[O]==l[r][i][1];if(a[O]==-1||f[O])a[O]=W(n,e,l,r,i,2);a[M]=-1,r>0?a[M]=l[r-1][i][0]:e.wrapWidth&&(a[M]=l[e.width-2][i][0]),f[M]=a[M]==l[r][i][1];if(a[M]==-1||f[M])a[M]=W(n,e,l,r,i,3);a[A]=-1,r<e.width-2?a[A]=l[r+1][i][1]:e.wrapWidth&&(a[A]=l[0][i][1]),f[A]=a[A]==l[r][i][0];if(a[A]==-1||f[A])a[A]=W(n,e,l,r,i,1);n.facets.length>=m&&t.Error("MAX_FACETS");var c=new x;if(l[r][i][0]===l[r][i][1]){if(l[r][i][0]===-1)continue;c.surfacePlane=l[r][i][0],c.numBorders=4,c.borderPlanes[0]=a[L],c.borderNoAdjust[0]=f[L],c.borderPlanes[1]=a[A],c.borderNoAdjust[1]=f[A],c.borderPlanes[2]=a[O],c.borderNoAdjust[2]=f[O],c.borderPlanes[3]=a[M],c.borderNoAdjust[3]=f[M],V(n,c,e,l,r,i,-1),$(n,c)&&(J(n,c),n.facets.push(c))}else c.surfacePlane=l[r][i][0],c.numBorders=3,c.borderPlanes[0]=a[L],c.borderNoAdjust[0]=f[L],c.borderPlanes[1]=a[A],c.borderNoAdjust[1]=f[A],c.borderPlanes[2]=l[r][i][1],c.borderPlanes[2]===-1&&(c.borderPlanes[2]=a[O],c.borderPlanes[2]===-1&&(c.borderPlanes[2]=W(n,e,l,r,i,4))),V(n,c,e,l,r,i,0),$(n,c)&&(J(n,c),n.facets.push(c)),n.facets.length>=m&&t.Error("MAX_FACETS"),c=c=new x,c.surfacePlane=l[r][i][1],c.numBorders=3,c.borderPlanes[0]=a[O],c.borderNoAdjust[0]=f[O],c.borderPlanes[1]=a[M],c.borderNoAdjust[1]=f[M],c.borderPlanes[2]=l[r][i][0],c.borderPlanes[2]===-1&&(c.borderPlanes[2]=a[L],c.borderPlanes[2]===-1&&(c.borderPlanes[2]=W(n,e,l,r,i,5))),V(n,c,e,l,r,i,1),$(n,c)&&(J(n,c),n.facets.push(c))}}function z(e,n,r,s){var o=i.PlaneFromPoints(n,r,s);if(!o)return-1;for(var u=0;u<e.planes.length;u++){var a=e.planes[u];if(vec3.dot(o.normal,a.normal)<0)continue;if(i.PointOnPlaneSide(n,a)!==i.SIDE_ON)continue;if(i.PointOnPlaneSide(r,a)!==i.SIDE_ON)continue;if(i.PointOnPlaneSide(s,a)!==i.SIDE_ON)continue;return u}e.planes.length>=y&&t.Error("MAX_PATCH_PLANES");var f=e.planes.length;return e.planes.push(o),f}function W(e,n,r,i,s,o){var u,a,f,l,c=vec3.create();switch(o){case 0:return u=n.points[i][s],a=n.points[i+1][s],f=X(r,i,s,0),l=e.planes[f],vec3.add(u,vec3.scale(l.normal,4,vec3.create()),c),z(e,u,a,c);case 2:return u=n.points[i][s+1],a=n.points[i+1][s+1],f=X(r,i,s,1),l=e.planes[f],vec3.add(u,vec3.scale(l.normal,4,vec3.create()),c),z(e,a,u,c);case 3:return u=n.points[i][s],a=n.points[i][s+1],f=X(r,i,s,1),l=e.planes[f],vec3.add(u,vec3.scale(l.normal,4,vec3.create()),c),z(e,a,u,c);case 1:return u=n.points[i+1][s],a=n.points[i+1][s+1],f=X(r,i,s,0),l=e.planes[f],vec3.add(u,vec3.scale(l.normal,4,vec3.create()),c),z(e,u,a,c);case 4:return u=n.points[i+1][s+1],a=n.points[i][s],f=X(r,i,s,0),l=e.planes[f],vec3.add(u,vec3.scale(l.normal,4,vec3.create()),c),z(e,u,a,c);case 5:return u=n.points[i][s],a=n.points[i+1][s+1],f=X(r,i,s,1),l=e.planes[f],vec3.add(u,vec3.scale(l.normal,4,vec3.create()),c),z(e,u,a,c)}return t.Error("EdgePlaneNum: bad k"),-1}function X(e,t,n,r){var i=e[t][n][r];return i!==-1?i:(i=e[t][n][r^1],i!==-1?i:(k("WARNING: GridPlane unresolvable"),-1))}function V(e,n,r,s,o,u,a){var f=[null,null,null,null],l;switch(a){case-1:f[0]=r.points[o][u],f[1]=r.points[o+1][u],f[2]=r.points[o+1][u+1],f[3]=r.points[o][u+1],l=4;break;case 0:f[0]=r.points[o][u],f[1]=r.points[o+1][u],f[2]=r.points[o+1][u+1],l=3;break;case 1:f[0]=r.points[o+1][u+1],f[1]=r.points[o][u+1],f[2]=r.points[o][u],l=3;break;default:t.Error("SetBorderInward: bad parameter"),l=0}for(var c=0;c<n.numBorders;c++){var h=0,p=0;for(var d=0;d<l;d++){var v=n.borderPlanes[c];if(v===-1)continue;var m=i.PointOnPlaneSide(f[d],e.planes[v]);m===i.SIDE_FRONT?h++:m===i.SIDE_BACK&&p++}h&&!p?n.borderInward[c]=!0:p&&!h?n.borderInward[c]=!1:!h&&!p?n.borderPlanes[c]=-1:(k("WARNING: SetBorderInward: mixed plane sides"),n.borderInward[c]=!1)}}function $(e,t){if(t.surfacePlane===-1)return!1;var n=[vec3.create(),vec3.create()],r=e.planes[t.surfacePlane].clone(),s=i.BaseWindingForPlane(r.normal,r.dist);for(var o=0;o<t.numBorders;o++){if(t.borderPlanes[o]===-1)return!1;e.planes[t.borderPlanes[o]].clone(r),t.borderInward[o]||(vec3.negate(r.normal),r.dist=-r.dist);if(!i.ChopWindingInPlace(s,r.normal,r.dist,.1))return!1}i.WindingBounds(s,n[0],n[1]);for(var o=0;o<3;o++){if(n[1][o]-n[0][o]>i.MAX_MAP_BOUNDS)return!1;if(n[0][o]>=i.MAX_MAP_BOUNDS)return!1;if(n[1][o]<=-i.MAX_MAP_BOUNDS)return!1}return!0}function J(e,t){var n,r,s,o,u,a,f,l=[!1],c=vec3.create(),h=vec3.create(),p=vec3.create(),d=vec3.create(),v=e.planes[t.surfacePlane].clone(),m=new i.Plane,g=i.BaseWindingForPlane(v.normal,v.dist);for(r=0;r<t.numBorders;r++){if(t.borderPlanes[r]===t.surfacePlane)continue;e.planes[t.borderPlanes[r]].clone(v),t.borderInward[r]||(vec3.negate(v.normal),v.dist=-v.dist);if(!i.ChopWindingInPlace(g,v.normal,v.dist,.1))return}i.WindingBounds(g,c,h),f=0;for(u=0;u<3;u++)for(a=-1;a<=1;a+=2,f++){v.normal[0]=v.normal[1]=v.normal[2]=0,v.normal[u]=a,a===1?v.dist=h[u]:v.dist=-c[u];if(G(e.planes[t.surfacePlane],v,l))continue;for(n=0;n<t.numBorders;n++)if(G(e.planes[t.borderPlanes[n]],v,l))break;n===t.numBorders&&(t.numBorders>26&&k("ERROR: too many bevels"),t.borderPlanes[t.numBorders]=Z(e,v,l),t.borderNoAdjust[t.numBorders]=0,t.borderInward[t.numBorders]=l[0],t.numBorders++)}for(r=0;r<g.p.length;r++){s=(r+1)%g.p.length,vec3.subtract(g.p[r],g.p[s],p),vec3.normalize(p);if(vec3.length(p)<.5)continue;Y(p);for(s=0;s<3;s++)if(p[s]==-1||p[s]==1)break;if(s<3)continue;for(u=0;u<3;u++)for(a=-1;a<=1;a+=2){d[0]=d[1]=d[2]=0,d[u]=a,vec3.cross(p,d,v.normal),vec3.normalize(v.normal);if(vec3.length(v.normal)<.5)continue;v.dist=vec3.dot(g.p[r],v.normal);for(o=0;o<g.p.length;o++){var y=vec3.dot(g.p[o],v.normal)-v.dist;if(y>.1)break}if(o<g.p.length)continue;if(G(e.planes[t.surfacePlane],v,l))continue;for(n=0;n<t.numBorders;n++)if(G(e.planes[t.borderPlanes[n]],v,l))break;if(n===t.numBorders){t.numBorders>26&&k("ERROR: too many bevels"),t.borderPlanes[t.numBorders]=Z(e,v,l);for(s=0;s<t.numBorders;s++)t.borderPlanes[t.numBorders]==t.borderPlanes[s]&&k("WARNING: bevel plane already used");t.borderNoAdjust[t.numBorders]=0,t.borderInward[t.numBorders]=l[0];var b=g.clone();e.planes[t.borderPlanes[t.numBorders]].clone(m),t.borderInward[t.numBorders]||(vec3.negate(m.normal),m.dist=-m.dist);if(!i.ChopWindingInPlace(b,m.normal,m.dist,.1)){k("WARNING: AddFacetBevels... invalid bevel");continue}t.numBorders++}}}t.borderPlanes[t.numBorders]=t.surfacePlane,t.borderNoAdjust[t.numBorders]=0,t.borderInward[t.numBorders]=!0,t.numBorders++}function G(e,t,n){if(Math.abs(e.normal[0]-t.normal[0])<K&&Math.abs(e.normal[1]-t.normal[1])<K&&Math.abs(e.normal[2]-t.normal[2])<K&&Math.abs(e.dist-t.dist)<Q)return n[0]=!1,!0;var r=new i.Plane;return vec3.negate(t.normal,r.normal),r.dist=-t.dist,Math.abs(e.normal[0]-r.normal[0])<K&&Math.abs(e.normal[1]-r.normal[1])<K&&Math.abs(e.normal[2]-r.normal[2])<K&&Math.abs(e.dist-r.dist)<Q?(n[0]=!0,!0):!1}function Y(e){for(var t=0;t<3;t++){if(Math.abs(e[t]-1)<K){e[0]=e[1]=e[2]=0,e[t]=1;break}if(Math.abs(e[t]+1)<K){e[0]=e[1]=e[2]=0,e[t]=-1;break}}}function Z(e,n,r){for(var i=0;i<e.planes.length;i++)if(G(e.planes[i],n,r))return i;e.planes.length===y&&t.Error("MAX_PATCH_PLANES");var s=e.planes.length,o=n.clone();return e.planes.push(o),r[0]=!1,s}function ot(e,t){if(!i.BoundsIntersect(e.bounds[0],e.bounds[1],t.bounds[0],t.bounds[1],u))return;if(e.isPoint){ft(e,t);return}for(var n=0;n<t.facets.length;n++){var r=t.facets[n],s=-1;tt.enterFrac=-1,tt.leaveFrac=1,tt.hit=!1;var o=t.planes[r.surfacePlane];vec3.set(o.normal,nt.normal),nt.dist=o.dist;var a=vec3.dot(e.offsets[o.signbits],nt.normal);nt.dist-=a,vec3.set(e.start,it),vec3.set(e.end,st);if(!lt(nt,it,st,tt))continue;tt.hit&&nt.clone(rt);var f=0;for(f=0;f<r.numBorders;f++){o=t.planes[r.borderPlanes[f]],r.borderInward[f]?(vec3.negate(o.normal,nt.normal),nt.dist=-o.dist):(vec3.set(o.normal,nt.normal),nt.dist=o.dist),a=vec3.dot(e.offsets[o.signbits],nt.normal),nt.dist+=Math.abs(a),vec3.set(e.start,it),vec3.set(e.end,st);if(!lt(nt,it,st,tt))break;tt.hit&&(s=f,nt.clone(rt))}if(f<r.numBorders)continue;if(s===r.numBorders-1)continue;tt.enterFrac<tt.leaveFrac&&tt.enterFrac>=0&&tt.enterFrac<e.trace.fraction&&(tt.enterFrac<0&&(tt.enterFrac=0),e.trace.fraction=tt.enterFrac,rt.clone(e.trace.plane))}}function ft(e,t){if(!e.isPoint)return;for(var n=0;n<t.planes.length;n++){var r=t.planes[n],i=vec3.dot(e.offsets[r.signbits],r.normal),s=vec3.dot(e.start,r.normal)-r.dist+i,o=vec3.dot(e.end,r.normal)-r.dist+i;s<=0?ut[n]=!1:ut[n]=!0,s===o?at[n]=99999:(at[n]=s/(s-o),at[n]<=0&&(at[n]=99999))}for(var n=0;n<t.facets.length;n++){var a=t.facets[n];if(!ut[a.surfacePlane])continue;var f=at[a.surfacePlane];if(f<0)continue;if(f>e.trace.fraction)continue;var l=0;for(l=0;l<a.numBorders;l++){var c=a.borderPlanes[l];if(ut[c]^a.borderInward[l]){if(at[c]>f)break}else if(at[c]<f)break}if(l===a.numBorders){var r=t.planes[a.surfacePlane],i=vec3.dot(e.offsets[r.signbits],r.normal),s=vec3.dot(e.start,r.normal)-r.dist+i,o=vec3.dot(e.end,r.normal)-r.dist+i;e.trace.fraction=(s-u)/(s-o),e.trace.fraction<0&&(e.trace.fraction=0),r.clone(e.trace.plane)}}}function lt(e,t,n,r){var i,s=vec3.dot(t,e.normal)-e.dist,o=vec3.dot(n,e.normal)-e.dist;return r.hit=!1,s>0&&(o>=u||o>=s)?!1:s<=0&&o<=0?!0:(s>o?(i=(s-u)/(s-o),i<0&&(i=0),i>r.enterFrac&&(r.enterFrac=i,r.hit=!0)):(i=(s+u)/(s-o),i>1&&(i=1),i<r.leaveFrac&&(r.leaveFrac=i)),!0)}function ct(e){var t=new i.Plane,n=vec3.createFrom(-1,-1,-1),r=vec3.createFrom(1,1,1),s=vec3.create(),o=vec3.create();for(var u=0;u<_.length;u++){var a=_[u];for(var f=0;f<a.facets.length;f++){var l=a.facets[f];for(var c=0;c<l.numBorders+1;c++){var h,p;c<l.numBorders?(h=l.borderPlanes[c],p=l.borderInward[c]):(h=l.surfacePlane,p=!1),a.planes[h].clone(t),p&&(vec3.negate(t),t.dist=-t.dist);for(y=0;y<3;y++)t[y]>0?s[y]=r[y]:s[y]=n[y];vec3.negate(t.normal,o),t.dist+=Math.abs(vec3.dot(s,o));var d=i.BaseWindingForPlane(t.normal,t.dist);for(var v=0;v<l.numBorders+1;v++){var m,g;v<l.numBorders?(m=l.borderPlanes[v],g=l.borderInward[v]):(m=l.surfacePlane,g=!1);if(m===h)continue;a.planes[m].clone(t),g||(vec3.negate(t.normal),t.dist=-t.dist);for(var y=0;y<3;y++)t[y]>0?s[y]=r[y]:s[y]=n[y];vec3.negate(t.normal,o),t.dist-=Math.abs(vec3.dot(s,o));if(!i.ChopWindingInPlace(d,t.normal,t.dist,.1))break}v===l.numBorders+1&&e(d.p)}}}}function ht(e,t){if(!Bt.vis||e===t||e==-1)return!0;var n=e*Bt.clusterBytes;return(Bt.vis[n+(t>>3)]&1<<(t&7))!==0}function pt(e,t,n,r){for(;;){if(r<0){var s=-1-r;Bt.leafs[s].cluster!==-1&&(e.lastLeaf=s);if(e.count>=e.maxCount)return;e.list[e.count++]=s;return}var o=Bt.nodes[r],u=i.BoxOnPlaneSide(t,n,Bt.planes[o.planeNum]);u===i.SIDE_FRONT?r=o.childrenNum[0]:u===i.SIDE_BACK?r=o.childrenNum[1]:(pt(e,t,n,o.childrenNum[0]),r=o.childrenNum[1])}}function dt(e,t,n,r){var i=new d;return i.list=n,i.maxCount=r,Bt.checkcount++,pt(i,e,t,0),i}function vt(e,t){var n;while(t>=0){var r=Bt.nodes[t],i=Bt.planes[r.planeNum];i.type<3?n=e[i.type]-i.dist:n=vec3.dot(i.normal,e)-i.dist,n<0?t=r.childrenNum[1]:t=r.childrenNum[0]}return-1-t}function mt(e){return vt(e,0)}function gt(e,t){var n=Bt.leafBrushes,r=Bt.brushes,s=Bt.brushSides,o;if(t){var u=Zt(t);o=u.leaf}else{var a=mt(e);o=Bt.leafs[a]}var f=0;for(var l=0;l<o.numLeafBrushes;l++){var c=n[o.firstLeafBrush+l],h=r[c];if(!i.BoundsIntersectPoint(h.bounds[0],h.bounds[1],e))continue;var p;for(var p=0;p<h.numSides;p++){var d=s[h.firstSide+p],v=vec3.dot(e,d.plane.normal);if(v>d.plane.dist)break}p===h.numSides&&(f|=h.contents)}return f}function yt(e,t,n,r){var s=vec3.subtract(e,n,vec3.create());if(t!==o&&(r[0]||r[1]||r[2])){var u=vec3.create(),a=vec3.create(),f=vec3.create();i.AnglesToVectors(r,u,a,f);var l=vec3.create(s);s[0]=vec3.dot(l,u),s[1]=-vec3.dot(l,a),s[2]=vec3.dot(l,f)}return gt(s,t)}function bt(e,n){var r=Bt.areas[e];if(r.floodValid===Bt.floodValid){if(r.floodnum===n)return;t.Error("FloodArea_r: reflooded")}r.floodnum=n,r.floodValid=Bt.floodValid;var i=e*Bt.areas.length;for(var s=0;s<Bt.areas.length;s++)Bt.areaPortals[i+s]>0&&bt(s,n)}function wt(){Bt.floodValid++;var e=0;for(var t=0;t<Bt.areas.length;t++){var n=Bt.areas[t];if(n.floodValid===Bt.floodValid)continue;e++,bt(t,e)}}function Et(e,n,r){if(e<0||n<0)return;(e>=Bt.areas.length||n>=Bt.areas.length)&&t.Error("ChangeAreaPortalState: bad area number"),r?(Bt.areaPortals[e*Bt.numAreas+n]++,Bt.areaPortals[n*Bt.numAreas+e]++):(Bt.areaPortals[e*Bt.numAreas+n]--,Bt.areaPortals[n*Bt.numAreas+e]--,Bt.areaPortals[n*Bt.numAreas+e]<0&&t.Error("AdjustAreaPortalState: negative reference count")),wt()}function St(e,n){return e<0||n<0?!1:((e>=Bt.areas.length||n>=Bt.areas.length)&&t.Error("area >= cm.numAreas"),Bt.areas[e].floodnum===Bt.areas[n].floodnum?!0:!1)}function xt(e,t){for(var n=0;n<3;n++)for(var r=0;r<3;r++)t[n][r]=e[r][n]}function Tt(e,t){var n=Bt.brushSides;if(!t.numSides)return;if(e.bounds[0][0]>t.bounds[1][0]||e.bounds[0][1]>t.bounds[1][1]||e.bounds[0][2]>t.bounds[1][2]||e.bounds[1][0]<t.bounds[0][0]||e.bounds[1][1]<t.bounds[0][1]||e.bounds[1][2]<t.bounds[0][2])return;for(var r=6;r<t.numSides;r++){var i=n[t.firstSide+r],s=i.plane,o=s.dist-vec3.dot(e.offsets[s.signbits],s.normal),u=vec3.dot(e.start,s.normal)-o;if(u>0)return}e.trace.startSolid=e.trace.allSolid=!0,e.trace.fraction=0,e.trace.contents=t.contents}function Nt(e,t){var n=Bt.brushes,r=Bt.leafBrushes;for(var i=0;i<t.numLeafBrushes;i++){var s=r[t.firstLeafBrush+i],o=n[s];if(o.checkcount===Bt.checkcount)continue;o.checkcount=Bt.checkcount;if(!(o.contents&e.contents))continue;Tt(e,o);if(e.trace.allSolid)return}}function kt(e){var t=Bt.leafs,n=vec3.add(e.start,e.size[0],vec3.create()),r=vec3.add(e.start,e.size[1],vec3.create());vec3.add(n,[-1,-1,-1]),vec3.add(r,[1,1,1]);var i=new d;i.list=Ct,i.maxCount=p,Bt.checkcount++,pt(i,n,r,0),Bt.checkcount++;for(var s=0;s<i.count;s++){Nt(e,t[i.list[s]]);if(e.trace.allSolid)break}}function Lt(e,t,n,r,i,s){var o=Bt.brushes,a=Bt.leafs,f=Bt.leafBrushes,l=Bt.nodes,c=Bt.planes;if(e.trace.fraction<=n)return;if(t<0){At(e,a[-(t+1)]);return}var h=l[t],p=c[h.planeNum],d,v,m;p.type<3?(d=i[p.type]-p.dist,v=s[p.type]-p.dist,m=e.extents[p.type]):(d=vec3.dot(p.normal,i)-p.dist,v=vec3.dot(p.normal,s)-p.dist,e.isPoint?m=0:m=2048);if(d>=m+1&&v>=m+1){Lt(e,h.childrenNum[0],n,r,i,s);return}if(d<-m-1&&v<-m-1){Lt(e,h.childrenNum[1],n,r,i,s);return}var g,y,b,w;d<v?(g=1/(d-v),y=1,w=(d+m+u)*g,b=(d-m+u)*g):d>v?(g=1/(d-v),y=0,w=(d-m-u)*g,b=(d+m+u)*g):(y=0,b=1,w=0);var E=vec3.create(),S;b<0?b=0:b>1&&(b=1),S=n+(r-n)*b,E[0]=i[0]+b*(s[0]-i[0]),E[1]=i[1]+b*(s[1]-i[1]),E[2]=i[2]+b*(s[2]-i[2]),Lt(e,h.childrenNum[y],n,S,i,E),w<0&&(w=0),w>1&&(w=1),S=n+(r-n)*w,E[0]=i[0]+w*(s[0]-i[0]),E[1]=i[1]+w*(s[1]-i[1]),E[2]=i[2]+w*(s[2]-i[2]),Lt(e,h.childrenNum[y^1],S,r,E,s)}function At(e,t){var n=Bt.brushes,r=Bt.leafBrushes;for(var s=0;s<t.numLeafBrushes;s++){var o=r[t.firstLeafBrush+s],a=n[o];if(a.checkcount===Bt.checkcount)continue;a.checkcount=Bt.checkcount;if(!(a.contents&e.contents))continue;if(!i.BoundsIntersect(e.bounds[0],e.bounds[1],a.bounds[0],a.bounds[1],u))continue;Ot(e,a);if(!e.trace.fraction)return}for(var s=0;s<t.numLeafSurfaces;s++){var f=Bt.surfaces[Bt.leafSurfaces[t.firstLeafSurface+s]];if(!f)continue;if(f.checkcount===Bt.checkcount)continue;f.checkcount=Bt.checkcount;if(!(f.contents&e.contents))continue;Mt(e,f);if(!e.trace.fraction)return}}function Ot(e,t){var n=Bt.brushSides,r=Bt.shaders,i=e.trace,s,o,a=!1,f=!1,l=-1,c=1;if(!t.numSides)return;for(var h=0;h<t.numSides;h++){var p=Bt.brushSides[t.firstSide+h],d=p.plane,v=d.dist-vec3.dot(e.offsets[d.signbits],d.normal),m=vec3.dot(e.start,d.normal)-v,g=vec3.dot(e.end,d.normal)-v;g>0&&(a=!0),m>0&&(f=!0);if(m>0&&(g>=u||g>=m))return;if(m<=0&&g<=0)continue;if(m>g){var y=(m-u)/(m-g);y<0&&(y=0),y>l&&(l=y,o=d,s=p)}else{var y=(m+u)/(m-g);y>1&&(y=1),y<c&&(c=y)}}if(!f){e.trace.startSolid=!0,a||(e.trace.allSolid=!0,e.trace.fraction=0,e.trace.contents=t.contents,e.trace.shaderName=t.shader.shaderName);return}l<c&&l>-1&&l<e.trace.fraction&&(l<0&&(l=0),e.trace.fraction=l,o.clone(e.trace.plane),e.trace.surfaceFlags=s.surfaceFlags,e.trace.contents=t.contents,e.trace.shaderName=t.shader.shaderName)}function Mt(e,t){var n=e.trace.fraction;ot(e,t.pc),e.trace.fraction<n&&(e.trace.surfaceFlags=t.surfaceFlags,e.trace.contents=t.contents)}function Dt(e,n,r,i,s,o,u,a){var f=_t;f.reset(),Bt.checkcount||(Bt.checkcount=0),Bt.checkcount++,i||(i=vec3.create()),s||(s=vec3.create()),f.contents=a;var l=vec3.create();for(var c=0;c<3;c++)l[c]=(i[c]+s[c])*.5,f.size[0][c]=i[c]-l[c],f.size[1][c]=s[c]-l[c],f.start[c]=n[c]+l[c],f.end[c]=r[c]+l[c];f.offsets[0][0]=f.size[0][0],f.offsets[0][1]=f.size[0][1],f.offsets[0][2]=f.size[0][2],f.offsets[1][0]=f.size[1][0],f.offsets[1][1]=f.size[0][1],f.offsets[1][2]=f.size[0][2],f.offsets[2][0]=f.size[0][0],f.offsets[2][1]=f.size[1][1],f.offsets[2][2]=f.size[0][2],f.offsets[3][0]=f.size[1][0],f.offsets[3][1]=f.size[1][1],f.offsets[3][2]=f.size[0][2],f.offsets[4][0]=f.size[0][0],f.offsets[4][1]=f.size[0][1],f.offsets[4][2]=f.size[1][2],f.offsets[5][0]=f.size[1][0],f.offsets[5][1]=f.size[0][1],f.offsets[5][2]=f.size[1][2],f.offsets[6][0]=f.size[0][0],f.offsets[6][1]=f.size[1][1],f.offsets[6][2]=f.size[1][2],f.offsets[7][0]=f.size[1][0],f.offsets[7][1]=f.size[1][1],f.offsets[7][2]=f.size[1][2];for(var c=0;c<3;c++)f.start[c]<f.end[c]?(f.bounds[0][c]=f.start[c]+f.size[0][c],f.bounds[1][c]=f.end[c]+f.size[1][c]):(f.bounds[0][c]=f.end[c]+f.size[0][c],f.bounds[1][c]=f.start[c]+f.size[1][c]);var h=o?Zt(o):null;n[0]==r[0]&&n[1]==r[1]&&n[2]==r[2]?o?Nt(f,h.leaf):kt(f):(f.size[0][0]===0&&f.size[0][1]===0&&f.size[0][2]===0?(f.isPoint=!0,f.extents=vec3.create()):(f.isPoint=!1,f.extents[0]=f.size[1][0],f.extents[1]=f.size[1][1],f.extents[2]=f.size[1][2]),o?At(f,h.leaf):Lt(f,0,0,1,f.start,f.end));for(var c=0;c<3;c++)f.trace.endPos[c]=n[c]+f.trace.fraction*(r[c]-n[c]);!f.trace.allSolid&&f.trace.fraction!==1&&vec3.squaredLength(f.trace.plane.normal)<=.9999&&!vec3.length(f.trace.endPos)&&t.Error("Invalid trace result"),f.trace.clone(e)}function Pt(e,t,n,r,i,s,o){return Dt(e,t,n,r,i,s,vec3.create(),o)}function Ht(e,t,n,r,s,u,a,f,l){r||(r=vec3.create()),s||(s=vec3.create());var c=vec3.create(),h=vec3.create(),p=vec3.create(),d=[vec3.create(),vec3.create()],v=[vec3.create(),vec3.create(),vec3.create()],m=[vec3.create(),vec3.create(),vec3.create()];for(var g=0;g<3;g++)p[g]=(r[g]+s[g])*.5,d[0][g]=r[g]-p[g],d[1][g]=s[g]-p[g],c[g]=t[g]+p[g],h[g]=n[g]+p[g];vec3.subtract(c,f),vec3.subtract(h,f);var y=!1;u!==o&&(l[0]||l[1]||l[2])&&(y=!0),y&&(i.AnglesToAxis(l,v),i.RotatePoint(c,v),i.RotatePoint(h,v)),Dt(e,c,h,d[0],d[1],u,f,a),y&&e.fraction!==1&&(xt(v,m),i.RotatePoint(e.plane.normal,m)),e.endPos[0]=t[0]+e.fraction*(n[0]-t[0]),e.endPos[1]=t[1]+e.fraction*(n[1]-t[1]),e.endPos[2]=t[2]+e.fraction*(n[2]-t[2])}function jt(e){k("Initializing"),Bt=new a,Bt.shaders=e.shaders,Bt.planes=e.planes,Bt.nodes=e.nodes,Bt.numClusters=e.numClusters,Bt.clusterBytes=e.clusterBytes,Bt.vis=e.vis,Ft(e.leafs,e.leafBrushes,e.leafSurfaces),It(e.brushes,e.brushSides),qt(e.bmodels),Rt(e.surfaces,e.verts),Kt(),wt()}function Ft(e,t,n){Bt.leafs=e,Bt.leafBrushes=t,Bt.leafSurfaces=n;var r=0;for(var i=0;i<e.length;i++){var s=e[i];s.area>=r&&(r=s.area+1)}Bt.areas=new Array(r),Bt.areaPortals=new Array(r*r);for(var i=0;i<r;i++)Bt.areas[i]=new h;for(var i=0;i<r*r;i++)Bt.areaPortals[i]=0}function It(e,t){var n=Bt.shaders,r=Bt.planes,i=Bt.brushSides=new Array(t.length);for(var s=0;s<t.length;s++){var o=t[s],u=i[s]=new l;u.plane=r[o.planeNum],u.surfaceFlags=n[o.shaderNum].surfaceFlags}var a=Bt.brushes=new Array(e.length);for(var s=0;s<e.length;s++){var f=e[s],h=a[s]=new c;h.shader=n[f.shaderNum],h.contents=h.shader.contents,h.bounds[0][0]=-i[f.side+0].plane.dist,h.bounds[0][1]=-i[f.side+2].plane.dist,h.bounds[0][2]=-i[f.side+4].plane.dist,h.bounds[1][0]=i[f.side+1].plane.dist,h.bounds[1][1]=i[f.side+3].plane.dist,h.bounds[1][2]=i[f.side+5].plane.dist,h.firstSide=f.side,h.numSides=f.numSides}}function qt(e){Bt.models=new Array(e.length);for(var t=0;t<e.length;t++){var n=e[t],r=Bt.models[t]=new f,i=vec3.createFrom(1,1,1);vec3.subtract(n.bounds[0],i,r.mins),vec3.add(n.bounds[1],i,r.maxs);if(t===0)continue;var s=r.leaf;s.numLeafBrushes=n.numBrushes,s.firstLeafBrush=Bt.leafBrushes.length;for(var o=0;o<n.numBrushes;o++)Bt.leafBrushes.push(n.firstBrush+o);s.numLeafSurfaces=n.numSurfaces,s.firstLeafSurface=Bt.leafSurfaces.length;for(var o=0;o<n.numSurfaces;o++)Bt.leafSurfaces.push(n.firstSurface+o)}}function Rt(e,n){Bt.surfaces=new Array(e.length);var i=new Array(g);for(var s=0;s<g;s++)i[s]=vec3.create();for(var s=0;s<e.length;s++){var o=e[s];if(o.surfaceType!==r.MST.PATCH)continue;var u=Bt.surfaces[s]=new C,a=o.patchWidth,f=o.patchHeight,l=a*f;l>g&&t.Error("ParseMesh: MAX_PATCH_VERTS");for(var c=0;c<l;c++)vec3.set(n[o.vertex+c].pos,i[c]);u.contents=Bt.shaders[o.shaderNum].contents,u.surfaceFlags=Bt.shaders[o.shaderNum].surfaceFlags,u.pc=D(a,f,i)}}function Kt(){Vt=new f,Vt.leaf.numLeafBrushes=1,Vt.leaf.firstLeafBrush=Bt.leafBrushes.length,Bt.leafBrushes.push(Bt.brushes.length),$t=new c,$t.firstSide=Bt.brushSides.length,$t.numSides=zt,$t.contents=s.CONTENTS.BODY,Bt.brushes.push($t),Jt=new Array(Xt);for(var e=0;e<Xt;e++){var t=Jt[e]=new i.Plane;Bt.planes.push(t)}for(var e=0;e<6;e++){var n=e&1,o=new r.dbrushside_t;o.plane=Jt[e*2+n],o.surfaceFlags=0;var u=Jt[e*2];u.type=e>>1,u.normal[0]=u.normal[1]=u.normal[2]=0,u.normal[e>>1]=1,u.signbits=0,u=Jt[e*2+1],u.type=3+(e>>1),u.normal[0]=u.normal[1]=u.normal[2]=0,u.normal[e>>1]=-1,u.signbits=i.GetPlaneSignbits(u.normal),Bt.brushSides.push(o)}}function Qt(e){return(e<0||e>=Bt.models.length)&&t.Error("GetInlineModel: bad number"),e}function Gt(e,t){return vec3.set(e,Vt.mins),vec3.set(t,Vt.maxs),Jt[0].dist=t[0],Jt[1].dist=-t[0],Jt[2].dist=e[0],Jt[3].dist=-e[0],Jt[4].dist=t[1],Jt[5].dist=-t[1],Jt[6].dist=e[1],Jt[7].dist=-e[1],Jt[8].dist=t[2],Jt[9].dist=-t[2],Jt[10].dist=e[2],Jt[11].dist=-e[2],vec3.set(e,$t.bounds[0]),vec3.set(t,$t.bounds[1]),o}function Yt(e,t,n){var r=Zt(e);vec3.set(r.mins,t),vec3.set(r.maxs,n)}function Zt(e){e<0&&t.Error("ClipHandleToModel: bad handle "+e);if(e<Bt.models.length)return Bt.models[e];if(e===o)return Vt;t.Error("ClipHandleToModel: bad handle "+Bt.models.length+" < "+e)}function en(e){return(e<0||e>=Bt.leafs.length)&&t.Error("LeafCluster: bad number"),Bt.leafs[e].cluster}function tn(e){return(e<0||e>=Bt.leafs.length)&&t.Error("LeafArea: bad number"),Bt.leafs[e].area}var t=e.COM,n=256,o=255,u=.125,a=function(){this.shaders=null,this.brushes=null,this.brushSides=null,this.models=null,this.leafs=null,this.leafBrushes=null,this.leafSurfaces=null,this.nodes=null,this.planes=null,this.shaders=null,this.surfaces=null,this.visibility=null,this.numClusters=0,this.clusterBytes=0,this.areas=null,this.areaPortals=null,this.floodValid=0},f=function(){this.mins=vec3.create(),this.maxs=vec3.create(),this.leaf=new r.dleaf_t},l=function(){this.plane=null,this.surfaceFlags=0},c=function(){this.shader=0,this.contents=0,this.bounds=[vec3.create(),vec3.create()],this.firstSide=0,this.numSides=0,this.checkcount=0},h=function(){this.floodnum=0,this.floodValid=0},p=1024,d=function(){this.list=null,this.count=0,this.maxCount=0,this.lastLeaf=0},v=function(){this.trace=new s.TraceResults,this.start=vec3.create(),this.end=vec3.create(),this.size=[vec3.create(),vec3.create()],this.offsets=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],this.extents=vec3.create(),this.bounds=[vec3.create(),vec3.create()],this.contents=0,this.isPoint=!1};v.prototype.reset=function(){this.trace.reset(),this.start[0]=this.start[1]=this.start[2]=0,this.end[0]=this.end[1]=this.end[2]=0;for(var e=0;e<this.size.length;e++)this.size[e][0]=this.size[e][1]=this.size[e][2]=0;for(var e=0;e<this.offsets.length;e++)this.offsets[e][0]=this.offsets[e][1]=this.offsets[e][2]=0;this.extents[0]=this.extents[1]=this.extents[2]=0;for(var e=0;e<this.bounds.length;e++)this.bounds[e][0]=this.bounds[e][1]=this.bounds[e][2]=0;this.contents=0,this.isPoint=!1};var m=1024,g=1024,y=2048,b=129,w=16,E=.1,S=function(){this.plane=vec4.create(),this.signbits=0},x=function(){this.surfacePlane=0,this.numBorders=0,this.borderPlanes=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.borderInward=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.borderNoAdjust=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1]},T=function(){this.bounds=[vec3.create(),vec3.create()],this.planes=[],this.facets=[]},N=function(){this.width=0,this.height=0,this.wrapWidth=0,this.wrapHeight=0,this.points=new Array(b);for(var e=0;e<b;e++){this.points[e]=new Array(b);for(var t=0;t<b;t++)this.points[e][t]=vec3.create()}},C=function(){this.checkcount=0,this.surfaceFlags=0,this.contents=0,this.pc=null},L=0,A=1,O=2,M=3,_=[],I=.1,K=1e-4,Q=.02,et=function(){this.enterFrac=0,this.leaveFrac=0,this.hit=!1},tt=new et,nt=new i.Plane,rt=new i.Plane,it=vec3.create(),st=vec3.create(),ut=new Array(y),at=new Array(y),Ct=new Uint32Array(p),_t=new v,Bt,Ut=1,zt=6,Wt=2,Xt=12,Vt=null,$t=null,Jt=null;return{LoadWorld:jt,InlineModel:Qt,TempBoxModel:Gt,ModelBounds:Yt,LeafArea:tn,LeafCluster:en,ClusterVisible:ht,BoxLeafnums:dt,PointLeafnum:mt,PointContents:gt,TransformedPointContents:yt,AdjustAreaPortalState:Et,AreasConnected:St,BoxTrace:Pt,TransformedBoxTrace:Ht,EmitCollisionSurfaces:ct}}return{CreateInstance:function(e){return new o(e)}}}),define("game/bg",["glmatrix","common/qmath","common/qshared"],function(e,t,n){function r(e){function tt(e){r.Error(e)}function nt(e,t,n){e.events[e.eventSequence&u-1]=t,e.eventParms[e.eventSequence&u-1]=n,e.eventSequence++}function rt(e,n){e.pm_type===O.INTERMISSION||e.pm_type===O.SPECTATOR?n.eType=W.INVISIBLE:e.stats[j.HEALTH]<=d?n.eType=W.INVISIBLE:n.eType=W.PLAYER,n.number=e.clientNum,n.arenaNum=e.arenaNum,n.pos.trType=l.INTERPOLATE,vec3.set(e.origin,n.pos.trBase),vec3.set(e.velocity,n.pos.trDelta),n.apos.trType=l.INTERPOLATE,vec3.set(e.viewangles,n.apos.trBase),n.angles2[t.YAW]=e.movementDir,n.legsAnim=e.legsAnim,n.torsoAnim=e.torsoAnim,n.clientNum=e.clientNum,n.eFlags=e.eFlags,e.stats[j.HEALTH]<=0?n.eFlags|=X.DEAD:n.eFlags&=~X.DEAD;if(e.externalEvent)n.event=e.externalEvent,n.eventParm=e.externalEventParm;else if(e.entityEventSequence<e.eventSequence){e.entityEventSequence<e.eventSequence-u&&(e.entityEventSequence=e.eventSequence-u);var r=e.entityEventSequence&u-1;n.event=e.events[r]|(e.entityEventSequence&3)<<8,n.eventParm=e.eventParms[r],e.entityEventSequence++}n.weapon=e.weapon,n.groundEntityNum=e.groundEntityNum,n.powerups=0;for(var i=0;i<o;i++)e.powerups[i]&&(n.powerups|=1<<i);n.loopSound=e.loopSound,n.generic1=e.generic1}function it(e,t,n){var i,s;switch(e.trType){case l.STATIONARY:case l.INTERPOLATE:vec3.set(e.trBase,n);break;case l.LINEAR:i=(t-e.trTime)*.001,vec3.add(e.trBase,vec3.scale(e.trDelta,i,vec3.create()),n);break;case l.SINE:i=(t-e.trTime)/e.trDuration,s=Math.sin(i*Math.PI*2),vec3.add(e.trBase,vec3.scale(e.trDelta,s,vec3.create()),n);break;case l.LINEAR_STOP:t>e.trTime+e.trDuration&&(t=e.trTime+e.trDuration),i=(t-e.trTime)*.001,i<0&&(i=0),vec3.add(e.trBase,vec3.scale(e.trDelta,i,vec3.create()),n);break;case l.GRAVITY:i=(t-e.trTime)*.001,vec3.add(e.trBase,vec3.scale(e.trDelta,i,vec3.create()),n),n[2]-=.5*p*i*i;break;default:r.Error("EvaluateTrajectory: unknown trType: "+e.trType)}}function st(e,t,n){var i,s;switch(e.trType){case l.STATIONARY:case l.INTERPOLATE:n[0]=n[1]=n[2]=0;break;case l.LINEAR:vec3.set(e.trDelta,n);break;case l.SINE:i=(t-e.trTime)/e.trDuration,s=Math.cos(i*Math.PI*2),s*=.5,vec3.scale(e.trDelta,s,n);break;case l.LINEAR_STOP:if(t>e.trTime+e.trDuration){n[0]=n[1]=n[2]=0;return}vec3.set(e.trDelta,n);break;case l.GRAVITY:i=(t-e.trTime)*.001,vec3.set(e.trDelta,n),n[2]-=p*i;break;default:r.Error("EvaluateTrajectoryDelta: unknown trType: "+e.trType)}}function ot(e,n){if(e.pm_type!==O.NORMAL)return;if(e.powerups[I.FLIGHT])return;if(e.jumppad_ent!==n.number){var r=vec3.create();t.VectorToAngles(n.origin2,r);var i=Math.abs(t.AngleNormalize180(r[t.PITCH])),s=i<45?0:1;nt(e,Q.JUMP_PAD,s)}e.jumppad_ent=n.number,e.jumppad_frame=e.pmove_framecount,vec3.set(n.origin2,e.velocity)}function ut(e,t,n){(t.modelIndex<1||t.modelIndex>=gn.length)&&r.Error("CanItemBeGrabbed: index out of range");var i=gn[t.modelIndex];switch(i.giType){case H.WEAPON:return!0;case H.AMMO:if(n.ammo[i.giTag]>=200)return!1;return!0;case H.ARMOR:if(n.stats[j.ARMOR]>=n.stats[j.MAX_HEALTH]*2)return!1;return!0;case H.HEALTH:if(i.quantity==5||i.quantity==100)return n.stats[j.HEALTH]>=n.stats[j.MAX_HEALTH]*2?!1:!0;if(n.stats[j.HEALTH]>=n.stats[j.MAX_HEALTH])return!1;return!0;case H.POWERUP:return!0;case H.TEAM:if(e==_.CTF)if(n.persistant[U.TEAM]==q.RED){if(i.giTag==I.BLUEFLAG||i.giTag==I.REDFLAG&&t.modelIndex2||i.giTag==I.REDFLAG&&n.powerups[I.BLUEFLAG])return!0}else if(n.persistant[U.TEAM]==q.BLUE)if(i.giTag==I.REDFLAG||i.giTag==I.BLUEFLAG&&t.modelIndex2||i.giTag==I.BLUEFLAG&&n.powerups[I.REDFLAG])return!0;return!1;case H.HOLDABLE:if(n.stats[j.HOLDABLE_ITEM])return!1;return!0;case H.BAD:return tt("CanItemBeGrabbed: IT.BAD"),!1;default:}return!1}function at(e,t,n){var r=vec3.create();return it(t.pos,n,r),e.origin[0]-r[0]>44||e.origin[0]-r[0]<-50||e.origin[1]-r[1]>36||e.origin[1]-r[1]<-36||e.origin[2]-r[2]>36||e.origin[2]-r[2]<-36?!1:!0}function ft(e,t,n,r){var i=0,s=vec3.create(e);s[2]+=E+1;var o=r(s,n);if(o&B.WATER){var u=t-E,a=u/2;i=1,s[2]=e[2]+E+a,o=r(s,n),o&B.WATER&&(i=2,s[2]=e[2]+E+u,o=r(s,n),o&B.WATER&&(i=3))}return i}function Ot(e){var t=e.ps,n=e.cmd,r=n.serverTime;if(r<t.commandTime)return;r>t.commandTime+1e3&&(t.commandTime=r-1e3),t.pmove_framecount=t.pmove_framecount+1&(1<<a)-1;while(t.commandTime!==r){var i=r-t.commandTime;e.pmove_fixed?i>e.pmove_msec&&(i=e.pmove_msec):i>66&&(i=66),n.serverTime=t.commandTime+i,Mt(e),e.ps.pm_flags&M.JUMP_HELD&&(e.cmd.upmove=20)}}function Mt(e){ct=e;var n=ct.ps,r=ct.cmd;lt.reset(),lt.msec=r.serverTime-n.commandTime,lt.msec<1?lt.msec=1:lt.msec>200&&(lt.msec=200),n.commandTime=r.serverTime,lt.frameTime=lt.msec*.001;if(Math.abs(r.forwardmove)>64||Math.abs(r.rightmove)>64)r.buttons&=~f.WALKING;!(n.pm_flags&M.RESPAWNED)&&!(n.pm_flags&M.NO_ATTACK)&&n.pm_type!==O.INTERMISSION&&n.pm_type!==O.NOCLIP&&r.buttons&f.ATTACK&&n.ammo[n.weapon]?n.eFlags|=X.FIRING:n.eFlags&=~X.FIRING,n.stats[j.HEALTH]>0&&!(r.buttons&(f.ATTACK|f.USE_HOLDABLE))&&(n.pm_flags&=~M.RESPAWNED),vec3.set(n.origin,lt.previous_origin),vec3.set(n.velocity,lt.previous_velocity),Zt(n,r),t.AnglesToVectors(n.viewangles,lt.forward,lt.right,lt.up);if(Math.abs(r.forwardmove)>64||Math.abs(r.rightmove)>64)r.buttons&=~f.WALKING;ct.cmd.upmove<10&&(n.pm_flags&=~M.JUMP_HELD);if(r.forwardmove<0)n.pm_flags|=M.BACKWARDS_RUN;else if(ct.cmd.forwardmove>0||r.forwardmove===0&&r.rightmove)n.pm_flags&=~M.BACKWARDS_RUN;n.pm_type>=O.DEAD&&(r.forwardmove=0,r.rightmove=0,r.upmove=0);if(ct.ps.pm_type===O.SPECTATOR){Pt(),Rt(),en();return}if(ct.ps.pm_type===O.NOCLIP){Ut(),en();return}if(ct.ps.pm_type==O.INTERMISSION||ct.ps.pm_type==O.SPINTERMISSION)return;Dt(),lt.previous_waterlevel=ct.waterlevel,Pt(),Bt(),n.pm_type===O.DEAD&&qt(),en(),n.pm_flags&M.TIME_WATERJUMP?Xt():ct.waterlevel>1?Wt():lt.walking?Vt():zt(),Bt(),Dt(),tn(),sn(),un(),an(),t.SnapVector(n.velocity),ct=null}function _t(e,t){var n=Math.abs(e.forwardmove);Math.abs(e.rightmove)>n&&(n=Math.abs(e.rightmove)),Math.abs(e.upmove)>n&&(n=Math.abs(e.upmove));if(!n)return 0;var r=Math.sqrt(e.forwardmove*e.forwardmove+e.rightmove*e.rightmove+e.upmove*e.upmove),i=t*n/(127*r);return i}function Dt(){var e=ct.ps;ct.waterlevel=ft(e.origin,e.viewheight,e.clientNum,ct.pointContents);var t=vec3.createFrom(e.origin[0],e.origin[1],e.origin[2]+E+1),n=ct.pointContents(t,-1);n&B.WATER?ct.watertype=n:ct.watertype=0}function Pt(){var e=ct.ps,t=new n.TraceResults;ct.mins[0]=-15,ct.mins[1]=-15,ct.maxs[0]=15,ct.maxs[1]=15,ct.mins[2]=E;if(ct.pm_type===O.DEAD){ct.maxs[2]=-8,e.viewheight=T;return}ct.cmd.upmove<0?e.pm_flags|=M.DUCKED:e.pm_flags&M.DUCKED&&(ct.maxs[2]=32,ct.trace(t,e.origin,e.origin,ct.mins,ct.maxs,e.clientNum,ct.tracemask),t.allSolid||(e.pm_flags&=~M.DUCKED)),e.pm_flags&M.DUCKED?(ct.maxs[2]=16,e.viewheight=x):(ct.maxs[2]=32,e.viewheight=S)}function Ht(){var e=ct.ps;return ct.cmd.upmove<10?!1:e.pm_flags&M.JUMP_HELD?(ct.cmd.upmove=0,!1):(lt.groundPlane=!1,lt.walking=!1,e.pm_flags|=M.JUMP_HELD,e.groundEntityNum=i,e.velocity[2]=Lt,ln(Q.JUMP),ct.cmd.forwardmove>=0?(mn(Z.LEGS_JUMP),e.pm_flags&=~M.BACKWARDS_JUMP):(mn(Z.LEGS_JUMPB),e.pm_flags|=M.BACKWARDS_JUMP),!0)}function Bt(){var e=ct.ps,t=new n.TraceResults,r=vec3.createFrom(e.origin[0],e.origin[1],e.origin[2]-.25);ct.trace(t,e.origin,r,ct.mins,ct.maxs,e.clientNum,ct.tracemask),lt.groundTrace=t;if(t.allSolid&&!Ft(t))return;if(t.fraction===1){It();return}if(e.velocity[2]>0&&vec3.dot(e.velocity,t.plane.normal)>10){ct.cmd.forwardmove>=0?(mn(Z.LEGS_JUMP),e.pm_flags&=~M.BACKWARDS_JUMP):(mn(Z.LEGS_JUMPB),e.pm_flags|=M.BACKWARDS_JUMP),e.groundEntityNum=i,lt.groundPlane=!1,lt.walking=!1;return}if(t.plane.normal[2]<pt){e.groundEntityNum=i,lt.groundPlane=!0,lt.walking=!1;return}lt.groundPlane=!0,lt.walking=!0,e.pm_flags&M.TIME_WATERJUMP&&(e.pm_flags&=~(M.TIME_WATERJUMP|M.TIME_LAND),e.pm_time=0),e.groundEntityNum===i&&(on(),lt.previous_velocity[2]<-200&&(e.pm_flags|=M.TIME_LAND,e.pm_time=250)),e.groundEntityNum=t.entityNum,cn(t.entityNum)}function jt(){var e=ct.ps;if(e.pm_time)return!1;if(ct.waterlevel!==2)return!1;var t=vec3.createFrom(lt.forward[0],lt.forward[1],0);vec3.normalize(t);var n=vec3.add(vec3.scale(t,30,vec3.create()),e.origin);n[2]+=4;var r=ct.pointContents(n,e.clientNum);return r&h.SOLID?(n[2]+=16,r=ct.pointContents(n,e.clientNum),r&(h.SOLID|h.PLAYERCLIP|h.BODY)?!1:(vec3.scale(lt.forward,200,e.velocity),e.velocity[2]=350,e.pm_flags|=M.TIME_WATERJUMP,e.pm_time=2e3,!0)):!1}function Ft(e){var t=ct.ps,r=vec3.create(),s=new n.TraceResults;for(var o=-1;o<=1;o++)for(var u=-1;u<=1;u++)for(var a=-1;a<=1;a++){vec3.set(t.origin,r),r[0]+=o,r[1]+=u,r[2]+=a,ct.trace(s,r,r,ct.mins,ct.maxs,t.clientNum,ct.tracemask);if(!s.allSolid)return s.clone(e),!0}return t.groundEntityNum=i,lt.groundPlane=!1,lt.walking=!1,!1}function It(){var e=ct.ps,t=new n.TraceResults;if(e.groundEntityNum!==i){var r=vec3.create(e.origin);r[2]-=64,ct.trace(t,e.origin,r,ct.mins,ct.maxs,e.clientNum,ct.tracemask),t.fraction===1&&(ct.cmd.forwardmove>=0?(mn(Z.LEGS_JUMP),e.pm_flags&=~M.BACKWARDS_JUMP):(mn(Z.LEGS_JUMPB),e.pm_flags|=M.BACKWARDS_JUMP))}e.groundEntityNum=i,lt.groundPlane=!1,lt.walking=!1}function qt(){if(!lt.walking)return;var e=ct.ps,t=vec3.length(e.velocity);t-=20,t<=0?e.velocity[0]=e.velocity[1]=e.velocity[2]=0:(vec3.normalize(e.velocity),vec3.scale(e.velocity,t))}function Rt(){var e=ct.ps,t=ct.cmd;Jt(!0);var n=_t(t,e.speed),r=vec3.create();for(var i=0;i<3;i++)r[i]=n*lt.forward[i]*t.forwardmove+n*lt.right[i]*t.rightmove;r[2]+=t.upmove;var s=vec3.length(r),o=vec3.normalize(r,vec3.create());Kt(o,s,xt),Yt(!1)}function Ut(){var e=ct.ps,n=ct.cmd;e.viewheight=S;var r=vec3.length(e.velocity);if(r<1)vec3.set(t.vec3origin,e.velocity);else{var i=Tt*1.5,s=r<gt?gt:r,o=s*i*lt.frameTime,u=r-o;u<0&&(u=0),u/=r,vec3.scale(e.velocity,u)}var a=_t(n,e.speed),f=vec3.create();for(var l=0;l<3;l++)f[l]=lt.forward[l]*n.forwardmove+lt.right[l]*n.rightmove;f[2]+=n.upmove;var c=vec3.length(f)*a,h=vec3.normalize(f,vec3.create());Kt(h,c,wt),vec3.add(e.origin,vec3.scale(e.velocity,lt.frameTime,vec3.create()))}function zt(){var e=ct.ps,t=ct.cmd;Jt(),$t(),lt.forward[2]=0,lt.right[2]=0,vec3.normalize(lt.forward),vec3.normalize(lt.right);var n=_t(t,e.speed),r=vec3.create();for(var i=0;i<2;i++)r[i]=lt.forward[i]*t.forwardmove+lt.right[i]*t.rightmove;r[2]=0;var s=vec3.normalize(r,vec3.create()),o=vec3.length(r)*n;Kt(s,o,Et),lt.groundPlane&&(e.velocity=Qt(e.velocity,lt.groundTrace.plane.normal,mt)),Yt(!0)}function Wt(){var e=ct.ps,t=ct.cmd;if(jt()){Xt();return}Jt();var n=_t(t,e.speed),r=vec3.create();if(!n)r[0]=0,r[1]=0,r[2]=-60;else{for(var i=0;i<3;i++)r[i]=lt.forward[i]*t.forwardmove+lt.right[i]*t.rightmove;r[2]+=n*ct.cmd.upmove}var s=vec3.normalize(r,vec3.create()),o=vec3.length(r);o>e.speed*bt&&(o=e.speed*bt),Kt(s,o,St);if(lt.groundPlane&&vec3.dot(e.velocity,lt.groundTrace.plane.normal)<0){var u=vec3.length(e.velocity);Qt(e.velocity,lt.groundTrace.plane.normal,e.velocity,mt),vec3.normalize(e.velocity),vec3.scale(e.velocity,u)}Gt(!1)}function Xt(){var e=ct.ps;Yt(!0),e.velocity[2]-=e.gravity*lt.frameTime,e.velocity[2]<0&&(e.pm_flags&=~M.ALL_TIMES,e.pm_time=0)}function Vt(){var e=ct.ps,t=ct.cmd;if(Ht()){zt();return}Jt(),$t(),lt.forward[2]=0,lt.right[2]=0,lt.forward=Qt(lt.forward,lt.groundTrace.plane.normal,mt),lt.right=Qt(lt.right,lt.groundTrace.plane.normal,mt),vec3.normalize(lt.forward),vec3.normalize(lt.right);var n=_t(t,e.speed),r=vec3.create();for(var i=0;i<3;i++)r[i]=lt.forward[i]*t.forwardmove+lt.right[i]*t.rightmove;var s=vec3.length(r),o=vec3.normalize(r,vec3.create());s*=n,e.pm_flags&M.DUCKED&&s>e.speed*yt&&(s=e.speed*yt);if(ct.waterlevel){var u=ct.waterlevel/3;u=1-(1-bt)*u,s>e.speed*u&&(s=e.speed*u)}var a=wt;if(lt.groundTrace.surfaceFlags&c.SLICK||e.pm_flags&M.TIME_KNOCKBACK)a=Et;Kt(o,s,a);if(lt.groundTrace.surfaceFlags&c.SLICK||e.pm_flags&M.TIME_KNOCKBACK)e.velocity[2]-=e.gravity*lt.frameTime;var f=vec3.length(e.velocity);e.velocity=Qt(e.velocity,lt.groundTrace.plane.normal,mt),vec3.normalize(e.velocity),vec3.scale(e.velocity,f);if(!e.velocity[0]&&!e.velocity[1])return;Yt(!1)}function $t(){var e=ct.ps;ct.cmd.forwardmove||ct.cmd.rightmove?ct.cmd.rightmove===0&&ct.cmd.forwardmove>0?e.movementDir=0:ct.cmd.rightmove<0&&ct.cmd.forwardmove>0?e.movementDir=1:ct.cmd.rightmove<0&&ct.cmd.forwardmove===0?e.movementDir=2:ct.cmd.rightmove<0&&ct.cmd.forwardmove<0?e.movementDir=3:ct.cmd.rightmove===0&&ct.cmd.forwardmove<0?e.movementDir=4:ct.cmd.rightmove>0&&ct.cmd.forwardmove<0?e.movementDir=5:ct.cmd.rightmove>0&&ct.cmd.forwardmove===0?e.movementDir=6:ct.cmd.rightmove>0&&ct.cmd.forwardmove>0&&(e.movementDir=7):e.movementDir===2?e.movementDir=1:e.movementDir===6&&(e.movementDir=7)}function Jt(e){var t=ct.ps,n=vec3.create(t.velocity);lt.walking&&(n[2]=0);var r=vec3.length(n);if(r<1){t.velocity[0]=0,t.velocity[1]=0;return}var i=0;if(ct.waterlevel<=1&&lt.walking&&!(lt.groundTrace.surfaceFlags&c.SLICK)&&!(t.pm_flags&M.TIME_KNOCKBACK)){var s=r<gt?gt:r;i+=s*Tt*lt.frameTime}ct.waterlevel&&(i+=r*Nt*ct.waterlevel*lt.frameTime),e&&(i+=r*Ct*lt.frameTime);var o=r-i;o<0&&(o=0),o/=r,vec3.scale(t.velocity,o)}function Kt(e,t,n){var r=ct.ps,i=vec3.dot(r.velocity,e),s=t-i;if(s<=0)return;var o=n*lt.frameTime*t;o>s&&(o=s),vec3.add(r.velocity,vec3.scale(e,o,vec3.create()))}function Qt(e,t,n){var r=vec3.dot(e,t);r<0?r*=n:r/=n;var i=vec3.scale(t,r,vec3.create());return vec3.subtract(e,i,vec3.create())}function Gt(e){var t=ct.ps,r=vec3.create(),i=lt.frameTime,s=[],o=4,u=vec3.create(),a=new n.TraceResults;e&&(vec3.set(t.velocity,r),r[2]-=t.gravity*i,t.velocity[2]=(t.velocity[2]+r[2])*.5,lt.groundPlane&&(t.velocity=Qt(t.velocity,lt.groundTrace.plane.normal,mt))),lt.groundPlane&&s.push(vec3.set(lt.groundTrace.plane.normal,vec3.create())),s.push(vec3.normalize(t.velocity,vec3.create()));for(var f=0;f<o;f++){vec3.add(t.origin,vec3.scale(t.velocity,i,vec3.create()),u),ct.trace(a,t.origin,u,ct.mins,ct.maxs,t.clientNum,ct.tracemask);if(a.allSolid)return t.velocity[2]=0,!1;a.fraction>0&&vec3.set(a.endPos,t.origin);if(a.fraction===1)break;cn(a.entityNum),i-=i*a.fraction;if(s.length>=ht)return t.velocity=vec3.create(),!1;for(var l=0;l<s.length;l++)if(vec3.dot(a.plane.normal,s[l])>.99){vec3.add(t.velocity,a.plane.normal);break}if(l<s.length)continue;s.push(vec3.set(a.plane.normal,vec3.create()));for(var l=0;l<s.length;++l){var c=vec3.dot(t.velocity,s[l]);if(c>=.1)continue;var h=Qt(t.velocity,s[l],mt),p=Qt(r,s[l],mt);for(var d=0;d<s.length;d++){if(d===l)continue;if(vec3.dot(h,s[d])>=.1)continue;h=Qt(h,s[d],mt),p=Qt(p,s[d],mt);if(vec3.dot(h,s[l])>=0)continue;var v=vec3.cross(s[l],s[d],vec3.create());vec3.normalize(v);var m=vec3.dot(v,t.velocity);vec3.scale(v,m,h),vec3.cross(s[l],s[d],v),vec3.normalize(v),m=vec3.dot(v,r),vec3.scale(v,m,p);for(var g=0;g<s.length;g++){if(g==l||g==d)continue;if(vec3.dot(h,s[g])>=.1)continue;return t.velocity=vec3.create(),!1}}vec3.set(h,t.velocity),vec3.set(p,r);break}}return e&&vec3.set(r,t.velocity),f===0}function Yt(e){var t=ct.ps,r=new n.TraceResults,i=vec3.create(t.origin),s=vec3.create(t.velocity);if(Gt(e))return;var o=vec3.createFrom(0,0,1),u=vec3.create(i);u[2]-=dt,ct.trace(r,i,u,ct.mins,ct.maxs,t.clientNum,ct.tracemask);if(t.velocity[2]>0&&(r.fraction===1||vec3.dot(r.plane.normal,o)<.7))return;vec3.set(i,o),o[2]+=dt,ct.trace(r,i,o,ct.mins,ct.maxs,t.clientNum,ct.tracemask);if(r.allSolid)return;vec3.set(r.endPos,t.origin),vec3.set(s,t.velocity),Gt(e);var a=r.endPos[2]-i[2];vec3.set(t.origin,u),u[2]-=a,ct.trace(r,t.origin,u,ct.mins,ct.maxs,t.clientNum,ct.tracemask),r.allSolid||vec3.set(r.endPos,t.origin),r.fraction<1&&(t.velocity=Qt(t.velocity,r.plane.normal,mt));var f=t.origin[2]-i[2];f>2&&(f<7?ln(Q.STEP_4):f<11?ln(Q.STEP_8):f<15?ln(Q.STEP_12):ln(Q.STEP_16))}function Zt(e,n){if(e.pm_type===O.INTERMISSION||e.pm_type===O.SPINTERMISSION)return;if(e.pm_type!==O.SPECTATOR&&e.stats[j.HEALTH]<=0)return;for(var r=0;r<3;r++){var i=n.angles[r]+e.delta_angles[r]&65535;i>32767&&(i-=65535),r===t.PITCH&&(i>16e3?(e.delta_angles[r]=16e3-n.angles[r],i=16e3):i<-16e3&&(e.delta_angles[r]=-16e3-n.angles[r],i=-16e3)),e.viewangles[r]=t.ShortToAngle(i)}}function en(){var e=ct.ps;e.pm_time&&(lt.msec>=e.pm_time?(e.pm_flags&=~M.ALL_TIMES,e.pm_time=0):e.pm_time-=lt.msec),e.legsTimer>0&&(e.legsTimer-=lt.msec,e.legsTimer<0&&(e.legsTimer=0)),e.torsoTimer>0&&(e.torsoTimer-=lt.msec,e.torsoTimer<0&&(e.torsoTimer=0)),e.stats[j.JUMPTIME]>0&&(e.stats[j.JUMPTIME]-=lt.msec)}function tn(){var e=ct.ps;if(e.pm_flags&M.RESPAWNED)return;if(ct.ps.persistant[U.SPECTATOR_STATE]!==R.NOT)return;if(e.pm_type===O.DEAD){e.weapon=F.NONE;return}e.weaponTime>0&&(e.weaponTime-=lt.msec),(e.weaponTime<=0||e.weaponState!==P.FIRING)&&e.weapon!==ct.cmd.weapon&&nn(ct.cmd.weapon);if(e.weaponTime>0)return;if(e.weaponState===P.DROPPING){rn();return}if(e.weaponState===P.RAISING){e.weaponState=P.READY,e.weapon===F.GAUNTLET?hn(Z.TORSO_STAND2):hn(Z.TORSO_STAND);return}if(e.pm_flags&M.NO_ATTACK)return;if(!(ct.cmd.buttons&f.ATTACK)){e.weaponTime=0,e.weaponState=P.READY;return}if(e.weapon===F.GAUNTLET){if(!ct.gauntletHit){e.weaponTime=0,e.weaponState=P.READY;return}hn(Z.TORSO_ATTACK2)}else hn(Z.TORSO_ATTACK);e.weaponState=P.FIRING;if(!e.ammo[e.weapon]){ln(Q.NOAMMO),e.weaponTime+=500;return}e.ammo[e.weapon]!==-1&&e.ammo[e.weapon]--,ln(Q.FIRE_WEAPON);var t=0;switch(e.weapon){case F.GAUNTLET:t=400;break;case F.LIGHTNING:t=50;break;case F.SHOTGUN:t=1e3;break;case F.MACHINEGUN:t=100;break;case F.GRENADE_LAUNCHER:t=800;break;case F.ROCKET_LAUNCHER:t=800;break;case F.PLASMAGUN:t=100;break;case F.RAILGUN:t=1500;break;case F.BFG:t=200;break;case F.GRAPPLING_HOOK:t=400;break;default:t=400}e.powerups[I.HASTE]&&(t/=1.3),e.weaponTime+=t}function nn(e){var t=ct.ps;if(e<=F.NONE||e>=F.NUM_WEAPONS)return;if(!(t.stats[j.WEAPONS]&1<<e))return;if(t.weaponState==P.DROPPING)return;ln(Q.CHANGE_WEAPON),t.weaponState=P.DROPPING,t.weaponTime+=200,hn(Z.TORSO_DROP)}function rn(){var e=ct.ps,t=ct.cmd.weapon;if(t<F.NONE||t>=F.NUM_WEAPONS)t=F.NONE;e.stats[j.WEAPONS]&1<<t||(t=F.NONE),e.weapon=t,e.weaponState=P.RAISING,e.weaponTime+=250,hn(Z.TORSO_RAISE)}function sn(){var e=ct.ps;e.weaponState===P.READY&&(e.weapon==F.GAUNTLET?vn(Z.TORSO_STAND2):vn(Z.TORSO_STAND))}function on(){var e=ct.ps;e.pm_flags&M.BACKWARDS_JUMP?mn(Z.LEGS_LANDB):mn(Z.LEGS_LAND),e.legsTimer=vt;var t=e.origin[2]-lt.previous_origin[2],n=lt.previous_velocity[2],r=-e.gravity,i=r/2,s=n,o=-t,u=s*s-4*i*o;if(u<0)return;var a=(-s-Math.sqrt(u))/(2*i),f=n+a*r;f=f*f*1e-4,e.pm_flags&M.DUCKED&&(f*=2);if(ct.waterlevel===3)return;ct.waterlevel===2&&(f*=.25),ct.waterlevel===1&&(f*=.5);if(f<1)return;lt.groundTrace.surfaceFlags&c.NODAMAGE||(f>60?ln(Q.FALL_FAR):f>40?e.pm_type===O.DEAD&&ln(Q.FALL_MEDIUM):f>7?ln(Q.FALL_SHORT):ln(fn())),e.bobCycle=0}function un(){var e=ct.ps;ct.xyspeed=Math.sqrt(e.velocity[0]*e.velocity[0]+e.velocity[1]*e.velocity[1]);if(e.groundEntityNum===i){ct.waterlevel>1&&dn(Z.LEGS_SWIM);return}if(!ct.cmd.forwardmove&&!ct.cmd.rightmove){ct.xyspeed<5&&(e.bobCycle=0,e.pm_flags&M.DUCKED?dn(Z.LEGS_IDLECR):dn(Z.LEGS_IDLE));return}var t=!1,n=0;e.pm_flags&M.DUCKED?(n=.5,e.pm_flags&M.BACKWARDS_RUN?dn(Z.LEGS_BACKCR):dn(Z.LEGS_WALKCR)):ct.cmd.buttons&f.WALKING?(n=.3,e.pm_flags&M.BACKWARDS_RUN?dn(Z.LEGS_BACKWALK):dn(Z.LEGS_WALK)):(n=.4,e.pm_flags&M.BACKWARDS_RUN?dn(Z.LEGS_BACK):dn(Z.LEGS_RUN),t=!0);var r=e.bobCycle;e.bobCycle=parseInt(r+n*lt.msec,10)%256,(r+64^e.bobCycle+64)&128&&(ct.waterlevel===0?t&&ln(fn()):ct.waterlevel===1?ln(Q.FOOTSPLASH):ct.waterlevel===2?ln(Q.SWIM):ct.waterlevel===3)}function an(){!lt.previous_waterlevel&&ct.waterlevel&&ln(Q.WATER_TOUCH),lt.previous_waterlevel&&!ct.waterlevel&&ln(Q.WATER_LEAVE),lt.previous_waterlevel!==3&&ct.waterlevel===3&&ln(Q.WATER_UNDER),lt.previous_waterlevel===3&&ct.waterlevel!==3&&ln(Q.WATER_CLEAR)}function fn(){return lt.groundTrace.surfaceFlags&c.NOSTEPS?0:lt.groundTrace.surfaceFlags&c.METALSTEPS?Q.FOOTSTEP_METAL:Q.FOOTSTEP}function ln(e){nt(ct.ps,e,0)}function cn(e){if(e===s)return;if(ct.numTouch===C)return;if(ct.touchEnts.indexOf(e)!==-1)return;ct.touchEnts[ct.numTouch]=e,ct.numTouch++}function hn(e){var t=ct.ps;if(t.pm_type>=O.DEAD)return;t.torsoAnim=t.torsoAnim&Y^Y|e}function pn(e){var t=ct.ps;if(t.pm_type>=O.DEAD)return;if(t.legsTimer>0)return;t.legsAnim=t.legsAnim&Y^Y|e}function dn(e){var t=ct.ps;if((t.legsAnim&~Y)===e)return;if(t.legsTimer>0)return;pn(e)}function vn(e){var t=ct.ps;if((t.torsoAnim&~Y)===e)return;if(t.torsoTimer>0)return;hn(e)}function mn(e){var t=ct.ps;t.legsTimer=0,pn(e)}function yn(e){for(var t=1;t<gn.length;t++){var n=gn[t];if(n.name===e)return n}return null}function bn(e){for(var t=1;t<gn.length;t++){var n=gn[t];if(n.giType===H.WEAPON&&n.giTag===e)return n}return null}function wn(e){for(var t=1;t<gn.length;t++){var n=gn[t];if((n.giType===H.POWERUP||n.giType===H.TEAM)&&n.giTag===e)return n}return null}function En(e){for(var t=1;t<gn.length;t++){var n=gn[t];if(n.giType===H.HOLDABLE&&n.giTag===e)return n}return null}var r=e.com,i=n.ENTITYNUM_NONE,s=n.ENTITYNUM_WORLD,o=n.MAX_POWERUPS,u=n.MAX_PS_EVENTS,a=n.PMOVEFRAMECOUNTBITS,f=n.BUTTON,l=n.TR,c=n.SURF,h=n.CONTENTS,p=800,d=-40,v=.66,m=16384,g=700,y=11,b=768,w=-9999,E=-24,S=26,x=12,T=-16,N=23,C=32,k=function(){this.forward=vec3.create(),this.right=vec3.create(),this.up=vec3.create(),this.frameTime=0,this.msec=0,this.walking=!1,this.groundPlane=!1,this.groundTrace=null,this.impactSpeed=0,this.previous_origin=vec3.create(),this.previous_velocity=vec3.create(),this.previous_waterlevel=0};k.prototype.reset=function(){this.forward[0]=this.forward[1]=this.forward[2]=0,this.right[0]=this.right[1]=this.right[2]=0,this.up[0]=this.up[1]=this.up[2]=0,this.frameTime=0,this.msec=0,this.walking=!1,this.groundPlane=!1,this.groundTrace=null,this.impactSpeed=0,this.previous_origin[0]=this.previous_origin[1]=this.previous_origin[2]=0,this.previous_velocity[0]=this.previous_velocity[1]=this.previous_velocity[2]=0,this.previous_waterlevel=0};var L=function(){this.ps=null,this.cmd=new n.UserCmd,this.mins=vec3.create(),this.maxs=vec3.create(),this.tracemask=0,this.gauntletHit=!1,this.touchEnts=new Array(C),this.numTouch=0,this.xyspeed=0,this.watertype=0,this.waterlevel=0,this.pmove_fixed=0,this.pmove_msec=0,this.trace=null,this.pointContents=null},A=function(){this.firstFrame=0,this.numFrames=0,this.loopFrames=0,this.frameLerp=0,this.initialLerp=0,this.reversed=!1,this.flipflop=!1},O={NORMAL:0,NOCLIP:1,SPECTATOR:2,DEAD:3,FREEZE:4,INTERMISSION:5,SPINTERMISSION:6},M={DUCKED:1,JUMP_HELD:2,NO_ATTACK:4,BACKWARDS_JUMP:8,BACKWARDS_RUN:16,TIME_LAND:32,TIME_KNOCKBACK:64,TIME_WATERJUMP:256,RESPAWNED:512,USE_ITEM_HELD:1024,GRAPPLE_PULL:2048,FOLLOW:4096,SCOREBOARD:8192,INVULEXPAND:16384,ALL_TIMES:352},_={FFA:0,TOURNAMENT:1,TEAM:2,CTF:3,NFCTF:4,CLANARENA:5,MAX_GAME_TYPE:6},D=[];D[_.FFA]="ffa",D[_.TOURNAMENT]="tournament",D[_.TEAM]="team",D[_.CTF]="ctf",D[_.NFCTF]="nfctf",D[_.CLANARENA]="ca";var P={READY:0,RAISING:1,DROPPING:2,FIRING:3},H={BAD:0,WEAPON:1,AMMO:2,ARMOR:3,HEALTH:4,POWERUP:5,HOLDABLE:6,PERSISTANT_POWERUP:7,TEAM:8},B={ALL:-1,SOLID:h.SOLID,PLAYERSOLID:h.SOLID|h.PLAYERCLIP|h.BODY,DEADSOLID:h.SOLID|h.PLAYERCLIP,WATER:h.WATER|h.LAVA|h.SLIME,OPAQUE:h.SOLID|h.SLIME|h.LAVA,SHOT:h.SOLID|h.BODY|h.CORPSE},j={HEALTH:0,HOLDABLE_ITEM:1,WEAPONS:2,ARMOR:3,DEAD_YAW:4,CLIENTS_READY:5,MAX_HEALTH:6,JUMP_TIME:7},F={NONE:0,GAUNTLET:1,MACHINEGUN:2,SHOTGUN:3,GRENADE_LAUNCHER:4,ROCKET_LAUNCHER:5,LIGHTNING:6,RAILGUN:7,PLASMAGUN:8,BFG:9,GRAPPLING_HOOK:10,NUM_WEAPONS:11},I={NONE:0,QUAD:1,BATTLESUIT:2,HASTE:3,INVIS:4,REGEN:5,FLIGHT:6,REDFLAG:7,BLUEFLAG:8,NEUTRALFLAG:9,NUM_POWERUPS:10},q={FREE:0,RED:1,BLUE:2,SPECTATOR:3,NUM_TEAMS:4},R={NOT:0,FREE:1,FOLLOW:2,SCOREBOARD:3},U={SCORE:0,HITS:1,RANK:2,TEAM:3,SPECTATOR_STATE:4,SPAWN_COUNT:5,PLAYEREVENTS:6,KILLED:7,IMPRESSIVE_COUNT:8,EXCELLENT_COUNT:9,DEFEND_COUNT:10,ASSIST_COUNT:11,GAUNTLET_FRAG_COUNT:12,CAPTURES:13},z={DENIEDREWARD:1,GAUNTLETREWARD:2,HOLYSHIT:4},W={GENERAL:0,PLAYER:1,ITEM:2,MISSILE:3,MOVER:4,BEAM:5,PORTAL:6,SPEAKER:7,PUSH_TRIGGER:8,TELEPORT_TRIGGER:9,INVISIBLE:10,GRAPPLE:11,TEAM:12,EVENTS:13},X={DEAD:1,TELEPORT_BIT:4,AWARD_EXCELLENT:8,PLAYER_EVENT:16,BOUNCE:16,BOUNCE_HALF:32,AWARD_GAUNTLET:64,NODRAW:128,FIRING:256,KAMIKAZE:512,MOVER_STOP:1024,AWARD_CAP:2048,TALK:4096,CONNECTION:8192,VOTED:16384,AWARD_IMPRESSIVE:32768,AWARD_DEFEND:65536,AWARD_ASSIST:131072,AWARD_DENIED:262144,TEAMVOTED:524288},V=256,$=512,J=V|$,K=300,Q={NONE:0,FOOTSTEP:1,FOOTSTEP_METAL:2,FOOTSPLASH:3,FOOTWADE:4,SWIM:5,STEP_4:6,STEP_8:7,STEP_12:8,STEP_16:9,FALL_SHORT:10,FALL_MEDIUM:11,FALL_FAR:12,JUMP_PAD:13,JUMP:14,WATER_TOUCH:15,WATER_LEAVE:16,WATER_UNDER:17,WATER_CLEAR:18,ITEM_PICKUP:19,GLOBAL_ITEM_PICKUP:20,NOAMMO:21,CHANGE_WEAPON:22,FIRE_WEAPON:23,USE_ITEM0:24,USE_ITEM1:25,USE_ITEM2:26,USE_ITEM3:27,USE_ITEM4:28,USE_ITEM5:29,USE_ITEM6:30,USE_ITEM7:31,USE_ITEM8:32,USE_ITEM9:33,USE_ITEM10:34,USE_ITEM11:35,USE_ITEM12:36,USE_ITEM13:37,USE_ITEM14:38,USE_ITEM15:39,ITEM_RESPAWN:40,ITEM_POP:41,PLAYER_TELEPORT_IN:42,PLAYER_TELEPORT_OUT:43,GRENADE_BOUNCE:44,GENERAL_SOUND:45,GLOBAL_SOUND:46,GLOBAL_TEAM_SOUND:47,BULLET_HIT_FLESH:48,BULLET_HIT_WALL:49,MISSILE_HIT:50,MISSILE_MISS:51,MISSILE_MISS_METAL:52,RAILTRAIL:53,SHOTGUN:54,BULLET:55,PAIN:56,DEATH1:57,DEATH2:58,DEATH3:59,OBITUARY:60,POWERUP_QUAD:61,POWERUP_BATTLESUIT:62,POWERUP_REGEN:63,GIB_PLAYER:64,SCOREPLUM:65,DEBUG_LINE:66,STOPLOOPINGSOUND:67,TAUNT:68,TAUNT_YES:69,TAUNT_NO:70,TAUNT_FOLLOWME:71,TAUNT_GETFLAG:72,TAUNT_GUARDBASE:73,TAUNT_PATROL:74},G={RED_CAPTURE:0,BLUE_CAPTURE:1,RED_RETURN:2,BLUE_RETURN:3,RED_TAKEN:4,BLUE_TAKEN:5,REDOBELISK_ATTACKED:6,BLUEOBELISK_ATTACKED:7,REDTEAM_SCORED:8,BLUETEAM_SCORED:9,REDTEAM_TOOK_LEAD:10,BLUETEAM_TOOK_LEAD:11,TEAMS_ARE_TIED:12,KAMIKAZE:13},Y=128,Z={BOTH_DEATH1:0,BOTH_DEAD1:1,BOTH_DEATH2:2,BOTH_DEAD2:3,BOTH_DEATH3:4,BOTH_DEAD3:5,TORSO_GESTURE:6,TORSO_ATTACK:7,TORSO_ATTACK2:8,TORSO_DROP:9,TORSO_RAISE:10,TORSO_STAND:11,TORSO_STAND2:12,LEGS_WALKCR:13,LEGS_WALK:14,LEGS_RUN:15,LEGS_BACK:16,LEGS_SWIM:17,LEGS_JUMP:18,LEGS_LAND:19,LEGS_JUMPB:20,LEGS_LANDB:21,LEGS_IDLE:22,LEGS_IDLECR:23,LEGS_TURN:24,TORSO_GETFLAG:25,TORSO_GUARDBASE:26,TORSO_PATROL:27,TORSO_FOLLOWME:28,TORSO_AFFIRMATIVE:29,TORSO_NEGATIVE:30,MAX:31,LEGS_BACKCR:32,LEGS_BACKWALK:33,FLAG_RUN:34,FLAG_STAND:35,FLAG_STAND2RUN:36,MAX_TOTALANIMATIONS:37},et={UNKNOWN:0,SHOTGUN:1,GAUNTLET:2,MACHINEGUN:3,GRENADE:4,GRENADE_SPLASH:5,ROCKET:6,ROCKET_SPLASH:7,PLASMA:8,PLASMA_SPLASH:9,RAILGUN:10,LIGHTNING:11,BFG:12,BFG_SPLASH:13,WATER:14,SLIME:15,LAVA:16,CRUSH:17,TELEFRAG:18,FALLING:19,SUICIDE:20,TARGET_LASER:21,TRIGGER_HURT:22,GRAPPLE:23},lt=new k,ct=null,ht=5,pt=.7,dt=18,vt=130,mt=1.001,gt=100,yt=.25,bt=.5,wt=10,Et=1,St=4,xt=8,Tt=6,Nt=1,Ct=3,kt=5,Lt=270,At=100,gn=[{},{classname:"item_armor_shard",name:"Armor Shard",models:{primary:"models/powerups/armor/shard.md3"},gfx:{icon:"icons/iconr_shard"},sounds:{pickup:"sound/misc/ar1_pkup"},quantity:5,giType:H.ARMOR,giTag:0},{classname:"item_armor_combat",name:"Armor",models:{primary:"models/powerups/armor/armor_yel.md3"},gfx:{icon:"icons/iconr_yellow"},sounds:{pickup:"sound/misc/ar2_pkup"},quantity:50,giType:H.ARMOR,giTag:0},{classname:"item_armor_body",name:"Heavy Armor",models:{primary:"models/powerups/armor/armor_red.md3"},gfx:{icon:"icons/iconr_red"},sounds:{pickup:"sound/misc/ar2_pkup"},quantity:100,giType:H.ARMOR,giTag:0},{classname:"item_health_small",name:"5 Health",models:{primary:"models/powerups/health/small_cross.md3",secondary:"models/powerups/health/small_sphere.md3"},gfx:{icon:"icons/iconh_green"},sounds:{pickup:"sound/items/s_health"},quantity:5,giType:H.HEALTH,giTag:0},{classname:"item_health",name:"25 Health",models:{primary:"models/powerups/health/medium_cross.md3",secondary:"models/powerups/health/medium_sphere.md3"},gfx:{icon:"icons/iconh_yellow"},sounds:{pickup:"sound/items/n_health"},quantity:25,giType:H.HEALTH,giTag:0},{classname:"item_health_large",name:"50 Health",models:{primary:"models/powerups/health/large_cross.md3",secondary:"models/powerups/health/large_sphere.md3"},gfx:{icon:"icons/iconh_red"},sounds:{pickup:"sound/items/l_health"},quantity:50,giType:H.HEALTH,giTag:0},{classname:"item_health_mega",name:"Mega Health",models:{primary:"models/powerups/health/mega_cross.md3",secondary:"models/powerups/health/mega_sphere.md3"},gfx:{icon:"icons/iconh_mega"},sounds:{pickup:"sound/items/m_health"},quantity:100,giType:H.HEALTH,giTag:0},{classname:"weapon_gauntlet",name:"Gauntlet",models:{primary:"models/weapons2/gauntlet/gauntlet.md3",barrel:"models/weapons2/gauntlet/gauntlet_barrel.md3",flash:"models/weapons2/gauntlet/gauntlet_flash.md3",hand:"models/weapons2/gauntlet/gauntlet_hand.md3"},gfx:{icon:"icons/iconw_gauntlet"},sounds:{pickup:"sound/misc/w_pkup",firing:"sound/weapons/melee/fstrun",flash0:"sound/weapons/melee/fstatck"},quantity:0,giType:H.WEAPON,giTag:F.GAUNTLET,flashDlightColor:[.6,.6,1]},{classname:"weapon_machinegun",name:"Machinegun",models:{primary:"models/weapons2/machinegun/machinegun.md3",barrel:"models/weapons2/machinegun/machinegun_barrel.md3",flash:"models/weapons2/machinegun/machinegun_flash.md3",hand:"models/weapons2/machinegun/machinegun_hand.md3"},shaders:{bulletExplosion:"bulletExplosion"},gfx:{icon:"icons/iconw_machinegun"},sounds:{pickup:"sound/misc/w_pkup",flash0:"sound/weapons/machinegun/machgf1b",flash1:"sound/weapons/machinegun/machgf2b",flash2:"sound/weapons/machinegun/machgf3b",flash3:"sound/weapons/machinegun/machgf4b",ric0:"sound/weapons/machinegun/ric1",ric1:"sound/weapons/machinegun/ric2",ric2:"sound/weapons/machinegun/ric3"},quantity:40,giType:H.WEAPON,giTag:F.MACHINEGUN,flashDlightColor:[1,1,0]},{classname:"weapon_shotgun",name:"Shotgun",models:{primary:"models/weapons2/shotgun/shotgun.md3",flash:"models/weapons2/shotgun/shotgun_flash.md3",hand:"models/weapons2/shotgun/shotgun_hand.md3"},shaders:{bulletExplosion:"bulletExplosion"},gfx:{icon:"icons/iconw_shotgun"},sounds:{pickup:"sound/misc/w_pkup",flash0:"sound/weapons/shotgun/sshotf1b"},quantity:10,giType:H.WEAPON,giTag:F.SHOTGUN,flashDlightColor:[1,1,0]},{classname:"weapon_grenadelauncher",name:"Grenade Launcher",models:{primary:"models/weapons2/grenadel/grenadel.md3",flash:"models/weapons2/grenadel/grenadel_flash.md3",hand:"models/weapons2/grenadel/grenadel_hand.md3",missile:"models/ammo/grenade1.md3"},shaders:{explosion:"grenadeExplosion"},gfx:{icon:"icons/iconw_grenade"},sounds:{pickup:"sound/misc/w_pkup",flash0:"sound/weapons/grenade/grenlf1a",bounce0:"sound/weapons/grenade/hgrenb1a",bounce1:"sound/weapons/grenade/hgrenb2a"},quantity:10,trailTime:700,trailRadius:32,giType:H.WEAPON,giTag:F.GRENADE_LAUNCHER,flashDlightColor:[1,.7,0]},{classname:"weapon_rocketlauncher",name:"Rocket Launcher",models:{primary:"models/weapons2/rocketl/rocketl.md3",flash:"models/weapons2/rocketl/rocketl_flash.md3",hand:"models/weapons2/rocketl/rocketl_hand.md3",missile:"models/ammo/rocket/rocket.md3"},shaders:{explosion:"rocketExplosion"},gfx:{icon:"icons/iconw_rocket"},sounds:{pickup:"sound/misc/w_pkup",missile:"sound/weapons/rocket/rockfly",flash0:"sound/weapons/rocket/rocklf1a",explosion:"sound/weapons/rocket/rocklx1a"},quantity:10,trailTime:2e3,trailRadius:64,giType:H.WEAPON,giTag:F.ROCKET_LAUNCHER,flashDlightColor:[1,.75,0],missileDlightIntensity:200,missileDlightColor:[1,.75,0]},{classname:"weapon_lightning",name:"Lightning Gun",models:{primary:"models/weapons2/lightning/lightning.md3",flash:"models/weapons2/lightning/lightning_flash.md3",hand:"models/weapons2/lightning/lightning_hand.md3",explosion:"models/weaphits/crackle.md3"},shaders:{lightning:"lightningBoltNew"},gfx:{icon:"icons/iconw_lightning"},sounds:{pickup:"sound/misc/w_pkup",ready:"sound/weapons/melee/fsthum",firing:"sound/weapons/lightning/lg_hum",flash0:"sound/weapons/lightning/lg_fire",hit0:"sound/weapons/lightning/lg_hit",hit1:"sound/weapons/lightning/lg_hit2",hit2:"sound/weapons/lightning/lg_hit3"},quantity:100,giType:H.WEAPON,giTag:F.LIGHTNING,flashDlightColor:[.6,.6,1]},{classname:"weapon_railgun",name:"Railgun",models:{primary:"models/weapons2/railgun/railgun.md3",flash:"models/weapons2/railgun/railgun_flash.md3",hand:"models/weapons2/railgun/railgun_hand.md3"},shaders:{core:"railCore",explosion:"railExplosion"},gfx:{icon:"icons/iconw_railgun"},sounds:{pickup:"sound/misc/w_pkup",ready:"sound/weapons/railgun/rg_hum",explosion:"sound/weapons/plasma/plasmx1a",flash0:"sound/weapons/railgun/railgf1a"},quantity:10,giType:H.WEAPON,giTag:F.RAILGUN,flashDlightColor:[1,.5,0]},{classname:"weapon_plasmagun",name:"Plasma Gun",models:{primary:"models/weapons2/plasma/plasma.md3",flash:"models/weapons2/plasma/plasma_flash.md3",hand:"models/weapons2/plasma/plasma_hand.md3"},shaders:{missile:"railDisc",explosion:"plasmaExplosion"},gfx:{icon:"icons/iconw_plasma"},sounds:{pickup:"sound/misc/w_pkup",missile:"sound/weapons/plasma/lasfly",explosion:"sound/weapons/plasma/plasmx1a",flash0:"sound/weapons/plasma/hyprbf1a"},quantity:50,giType:H.WEAPON,giTag:F.PLASMAGUN,flashDlightColor:[.6,.6,1]},{classname:"weapon_bfg",name:"BFG10K",models:{primary:"models/weapons2/bfg/bfg.md3",barrel:"models/weapons2/bfg/bfg_barrel.md3",flash:"models/weapons2/bfg/bfg_flash.md3",hand:"models/weapons2/bfg/bfg_hand.md3",missile:"models/weaphits/bfg.md3"},shaders:{explosion:"bfgExplosion"},gfx:{icon:"icons/iconw_bfg"},sounds:{pickup:"sound/misc/w_pkup",ready:"sound/weapons/bfg/bfg_hum",missile:"sound/weapons/rocket/rockfly",flash0:"sound/weapons/bfg/bfg_fire"},quantity:20,giType:H.WEAPON,giTag:F.BFG,flashDlightColor:[1,.7,1]},{classname:"ammo_bullets",name:"Bullets",models:{primary:"models/powerups/ammo/machinegunam.md3"},gfx:{icon:"icons/icona_machinegun"},sounds:{pickup:"sound/misc/am_pkup"},quantity:50,giType:H.AMMO,giTag:F.MACHINEGUN},{classname:"ammo_shells",name:"Shells",models:{primary:"models/powerups/ammo/shotgunam.md3"},gfx:{icon:"icons/icona_shotgun"},sounds:{pickup:"sound/misc/am_pkup"},quantity:10,giType:H.AMMO,giTag:F.SHOTGUN},{classname:"ammo_grenades",name:"Grenades",models:{primary:"models/powerups/ammo/grenadeam.md3"},gfx:{icon:"icons/icona_grenade"},sounds:{pickup:"sound/misc/am_pkup"},quantity:5,giType:H.AMMO,giTag:F.GRENADE_LAUNCHER},{classname:"ammo_rockets",name:"Rockets",models:{primary:"models/powerups/ammo/rocketam.md3"},gfx:{icon:"icons/icona_rocket"},sounds:{pickup:"sound/misc/am_pkup"},quantity:5,giType:H.AMMO,giTag:F.ROCKET_LAUNCHER},{classname:"ammo_lightning",name:"Lightning",models:{primary:"models/powerups/ammo/lightningam.md3"},gfx:{icon:"icons/icona_lightning"},sounds:{pickup:"sound/misc/am_pkup"},quantity:60,giType:H.AMMO,giTag:F.LIGHTNING},{classname:"ammo_slugs",name:"Slugs",models:{primary:"models/powerups/ammo/railgunam.md3"},gfx:{icon:"icons/icona_railgun"},sounds:{pickup:"sound/misc/am_pkup"},quantity:10,giType:H.AMMO,giTag:F.RAILGUN},{classname:"ammo_cells",name:"Cells",models:{primary:"models/powerups/ammo/plasmaam.md3"},gfx:{icon:"icons/icona_plasma"},sounds:{pickup:"sound/misc/am_pkup"},quantity:30,giType:H.AMMO,giTag:F.PLASMAGUN},{classname:"ammo_bfg",name:"Bfg Ammo",models:{primary:"models/powerups/ammo/bfgam.md3"},gfx:{icon:"icons/icona_bfg"},sounds:{pickup:"sound/misc/am_pkup"},quantity:15,giType:H.AMMO,giTag:F.BFG},{classname:"item_quad",name:"Quad Damage",models:{primary:"models/powerups/instant/quad.md3",secondary:"models/powerups/instant/quad_ring.md3"},gfx:{icon:"icons/quad"},sounds:{pickup:"sound/items/quaddamage",use:"sound/items/damage3"},quantity:30,giType:H.POWERUP,giTag:I.QUAD},{classname:"item_enviro",name:"Battle Suit",models:{primary:"models/powerups/instant/enviro.md3",secondary:"models/powerups/instant/enviro_ring.md3"},gfx:{icon:"icons/envirosuit"},sounds:{pickup:"sound/items/protect"},quantity:30,giType:H.POWERUP,giTag:I.BATTLESUIT},{classname:"item_haste",name:"Speed",models:{primary:"models/powerups/instant/haste.md3",secondary:"models/powerups/instant/haste_ring.md3"},gfx:{icon:"icons/haste"},sounds:{pickup:"sound/items/haste"},quantity:30,giType:H.POWERUP,giTag:I.HASTE},{classname:"item_invis",name:"Invisibility",models:{primary:"models/powerups/instant/invis.md3",secondary:"models/powerups/instant/invis_ring.md3"},gfx:{icon:"icons/invis"},sounds:{pickup:"sound/items/invisibility"},quantity:30,giType:H.POWERUP,giTag:I.INVIS},{classname:"item_regen",name:"Regeneration",models:{primary:"models/powerups/instant/regen.md3",secondary:"models/powerups/instant/regen_ring.md3"},gfx:{icon:"icons/regen"},sounds:{pickup:"sound/items/regeneration",use:"sound/items/regen"},quantity:30,giType:H.POWERUP,giTag:I.REGEN},{classname:"item_flight",name:"Flight",models:{primary:"models/powerups/instant/flight.md3",secondary:"models/powerups/instant/flight_ring.md3"},gfx:{icon:"icons/flight"},sounds:{pickup:"sound/items/flight"},quantity:60,giType:H.POWERUP,giTag:I.FLIGHT},{classname:"team_CTF_redflag",name:"Red Flag",models:{primary:"models/flags/r_flag.md3"},gfx:{icon:"icons/iconf_red1"},quantity:0,giType:H.TEAM,giTag:I.REDFLAG},{classname:"team_CTF_blueflag",name:"Blue Flag",models:{primary:"models/flags/b_flag.md3"},gfx:{icon:"icons/iconf_blu1"},quantity:0,giType:H.TEAM,giTag:I.BLUEFLAG},{classname:"team_CTF_neutralflag",name:"Neutral Flag",models:{primary:"models/flags/n_flag.md3"},gfx:{icon:"icons/iconf_neutral1"},quantity:0,giType:H.TEAM,giTag:I.NEUTRALFLAG}];return{DEFAULT_GRAVITY:p,GIB_HEALTH:d,ARMOR_PROTECTION:v,RANK_TIED_FLAG:m,DEFAULT_SHOTGUN_SPREAD:g,DEFAULT_SHOTGUN_COUNT:y,LIGHTNING_RANGE:b,SCORE_NOT_PRESENT:w,DEFAULT_VIEWHEIGHT:S,CROUCH_VIEWHEIGHT:x,CS_FLAGSTATUS:N,ANIM_TOGGLEBIT:Y,EV_EVENT_BIT1:V,EV_EVENT_BIT2:$,EV_EVENT_BITS:J,EVENT_VALID_MSEC:K,PM:O,PMF:M,GT:_,WS:P,IT:H,MASK:B,STAT:j,WP:F,PW:I,TEAM:q,SPECTATOR:R,PERS:U,PLAYEREVENTS:z,ET:W,EF:X,EV:Q,GTS:G,ANIM:Z,MOD:et,GametypeNames:D,PmoveInfo:L,Animation:A,ItemList:gn,FindItem:yn,FindItemForWeapon:bn,FindItemForPowerup:wn,FindItemForHoldable:En,Pmove:Ot,UpdateViewAngles:Zt,AddPredictableEventToPlayerstate:nt,PlayerStateToEntityState:rt,EvaluateTrajectory:it,EvaluateTrajectoryDelta:st,TouchJumpPad:ot,CanItemBeGrabbed:ut,PlayerTouchesItem:at,GetWaterLevel:ft}}return{CreateInstance:function(e){return new r(e)}}}),define("game/gm",["underscore","glmatrix","common/qmath","common/qshared","common/cvar","game/bg"],function(e,t,n,r,i,s){function o(e){function Nt(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"GM:"),Function.apply.call(console.log,console,e)}function Ct(e){o.Error(e)}function kt(e){Nt("Initializing"),Tt=new gt,Tt.time=e,Tt.startTime=e,_r(),qi();var t=i.GetCvar("sv_maxClients");Tt.maxclients=t.getAsInt(),u.LocateGameData(Tt.gentities,Tt.clients),Hn(),Ht()}function Lt(){Ri()}function At(e){if(Tt.restarted){console.log("level restarted ignoring");return}Tt.framenum++,Tt.previousTime=Tt.time,Tt.time=e;for(var t=0;t<l;t++){var n=Tt.gentities[t];if(!n.inuse)continue;Tt.arena=Tt.arenas[n.s.arenaNum];if(Tt.time-n.eventTime>A){n.s.event&&(n.s.event=0,n.client&&(n.client.ps.externalEvent=0));if(n.freeAfterEvent){Br(n);continue}n.unlinkAfterEvent&&(n.unlinkAfterEvent=!1,u.UnlinkEntity(n))}if(n.freeAfterEvent)continue;if(!n.r.linked&&n.neverFree)continue;if(n.s.eType===K.MISSILE){Ei(n);continue}if(n.s.eType===K.ITEM||n.physicsObject){si(n);continue}if(n.s.eType===K.MOVER){Oi(n);continue}if(t<Tt.maxclients){pn(n);continue}$r(n)}for(var t=0;t<Tt.maxclients;t++){var n=Tt.gentities[t];n.inuse&&wn(n)}jt()}function Ot(){for(var e=0;e<Tt.maxclients;e++)Tt.clients[e].pers.connected===vt.CONNECTED&&Qn(Tt.gentities[e])}function Mt(e,t){return u.FindEntitiesInBox(e,t,Tt.arena.arenaNum)}function _t(e,t,n,r,i,s,o){return u.Trace(e,t,n,r,i,Tt.arena.arenaNum,s,o)}function Dt(e,t){return u.PointContents(e,Tt.arena.arenaNum,t)}function Pt(){return{com:{Error:o.Error}}}function Ht(){var e=["default"],t=u.GetEntityDefs();for(var n=0;n<t.length;n++){var r=t[n];if(r.classname==="info_player_intermission"){var i=parseInt(r.arena,10);if(isNaN(i))continue;if(e[i]!==undefined)continue;e[i]=r.message}}for(var n=0;n<e.length;n++){var s=new yt;s.arenaNum=n,s.name=e[n],Tt.arena=Tt.arenas[n]=s,jr(n),Bt()}}function Bt(){var e={name:Tt.arena.name,fraglimit:dr.at(Tt.arena.arenaNum).getAsInt(),capturelimit:mr.at(Tt.arena.arenaNum).getAsInt(),score1:Tt.arena.score1,score2:Tt.arena.score2,count1:Tt.arena.count1,count2:Tt.arena.count2,warmup:Tt.arena.warmupTime};u.SetConfigstring("arena"+Tt.arena.arenaNum,e),Nt("ArenaInfoChanged: "+Tt.arena.arenaNum+" "+JSON.stringify(e))}function jt(){i.Modified(r.CVAR.ARENAINFO)&&(Bt(),i.ClearModified(r.CVAR.ARENAINFO));for(var e=0;e<Tt.arenas.length;e++)Tt.arena=Tt.arenas[e],Ft(),Ut(),Vt()}function Ft(){if(Tt.arena.numPlayingClients===0)return;pr.getAsInt()===F.TOURNAMENT?qt():pr.getAsInt()>=F.TEAM&&Rt()}function It(e){if(Tt.arena.warmupTime===e)return;Tt.arena.warmupTime=e,Nt("Setting warmup for",Tt.arena.arenaNum,Tt.arena.warmupTime),Bt()}function qt(){var e;while(e=Jt())kn(e.client,"f");if(Tt.arena.numPlayingClients!==2){It(ft);return}if(Tt.arena.warmupTime===lt)return;if(Tt.arena.warmupTime<0){if(Tt.arena.numPlayingClients===2){var t=0;xr.getAsInt()>1&&(t=Tt.time+(xr.getAsInt()-1)*1e3),It(t)}return}if(Tt.time>Tt.arena.warmupTime)return}function Rt(){var e=new Array(X.NUM_TEAMS),t=!1;if(pr.getAsInt()>F.TEAM){e[X.BLUE]=ms(X.BLUE,v),e[X.RED]=ms(X.RED,v);if(e[X.RED]<1||e[X.BLUE]<1)t=!0}else Tt.arena.numPlayingClients<2&&(t=!0);if(t){pr.getAsInt()===F.CLANARENA&&Tt.arena.warmupTime!==ft&&Wt(null),It(ft);return}if(Tt.arena.warmupTime===lt)return;if(Tt.arena.warmupTime<0){var n=0;xr.getAsInt()>1&&(n=Tt.time+(xr.getAsInt()-1)*1e3),It(n);return}if(Tt.time>Tt.arena.warmupTime){pr.getAsInt()===F.CLANARENA&&zt();return}}function Ut(){if(pr.getAsInt()!==F.CLANARENA)return;if(Tt.arena.restartTime){Tt.time>Tt.arena.restartTime&&Xt();return}if(Tt.arena.warmupTime===lt){var e=new Array(X.NUM_TEAMS);e[X.RED]=gs(X.RED),e[X.BLUE]=gs(X.BLUE),e[X.RED]?e[X.BLUE]||Wt(X.RED):Wt(X.BLUE)}}function zt(){Nt("StartRound"),It(lt)}function Wt(e){Nt("EndRound"),e!==null&&(Tt.arena.teamScores[e]+=1),Tt.arena.restartTime=Tt.time+4e3,Tt.arena.lastWinningTeam=e}function Xt(){Nt("RestartRound"),Tt.arena.restartTime=0,It(ft),Qt(),nn()}function Vt(){}function $t(){if(Tt.arena.numPlayingClients<2)return!1;if(pr.getAsInt()>=F.TEAM)return Tt.arena.teamScores[X.RED]===Tt.arena.teamScores[X.BLUE];var e=Tt.clients[Tt.arena.sortedClients[0]].ps.persistant[$.SCORE],t=Tt.clients[Tt.arena.sortedClients[1]].ps.persistant[$.SCORE];return e==t}function Jt(){var e=Er.at(Tt.arena.arenaNum).getAsInt()*2,t=null;for(var n=0;n<Tt.maxclients;n++){var r=Tt.gentities[n];if(!r.inuse)continue;if(r.s.arenaNum!==Tt.arena.arenaNum)continue;if(r.client.pers.teamState.state!==mt.QUEUED)continue;if(r.client.sess.spectatorState===V.SCOREBOARD||r.client.sess.spectatorClient<0)continue;if(!t||r.client.sess.spectatorNum>t.client.sess.spectatorNum)t=r}return t&&(t.client.pers.teamState.state=mt.BEGIN,Nt("Popping client",t.client.ps.clientNum,"from queue")),t}function Kt(e){var t=e.client;t.pers.teamState.state=mt.QUEUED,Nt("Pushing client",t.ps.clientNum,"to end of queue");for(var n=0;n<Tt.maxclients;n++){var r=Tt.gentities[n];if(!r.inuse)continue;if(r.s.arenaNum!==e.s.arenaNum)continue;r===e?r.client.sess.spectatorNum=0:r.client.sess.spectatorNum!==-1&&r.client.sess.spectatorNum++}}function Qt(){Nt("CycleQueuedClients");var e=Er.at(Tt.arena.arenaNum).getAsInt();if(!Tt.arena.lastWinningTeam)for(var t=0;t<Tt.maxclients;t++){var n=Tt.gentities[t];if(!n.inuse)continue;if(n.s.arenaNum!==Tt.arena.arenaNum)continue;n.client.pers.teamState.state!==mt.QUEUED&&cn(n)}else for(var t=0;t<Tt.maxclients;t++){var n=Tt.gentities[t];if(!n.inuse)continue;if(n.s.arenaNum!==Tt.arena.arenaNum)continue;n.client.sess.sessionTeam===Tt.arena.lastWinningTeam&&cn(n)}var r;while(r=Jt())r.client.sess.spectatorState=V.NOT,r.client.pers.teamState.state=mt.BEGIN,cn(r)}function Gt(){Tt.intermissionQueued=Tt.time,u.SetConfigstring("intermission",1)}function Yt(){if(Tt.intermissiontime)return;pr.getAsInt()===F.TOURNAMENT&&AdjustTournamentScores(),Tt.intermissiontime=Tt.time;for(var e=0;e<Tt.maxclients;e++){var t=Tt.gentities[e];if(!t.inuse)continue;t.health<=0&&hn(t),en(t)}Ot()}function Zt(){var e=0,t=0,n=0,r=0;for(var i=0;i<Tt.maxclients;i++){var s=Tt.clients[i];if(s.pers.connected!==vt.CONNECTED)continue;if(Tt.gentities[s.ps.clientNum].r.svFlags&pt.BOT)continue;r++,s.readyToExit?(e++,i<16&&(n|=1<<i)):t++}for(var i=0;i<Tt.maxclients;i++){var s=Tt.clients[i];if(s.pers.connected!==vt.CONNECTED)continue;s.ps.stats[U.CLIENTS_READY]=n}if(Tt.time<Tt.intermissiontime+5e3)return;if(r>0){if(!e){Tt.readyToExit=!1;return}if(!t){ExitLevel();return}}Tt.readyToExit||(Tt.readyToExit=!0,Tt.exitTime=Tt.time);if(Tt.time<Tt.exitTime+1e4)return;tn()}function en(e){e.client.sess.spectatorState===V.FOLLOW&&StopFollowing(e);var t=vec3.create(),n=vec3.create();Pn(t,n),vec3.set(t,e.s.origin),vec3.set(t,e.client.ps.origin),vec3.set(n,e.client.ps.viewangles),e.client.ps.pm_type=B.INTERMISSION,e.client.ps.eFlags=0,e.s.eFlags=0,e.s.eType=K.GENERAL,e.s.modelIndex=0,e.s.loopSound=0,e.s.event=0,e.r.contents=0}function tn(){Tt.changemap=null,Tt.intermissiontime=0;for(var e=0;e<Tt.maxclients;e++){var t=Tt.clients[e];if(t.pers.connected!==vt.CONNECTED)continue;t.ps.persistant[$.SCORE]=0}Ri();for(var e=0;e<Tt.maxclients;e++)Tt.clients[e].pers.connected===vt.CONNECTED&&(Tt.clients[e].pers.connected=vt.CONNECTING)}function nn(){var e,t,n;Tt.arena.numConnectedClients=0,Tt.arena.numNonSpectatorClients=0,Tt.arena.numPlayingClients=0;for(var r=0;r<Tt.maxclients;r++){var i=Tt.gentities[r];if(!i.inuse)continue;if(i.s.arenaNum!==Tt.arena.arenaNum)continue;if(i.client.pers.connected===vt.DISCONNECTED)continue;Tt.arena.sortedClients[Tt.arena.numConnectedClients]=r,Tt.arena.numConnectedClients+=1,i.client.sess.sessionTeam!==X.SPECTATOR&&(Tt.arena.numNonSpectatorClients+=1,i.client.pers.connected===vt.CONNECTED&&(Tt.arena.numPlayingClients+=1))}Tt.arena.sortedClients.sort(rn);if(pr.getAsInt()>=F.TEAM)for(var r=0;r<Tt.arena.numConnectedClients;r++){var s=Tt.clients[Tt.arena.sortedClients[r]];Tt.arena.teamScores[X.RED]===Tt.arena.teamScores[X.BLUE]?s.ps.persistant[$.RANK]=2:Tt.arena.teamScores[X.RED]>Tt.arena.teamScores[X.BLUE]?s.ps.persistant[$.RANK]=0:s.ps.persistant[$.RANK]=1}else{e=-1,t=0;for(var r=0;r<Tt.arena.numPlayingClients;r++){var s=Tt.clients[Tt.arena.sortedClients[r]];n=s.ps.persistant[$.SCORE],r===0||n!==t?(e=r,Tt.clients[Tt.arena.sortedClients[r]].ps.persistant[$.RANK]=e):(Tt.clients[Tt.arena.sortedClients[r-1]].ps.persistant[$.RANK]=e|w,Tt.clients[Tt.arena.sortedClients[r]].ps.persistant[$.RANK]=e|w),t=n}}if(pr.getAsInt()>=F.TEAM)Tt.arena.score1=Tt.arena.teamScores[X.RED],Tt.arena.score2=Tt.arena.teamScores[X.BLUE],pr.getAsInt()===F.CLANARENA?(Tt.arena.count1=gs(X.RED),Tt.arena.count2=gs(X.BLUE)):(Tt.arena.count1=ms(X.RED,v),Tt.arena.count2=ms(X.BLUE,v));else{var o=Tt.arena.sortedClients[0],u=Tt.arena.sortedClients[1];Tt.arena.numConnectedClients===0?(Tt.arena.score1=T,Tt.arena.score2=T,Tt.arena.count1=v,Tt.arena.count2=v):Tt.arena.numConnectedClients===1?(Tt.arena.score1=Tt.clients[o].ps.persistant[$.SCORE],Tt.arena.count1=o,Tt.arena.score2=T,Tt.arena.count2=v):(Tt.arena.score1=Tt.clients[o].ps.persistant[$.SCORE],Tt.arena.count1=o,Tt.arena.score2=Tt.clients[u].ps.persistant[$.SCORE],Tt.arena.count2=u)}Bt(),Tt.arena.intermissiontime&&Ot()}function rn(e,t){var n=Tt.clients[e],r=Tt.clients[t];return n.sess.spectatorState===V.SCOREBOARD||n.sess.spectatorClient<0?1:r.sess.spectatorState===V.SCOREBOARD||r.sess.spectatorClient<0?-1:n.pers.connected===vt.CONNECTING?1:r.pers.connected===vt.CONNECTING?-1:n.sess.sessionTeam==X.SPECTATOR&&r.sess.sessionTeam==X.SPECTATOR?n.sess.spectatorNum>r.sess.spectatorNum?-1:n.sess.spectatorNum<r.sess.spectatorNum?1:0:n.sess.sessionTeam==X.SPECTATOR?1:r.sess.sessionTeam==X.SPECTATOR?-1:n.ps.persistant[$.SCORE]>r.ps.persistant[$.SCORE]?-1:n.ps.persistant[$.SCORE]<r.ps.persistant[$.SCORE]?1:0}function un(e,t){var n=Tt.gentities[e],r=Tt.clients[e],i=u.GetUserinfo(e);n.reset(),r.reset(),n.inuse=!0,n.s.number=r.ps.clientNum=e,n.s.arenaNum=r.ps.arenaNum=0,n.client=r,n.client.pers.connected=vt.CONNECTING,Tt.arena=Tt.arenas[n.s.arenaNum],(t||Tt.newSession)&&Ui(r,i),zi(r),an(e),t&&u.SendServerCommand(null,"print",r.pers.netname+" connected"),pr.getAsInt()>=F.TEAM&&r.sess.sessionTeam!==X.SPECTATOR&&Ln(r,null),nn()}function an(e){var t=Tt.gentities[e],n=t.client,r=u.GetUserinfo(e);n.pers.netname=r.name;var i={name:n.pers.netname,team:n.sess.sessionTeam};u.SetConfigstring("player"+e,i),Nt("ClientUserinfoChanged: "+e+" "+JSON.stringify(i))}function fn(e){var t=Tt.gentities[e],n=Tt.clients[e];Tt.arena=Tt.arenas[t.s.arenaNum],t.r.linked&&u.UnlinkEntity(t),t.touch=0,t.pain=0,n.pers.connected=vt.CONNECTED,n.pers.enterTime=Tt.time,cn(t),n.sess.sessionTeam!==X.SPECTATOR&&pr.getAsInt()!==F.TOURNAMENT&&u.SendServerCommand(null,"print",n.pers.netname+" entered the game"),nn()}function ln(e){var t=Tt.gentities[e];if(!t.client||t.client.pers.connected==vt.DISCONNECTED)return;Tt.arena=Tt.arenas[t.s.arenaNum],Nt("ClientDisconnect: "+e),u.UnlinkEntity(t),t.s.modelIndex=0,t.classname="disconnected",t.client.pers.connected=vt.DISCONNECTED,u.SetConfigstring("player"+e,null),nn()}function cn(e){var t=e.client,n=vec3.create(),r=vec3.create();t.pers.teamState.state===mt.QUEUED&&(t.sess.spectatorState=V.FREE);var i;t.sess.spectatorState!==V.NOT?i=Dn(n,r):(pr.getAsInt()>=F.CTF?i=js(t.sess.sessionTeam,t.pers.teamState.state,n,r):i=Mn(t.ps.origin,n,r),t.pers.teamState.state=mt.ACTIVE);var s=t.ps.eFlags&(Q.TELEPORT_BIT|Q.VOTED|Q.TEAMVOTED);s^=Q.TELEPORT_BIT;var o=t.pers.clone(),f=t.sess.clone(),l=new Array(c);for(var h=0;h<c;h++)l[h]=t.ps.persistant[h];var p=t.accuracy_hits,d=t.accuracy_shots,m=t.ps.eventSequence,g=t.ps.ping;t.reset(),o.clone(t.pers),f.clone(t.sess);for(var h=0;h<c;h++)t.ps.persistant[h]=l[h];t.accuracy_hits=p,t.accuracy_shots=d,t.ps.ping=g,t.ps.clientNum=e.s.number,t.ps.arenaNum=e.s.arenaNum,t.ps.eventSequence=m,t.lastkilled_client=-1,t.ps.persistant[$.SPAWN_COUNT]++,t.ps.persistant[$.TEAM]=t.sess.sessionTeam,t.ps.persistant[$.SPECTATOR_STATE]=t.sess.spectatorState,t.airOutTime=Tt.time+12e3,t.pers.maxHealth=100,t.ps.stats[U.MAX_HEALTH]=t.pers.maxHealth,t.ps.eFlags=s,e.s.groundEntityNum=v,e.client=Tt.clients[e.s.number],e.takeDamage=!0,e.inuse=!0,e.classname="player",e.r.contents=P.BODY,e.clipmask=R.PLAYERSOLID,e.die=ir,e.waterlevel=0,e.watertype=0,e.flags=0,vec3.set(sn,e.r.mins),vec3.set(on,e.r.maxs),pr.getAsInt()===F.CLANARENA?(t.ps.stats[U.WEAPONS]=1<<z.GAUNTLET,t.ps.stats[U.WEAPONS]|=1<<z.MACHINEGUN,t.ps.stats[U.WEAPONS]|=1<<z.SHOTGUN,t.ps.stats[U.WEAPONS]|=1<<z.GRENADE_LAUNCHER,t.ps.stats[U.WEAPONS]|=1<<z.ROCKET_LAUNCHER,t.ps.stats[U.WEAPONS]|=1<<z.LIGHTNING,t.ps.stats[U.WEAPONS]|=1<<z.RAILGUN,t.ps.stats[U.WEAPONS]|=1<<z.PLASMAGUN,t.ps.ammo[z.GAUNTLET]=-1,t.ps.ammo[z.MACHINEGUN]=-1,t.ps.ammo[z.SHOTGUN]=-1,t.ps.ammo[z.GRENADE_LAUNCHER]=-1,t.ps.ammo[z.ROCKET_LAUNCHER]=-1,t.ps.ammo[z.LIGHTNING]=-1,t.ps.ammo[z.RAILGUN]=-1,t.ps.ammo[z.PLASMAGUN]=-1,t.ps.weapon=z.ROCKET_LAUNCHER,e.health=t.ps.stats[U.HEALTH]=t.ps.stats[U.MAX_HEALTH],t.ps.stats[U.ARMOR]=t.ps.stats[U.MAX_HEALTH]):(t.ps.stats[U.WEAPONS]=1<<z.GAUNTLET,t.ps.stats[U.WEAPONS]|=1<<z.MACHINEGUN,t.ps.ammo[z.GAUNTLET]=-1,pr.getAsInt()===F.TEAM?t.ps.ammo[z.MACHINEGUN]=50:t.ps.ammo[z.MACHINEGUN]=100,t.ps.weapon=z.MACHINEGUN,e.health=t.ps.stats[U.HEALTH]=t.ps.stats[U.MAX_HEALTH]+25),t.ps.weaponState=I.READY,Qr(e,n),vec3.set(n,t.ps.origin),Nn(e,r),u.GetUserCmd(t.ps.clientNum,e.client.pers.cmd),t.ps.pm_flags|=j.RESPAWNED,t.ps.pm_flags|=j.TIME_KNOCKBACK,t.ps.pm_time=100,t.respawnTime=Tt.time,t.inactivityTime=Tt.time+Mr.getAsInt()*1e3,t.ps.torsoAnim=Z.TORSO_STAND,t.ps.legsAnim=Z.LEGS_IDLE;if(!Tt.intermissiontime){if(e.client.sess.spectatorState===V.NOT){Un(e),Kr(i,e);if(pr.getAsInt()!==F.CLANARENA)for(var h=z.NUM_WEAPONS-1;h>0;h--)if(t.ps.stats[U.WEAPONS]&1<<h){t.ps.weapon=h;break}vec3.set(e.client.ps.origin,e.r.currentOrigin);var y=Xr(e.client.ps.origin,G.PLAYER_TELEPORT_IN);y.s.clientNum=e.s.clientNum,u.LinkEntity(e)}}else en(e);t.ps.commandTime=Tt.time-100,t.pers.cmd.serverTime=Tt.time,dn(t.ps.clientNum),wn(e),a.PlayerStateToEntityState(t.ps,e.s)}function hn(e){Bn(e),cn(e)}function pn(e){if(!gr.getAsInt())return;e.client.pers.cmd.serverTime=Tt.time,vn(e)}function dn(e){var t=Tt.gentities[e];Tt.arena=Tt.arenas[t.s.arenaNum],u.GetUserCmd(e,t.client.pers.cmd),t.client.lastCmdTime=Tt.time;if(gr.getAsInt())return;vn(t)}function vn(e){var t=e.client,n=t.pers.cmd;n.serverTime>Tt.time+200&&(n.serverTime=Tt.time+200),n.serverTime<Tt.time-1e3&&(n.serverTime=Tt.time-1e3);var r=n.serverTime-t.ps.commandTime;if(r<1&&t.sess.spectatorState!==V.FOLLOW)return;r>200&&(r=200),br.getAsInt()<8?br.setValue(8):br.getAsInt()>33&&br.setValue(33),yr.getAsInt()&&(n.serverTime=(n.serverTime+br.getAsInt()-1)/br.getAsInt()*br.getAsInt());if(Tt.intermissiontime){gn(t);return}if(t.sess.spectatorState!==V.NOT){if(t.sess.spectatorState===V.SCOREBOARD)return;yn(e,n);return}Tt.time>t.rewardTime&&(t.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP)),t.noclip?t.ps.pm_type=B.NOCLIP:t.ps.stats[U.HEALTH]<=0?t.ps.pm_type=B.DEAD:t.ps.pm_type=B.NORMAL,t.ps.gravity=Nr.getAsInt(),t.ps.speed=Tr.getAsInt(),t.ps.powerups[W.HASTE]&&(t.ps.speed*=1.3),pr.getAsInt()===F.CLANARENA&&(Tt.arena.warmupTime>0?t.ps.pm_flags|=j.NO_ATTACK:t.ps.pm_flags&=~j.NO_ATTACK);var i=t.ps.eventSequence,s=new a.PmoveInfo;s.ps=t.ps,n.clone(s.cmd),s.trace=_t,s.pointContents=Dt,s.pmove_fixed=yr.getAsInt(),s.pmove_msec=br.getAsInt(),s.ps.pm_type===B.DEAD?s.tracemask=R.PLAYERSOLID&~P.BODY:s.tracemask=R.PLAYERSOLID,t.ps.weapon===z.GAUNTLET&&!(t.ps.pm_flags&j.NO_ATTACK)&&!(n.buttons&M.TALK)&&n.buttons&M.ATTACK&&t.ps.weaponTime<=0&&(s.gauntletHit=Vs(e)),e.flags&ht.FORCE_GESTURE&&(e.flags&=~ht.FORCE_GESTURE,t.pers.cmd.buttons|=M.GESTURE),vec3.set(t.ps.origin,t.oldOrigin),a.Pmove(s),t.ps.eventSequence!==i&&(e.eventTime=Tt.time),a.PlayerStateToEntityState(t.ps,e.s),mn(t.ps),vec3.set(e.s.pos.trBase,e.r.currentOrigin),vec3.set(s.mins,e.r.mins),vec3.set(s.maxs,e.r.maxs),e.waterlevel=s.waterlevel,e.watertype=s.watertype,bn(e,i),u.LinkEntity(e),t.noclip||xn(e),vec3.set(t.ps.origin,e.r.currentOrigin),Tn(e,s),t.ps.eventSequence!=i&&(e.eventTime=Tt.time);if(t.ps.pm_type===B.DEAD){if(Tt.time>t.respawnTime){if(Or.getAsInt()>0&&Tt.time-t.respawnTime>Or.getAsInt()*1e3){hn(e);return}n.buttons&(M.ATTACK|M.USE_HOLDABLE)&&hn(e)}return}}function mn(e){if(e.entityEventSequence<e.eventSequence){var t=e.entityEventSequence&p-1,n=e.events[t]|(e.entityEventSequence&3)<<8;extEvent=e.externalEvent,e.externalEvent=0;var r=Xr(e.origin,n);number=r.s.number,a.PlayerStateToEntityState(e,r.s),r.s.number=number,r.s.eType=K.EVENTS+n,r.s.eFlags|=Q.PLAYER_EVENT,r.s.otherEntityNum=e.clientNum,r.r.svFlags|=pt.NOTSINGLECLIENT,r.r.singleClient=e.clientNum,e.externalEvent=extEvent}}function gn(e){e.ps.eFlags&=~Q.TALK,e.ps.eFlags&=~Q.FIRING,e.oldbuttons=e.buttons,e.buttons=e.pers.cmd.buttons,e.buttons&(M.ATTACK|M.USE_HOLDABLE)&(e.oldbuttons^e.buttons)&&(e.readyToExit=1)}function yn(e,t){var n=e.client;if(n.sess.spectatorState!==V.FOLLOW){n.ps.pm_type=B.SPECTATOR,n.ps.speed=400;var r=new a.PmoveInfo;r.ps=n.ps,t.clone(r.cmd),r.tracemask=R.PLAYERSOLID&~P.BODY,r.trace=_t,r.pointContents=Dt,a.Pmove(r),vec3.set(n.ps.origin,e.s.origin),xn(e),u.UnlinkEntity(e)}}function bn(e,t){var n=e.client;t<n.ps.eventSequence-p&&(t=n.ps.eventSequence-p);for(var r=t;r<n.ps.eventSequence;r++){var i=n.ps.events[r&p-1];switch(i){case G.FALL_MEDIUM:case G.FALL_FAR:if(e.s.eType!==K.PLAYER)break;var s=5;i==G.FALL_FAR&&(s=10),e.painDebounceTime=Tt.time+200,er(e,null,null,null,null,s,0,et.FALLING);break;case G.FIRE_WEAPON:zs(e);break;default:}}}function wn(e){var t=e.client;if(t.sess.spectatorState!==V.NOT){En(e);return}for(var n=0;n<h;n++)t.ps.powerups[n]<Tt.time&&(t.ps.powerups[n]=0);if(Tt.intermissiontime)return;Rn(e),qn(e),Tt.time-t.lastCmdTime>1e3?t.ps.eFlags|=Q.CONNECTION:t.ps.eFlags&=~Q.CONNECTION,t.ps.stats[U.HEALTH]=e.health,Sn(e),a.PlayerStateToEntityState(t.ps,e.s),mn(t.ps)}function En(e){var t=e.client;if(t.sess.spectatorState===V.FOLLOW){var n=t.sess.spectatorClient;n===-1?n=Tt.follow1:n===-2&&(n=Tt.follow2);if(n>=0){var t=Tt.clients[n];if(t.pers.connected===vt.CONNECTED&&t.sess.spectatorState===V.NOT){var r=t.ps.eFlags&~(Q.VOTED|Q.TEAMVOTED)|t.ps.eFlags&(Q.VOTED|Q.TEAMVOTED);t.ps=t.ps,t.ps.pm_flags|=j.FOLLOW,t.ps.eFlags=r;return}t.sess.spectatorClient>=0&&(t.sess.spectatorState=V.FREE,fn(e.s.number))}}t.sess.spectatorState===V.SCOREBOARD?t.ps.pm_flags|=j.SCOREBOARD:t.ps.pm_flags&=~j.SCOREBOARD}function Sn(e){}function xn(e){if(!e.client)return;if(e.client.pm_type===B.DEAD)return;var t=e.client.ps,n=vec3.createFrom(40,40,52),r=vec3.create(),i=vec3.create();vec3.subtract(t.origin,n,r),vec3.add(t.origin,n,i);var s=Mt(r,i);vec3.add(t.origin,e.r.mins,r),vec3.add(t.origin,e.r.maxs,i);for(var o=0;o<s.length;o++){var f=Tt.gentities[s[o]];if(!f.touch)continue;if(!(f.r.contents&P.TRIGGER))continue;if(f.s.eType===K.ITEM){if(!a.PlayerTouchesItem(t,f.s,Tt.time))continue}else if(!u.EntityContact(r,i,f))continue;f.touch.call(this,f,e)}t.jumppad_frame!=t.pmove_framecount&&(t.jumppad_frame=0,t.jumppad_ent=0)}function Tn(e,t){for(var n=0;n<t.numTouch;n++){for(var r=0;r<n;r++)if(t.touchEnts[r]===t.touchEnts[n])break;if(r!==n)continue;var i=Tt.gentities[t.touchEnts[n]];if(!i.touch)continue;i.touch(i,e,null)}}function Nn(e,t){var r=e.client;for(var i=0;i<3;i++){var s=n.AngleToShort(t[i]);r.ps.delta_angles[i]=s-r.pers.cmd.angles[i]}vec3.set(t,e.s.angles),vec3.set(e.s.angles,r.ps.viewangles)}function Cn(e,t){if(t<0||t>=Tt.arenas.length){Ct("Invalid arena number.");return}var n=Tt.arena;Tt.arena=Tt.arenas[t],e.s.arenaNum=e.client.ps.arenaNum=t,kn(e.client,"f"),Tt.arena=n,nn()}function kn(e,t){var n=e.ps.clientNum,r=Tt.gentities[n],i,s=V.NOT,o=0,u=e.sess.sessionTeam;t==="scoreboard"||t==="score"?(i=X.SPECTATOR,s=V.SCOREBOARD):t==="follow1"?(i=X.SPECTATOR,s=V.FOLLOW,o=-1):t==="follow2"?(i=X.SPECTATOR,s=V.FOLLOW,o=-2):t==="spectator"||t==="s"?(i=X.SPECTATOR,s=V.FREE):(t==="red"||t==="r"?i=X.RED:t==="blue"||t==="b"?i=X.BLUE:i=vs(n),i===X.SPECTATOR&&(s=V.FREE,Kt(r))),Nt("Setting team for",n,"to",i),e.sess.sessionTeam=i,e.sess.spectatorState=s,e.sess.spectatorClient=o;if(e.pers.connected!==vt.CONNECTED)return;e.ps.pm_type===B.DEAD&&Bn(r),u!==X.SPECTATOR&&(r.flags&=~ht.GODMODE,e.ps.stats[U.HEALTH]=r.health=0,ir(r,r,r,1e5,et.SUICIDE)),Ln(e,u),an(n),fn(n)}function Ln(e,t){e.sess.sessionTeam===X.RED?u.SendServerCommand(null,"cp",e.pers.netname+" joined the red team."):e.sess.sessionTeam===X.BLUE?u.SendServerCommand(null,"cp",e.pers.netname+" joined the blue team."):e.sess.sessionTeam===X.SPECTATOR&&t!==X.SPECTATOR?u.SendServerCommand(null,"cp",e.pers.netname+" joined the spectators."):e.sess.sessionTeam===X.FREE&&u.SendServerCommand(null,"cp",e.pers.netname+" joined the battle.")}function An(e){var t=Tt.clients[e];return t.ps}function On(e,t){return e.dist>t.dist?-1:e.dist<t.dist?1:0}function Mn(e,t,r){var i=Vr({classname:"info_player_deathmatch"}),s=[],o;for(var u=0;u<i.length;u++){o=i[u];if(_n(o))continue;if(o.flags&ht.NO_HUMANS)continue;if(o.arena!==d&&o.arena!==Tt.arena.arenaNum)continue;var a=vec3.subtract(o.s.origin,e,vec3.create()),f=vec3.length(a);s.push({dist:f,spot:o})}if(!s.length)o=i[0],o||Ct("Couldn't find a spawn point");else{s.sort(On);var l=n.irrandom(0,Math.floor(s.length/2));o=s[l].spot}return vec3.set(o.s.origin,t),t[2]+=9,vec3.set(o.s.angles,r),o}function _n(e){var t=vec3.add(e.s.origin,sn,vec3.create()),n=vec3.add(e.s.origin,on,vec3.create()),r=Mt(t,n);for(var i=0;i<r.length;i++){var s=Tt.gentities[r[i]];if(s.client)return!0}return!1}function Dn(e,t){return Pn(e,t)}function Pn(e,t){var r=Vr({classname:"info_player_intermission"}),i;if(!r.length)i=Mn(n.vec3origin,e,t);else{var s;for(s=0;s<r.length;s++){i=r[s];if(i.arena===Tt.arena.arenaNum){Nt("SelectIntermissionSpawnPoint found for",i.arena);break}}s===r.length&&(i=r[0]),vec3.set(i.s.origin,e),vec3.set(i.s.angles,t);if(i.target){var o=Jr(i.target);if(o){var u=vec3.subtract(o.s.origin,e,vec3.create());n.VectorToAngles(u,t)}}}return i}function Hn(){Tt.bodyQueueIndex=0;for(var e=0;e<nt;e++){var t=Hr();t.classname="bodyqueue",t.neverFree=!0,Tt.bodyQueue[e]=t}}function Bn(e){u.UnlinkEntity(e);var t=Dt(e.s.origin,-1);if(t&P.NODROP)return;var n=Tt.bodyQueue[Tt.bodyQueueIndex];Tt.bodyQueueIndex=(Tt.bodyQueueIndex+1)%nt;var r=n.s.number;e.s.clone(n.s),n.s.eFlags=Q.DEAD,n.s.powerups=0,n.s.loopSound=0,n.s.number=r,n.timestamp=Tt.time,n.physicsObject=!0,n.physicsBounce=0,n.s.groundEntityNum===v?(n.s.pos.trType=_.GRAVITY,n.s.pos.trTime=Tt.time,vec3.set(e.client.ps.velocity,n.s.pos.trDelta)):n.s.pos.trType=_.STATIONARY,n.s.event=0;switch(n.s.legsAnim&~N){case Z.BOTH_DEATH1:case Z.BOTH_DEAD1:n.s.torsoAnim=n.s.legsAnim=Z.BOTH_DEAD1;break;case Z.BOTH_DEATH2:case Z.BOTH_DEAD2:n.s.torsoAnim=n.s.legsAnim=Z.BOTH_DEAD2;break;case Z.BOTH_DEATH3:case Z.BOTH_DEAD3:default:n.s.torsoAnim=n.s.legsAnim=Z.BOTH_DEAD3}n.r.svFlags=e.r.svFlags,vec3.set(e.r.mins,n.r.mins),vec3.set(e.r.maxs,n.r.maxs),vec3.set(e.r.absmin,n.r.absmin),vec3.set(e.r.absmax,n.r.absmax),n.clipmask=P.SOLID|P.PLAYERCLIP,n.r.contents=P.CORPSE,n.r.ownerNum=e.s.number,n.nextthink=Tt.time+5e3,n.think=jn,n.die=Fn,e.health<=y?n.takeDamage=!1:n.takeDamage=!0,vec3.set(n.s.pos.trBase,n.r.currentOrigin),u.LinkEntity(n)}function jn(e){if(Tt.time-e.timestamp>6500){u.UnlinkEntity(e),e.physicsObject=!1;return}e.nextthink=Tt.time+100,e.s.pos.trBase[2]-=1}function Fn(e,t,n,r,i){if(e.health>y)return;or(e,0)}function In(e,t,r){var i=r[0]>999999;if(e.client.sess.spectatorState===V.NOT){var s=Xr(e.client.ps.origin,G.PLAYER_TELEPORT_OUT);s.s.clientNum=e.s.clientNum,s=Xr(t,G.PLAYER_TELEPORT_IN),s.s.clientNum=e.s.clientNum}u.UnlinkEntity(e),vec3.set(t,e.client.ps.origin),e.client.ps.origin[2]+=1,i||(n.AnglesToVectors(r,e.client.ps.velocity,null,null),vec3.scale(e.client.ps.velocity,400),e.client.ps.pm_time=160,e.client.ps.pm_flags|=j.TIME_KNOCKBACK,Nn(e,r)),e.client.ps.eFlags^=Q.TELEPORT_BIT,e.client.sess.spectatorState===V.NOT&&Un(e),a.PlayerStateToEntityState(e.client.ps,e.s),vec3.set(e.client.ps.origin,e.r.currentOrigin),e.client.sess.spectatorState===V.NOT&&u.LinkEntity(e)}function qn(e){var t=e.client;if(t.ps.pm_type===B.DEAD)return;var r=t.damage_blood+t.damage_armor;if(r===0)return;r>255&&(r=255);if(t.damage_fromWorld)t.ps.damagePitch=255,t.ps.damageYaw=255,t.damage_fromWorld=!1;else{var i=vec3.create();n.VectorToAngles(t.damage_from,i),t.ps.damagePitch=i[n.PITCH]/360*256,t.ps.damageYaw=i[n.YAW]/360*256}Tt.time>e.painDebounceTime&&!(e.flags&ht.GODMODE)&&(e.painDebounceTime=Tt.time+700,ni(e,G.PAIN,e.health),t.ps.damageEvent++),t.ps.damageCount=r,t.damage_blood=0,t.damage_armor=0,t.damage_knockback=0}function Rn(e){var t=e.client;if(t.noclip){t.airOutTime=Tt.time+12e3;return}var n=e.waterlevel,r=t.ps.powerups[W.BATTLESUIT]>Tt.time;n===3?(r&&(t.airOutTime=Tt.time+1e4),t.airOutTime<Tt.time&&(t.airOutTime+=1e3,e.health>0&&(e.damage+=2,e.damage>15&&(e.damage=15),e.painDebounceTime=Tt.time+200,er(e,null,null,null,null,e.damage,ct.NO_ARMOR,et.WATER)))):(t.airOutTime=Tt.time+12e3,e.damage=2),n&&e.watertype&(P.LAVA|P.SLIME)&&e.health>0&&e.painDebounceTime<=Tt.time&&(r?ni(e,G.POWERUP_BATTLESUIT,0):(e.watertype&P.LAVA&&er(e,null,null,null,null,30*n,0,et.LAVA),e.watertype&P.SLIME&&er(e,null,null,null,null,10*n,0,et.SLIME)))}function Un(e){var t=vec3.add(e.client.ps.origin,e.r.mins,vec3.create()),n=vec3.add(e.client.ps.origin,e.r.maxs,vec3.create()),r=Mt(t,n);for(var i=0;i<r.length;i++){var s=Tt.gentities[r[i]];if(!s.client)continue;er(s,e,e,null,null,1e5,ct.NO_PROTECTION,et.TELEFRAG)}}function zn(e,t){var n=Tt.gentities[e];if(!n.client||n.client.pers.connected!==vt.CONNECTED)return;var r=t.type,i=t.data;if(r==="say"){Wn(n,Vn.ALL,i[0]);return}if(r==="score"){Kn(n);return}r==="noclip"?Gn(n):r==="team"?Yn(n,i[0]):r==="arena"&&Zn(n,i[0])}function Wn(e,t,n){if(!n)return;$n(e,null,t,n)}function $n(e,t,n,r){if(!r)return;pr.getAsInt()<F.TEAM&&n===Vn.TEAM&&(n=Vn.ALL);var i;switch(n){case Vn.ALL:i=e.client.pers.netname}r=r.substr(0,Xn);for(var s=0;s<Tt.maxclients;s++){var o=Tt.gentities[s];Jn(e,o,n,i,r)}}function Jn(e,t,n,r,i){if(!t)return;if(!t.inuse)return;if(!t.client)return;if(t.client.pers.connected!==vt.CONNECTED)return;if(n===Vn.TEAM&&!ds(e,t))return;if(pr.getAsInt()===F.TOURNAMENT&&t.client.sess.sessionTeam===X.FREE&&e.client.sess.sessionTeam!==X.FREE)return;u.SendServerCommand(t.s.number,n===Vn.TEAM?"tchat":"chat",{name:r,text:i})}function Kn(e){Qn(e)}function Qn(e){var t=Tt.arenas[e.s.arenaNum],n={scoreRed:t.teamScores[X.RED],scoreBlue:t.teamScores[X.BLUE],scores:[]};for(var r=0;r<t.numConnectedClients;r++){var i=t.sortedClients[r],s=Tt.clients[i],o=-1;s.pers.connected!==vt.CONNECTING&&(o=s.ps.ping<999?s.ps.ping:999);var a=0;s.accuracy_shots&&(a=s.accuracy_hits*100/s.accuracy_shots);var f=s.ps.persistant[$.RANK]===0&&s.ps.persistant[$.KILLED]===0?1:0;n.scores.push({clientNum:i,score:s.ps.persistant[$.SCORE],ping:o,time:(Tt.time-s.pers.enterTime)/6e4,powerups:Tt.gentities[t.sortedClients[r]].s.powerups,accuracy:a,impressive:s.ps.persistant[$.IMPRESSIVE_COUNT],excellent:s.ps.persistant[$.EXCELLENT_COUNT],gauntlet:s.ps.persistant[$.GAUNTLET_FRAG_COUNT],defend:s.ps.persistant[$.DEFEND_COUNT],assist:s.ps.persistant[$.ASSIST_COUNT],perfect:f,captures:s.ps.persistant[$.CAPTURES],dead:s.pers.teamState.state===mt.QUEUED})}u.SendServerCommand(e.s.number,"scores",n)}function Gn(e){e.client.noclip=!e.client.noclip;var t="noclip ON";e.client.noclip||(t="noclip OFF"),u.SendServerCommand(e.s.number,"print",t)}function Yn(e,t){if(!t){var n=e.client.sess.sessionTeam;switch(n){case X.BLUE:u.SendServerCommand(e.s.number,"print","Blue team");break;case X.RED:u.SendServerCommand(e.s.number,"print","Red team");break;case X.FREE:u.SendServerCommand(e.s.number,"print","Free team");break;case X.SPECTATOR:u.SendServerCommand(e.s.number,"print","Spectator team")}return}if(e.client.switchTeamTime>Tt.time){u.SendServerCommand(e.s.number,"print","May not switch teams more than once per 5 seconds.");return}pr.getAsInt()===F.TOURNAMENT&&e.client.sess.sessionTeam===X.FREE&&e.client.sess.losses++,kn(e.client,t),e.client.switchTeamTime=Tt.time+5e3}function Zn(e,t){t=parseInt(t,10);if(isNaN(t)||t<0||t>=Tt.arenas.length){u.SendServerCommand(e.s.number,"print","Invalid arena");return}if(e.client.switchArenaTime>Tt.time){u.SendServerCommand(e.s.number,"print","May not switch arenas more than once per 3 seconds.");return}Cn(e,t),e.client.switchArenaTime=Tt.time+3e3}function er(e,t,n,r,i,s,o,u){if(!e.takeDamage)return;if(Tt.intermissionQueued)return;t||(t=Tt.gentities[m]),n||(n=Tt.gentities[m]);if(e.s.eType===K.MOVER){e.use&&e.moverState==dt.POS1&&e.use(e,t,n);return}var a=e.client;if(a&&a.noclip)return;r?vec3.normalize(r):o|=ct.NO_KNOCKBACK;var f=s;f>200&&(f=200),e.flags&ht.NO_KNOCKBACK&&(f=0),o&ct.NO_KNOCKBACK&&(f=0);if(f&&e.client){var l=200,c=vec3.scale(r,Cr.getAsInt()*f/l,vec3.create());vec3.add(e.client.ps.velocity,c);if(!e.client.ps.pm_time){var h=f*2;h<50?h=50:h>200&&(h=200),e.client.ps.pm_time=h,e.client.ps.pm_flags|=j.TIME_KNOCKBACK}}if(!(o&ct.NO_PROTECTION)){if(e!==n&&ds(e,n)&&!wr.getAsInt())return;if(e.flags&ht.GODMODE)return}if(a&&a.ps.powerups[W.BATTLESUIT]){ni(e,G.POWERUP_BATTLESUIT,0);if(o&ct.RADIUS||u===et.FALLING)return;s*=.5}n.client&&a&&e!==n&&e.health>0&&e.s.eType!==K.MISSILE&&e.s.eType!==K.GENERAL&&(ds(e,n)?n.client.ps.persistant[$.HITS]--:n.client.ps.persistant[$.HITS]++),e===n&&(s*=.5),s=Math.ceil(s),pr.getAsInt()===F.CLANARENA&&e===n&&(t.classname==="rocket"||t.classname==="grenade")&&(s=0);var p=s,d=fr(e,p,o);p-=d,a&&(n?a.ps.persistant[$.ATTACKER]=n.s.number:a.ps.persistant[$.ATTACKER]=m,a.damage_armor+=d,a.damage_blood+=p,a.damage_knockback+=f,r?(vec3.set(r,a.damage_from),a.damage_fromWorld=!1):(vec3.set(e.r.currentOrigin,a.damage_from),a.damage_fromWorld=!0)),e.client&&(e.client.lasthurt_client=n.s.number,e.client.lasthurt_mod=u);if(p){e.health=e.health-p,e.client&&(e.client.ps.stats[U.HEALTH]=e.health);if(e.health<=0){a&&(e.flags|=ht.NO_KNOCKBACK),e.health<-999&&(e.health=-999),e.enemy=n,e.die(e,t,n,p,u);return}e.pain&&e.pain(e,n,p)}}function tr(e,t,n,r,i,s,o){var u=vec3.create(),a=vec3.create(),f=vec3.create(),l=!1;i<1&&(i=1);for(var c=0;c<3;c++)a[c]=e[c]-i,f[c]=e[c]+i;var h=Mt(a,f);for(var p=0;p<h.length;p++){var d=Tt.gentities[h[p]];if(d===s)continue;if(!d.takeDamage)continue;for(var c=0;c<3;c++)e[c]<d.r.absmin[c]?u[c]=d.r.absmin[c]-e[c]:e[c]>d.r.absmax[c]?u[c]=e[c]-d.r.absmax[c]:u[c]=0;var v=vec3.length(u);if(v>=i)continue;var m=r*(1-v/i);if(nr(d,e)){ar(d,n)&&(l=!0);var g=vec3.subtract(d.r.currentOrigin,e,vec3.create());g[2]+=24,er(d,t,n,g,e,m,ct.RADIUS,o)}}return l}function nr(e,t){var i=new r.TraceResults,s=vec3.add(e.r.absmin,e.r.absmax,vec3.create());vec3.scale(s,.5);var o=vec3.create(s);return _t(i,t,o,n.vec3origin,n.vec3origin,v,R.SOLID),i.fraction===1||i.entityNum===e.s.number?!0:(vec3.set(s,o),o[0]+=15,o[1]+=15,_t(i,t,o,n.vec3origin,n.vec3origin,v,R.SOLID),i.fraction===1?!0:(vec3.set(s,o),o[0]+=15,o[1]-=15,_t(i,t,o,n.vec3origin,n.vec3origin,v,R.SOLID),i.fraction===1?!0:(vec3.set(s,o),o[0]-=15,o[1]+=15,_t(i,t,o,n.vec3origin,n.vec3origin,v,R.SOLID),i.fraction===1?!0:(vec3.set(s,o),o[0]-=15,o[1]-=15,_t(i,t,o,n.vec3origin,n.vec3origin,v,R.SOLID),i.fraction===1?!0:!1))))}function ir(e,t,n,r,i){if(e.client.ps.pm_type===B.DEAD)return;if(Tt.intermissiontime)return;e.client.ps.pm_type=B.DEAD,pr.getAsInt()===F.CLANARENA&&Tt.arena.warmupTime===lt&&Kt(e);var s,o;n&&(s=n.s.number,n.client?o=n.client.pers.netname:o="<non-client>");if(s===undefined||s<0||s>=f)s=m,o="<world>";Nt("Kill:",s,e.s.number,i,",",o,"killed",e.client.pers.netname);var a=Xr(e.r.currentOrigin,G.OBITUARY);a.s.eventParm=i,a.s.otherEntityNum=e.s.number,a.s.otherEntityNum2=s,a.r.svFlags=pt.BROADCAST,e.enemy=n,e.client.ps.persistant[$.KILLED]++,n&&n.client?(n.client.lastkilled_client=e.s.number,n==e||ds(e,n)?lr(n,e.r.currentOrigin,-1):(lr(n,e.r.currentOrigin,1),i===et.GAUNTLET&&(n.client.ps.persistant[$.GAUNTLET_FRAG_COUNT]++,n.client.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP),n.client.ps.eFlags|=Q.AWARD_GAUNTLET,n.client.rewardTime=Tt.time+ot,e.client.ps.persistant[$.PLAYEREVENTS]^=J.GAUNTLETREWARD),Tt.time-n.client.lastKillTime<st&&(n.client.ps.persistant[$.EXCELLENT_COUNT]++,n.client.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP),n.client.ps.eFlags|=Q.AWARD_EXCELLENT,n.client.rewardTime=Tt.time+ot),n.client.lastKillTime=Tt.time)):lr(e,e.r.currentOrigin,-1),i===et.SUICIDE&&(e.client.ps.powerups[W.NEUTRALFLAG]?(Ds(X.FREE),e.client.ps.powerups[W.NEUTRALFLAG]=0):e.client.ps.powerups[W.REDFLAG]?(Ds(X.RED),e.client.ps.powerups[W.REDFLAG]=0):e.client.ps.powerups[W.BLUEFLAG]&&(Ds(X.BLUE),e.client.ps.powerups[W.BLUEFLAG]=0)),hr(e),Qn(e);for(var l=0;l<Tt.maxclients;l++){var c=Tt.clients[l];if(c.pers.connected!==vt.CONNECTED)continue;if(c.sess.sessionTeam!==X.SPECTATOR)continue;c.sess.spectatorClient===e.s.number&&Qn(Tt.gentities[l])}e.takeDamage=!0,e.s.weapon=z.NONE,e.s.powerups=0,e.r.contents=P.CORPSE,e.s.angles[0]=0,e.s.angles[2]=0,sr(e,t,n),vec3.set(e.s.angles,e.client.ps.viewangles),e.s.loopSound=0,e.r.maxs[2]=-8,e.client.respawnTime=Tt.time+1700;for(var l=0;l<h;l++)e.client.ps.powerups[l]=0;var p=Dt(e.r.currentOrigin,-1);if(e.health<=y&&!(p&P.NODROP)||i===et.SUICIDE)or(e,s);else{var d;switch(rr){case 0:d=Z.BOTH_DEATH1;break;case 1:d=Z.BOTH_DEATH2;break;case 2:default:d=Z.BOTH_DEATH3}e.health<=y&&(e.health=y+1),e.client.ps.legsAnim=e.client.ps.legsAnim&N^N|d,e.client.ps.torsoAnim=e.client.ps.torsoAnim&N^N|d,ni(e,G.DEATH1+rr,s),e.die=Fn,rr=(rr+1)%3}u.LinkEntity(e)}function sr(e,t,r){var i=vec3.create();if(r&&r!==e)vec3.subtract(r.s.pos.trBase,e.s.pos.trBase,i);else{if(!t||t===e){e.client.ps.stats[U.DEAD_YAW]=e.s.angles[n.YAW];return}vec3.subtract(t.s.pos.trBase,e.s.pos.trBase,i)}e.client.ps.stats[U.DEAD_YAW]=ur(i)}function or(e,t){ni(e,G.GIB_PLAYER,t),e.takeDamage=!1,e.s.eType=K.INVISIBLE,e.r.contents=0}function ur(e){var t;return e[n.YAW]===0&&e[n.PITCH]===0?t=0:(e[n.PITCH]?t=Math.atan2(e[n.YAW],e[n.PITCH])*180/Math.PI:e[n.YAW]>0?t=90:t=270,t<0&&(t+=360)),t}function ar(e,t){return e.takeDamage?e===t?!1:e.client?t.client?e.client.ps.stats[U.HEALTH]<=0?!1:ds(e,t)?!1:!0:!1:!1:!1}function fr(e,t,n){if(!t)return 0;if(n&ct.NO_ARMOR)return 0;var r=e.client;if(!r)return 0;var i=r.ps.stats[U.ARMOR],s=Math.ceil(t*b);return s>=i&&(s=i),s?(r.ps.stats[U.ARMOR]-=s,s):0}function lr(e,t,n){var r=e.client;if(!r)return;if(Tt.arena.warmupTime)return;cr(e,t,n),r.ps.persistant[$.SCORE]+=n,pr.getAsInt()===F.TEAM&&(Tt.arena.teamScores[r.ps.persistant[$.TEAM]]+=n),nn()}function cr(e,t,n){var r=Xr(t,G.SCOREPLUM);r.r.svFlags|=pt.SINGLECLIENT,r.r.singleClient=e.s.number,r.s.otherEntityNum=e.s.number,r.s.time=n}function hr(e){if(pr.getAsInt()===F.CLANARENA)return;var t=e.s.weapon;if(t===z.MACHINEGUN||t===z.GRAPPLING_HOOK)e.client.ps.weaponstate===I.DROPPING&&(t=e.client.pers.cmd.weapon),e.client.ps.stats[U.WEAPONS]&1<<t||(t=z.NONE);if(t>z.MACHINEGUN&&t!==z.GRAPPLING_HOOK&&e.client.ps.ammo[t]){var n=a.FindItemForWeapon(t);yi(e,n,0)}if(pr.getAsInt()!==F.TEAM){var r=45;for(var i=1;i<W.NUM_POWERUPS;i++)if(e.client.ps.powerups[i]>Tt.time){var n=a.FindItemForPowerup(i);if(!n)continue;var s=yi(e,n,r);s.count=(e.client.ps.powerups[i]-Tt.time)/1e3,s.count<1&&(s.count=1),r+=45}}}function _r(){dr=i.AddCvar("g_fraglimit",20,O.ARENAINFO|O.ARCHIVE),mr=i.AddCvar("g_capturelimit",8,O.ARENAINFO|O.ARCHIVE),pr=i.AddCvar("g_gametype",0,O.SERVERINFO|O.ARCHIVE,!0),vr=i.AddCvar("g_timelimit",0,O.SERVERINFO|O.ARCHIVE),gr=i.AddCvar("g_synchronousClients",0,O.SYSTEMINFO),yr=i.AddCvar("pmove_fixed",1,O.SYSTEMINFO),br=i.AddCvar("pmove_msec",8,O.SYSTEMINFO),wr=i.AddCvar("g_friendlyFire",0,O.ARCHIVE),Er=i.AddCvar("g_playersPerTeam",0,O.ARCHIVE),Sr=i.AddCvar("g_teamForceBalance",0,O.ARCHIVE),xr=i.AddCvar("g_warmup",10,O.ARCHIVE),Tr=i.AddCvar("g_speed",320),Nr=i.AddCvar("g_gravity",800),Cr=i.AddCvar("g_knockback",1e3),kr=i.AddCvar("g_quadfactor",3),Lr=i.AddCvar("g_weaponrespawn",5),Ar=i.AddCvar("g_weaponTeamRespawn",30),Or=i.AddCvar("g_forceRespawn",20),Mr=i.AddCvar("g_inactivity",0)}function Hr(){for(var e=f;e<l;e++){var t=Tt.gentities[e];if(t.inuse)continue;if(t.freeTime>Tt.startTime+2e3&&Tt.time-t.freeTime<1e3)continue;return t.reset(),t.inuse=!0,t.s.number=e,t.s.arenaNum=Tt.arena?Tt.arena.arenaNum:d,t}Ct("Game entities is full")}function Br(e){u.UnlinkEntity(e);if(e.neverFree)return;e.inuse=!1,e.classname="freed",e.freeTime=Tt.time}function jr(){var e=u.GetEntityDefs();for(var t=0;t<e.length;t++){var n=e[t];Fr(n)}Wr()}function Fr(e){var t=Hr();Tt.spawnVars=e;for(var n in e){if(!e.hasOwnProperty(n))continue;Ir(t,n,e[n])}if(pr.getAsInt()>=F.TEAM){var r=Ur("notteam",0);if(r){u.LinkEntity(t),u.AdjustAreaPortalState(t,!0),Br(t);return}}else{var i=Ur("notfree",0);if(i){u.LinkEntity(t),u.AdjustAreaPortalState(t,!0),Br(t);return}}var s=qr("gametype",null);if(s!==null&&pr.getAsInt()>=F.FFA&&pr.getAsInt()<F.MAX_GAME_TYPE){var o=tt[pr.getAsInt()];if(s.indexOf(o)===-1){u.LinkEntity(t),u.AdjustAreaPortalState(t,!0),Br(t);return}}for(var f=1;f<a.ItemList.length;f++){var l=a.ItemList[f];if(l.classname===t.classname){ii(t,l);return}}t.spawn=Dr[t.classname];if(!t.spawn){Br(t);return}t.spawn.call(this,t)}function Ir(e,t,n){var i=Pr[t];if(!i)return;var s;switch(i.type){case"vector":n.replace(/([^\s]+)\s+([^\s]+)\s*([^\s]*)/,function(e,t,n,r){s=vec3.createFrom(parseFloat(t),parseFloat(n),r?parseFloat(r):0)});break;case"int":s=parseInt(n,10);break;case"float":s=parseFloat(n);break;case"anglehack":s=vec3.createFrom(0,parseFloat(n),0);break;default:s=n}if(!i.aliases)e[t]=s;else for(var o=0;o<i.aliases.length;o++){var u=i.aliases[o];r.ASET(e,u,s)}}function qr(e,t){return typeof Tt.spawnVars[e]!="undefined"?Tt.spawnVars[e]:t}function Rr(e,t){var n=qr(e,t);return parseFloat(n)}function Ur(e,t){var n=qr(e,t);return parseInt(n,10)}function zr(e,t){var n=vec3.create(),r=qr(e,t);return r.replace(/(.+) (.+) (.+)/,function(e,t,r,i){n[0]=parseFloat(t),n[1]=parseFloat(t),n[2]=parseFloat(t)}),n}function Wr(){var e=0,t=0;for(var n=1;n<l;n++){var r=Tt.gentities[n];if(!r.inuse)continue;if(r.s.arenaNum!==Tt.arena.arenaNum)continue;if(!r.team)continue;if(r.flags&ht.TEAMSLAVE)continue;r.teammaster=r,e++,t++;for(var i=n+1;i<l;i++){var s=Tt.gentities[i];if(!s.inuse)continue;if(s.s.arenaNum!==Tt.arena.arenaNum)continue;if(!s.team)continue;if(s.flags&ht.TEAMSLAVE)continue;r.team===s.team&&(t++,s.teamchain=r.teamchain,r.teamchain=s,s.teammaster=r,s.flags|=ht.TEAMSLAVE,s.targetName&&(r.targetName=s.targetName,s.targetName=null))}}Nt(e,"teams with",t,"entities")}function Xr(e,t){var n=Hr();return n.s.eType=K.EVENTS+t,n.classname="tempEntity",n.eventTime=Tt.time,n.freeAfterEvent=!0,Qr(n,e),u.LinkEntity(n),n}function Vr(e){var t=[];for(var n=0;n<Tt.gentities.length;n++){var r=Tt.gentities[n];if(!r.inuse)continue;if(r.s.arenaNum!==Tt.arena.arenaNum)continue;var i=!0;for(var s in e){var o=e[s];if(r[s]!==o){i=!1;break}}i&&t.push(r)}return t}function $r(e){var t=e.nextthink;if(t<=0)return;if(t>Tt.time)return;e.nextthink=0,e.think||Ct("null ent.think"),e.think.call(this,e)}function Jr(e){if(!e)return Nt("PickTarget called with NULL targetname"),null;var t=Vr({targetName:e});return t.length?t[n.irrandom(0,t.length-1)]:(Nt("PickTarget: target "+e+" not found"),null)}function Kr(e,t){if(!e)return;if(!e.target)return;var n=Vr({targetName:e.target});for(var r=0;r<n.length;r++){var i=n[r];i==e?Nt("WARNING: Entity used itself."):i.use&&i.use(i,e,t);if(!e.inuse){Nt("Entity was removed while using targets.");return}}}function Qr(e,t){vec3.set(t,e.s.pos.trBase),e.s.pos.trType=_.STATIONARY,e.s.pos.trTime=0,e.s.pos.trDuration=0,e.s.pos.trDelta[0]=e.s.pos.trDelta[1]=e.s.pos.trDelta[2]=0,vec3.set(t,e.r.currentOrigin)}function ti(e,t){vec3.equal(e,Gr)?vec3.set(Yr,t):vec3.equal(e,Zr)?vec3.set(ei,t):n.AnglesToVectors(e,t,null,null),e[0]=e[1]=e[2]=0}function ni(e,t,n){var r;if(!t){Nt("AddEvent: zero event added for entity",e.s.number);return}e.client?(r=e.client.ps.externalEvent&L,r=r+C&L,e.client.ps.externalEvent=t|r,e.client.ps.externalEventParm=n,e.client.ps.externalEventTime=Tt.time):(r=e.s.event&L,r=r+C&L,e.s.event=t|r,e.s.eventParm=n),e.eventTime=Tt.time}function ri(e,t,n){if(!e.client)return;a.AddPredictableEventToPlayerstate(e.client.ps,t,n)}function ii(e,t){e.item=t,e.nextthink=Tt.time+rt*2,e.think=ui,e.physicsBounce=.5}function si(e){var t=new r.TraceResults;!(e.spawnflags&1)&&e.s.groundEntityNum===v&&e.s.pos.trType!==_.GRAVITY&&(e.s.pos.trType=_.GRAVITY,e.s.pos.trTime=Tt.time);if(e.s.pos.trType===_.STATIONARY){$r(e);return}var n=vec3.create();a.EvaluateTrajectory(e.s.pos,Tt.time,n);var i;e.clipmask?i=e.clipmask:i=R.PLAYERSOLID&~P.BODY,_t(t,e.r.currentOrigin,n,e.r.mins,e.r.maxs,e.r.ownerNum,i),t.startSolid&&(t.fraction=0),vec3.set(t.endPos,e.r.currentOrigin),u.LinkEntity(e),$r(e);if(t.fraction===1)return;var s=Dt(e.r.currentOrigin,-1);if(s&P.NODROP){e.item&&e.item.giType===q.TEAM?Ps(e):Br(e);return}oi(e,t)}function oi(e,t){var n=Tt.previousTime+(Tt.time-Tt.previousTime)*t.fraction,r=vec3.create();a.EvaluateTrajectoryDelta(e.s.pos,n,r);var i=vec3.dot(r,t.plane.normal);vec3.add(vec3.scale(t.plane.normal,-2*i,e.s.pos.trDelta),r),vec3.scale(e.s.pos.trDelta,e.physicsBounce,e.s.pos.trDelta);if(t.plane.normal[2]>0&&e.s.pos.trDelta[2]<40){t.endPos[2]+=1,Qr(e,t.endPos),e.s.groundEntityNum=t.entityNum;return}vec3.add(e.r.currentOrigin,t.plane.normal),vec3.set(e.r.currentOrigin,e.s.pos.trBase),e.s.pos.trTime=Tt.time}function ui(e){var t=a.ItemList.indexOf(e.item),i=new r.TraceResults;vec3.set([-it,-it,-it],e.r.mins),vec3.set([it,it,it],e.r.maxs),e.s.eType=K.ITEM,e.s.modelIndex=t,e.s.modelIndex2=0,e.r.contents=P.TRIGGER,e.touch=fi;if(e.spawnflags&1)Qr(e,e.s.origin);else{var s=vec3.createFrom(e.s.origin[0],e.s.origin[1],e.s.origin[2]-4096);_t(i,e.s.origin,s,e.r.mins,e.r.maxs,e.s.number,R.SOLID);if(i.startSolid){Nt("FinishSpawningItem:",e.classname,"startsolid at",e.s.origin[0],e.s.origin[1],e.s.origin[2]),Br(e);return}e.s.groundEntityNum=i.entityNum,Qr(e,i.endPos)}if(e.flags&ht.TEAMSLAVE||e.targetName){e.s.eFlags|=Q.NODRAW,e.r.contents=0;return}if(e.item.giType===q.POWERUP){var o=45+n.crandom()*15;e.s.eFlags|=Q.NODRAW,e.r.contents=0,e.nextthink=Tt.time+o*1e3,e.think=ai;return}u.LinkEntity(e)}function ai(e){if(e.team){e.teammaster||Ct("RespawnItem: bad teammaster");var t,r,i=e.teammaster;for(t=0,e=i;e;e=e.teamchain,t++);r=n.irrandom(0,t-1);for(t=0,e=i;t<r;e=e.teamchain,t++);}e.r.contents=P.TRIGGER,e.s.eFlags&=~Q.NODRAW,e.r.svFlags&=~pt.NOCLIENT,u.LinkEntity(e);if(e.item.giType===q.POWERUP){var s;e.speed?s=Xr(e.s.pos.trBase,G.GENERAL_SOUND):s=Xr(e.s.pos.trBase,G.GLOBAL_SOUND),s.r.svFlags|=pt.BROADCAST}if(e.item.giType===q.HOLDABLE){var s;e.speed?s=Xr(e.s.pos.trBase,G.GENERAL_SOUND):s=Xr(e.s.pos.trBase,G.GLOBAL_SOUND),s.r.svFlags|=pt.BROADCAST}ni(e,G.ITEM_RESPAWN,0),e.nextthink=0}function fi(e,t){if(!t.client)return;if(t.health<1)return;if(!a.CanItemBeGrabbed(pr.getAsInt(),e.s,t.client.ps))return;var n=!0,r;switch(e.item.giType){case q.WEAPON:r=ci(e,t);break;case q.AMMO:r=hi(e,t);break;case q.ARMOR:r=di(e,t);break;case q.HEALTH:r=vi(e,t);break;case q.POWERUP:r=mi(e,t),n=!1;break;case q.TEAM:r=Ts(e,t);break;case q.HOLDABLE:r=gi(e,t);break;default:return}if(!r)return;n?ri(t,G.ITEM_PICKUP,e.s.modelIndex):ni(t,G.ITEM_PICKUP,e.s.modelIndex);if(e.item.giType===q.POWERUP||e.item.giType===q.TEAM){var i;e.speed?(i=Xr(e.s.pos.trBase,G.GLOBAL_ITEM_PICKUP),i.s.eventParm=e.s.modelIndex,i.r.svFlags|=pt.r.singleClient,i.r.singleClient=t.s.number):(i=Xr(e.s.pos.trBase,G.GLOBAL_ITEM_PICKUP),i.s.eventParm=e.s.modelIndex,i.r.svFlags|=pt.BROADCAST)}Kr(e,t);if(e.wait===-1){e.r.svFlags|=pt.NOCLIENT,e.s.eFlags|=Q.NODRAW,e.r.contents=0,e.unlinkAfterEvent=!0;return}e.wait&&(r=e.wait),e.random&&(r+=Math.random()*e.random,r<1&&(r=1)),e.flags&ht.DROPPED_ITEM&&(e.freeAfterEvent=!0),e.r.svFlags|=pt.NOCLIENT,e.s.eFlags|=Q.NODRAW,e.r.contents=0,r<=0?(e.nextthink=0,e.think=0):(e.nextthink=Tt.time+r*1e3,e.think=ai),u.LinkEntity(e)}function ci(e,t){var n;return e.count<0?n=0:(e.count?n=e.count:n=e.item.quantity,!(e.flags&ht.DROPPED_ITEM)&&pr.getAsInt()!==F.TEAM&&(t.client.ps.ammo[e.item.giTag]<n?n-=t.client.ps.ammo[e.item.giTag]:n=1)),t.client.ps.stats[U.WEAPONS]|=1<<e.item.giTag,pi(t,e.item.giTag,n),pr.getAsInt()===F.TEAM?Ar.getAsInt():Lr.getAsInt()}function hi(e,t){var n;return e.count?n=e.count:n=e.item.quantity,pi(t,e.item.giTag,n),li.AMMO}function pi(e,t,n){e.client.ps.ammo[t]+=n,e.client.ps.ammo[t]>200&&(e.client.ps.ammo[t]=200)}function di(e,t){return t.client.ps.stats[U.ARMOR]+=e.item.quantity,t.client.ps.stats[U.ARMOR]>t.client.ps.stats[U.MAX_HEALTH]*2&&(t.client.ps.stats[U.ARMOR]=t.client.ps.stats[U.MAX_HEALTH]*2),li.ARMOR}function vi(e,t){var n,r;return e.item.quantity!=5&&e.item.quantity!=100?n=t.client.ps.stats[U.MAX_HEALTH]:n=t.client.ps.stats[U.MAX_HEALTH]*2,e.count?r=e.count:r=e.item.quantity,t.health+=r,t.health>n&&(t.health=n),t.client.ps.stats[U.HEALTH]=t.health,e.item.quantity==100?li.MEGAHEALTH:li.HEALTH}function mi(e,t){var i=new r.TraceResults;t.client.ps.powerups[e.item.giTag]||(t.client.ps.powerups[e.item.giTag]=Tt.time-Tt.time%1e3);var s;e.count?s=e.count:s=e.item.quantity,t.client.ps.powerups[e.item.giTag]+=s*1e3;for(var o=0;o<f;o++){var u=Tt.clients[o];if(u===t.client)continue;if(u.pers.connected===vt.DISCONNECTED)continue;if(u.ps.pm_type===B.DEAD)continue;if(pr.getAsInt()>=F.TEAM&&t.client.sess.sessionTeam===u.sess.sessionTeam)continue;var a=vec3.subtract(e.s.pos.trBase,u.ps.origin,vec3.create()),l=vec3.normalize(a);if(l>192)continue;var c=vec3.create();n.AnglesToVectors(u.ps.viewangles,c,null,null);if(vec3.dot(a,c)<.4)continue;_t(i,u.ps.origin,e.s.pos.trBase,null,null,v,P.SOLID);if(i.fraction!==1)continue;u.ps.persistant[$.PLAYEREVENTS]^=J.DENIEDREWARD}return li.POWERUP}function gi(e,t){return li.HOLDABLE}function yi(e,t,r){var i=vec3.create(),s=vec3.create();vec3.set(e.s.apos.trBase,s),s[n.YAW]+=r,s[n.PITCH]=0,n.AnglesToVectors(s,i,null,null),vec3.scale(i,150,i),i[2]+=200+n.crandom()*50;var o=Hr();return o.s.eType=K.ITEM,o.s.modelIndex=a.ItemList.indexOf(t),o.s.modelIndex2=1,o.classname=t.classname,o.item=t,vec3.set([-it,-it,-it],o.r.mins),vec3.set([it,it,it],o.r.maxs),o.r.contents=P.TRIGGER,o.touch=fi,Qr(o,e.s.pos.trBase),o.s.pos.trType=_.GRAVITY,o.s.pos.trTime=Tt.time,vec3.set(i,o.s.pos.trDelta),o.s.eFlags|=Q.BOUNCE_HALF,pr.getAsInt()!=F.CTF&&pr.getAsInt()!=F.NFCTF||t.giType!=q.TEAM?(o.think=Br,o.nextthink=Tt.time+3e4):(o.think=Hs,o.nextthink=Tt.time+3e4,xs(o)),o.flags=ht.DROPPED_ITEM,u.LinkEntity(o),o}function bi(e,t,n){ai(e)}function Ei(e){var t=new r.TraceResults,n=vec3.create();a.EvaluateTrajectory(e.s.pos,Tt.time,n),_t(t,e.r.currentOrigin,n,e.r.mins,e.r.maxs,e.r.ownerNum,e.clipmask),t.startSolid||t.allSolid?(_t(t,e.r.currentOrigin,e.r.currentOrigin,e.r.mins,e.r.maxs,e.r.ownerNum,e.clipmask),t.fraction=0):vec3.set(t.endPos,e.r.currentOrigin),u.LinkEntity(e);if(t.fraction!==1){if(t.surfaceFlags&D.NOIMPACT){Br(e);return}Si(e,t);if(e.s.eType!==K.MISSILE)return}$r(e)}function Si(e,t){var r=Tt.gentities[t.entityNum],i=!1;if(!r.takeDamage&&e.s.eFlags&(Q.BOUNCE|Q.BOUNCE_HALF)){xi(e,t),ni(e,G.GRENADE_BOUNCE,0);return}if(r.takeDamage&&e.damage){var s=vec3.create();ar(r,Tt.gentities[e.r.ownerNum])&&(Tt.gentities[e.r.ownerNum].client.accuracy_hits++,i=!0),a.EvaluateTrajectoryDelta(e.s.pos,Tt.time,s),vec3.length(s)===0&&(s[2]=1),er(r,e,Tt.gentities[e.r.ownerNum],s,e.s.origin,e.damage,0,e.methodOfDeath)}r.takeDamage&&r.client?(ni(e,G.MISSILE_HIT,n.DirToByte(t.plane.normal)),e.s.otherEntityNum=r.s.number):t.surfaceFlags&D.METALSTEPS?ni(e,G.MISSILE_MISS_METAL,n.DirToByte(t.plane.normal)):ni(e,G.MISSILE_MISS,n.DirToByte(t.plane.normal)),e.freeAfterEvent=!0,e.s.eType=K.GENERAL,Qr(e,t.endPos),e.splashDamage&&tr(t.endPos,e,e.parent,e.splashDamage,e.splashRadius,r,e.splashMethodOfDeath)&&(i||Tt.gentities[e.r.ownerNum].client.accuracy_hits++),u.LinkEntity(e)}function xi(e,t){var n=vec3.create(),r,i;i=Tt.previousTime+(Tt.time-Tt.previousTime)*t.fraction,a.EvaluateTrajectoryDelta(e.s.pos,i,n),r=vec3.dot(n,t.plane.normal),vec3.add(n,vec3.scale(t.plane.normal,-2*r,vec3.create()),e.s.pos.trDelta);if(e.s.eFlags&Q.BOUNCE_HALF){vec3.scale(e.s.pos.trDelta,.65,e.s.pos.trDelta);if(t.plane.normal[2]>.2&&vec3.length(e.s.pos.trDelta)<40){Qr(e,t.endPos),e.s.time=Tt.time/4;return}}vec3.add(e.r.currentOrigin,t.plane.normal,e.r.currentOrigin),vec3.set(e.r.currentOrigin,e.s.pos.trBase),e.s.pos.trTime=Tt.time}function Ti(e){var t=vec3.create(),r=vec3.createFrom(0,0,1);a.EvaluateTrajectory(e.s.pos,Tt.time,t),Qr(e,t),e.s.eType=K.GENERAL,e.freeAfterEvent=!0,ni(e,G.MISSILE_MISS,n.DirToByte(r)),e.splashDamage&&tr(e.r.currentOrigin,e,e.parent,e.splashDamage,e.splashRadius,e,e.splashMethodOfDeath)&&Tt.gentities[e.r.ownerNum].client.accuracy_hits++,u.LinkEntity(e)}function Ni(e,t,n){var r=Hr();return r.classname="rocket",r.nextthink=Tt.time+15e3,r.think=Ti,r.s.eType=K.MISSILE,r.r.svFlags=pt.USE_CURRENT_ORIGIN,r.s.weapon=z.ROCKET_LAUNCHER,r.r.ownerNum=e.s.number,r.parent=e,r.damage=100,r.splashDamage=100,r.splashRadius=120,r.methodOfDeath=et.ROCKET,r.splashMethodOfDeath=et.ROCKET_SPLASH,r.clipmask=R.SHOT,r.s.pos.trType=_.LINEAR,r.s.pos.trTime=Tt.time-wi,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,900,r.s.pos.trDelta),vec3.set(t,r.r.currentOrigin),r}function Ci(e,t,n){var r=Hr();return r.classname="grenade",r.nextthink=Tt.time+2500,r.think=Ti,r.s.eType=K.MISSILE,r.r.svFlags=pt.USE_CURRENT_ORIGIN,r.s.weapon=z.GRENADE_LAUNCHER,r.s.eFlags=Q.BOUNCE_HALF,r.r.ownerNum=e.s.number,r.parent=e,r.damage=100,r.splashDamage=100,r.splashRadius=150,r.methodOfDeath=et.GRENADE,r.splashMethodOfDeath=et.GRENADE_SPLASH,r.clipmask=R.SHOT,r.s.pos.trType=_.GRAVITY,r.s.pos.trTime=Tt.time-wi,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,700,r.s.pos.trDelta),vec3.set(t,r.r.currentOrigin),r}function ki(e,t,n){var r=Hr();return r.classname="plasma",r.nextthink=Tt.time+1e4,r.think=Ti,r.s.eType=K.MISSILE,r.r.svFlags=pt.USE_CURRENT_ORIGIN,r.s.weapon=z.PLASMAGUN,r.r.ownerNum=e.s.number,r.parent=e,r.damage=20,r.splashDamage=15,r.splashRadius=20,r.methodOfDeath=et.PLASMA,r.splashMethodOfDeath=et.PLASMA_SPLASH,r.clipmask=R.SHOT,r.s.pos.trType=_.LINEAR,r.s.pos.trTime=Tt.time-wi,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,2e3,r.s.pos.trDelta),vec3.set(t,r.r.currentOrigin),r}function Li(e,t,n){var r=Hr();return r.classname="bfg",r.nextthink=Tt.time+1e4,r.think=Ti,r.s.eType=K.MISSILE,r.r.svFlags=pt.USE_CURRENT_ORIGIN,r.s.weapon=z.BFG,r.r.ownerNum=e.s.number,r.parent=e,r.damage=100,r.splashDamage=100,r.splashRadius=120,r.methodOfDeath=et.BFG,r.splashMethodOfDeath=et.BFG_SPLASH,r.clipmask=R.SHOT,r.s.pos.trType=_.LINEAR,r.s.pos.trTime=Tt.time-wi,vec3.set(t,r.s.pos.trBase),vec3.normalize(n),vec3.scale(n,2e3,r.s.pos.trDelta),vec3.set(t,r.r.currentOrigin),r}function Ai(e){e.use=Bi,e.reached=ji,e.moverState=dt.POS1,e.r.svFlags=pt.USE_CURRENT_ORIGIN,e.s.eType=K.MOVER,vec3.set(e.pos1,e.r.currentOrigin),u.LinkEntity(e),e.s.pos.trType=_.STATIONARY,vec3.set(e.pos1,e.s.pos.trBase);var t=vec3.subtract(e.pos2,e.pos1,vec3.create()),n=vec3.length(t);e.speed||(e.speed=100),vec3.scale(t,e.speed,e.s.pos.trDelta),e.s.pos.trDuration=n*1e3/e.speed,e.s.pos.trDuration<=0&&(e.s.pos.trDuration=1)}function Oi(e){if(e.flags&ht.TEAMSLAVE)return;(e.s.pos.trType!==_.STATIONARY||e.s.apos.trType!==_.STATIONARY)&&Mi(e),$r(e)}function Mi(e){var t,n,r=vec3.create(),i=vec3.create(),s=vec3.create(),o=vec3.create();for(t=e;t;t=t.teamchain){a.EvaluateTrajectory(t.s.pos,Tt.time,s),a.EvaluateTrajectory(t.s.apos,Tt.time,o),vec3.subtract(s,t.r.currentOrigin,r),vec3.subtract(o,t.r.currentAngles,i),n=_i(t,r,i);if(n)break}if(t){for(t=e;t;t=t.teamchain)t.s.pos.trTime+=Tt.time-Tt.previousTime,t.s.apos.trTime+=Tt.time-Tt.previousTime,a.EvaluateTrajectory(t.s.pos,Tt.time,t.r.currentOrigin),a.EvaluateTrajectory(t.s.apos,Tt.time,t.r.currentAngles),u.LinkEntity(t);e.blocked&&e.blocked(e,n);return}for(t=e;t;t=t.teamchain)t.s.pos.trType===_.LINEAR_STOP&&Tt.time>=t.s.pos.trTime+t.s.pos.trDuration&&t.reached&&t.reached(t)}function _i(e,t,r){var i=vec3.create(),s=vec3.create(),o=vec3.create(),a=vec3.create();if(e.r.currentAngles[0]||e.r.currentAngles[1]||e.r.currentAngles[2]||r[0]||r[1]||r[2]){var f=n.RadiusFromBounds(e.r.mins,e.r.maxs);for(var l=0;l<3;l++)i[l]=e.r.currentOrigin[l]+t[l]-f,s[l]=e.r.currentOrigin[l]+t[l]+f,o[l]=i[l]-t[l],a[l]=s[l]-t[l]}else{for(var l=0;l<3;l++)i[l]=e.r.absmin[l]+t[l],s[l]=e.r.absmax[l]+t[l];vec3.set(e.r.absmin,o),vec3.set(e.r.absmax,a);for(l=0;l<3;l++)t[l]>0?a[l]+=t[l]:o[l]+=t[l]}u.UnlinkEntity(e);var c=Mt(o,a);vec3.add(e.r.currentOrigin,t),vec3.add(e.r.currentAngles,r),u.LinkEntity(e);for(var l=0;l<c.length;l++){var h=Tt.gentities[c[l]];if(h.s.eType!==K.ITEM&&h.s.eType!==K.PLAYER&&!h.physicsObject)continue;if(h.s.groundEntityNum!==e.s.number){if(h.r.absmin[0]>=s[0]||h.r.absmin[1]>=s[1]||h.r.absmin[2]>=s[2]||h.r.absmax[0]<=i[0]||h.r.absmax[1]<=i[1]||h.r.absmax[2]<=i[2])continue;if(!Di(h))continue}if(Pi(h,e,t,r))continue;if(e.s.pos.trType===_.SINE||e.s.apos.trType===_.SINE){er(h,e,e,null,null,99999,0,et.CRUSH);continue}var p=h;return p}return null}function Di(e){var t;e.clipmask?t=e.clipmask:t=R.SOLID;var n=new r.TraceResults;return e.client?_t(n,e.client.ps.origin,e.client.ps.origin,e.r.mins,e.r.maxs,e.s.number,t):_t(n,e.s.pos.trBase,e.s.pos.trBase,e.r.mins,e.r.maxs,e.s.number,t),n.startSolid?Tt.gentities[n.entityNum]:null}function Pi(e,t,n,r){return t.s.eFlags&Q.MOVER_STOP&&e.s.groundEntityNum!==t.s.number?!1:!1}function Hi(e,t,n){var r=vec3.create(),i;e.moverState=t,e.s.pos.trTime=n;switch(t){case dt.POS1:vec3.set(e.pos1,e.s.pos.trBase),e.s.pos.trType=_.STATIONARY;break;case dt.POS2:vec3.set(e.pos2,e.s.pos.trBase),e.s.pos.trType=_.STATIONARY;break;case dt.ONETOTWO:vec3.set(e.pos1,e.s.pos.trBase),vec3.subtract(e.pos2,e.pos1,r),i=1e3/e.s.pos.trDuration,vec3.scale(r,i,e.s.pos.trDelta),e.s.pos.trType=_.LINEAR_STOP;break;case dt.TWOTOONE:vec3.set(e.pos2,e.s.pos.trBase),vec3.subtract(e.pos1,e.pos2,r),i=1e3/e.s.pos.trDuration,vec3.scale(r,i,e.s.pos.trDelta),e.s.pos.trType=_.LINEAR_STOP}a.EvaluateTrajectory(e.s.pos,Tt.time,e.r.currentOrigin),u.LinkEntity(e)}function Bi(e,t,n){var r,i;if(e.flags&ht.TEAMSLAVE){Bi(e.teammaster,t,n);return}e.activator=n;if(e.moverState===dt.POS1){Fi(e,dt.ONETOTWO,Tt.time+50),e.sound1to2&&ni(e,G.GENERAL_SOUND,e.sound1to2),e.s.loopSound=e.soundLoop,(e.teammaster===e||!e.teammaster)&&u.AdjustAreaPortalState(e,!0);return}if(e.moverState===dt.POS2){e.nextthink=Tt.time+e.wait;return}if(e.moverState===dt.TWOTOONE){r=e.s.pos.trDuration,i=Tt.time-e.s.pos.trTime,i>r&&(i=r),Fi(e,dt.ONETOTWO,Tt.time-(r-i)),e.sound1to2&&ni(e,G.GENERAL_SOUND,e.sound1to2);return}if(e.moverState===dt.ONETOTWO){r=e.s.pos.trDuration,i=Tt.time-e.s.pos.trTime,i>r&&(i=r),Fi(e,dt.TWOTOONE,Tt.time-(r-i)),e.sound2to1&&ni(e,G.GENERAL_SOUND,e.sound2to1);return}}function ji(e){e.s.loopSound=e.soundLoop,e.moverState===dt.ONETOTWO?(Hi(e,dt.POS2,Tt.time),e.soundPos2&&ni(e,G.GENERAL_SOUND,e.soundPos2),e.think=Ii,e.nextthink=Tt.time+e.wait,e.activator||(e.activator=e),Kr(e,e.activator)):e.moverState===dt.TWOTOONE?(Hi(e,dt.POS1,Tt.time),e.soundPos1&&ni(e,G.GENERAL_SOUND,e.soundPos1),(e.teammaster===e||!e.teammaster)&&u.AdjustAreaPortalState(e,!1)):Ct("ReachedBinaryMover: bad moverState")}function Fi(e,t,n){for(var r=e;r;r=r.teamchain)Hi(r,t,n)}function Ii(e){Fi(e,dt.TWOTOONE,Tt.time),e.s.loopSound=e.soundLoop,e.sound2to1&&ni(e,G.GENERAL_SOUND,e.sound2to1)}function qi(){var e=i.AddCvar("session"),t=e.getAsInt();pr.getAsInt()!==t&&(Tt.newSession=!0,Nt("Gametype changed, clearing session data."))}function Ri(){var e=i.AddCvar("session");e.setValue("session",pr.getAsInt());for(var t=0;t<f;t++)Tt.clients[t].pers.connected===vt.CONNECTED&&Wi(Tt.clients[t])}function Ui(e,t){var n=e.sess,r=t.team;if(r==="s")n.sessionTeam=X.SPECTATOR;else{n.sessionTeam=vs(e.ps.clientNum);if(n.sessionTeam===X.SPECTATOR){var i=Tt.gentities[e.ps.clientNum];Kt(i)}}Wi(e)}function zi(e){var t="session"+e.ps.clientNum,n=i.GetCvar(t);if(!n)return;var r=JSON.parse(n.getAsString());e.sess.sessionTeam=r.sessionTeam,e.sess.spectatorNum=r.spectatorNum,e.sess.spectatorState=r.spectatorState,e.sess.spectatorClient=r.spectatorClient,e.sess.wins=r.wins,e.sess.losses=r.losses}function Wi(e){var t="session"+e.ps.clientNum,n=JSON.stringify(e.sess),r=i.AddCvar(t);r.setValue(n)}function hs(e){return e===X.RED?"RED":e===X.BLUE?"BLUE":e===X.SPECTATOR?"SPECTATOR":"FREE"}function ps(e){return e===X.RED?X.BLUE:e===X.BLUE?X.RED:e}function ds(e,t){return!e.client||!t.client?!1:pr.getAsInt()<F.TEAM?!1:e.client.sess.sessionTeam===t.client.sess.sessionTeam?!0:!1}function vs(e){var t=X.FREE;if(pr.getAsInt()>=F.TEAM){var n=new Array(X.NUM_TEAMS);n[X.RED]=ms(X.RED,e),n[X.BLUE]=ms(X.BLUE,e),n[X.RED]>n[X.BLUE]?t=X.BLUE:n[X.BLUE]>n[X.RED]?t=X.RED:Tt.arena.teamScores[X.RED]>Tt.arena.teamScores[X.BLUE]?t=X.BLUE:t=X.RED}return pr.getAsInt()===F.TOURNAMENT&&Tt.arena.numNonSpectatorClients>=2&&(t=X.SPECTATOR),t}function ms(e,t){var n=0;for(var r=0;r<Tt.maxclients;r++){if(r===t)continue;var i=Tt.gentities[r];if(!i.inuse)continue;if(i.s.arenaNum!==Tt.arena.arenaNum)continue;i.client.sess.sessionTeam===e&&n++}return n}function gs(e){var t=0;for(var n=0;n<Tt.maxclients;n++){var r=Tt.gentities[n];if(!r.inuse)continue;if(r.s.arenaNum!==Tt.arena.arenaNum)continue;if(r.client.sess.sessionTeam!==e)continue;r.client.pers.teamState.state!==mt.QUEUED&&t++}return t}function ys(){bs();if(pr.getAsInt()===F.CTF){var e=FindItemForPowerup(W.REDFLAG);e||Ct("No team_CTF_redflag in map"),e=FindItemForPowerup(W.BLUEFLAG),e||Ct("No team_CTF_blueflag in map")}}function bs(){cs.reset();switch(pr.getAsInt()){case F.CTF:cs.redStatus=-1,cs.blueStatus=-1,Ss(X.RED,H.ATBASE),Ss(X.BLUE,H.ATBASE);break;default:}}function Ss(e,t){var n=!1;switch(e){case X.RED:cs.redStatus!=t&&(cs.redStatus=t,n=!0);break;case X.BLUE:cs.blueStatus!=t&&(cs.blueStatus=t,n=!0);break;case X.FREE:cs.flagStatus!=t&&(cs.flagStatus=t,n=!0)}if(n){var r=new Array(4);pr.getAsInt()==F.CTF?(r[0]=ws[cs.redStatus],r[1]=ws[cs.blueStatus],r[2]=0):(r[0]=Es[cs.flagStatus],r[1]=0),u.SetConfigstring("flagstatus",r)}}function xs(e){e.item.giTag===W.REDFLAG?Ss(X.RED,H.DROPPED):e.item.giTag===W.BLUEFLAG?Ss(X.BLUE,H.DROPPED):e.item.giTag==W.NEUTRALFLAG&&Ss(X.FREE,H.DROPPED)}function Ts(e,t){var n=t.client,r;if(e.classname==="team_CTF_redflag")r=X.RED;else{if(e.classname!=="team_CTF_blueflag")return u.SendServerCommand(t.s.number,"print","Don't know what team the flag is on."),0;r=X.BLUE}return r===n.sess.sessionTeam?Ns(e,t,r):Cs(e,t,r)}function Ns(e,t,n){var r=t.client,i;r.sess.sessionTeam==X.RED?i=W.BLUEFLAG:i=W.REDFLAG;if(e.flags&ht.DROPPED_ITEM)return u.SendServerCommand(null,"print",r.pers.netname+" returned the "+hs(n)+" flag!"),lr(t,e.r.currentOrigin,$i),t.client.pers.teamState.flagrecovery++,t.client.pers.teamState.lastreturnedflag=Tt.time,Os(As(n),n),0;if(!r.ps.powerups[i])return 0;u.SendServerCommand(null,"print",r.pers.netname+" captured the "+hs(ps(n))+" flag!"),r.ps.powerups[i]=0,cs.last_flag_capture=Tt.time,cs.last_capture_team=n,Bs(t.client.sess.sessionTeam,e.s.pos.trBase,1),ks(t.client.sess.sessionTeam),t.client.pers.teamState.captures++,t.client.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP),t.client.ps.eFlags|=Q.AWARD_CAP,t.client.rewardTime=Tt.time+ot,t.client.ps.persistant[$.CAPTURES]++,lr(t,e.r.currentOrigin,Xi),_s(e,n);for(var s=0;s<Tt.maxclients;s++){var o=Tt.gentities[s];if(!o.inuse||o==t)continue;o.client.sess.sessionTeam!=r.sess.sessionTeam?o.client.pers.teamState.lasthurtcarrier=-5:o.client.sess.sessionTeam==r.sess.sessionTeam&&(o.client.pers.teamState.lastreturnedflag+os>Tt.time&&(lr(o,e.r.currentOrigin,es),t.client.pers.teamState.assists++,o.client.ps.persistant[$.ASSIST_COUNT]++,o.client.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP),o.client.ps.eFlags|=Q.AWARD_ASSIST,o.client.rewardTime=Tt.time+ot),o.client.pers.teamState.lastfraggedcarrier+ss>Tt.time&&(lr(o,e.r.currentOrigin,ts),t.client.pers.teamState.assists++,o.client.ps.persistant[$.ASSIST_COUNT]++,o.client.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP),o.client.ps.eFlags|=Q.AWARD_ASSIST,o.client.rewardTime=Tt.time+ot))}return Ls(),nn(),0}function Cs(e,t,n){var r=t.client;return u.SendServerCommand(null,"print",t.client.pers.netname+" got the "+hs(n)+" flag!"),n==X.RED?r.ps.powerups[W.REDFLAG]=536870911:r.ps.powerups[W.BLUEFLAG]=536870911,Ss(n,H.TAKEN),r.pers.teamState.flagsince=Tt.time,Ms(e,n),-1}function ks(e){for(var t=0;t<f;t++){var n=Tt.gentities[t];if(!n.inuse)continue;if(!n.client)continue;if(n.client.sess.sessionTeam!=e)continue;n.flags|=ht.FORCE_GESTURE}}function Ls(){pr.getAsInt()==F.CTF?(As(X.RED),As(X.BLUE)):pr.getAsInt()==F.NFCTF&&As(X.FREE)}function As(e){var t,n,r;switch(e){case X.RED:t="team_CTF_redflag";break;case X.BLUE:t="team_CTF_blueflag";break;case X.FREE:t="team_CTF_neutralflag";break;default:return null}n=Vr({classname:t});for(var i=0;i<n.length;i++)n[i].flags&ht.DROPPED_ITEM?Br(n[i]):(r=n[i],ai(n[i]));return Ss(e,H.ATBASE),r}function Os(e,t){if(!e)return;var n=Xr(e.s.pos.trBase,G.GLOBAL_TEAM_SOUND);t==X.BLUE?n.s.eventParm=Y.RED_RETURN:n.s.eventParm=Y.BLUE_RETURN,n.r.svFlags|=pt.BROADCAST}function Ms(e,t){if(!e)return;switch(t){case X.RED:if(cs.blueStatus!=H.ATBASE&&cs.blueTakenTime>Tt.time-1e4)return;cs.blueTakenTime=Tt.time;break;case X.BLUE:if(cs.redStatus!=H.ATBASE&&cs.redTakenTime>Tt.time-1e4)return;cs.redTakenTime=Tt.time}var n=Xr(e.s.pos.trBase,G.GLOBAL_TEAM_SOUND);t==X.BLUE?n.s.eventParm=Y.RED_TAKEN:n.s.eventParm=Y.BLUE_TAKEN,n.r.svFlags|=pt.BROADCAST}function _s(e,t){if(!e)return;var n=Xr(e.s.pos.trBase,G.GLOBAL_TEAM_SOUND);t===X.BLUE?n.s.eventParm=Y.BLUE_CAPTURE:n.s.eventParm=Y.RED_CAPTURE,n.r.svFlags|=pt.BROADCAST}function Ds(e){Os(As(e),e),e===X.FREE?u.SendServerCommand(null,"print","The flag has returned!"):u.SendServerCommand(null,"print","The "+hs(e)+" flag has returned!")}function Ps(e){e.item.giTag===W.REDFLAG?Ds(X.RED):e.item.giTag===W.BLUEFLAG?Ds(X.BLUE):e.item.giTag===W.NEUTRALFLAG&&Ds(X.FREE)}function Hs(e){var t=X.FREE;e.item.giTag===W.REDFLAG?t=X.RED:e.item.giTag===W.BLUEFLAG?t=X.BLUE:e.item.giTag===W.NEUTRALFLAG&&(t=X.FREE),Os(As(t),t)}function Bs(e,t,n){var r=Xr(t,G.GLOBAL_TEAM_SOUND);r.r.svFlags|=pt.BROADCAST,e===X.RED?Tt.teamScores[X.RED]+n===Tt.teamScores[X.BLUE]?r.s.eventParm=Y.TEAMS_ARE_TIED:Tt.teamScores[X.RED]<=Tt.teamScores[X.BLUE]&&Tt.teamScores[X.RED]+n>Tt.teamScores[X.BLUE]?r.s.eventParm=Y.REDTEAM_TOOK_LEAD:r.s.eventParm=Y.REDTEAM_SCORED:Tt.teamScores[X.BLUE]+n===Tt.teamScores[X.RED]?r.s.eventParm=Y.TEAMS_ARE_TIED:Tt.teamScores[X.BLUE]<=Tt.teamScores[X.RED]&&Tt.teamScores[X.BLUE]+n>Tt.teamScores[X.RED]?r.s.eventParm=Y.BLUETEAM_TOOK_LEAD:r.s.eventParm=Y.BLUETEAM_SCORED,Tt.teamScores[e]+=n}function js(e,t,r,i){var s;t==mt.BEGIN?e==X.RED?s="team_CTF_redplayer":e==X.BLUE&&(s="team_CTF_blueplayer"):e==X.RED?s="team_CTF_redspawn":e==X.BLUE&&(s="team_CTF_bluespawn");if(!s)return Mn(n.vec3origin,r,i);var o=Vr({classname:s}),u=[],a;for(var f=0;f<o.length;f++){a=o[f];if(_n(a))continue;if(a.arena!==d&&a.arena!==Tt.arena.arenaNum)continue;u.push(a)}if(!u.length){a=o[0];if(!a)return Mn(n.vec3origin,r,i)}else{var l=n.irrandom(0,u.length-1);a=u[l]}return vec3.set(a.s.origin,r),r[2]+=9,vec3.set(a.s.angles,i),a}function Fs(e){vec3.equal(e.s.angles,n.vec3origin)||ti(e.s.angles,e.movedir),u.SetBrushModel(e,e.model),e.r.contents=P.TRIGGER,e.r.svFlags=pt.NOCLIENT}function Is(e){var t=vec3.add(e.r.absmin,e.r.absmax,vec3.create());vec3.scale(t,.5);var n=Jr(e.target);if(!n){Br(e);return}var r=n.s.origin[2]-t[2],i=Nr.getAsInt(),s=Math.sqrt(r/(.5*i));if(!s){Br(e);return}vec3.subtract(n.s.origin,t,e.s.origin2),e.s.origin2[2]=0;var o=vec3.length(e.s.origin2);vec3.normalize(e.s.origin2);var u=o/s;vec3.scale(e.s.origin2,u),e.s.origin2[2]=s*i}function zs(e){var t=e.client;e.s.weapon!==z.GRAPPLING_HOOK&&e.s.weapon!==z.GAUNTLET&&t.accuracy_shots++;switch(e.s.weapon){case z.GAUNTLET:break;case z.LIGHTNING:eo(e);break;case z.SHOTGUN:Ks(e);break;case z.MACHINEGUN:pr.getAsInt()!==F.TEAM?$s(e,qs,Rs,et.MACHINEGUN):$s(e,qs,Us,et.MACHINEGUN);break;case z.GRENADE_LAUNCHER:Ys(e);break;case z.ROCKET_LAUNCHER:Zs(e);break;case z.PLASMAGUN:to(e);break;case z.RAILGUN:ro(e);break;case z.BFG:io(e);break;case z.GRAPPLING_HOOK:break;default:}}function Ws(e,t,n){vec3.set(e.s.pos.trBase,n),n[2]+=e.client.ps.viewheight,vec3.add(n,vec3.scale(t,14,vec3.create()))}function Xs(e){var t=e.client;return t.ps.powerups[W.QUAD]?kr.getAsInt():1}function Vs(e){if(e.client.noclip)return!1;var t=new r.TraceResults,i=vec3.create(),s=vec3.create(),o=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,s,null,null),Ws(e,s,i),vec3.add(vec3.scale(s,32,o),i),_t(t,i,o,null,null,e.s.number,R.SHOT);if(t.surfaceFlags&D.NOIMPACT)return!1;var u=Tt.gentities[t.entityNum];if(u.takeDamage&&u.client){var a=Xr(t.endPos,G.MISSILE_HIT);a.s.otherEntityNum=u.s.number,a.s.eventParm=n.DirToByte(t.plane.normal),a.s.weapon=e.s.weapon}if(!u.takeDamage)return!1;e.client.ps.powerups[W.QUAD]&&ni(e,G.POWERUP_QUAD,0);var f=50*Xs(e);return er(u,e,e,s,t.endPos,f,0,et.GAUNTLET),!0}function $s(e,t,i,s){var o=new r.TraceResults,u=vec3.create(),a=vec3.create(),f=vec3.create(),l=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,a,f,l),Ws(e,a,u),i*=Xs(e);var c=Math.random()*Math.PI*2,h=Math.sin(c)*n.crandom()*t*16;c=Math.cos(c)*n.crandom()*t*16;var p=vec3.add(u,vec3.scale(a,131072,vec3.create()),vec3.create());vec3.add(p,vec3.scale(f,c,vec3.create())),vec3.add(p,vec3.scale(l,h,vec3.create()));var d=e.s.number;for(var v=0;v<10;v++){_t(o,u,p,null,null,d,R.SHOT);if(o.surfaceFlags&D.NOIMPACT)return;var m=Tt.gentities[o.entityNum],g;m.takeDamage&&m.client?(g=Xr(o.endPos,G.BULLET_HIT_FLESH),g.s.eventParm=m.s.number,ar(m,e)&&e.client.accuracy_hits++):(g=Xr(o.endPos,G.BULLET_HIT_WALL),g.s.eventParm=n.DirToByte(o.plane.normal)),g.s.otherEntityNum=e.s.number,m.takeDamage&&er(m,e,e,a,o.endPos,i,0,s);break}}function Ks(e){var t=vec3.create(),r=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,r,null,null),Ws(e,r,t);var i=Xr(t,G.SHOTGUN);vec3.scale(r,4096,i.s.origin2),i.s.eventParm=n.irrandom(0,255),i.s.otherEntityNum=e.s.number,Qs(i.s.pos.trBase,i.s.origin2,i.s.eventParm,e)}function Qs(e,t,r,i){var s,o,u=vec3.create(),a=vec3.create(),f=vec3.create(),l=vec3.create(),c=!1;vec3.normalize(t,a),n.PerpendicularVector(a,f),vec3.cross(a,f,l);for(var h=0;h<S;h++)s=n.crandom()*E*16,o=n.crandom()*E*16,vec3.add(e,vec3.scale(a,131072,vec3.create()),u),vec3.add(u,vec3.scale(f,s,vec3.create())),vec3.add(u,vec3.scale(l,o,vec3.create())),Gs(e,u,i)&&!c&&(c=!0,i.client.accuracy_hits+=1)}function Gs(e,t,n){var i=new r.TraceResults,s=vec3.subtract(t,e,vec3.create());vec3.normalize(s);for(var o=0;o<10;o++){_t(i,e,t,null,null,n.s.number,R.SHOT);var u=Tt.gentities[i.entityNum];if(i.surfaceFlags&D.NOIMPACT)return!1;if(u.takeDamage){var a=Js*Xs(n);er(u,n,n,s,i.endPos,a,0,et.SHOTGUN);if(ar(u,n))return!0}return!1}return!1}function Ys(e){var t=vec3.create(),r=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,r,null,null),Ws(e,r,t),r[2]+=.2,vec3.normalize(r);var i=Ci(e,t,r);i.damage*=Xs(e),i.splashDamage*=Xs(e)}function Zs(e){var t=vec3.create(),r=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,r,null,null),Ws(e,r,t);var i=Ni(e,t,r);i.damage*=Xs(e),i.splashDamage*=Xs(e)}function eo(e){var t=new r.TraceResults,i=8*Xs(e),s=vec3.create(),o=vec3.create(),u=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,u,null,null),Ws(e,u,o);for(var a=0;a<10;a++){vec3.add(o,vec3.scale(u,x,vec3.create()),s),_t(t,o,s,null,null,e.s.number,R.SHOT);if(t.entityNum===v)return;var f=Tt.gentities[t.entityNum];f.takeDamage&&er(f,e,e,u,t.endPos,i,0,et.LIGHTNING);var l;f.takeDamage&&f.client?(l=Xr(t.endPos,G.MISSILE_HIT),l.s.otherEntityNum=f.s.number,l.s.eventParm=n.DirToByte(t.plane.normal),l.s.weapon=e.s.weapon,ar(f,e)&&e.client.accuracy_hits++):t.surfaceFlags&D.NOIMPACT||(l=Xr(t.endPos,G.MISSILE_MISS),l.s.eventParm=n.DirToByte(t.plane.normal),l.s.weapon=e.s.weapon);break}}function to(e){var t=vec3.create(),r=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,r,null,null),Ws(e,r,t);var i=ki(e,t,r);i.damage*=Xs(e),i.splashDamage*=Xs(e)}function ro(e){var t=100*Xs(e),i=e.s.number,s=[],o=vec3.create(),a=0,f=new r.TraceResults,l=vec3.create(),c=vec3.create(),h=vec3.create(),p=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,c,h,p),Ws(e,c,l),vec3.add(l,vec3.scale(c,8192,vec3.create()),o);while(s.length<no){_t(f,l,o,null,null,i,R.SHOT);if(f.entityNum>=g)break;var d=Tt.gentities[f.entityNum];d.takeDamage&&(ar(d,e)&&a++,er(d,e,e,c,f.endPos,t,0,et.RAILGUN));if(f.contents&P.SOLID)break;u.UnlinkEntity(d),s.push(d)}for(var v=0;v<s.length;v++)u.LinkEntity(s[v]);var m=Xr(f.endPos,G.RAILTRAIL);m.s.clientNum=e.s.clientNum,vec3.set(l,m.s.origin2),vec3.add(m.s.origin2,vec3.scale(h,4,vec3.create())),vec3.add(m.s.origin2,vec3.scale(p,-1,vec3.create())),f.surfaceFlags&D.NOIMPACT?m.s.eventParm=255:m.s.eventParm=n.DirToByte(f.plane.normal),m.s.clientNum=e.s.clientNum,a===0?e.client.accurateCount=0:(e.client.accurateCount+=a,e.client.accurateCount>=2&&(e.client.accurateCount-=2,e.client.ps.persistant[$.IMPRESSIVE_COUNT]++,e.client.ps.eFlags&=~(Q.AWARD_IMPRESSIVE|Q.AWARD_EXCELLENT|Q.AWARD_GAUNTLET|Q.AWARD_ASSIST|Q.AWARD_DEFEND|Q.AWARD_CAP),e.client.ps.eFlags|=Q.AWARD_IMPRESSIVE,e.client.rewardTime=Tt.time+ot),e.client.accuracy_hits++)}function io(e){var t=vec3.create(),r=vec3.create();n.AnglesToVectors(e.client.ps.viewangles,r,null,null),Ws(e,r,t);var i=Li(e,t,r);i.damage*=Xs(e),i.splashDamage*=Xs(e)}function so(e,t,n){if(!t.client)return;e.moverState===dt.POS1&&Bi(e,t,t)}function oo(e,t){if(!t.client){Xr(t.s.origin,G.ITEM_POP),Br(t);return}e.damage&&er(t,e,e,null,null,e.damage,0,et.CRUSH);if(e.spawnflags&4)return;Bi(e,e,t)}function uo(e){for(var t=e;t;t=t.teamchain)t.takeDamage=!0;var r=vec3.create(e.r.absmin),i=vec3.create(e.r.absmax);for(var t=e.teamchain;t;t=t.teamchain)n.AddPointToBounds(t.r.absmin,r,i),n.AddPointToBounds(t.r.absmax,r,i);var s=0;for(var o=1;o<3;o++)i[o]-r[o]<i[s]-r[s]&&(s=o);i[s]+=120,r[s]-=120;var t=Hr();t.classname="door_trigger",vec3.set(r,t.r.mins),vec3.set(i,t.r.maxs),t.parent=e,t.contents=P.TRIGGER,t.touch=fo,t.count=s,u.LinkEntity(t),Fi(e,e.moverState,Tt.time)}function ao(e){Fi(e,e.moverState,Tt.time)}function fo(e,t,n){t.client&&t.client.sess.spectatorState!==V.NOT?e.parent.moverState!==dt.ONETOTWO&&e.parent.moverState!==dt.POS2&&lo(e,t,n):e.parent.moverState!==dt.ONETOTWO&&Bi(e.parent,e,t)}function lo(e,t,n){var r=e.count,i=e.r.absmin[r]+100,s=e.r.absmax[r]-100,o=vec3.create(t.client.ps.origin);if(o[r]<i||o[r]>s)return;Math.abs(o[r]-s)<Math.abs(o[r]-i)?o[r]=i-10:o[r]=s+10,In(t,o,vec3.createFrom(1e7,0,0))}function vo(e){var t=Vr({targetName:e.target});if(!t.length){Nt("func_train at",e.r.absmin,"with an unfound target");return}e.nextTrain=t[0];var n;for(var r=e.nextTrain;r!==n;r=i){n||(n=r);if(!r.target){Nt("Train corner at",r.s.origin,"without a target");return}t=Vr({targetName:r.target});var i;for(var s=0;s<t.length;s++){i=t[s++];if(i.classname==="path_corner")break}r.nextTrain=i}mo(e)}function mo(e){var t=e.nextTrain;if(!t||!t.nextTrain)return;Kr(t,null),e.nextTrain=t.nextTrain,vec3.set(t.s.origin,e.pos1),vec3.set(t.nextTrain.s.origin,e.pos2);var n=t.speed?t.speed:e.speed;n<1&&(n=1);var r=vec3.subtract(e.pos2,e.pos1,vec3.create()),i=vec3.length(r);e.s.pos.trDuration=i*1e3/n,e.r.svFlags&=~pt.NOCLIENT,e.s.pos.trDuration<1&&(e.s.pos.trDuration=1,e.r.svFlags|=pt.NOCLIENT),e.s.loopSound=t.soundLoop,Hi(e,dt.ONETOTWO,Tt.time),t.wait&&(e.nextthink=Tt.time+t.wait*1e3,e.think=go,e.s.pos.trType=_.STATIONARY)}function go(e){e.s.pos.trTime=Tt.time,e.s.pos.trType=_.LINEAR_STOP}function yo(e){var t=Jr(e.target);if(!t){Nt("Couldn't find target for misc_partal_surface"),Br(e);return}e.r.ownerNum=t.s.number,t.spawnflags&1?e.s.frame=25:t.spawnflags&2&&(e.s.frame=75),t.spawnflags&4?e.s.powerups=0:e.s.powerups=1,e.s.clientNum=t.s.clientNum,vec3.set(t.s.origin,e.s.origin2);var r=vec3.create(),i=Jr(t.target);i?(vec3.subtract(i.s.origin,t.s.origin,r),vec3.normalize(r)):ti(t.s.angles,r),e.s.eventParm=n.DirToByte(r)}function bo(e,t,n){if(!n.client)return;if(n.client.ps.pm_type!==B.NORMAL)return;if(n.client.ps.powerups[W.FLIGHT])return;vec3.set(e.s.origin2,n.client.ps.velocity)}function wo(e,t,n){if(!n.client)return;var r=Jr(e.target);if(!r){Nt("Couldn't find teleporter destination");return}In(n,r.s.origin,r.s.angles)}function Eo(e,t){if(!t.takeDamage)return;if(e.timestamp>Tt.time)return;e.spawnflags&16?e.timestamp=Tt.time+1e3:e.timestamp=Tt.time+rt,!(e.spawnflags&4);var n=0;e.spawnflags&8&&(n=ct.NO_PROTECTION),er(t,e,e,null,null,e.damage,n,et.TRIGGER_HURT)}function So(e,t,n){e.r.linked?u.UnlinkEntity(e):u.LinkEntity(e)}function xo(e,t,n){if(!t.client)return;No(e,t)}function To(e,t,n){No(e,n)}function No(e,t){e.activator=t;if(e.nextthink)return;if(t.client){if(e.spawnflags&1&&t.client.sess.sessionTeam!==X.RED)return;if(e.spawnflags&2&&t.client.sess.sessionTeam!==X.BLUE)return}Kr(e,e.activator),e.wait>0?(e.think=Co,e.nextthink=Tt.time+(e.wait+e.random*n.crandom())*1e3):(e.touch=0,e.nextthink=Tt.time+rt,e.think=Br)}function Co(e){e.nextthink=0}function ko(e,t){if(!t.client)return;a.TouchJumpPad(t.client.ps,e.s)}function Lo(e,t){if(!t.client)return;if(t.client.ps.pm_type===B.DEAD)return;if(e.arena!==d){Cn(t,e.arena);return}var n=Jr(e.target);if(!n){Nt("Couldn't find teleporter destination"),Br(e);return}In(t,n.s.origin,n.s.angles)}var t=e.sys,o=e.com,u=e.sv,a=s.CreateInstance(Pt()),f=r.MAX_CLIENTS,l=r.MAX_GENTITIES,c=r.MAX_PERSISTANT,h=r.MAX_POWERUPS,p=r.MAX_PS_EVENTS,d=r.ARENANUM_NONE,v=r.ENTITYNUM_NONE,m=r.ENTITYNUM_WORLD,g=r.ENTITYNUM_MAX_NORMAL,y=a.GIB_HEALTH,b=a.ARMOR_PROTECTION,w=a.RANK_TIED_FLAG,E=a.DEFAULT_SHOTGUN_SPREAD,S=a.DEFAULT_SHOTGUN_COUNT,x=a.LIGHTNING_RANGE,T=a.SCORE_NOT_PRESENT,N=a.ANIM_TOGGLEBIT,C=a.EV_EVENT_BIT1,k=a.EV_EVENT_BIT2,L=a.EV_EVENT_BITS,A=a.EVENT_VALID_MSEC,O=r.CVAR,M=r.BUTTON,_=r.TR,D=r.SURF,P=r.CONTENTS,H=r.FLAG,B=a.PM,j=a.PMF,F=a.GT,I=a.WS,q=a.IT,R=a.MASK,U=a.STAT,z=a.WP,W=a.PW,X=a.TEAM,V=a.SPECTATOR,$=a.PERS,J=a.PLAYEREVENTS,K=a.ET,Q=a.EF,G=a.EV,Y=a.GTS,Z=a.ANIM,et=a.MOD,tt=a.GametypeNames,nt=8,rt=100,it=15,st=3e3,ot=2e3,ut=1e3,at=5e3,ft=-1,lt=0,ct={RADIUS:1,NO_ARMOR:2,NO_KNOCKBACK:4,NO_PROTECTION:8},ht={GODMODE:16,NOTARGET:32,TEAMSLAVE:1024,NO_KNOCKBACK:2048,DROPPED_ITEM:4096,NO_BOTS:8192,NO_HUMANS:16384,FORCE_GESTURE:32768},pt={NOCLIENT:1,BOT:2,BROADCAST:8,PORTAL:32,USE_CURRENT_ORIGIN:64,SINGLECLIENT:128,NOTSINGLECLIENT:256},dt={POS1:0,POS2:1,ONETOTWO:2,TWOTOONE:3},vt={DISCONNECTED:0,CONNECTING:1,CONNECTED:2},mt={BEGIN:0,ACTIVE:1,QUEUED:2},gt=function(){this.clients=new Array(f),this.gentities=new Array(l),this.gentitySize=0,this.num_entities=0,this.maxclients=0,this.framenum=0,this.previousTime=0,this.time=0,this.startTime=0,this.lastTeamLocationTime=0,this.newSession=!1,this.restarted=!1,this.spawnVars=null,this.bodyQueue=new Array(nt),this.bodyQueueIndex=0,this.arenas=[],this.arena=null;for(var e=0;e<f;e++)this.clients[e]=new wt;for(var e=0;e<l;e++)this.gentities[e]=new bt},yt=function(){this.arenaNum=d,this.name=null,this.teamScores=new Array(X.NUM_TEAMS),this.warmupTime=0,this.restartTime=0,this.lastWinningTeam=0,this.numConnectedClients=0,this.numNonSpectatorClients=0,this.numPlayingClients=0,this.sortedClients=new Array(f),this.score1=0,this.score2=0,this.count1=0,this.count2=0,this.alive1=0,this.alive2=0;for(var e=0;e<X.NUM_TEAMS;e++)this.teamScores[e]=0},bt=function(){this.reset()};bt.prototype.reset=function(){this.s=new r.EntityState,this.r=new r.SharedEntity,this.client=null,this.parent=null,this.inuse=!1,this.classname="noclass",this.spawnflags=0,this.arena=d,this.freeTime=0,this.eventTime=0,this.freeAfterEvent=!1,this.unlinkAfterEvent=!1,this.neverFree=!1,this.model=null,this.model2=null,this.message=null,this.physicsObject=!1,this.physicsBounce=0,this.clipmask=0,this.moverState=0,this.soundPos1=0,this.sound1to2=0,this.sound2to1=0,this.soundPos2=0,this.soundLoop=0,this.nextTrain=null,this.prevTrain=null,this.pos1=vec3.create(),this.pos2=vec3.create(),this.target=null,this.targetName=null,this.team=null,this.targetShaderName=null,this.targetShaderNewName=null,this.targetEnt=null,this.speed=0,this.wait=0,this.movedir=vec3.create(),this.nextthink=0,this.think=null,this.timestamp=0,this.painDebounceTime=0,this.flyDebounceTime=0,this.health=0,this.takeDamage=!1,this.damage=0,this.splashDamage=0,this.splashRadius=0,this.methodOfDeath=0,this.splashMethodOfDeath=0,this.count=0,this.chain=null,this.enemy=null,this.activator=null,this.teamchain=null,this.teammaster=null,this.watertype=0,this.waterlevel=0,this.noise_index=0,this.wait=0,this.random=0};var wt=function(){this.reset()};wt.prototype.reset=function(){this.ps=new r.PlayerState,this.pers=new St,this.sess=new xt,this.readyToExit=!1,this.noclip=!1,this.lastCmdTime=0,this.oldOrigin=vec3.create(),this.damage_armor=0,this.damage_blood=0,this.damage_knockback=0,this.damage_from=vec3.create(),this.damage_fromWorld=!1,this.impressive_count=0,this.accuracy_shots=0,this.accuracy_hits=0,this.lastkilled_client=0,this.lasthurt_mod=0,this.respawnTime=0,this.inactivityTime=0,this.inactivityWarning=0,this.rewardTime=0,this.lastKillTime=0,this.airOutTime=0,this.switchTeamTime=0,this.switchArenaTime=0};var Et=function(){this.state=mt.BEGIN,this.captures=0,this.basedefense=0,this.carrierdefense=0,this.flagrecovery=0,this.fragcarrier=0,this.assists=0,this.lasthurtcarrier=0,this.lastreturnedflag=0,this.flagsince=0,this.lastfraggedcarrier=0},St=function(){this.connected=0,this.netname=null,this.cmd=new r.UserCmd,this.localClient=!1,this.predictItemPickup=!1,this.maxHealth=0,this.enterTime=0,this.teamState=new Et,this.voteCount=0,this.teamVoteCount=0,this.teamInfo=!1};St.prototype.clone=function(e){return typeof e=="undefined"&&(e=new St),e.connected=this.connected,e.netname=this.netname,e.cmd=this.cmd,e.localClient=this.localClient,e.predictItemPickup=this.predictItemPickup,e.maxHealth=this.maxHealth,e.enterTime=this.enterTime,e.teamState=this.teamState,e.voteCount=this.voteCount,e.teamVoteCount=this.teamVoteCount,e.teamInfo=this.teamInfo,e};var xt=function(){this.sessionTeam=X.FREE,this.spectatorState=V.NOT,this.spectatorClient=0,this.spectatorNum=0,this.wins=0,this.losses=0};xt.prototype.clone=function(e){return typeof e=="undefined"&&(e=new xt),e.sessionTeam=this.sessionTeam,e.spectatorState=this.spectatorState,e.spectatorClient=this.spectatorClient,e.spectatorNum=this.spectatorNum,e.wins=this.wins,e.losses=this.losses,e};var Tt,sn=vec3.createFrom(-15,-15,-24),on=vec3.createFrom(15,15,32),Xn=150,Vn={ALL:0,TEAM:1,TELL:2},rr=0,pr,dr,vr,mr,gr,yr,br,wr,Er,Sr,xr,Tr,Nr,Cr,kr,Lr,Ar,Or,Mr,Dr={},Pr={angle:{type:"anglehack",aliases:[r.FTA("s.angles")]},angles:{type:"vector",aliases:[r.FTA("s.angles")]},arena:{type:"int"},classname:{},count:{type:"int"},dmg:{type:"int",aliases:[r.FTA("damage")]},health:{type:"int"},message:{},model:{},model2:{},origin:{type:"vector",aliases:[r.FTA("r.currentOrigin"),r.FTA("s.origin"),r.FTA("s.pos.trBase")]},random:{type:"float"},spawnflags:{type:"int"},speed:{type:"float"},target:{},targetname:{aliases:[r.FTA("targetName")]},team:{},wait:{type:"float"}},Gr=vec3.createFrom(0,-1,0),Yr=vec3.createFrom(0,0,1),Zr=vec3.createFrom(0,-2,0),ei=vec3.createFrom(0,0,-1),li={ARMOR:25,HEALTH:35,AMMO:40,HOLDABLE:60,MEGAHEALTH:35,POWERUP:120},wi=50,Xi=5,Vi=0,$i=1,Ji=0,Ki=2,Qi=4e4,Gi=2,Yi=1,Zi=1,es=1,ts=2,ns=1e3,rs=1e3,is=8e3,ss=1e4,os=1e4,us=750,as=750,fs=2e4,ls=function(){this.reset()};ls.prototype.reset=function(){this.last_flag_capture=0,this.last_capture_team=0,this.redStatus=0,this.blueStatus=0,this.flagStatus=0,this.redTakenTime=0,this.blueTakenTime=0};var cs=new ls,ws=[0,1,"*","*",2],Es=[0,1,2,3,4],qs=200,Rs=7,Us=5,Js=10,no=4;Dr.func_bobbing=function(e){var t=Rr("height",32),n=Rr("phase",0);e.speed=Rr("speed",4),e.damage=Ur("dmg",2),u.SetBrushModel(e,e.model),Ai(e),vec3.set(e.s.origin,e.s.pos.trBase),vec3.set(e.s.origin,e.r.currentOrigin),e.s.pos.trDuration=e.speed*1e3,e.s.pos.trTime=e.s.pos.trDuration*n,e.s.pos.trType=_.SINE,e.spawnflags&1?e.s.pos.trDelta[0]=t:e.spawnflags&2?e.s.pos.trDelta[1]=t:e.s.pos.trDelta[2]=t},Dr.func_button=function(e){e.speed||(e.speed=40),e.wait||(e.wait=1),e.wait*=1e3,vec3.set(e.s.origin,e.pos1),u.SetBrushModel(e,e.model);var t=Rr("lip",4);ti(e.s.angles,e.movedir);var n=vec3.createFrom(Math.abs(e.movedir[0]),Math.abs(e.movedir[1]),Math.abs(e.movedir[2])),r=vec3.subtract(e.r.maxs,e.r.mins,vec3.create()),i=n[0]*r[0]+n[1]*r[1]+n[2]*r[2]-t;vec3.add(e.pos1,vec3.scale(e.movedir,i,vec3.create()),e.pos2),e.health?e.takeDamage=!0:e.touch=so,Ai(e)},Dr.func_door=function(e){e.blocked=oo,e.speed||(e.speed=400),e.wait||(e.wait=2),e.wait*=1e3;var t=Rr("lip",8);e.damage=Ur("dmg",2),vec3.set(e.s.origin,e.pos1),u.SetBrushModel(e,e.model),ti(e.s.angles,e.movedir);var n=vec3.createFrom(Math.abs(e.movedir[0]),Math.abs(e.movedir[1]),Math.abs(e.movedir[2])),r=vec3.subtract(e.r.maxs,e.r.mins,vec3.create()),i=vec3.dot(n,r)-t;vec3.add(e.pos1,vec3.scale(e.movedir,i,vec3.create()),e.pos2);if(e.spawnflags&1){var s=vec3.create(e.pos2);vec3.set(e.s.origin,e.pos2),vec3.set(s,e.pos1)}Ai(e),e.nextthink=Tt.time+rt;if(!(e.flags&ht.TEAMSLAVE)){var o=Ur("health",0);o&&(e.takeDamage=!0),e.targetName||o?e.think=ao:e.think=uo}},Dr.func_static=function(e){u.SetBrushModel(e,e.model),Ai(e),vec3.set(e.s.origin,e.s.pos.trBase),vec3.set(e.s.origin,e.r.currentOrigin)};var co=1,ho=2,po=4;return Dr.func_train=function(e){console.log("SPAWANING func_train"),e.s.angles[0]=e.s.angles[1]=e.s.angles[2]=0,e.spawnflags&po?e.damage=0:e.damage||(e.damage=2),e.speed||(e.speed=100);if(!e.target){Nt("func_train without a target at",e.r.absmin),Br(e);return}u.SetBrushModel(e,e.model),Ai(e),e.reached=mo,e.nextthink=Tt.time+rt,e.think=vo},Dr.info_notnull=function(e){Qr(e,e.s.origin)},Dr.info_player_deathmatch=function(e){},Dr.info_player_intermission=function(e){},Dr.misc_portal_camera=function(e){e.r.mins[0]=e.r.mins[1]=e.r.mins[2]=0,e.r.maxs[0]=e.r.maxs[1]=e.r.maxs[2]=0,u.LinkEntity(e);var t=Rr("roll",0);e.s.clientNum=t/360*256},Dr.misc_portal_surface=function(e){e.r.mins[0]=e.r.mins[1]=e.r.mins[2]=0,e.r.maxs[0]=e.r.maxs[1]=e.r.maxs[2]=0,u.LinkEntity(e),e.r.svFlags=pt.PORTAL,e.s.eType=K.PORTAL,e.target?(e.think=yo,e.nextthink=Tt.time+100):vec3.set(e.s.origin,e.s.origin2)},Dr.misc_teleporter_dest=function(e){Qr(e,e.s.origin)},Dr.path_corner=function(e){if(!e.targetName){Nt("path_corner with no targetname at",e.s.origin),Br(e);return}},Dr.target_position=function(e){Qr(e,e.s.origin)},Dr.target_push=function(e){e.speed||(e.speed=1e3),ti(e.s.angles,e.s.origin2),vec3.scale(e.s.origin2,e.speed),e.target&&(vec3.set(e.s.origin,e.r.absmin),vec3.set(e.s.origin,e.r.absmax),e.think=Is,e.nextthink=Tt.time+rt),e.use=bo},Dr.target_teleporter=function(e){e.targetName||Nt("Untargeted",e.classname,"at",e.s.origin),e.use=wo},Dr.team_CTF_blueplayer=function(e){},Dr.team_CTF_bluespawn=function(e){},Dr.team_CTF_redplayer=function(e){},Dr.team_CTF_redspawn=function(e){},Dr.trigger_hurt=function(e){Fs(e),e.touch=Eo,e.use=So,e.damage||(e.damage=5),e.spawnflags&1?u.UnlinkEntity(e):u.LinkEntity(e)},Dr.trigger_multiple=function(e){e.wait=Rr("wait",.5),e.random=Rr("random",0),e.random>=e.wait&&e.wait>=0&&(e.random=e.wait-rt,Nt("trigger_multiple has random >= wait")),e.touch=xo,e.use=To,Fs(e),u.LinkEntity(e)},Dr.trigger_push=function(e){Fs(e),e.r.svFlags&=~pt.NOCLIENT,e.s.eType=K.PUSH_TRIGGER,e.touch=ko,e.think=Is,e.nextthink=Tt.time+rt,u.LinkEntity(e)},Dr.trigger_teleport=function(e){Fs(e),e.spawnflags&1?e.r.svFlags|=pt.NOCLIENT:e.r.svFlags&=~pt.NOCLIENT,e.s.eType=K.TELEPORT_TRIGGER,e.touch=Lo,u.LinkEntity(e)},Dr.worldspawn=function(e){u.SetConfigstring("levelStartTime",Tt.startTime);var t=qr("music","");t=t.replace("\\","/").replace(/\.[^\/.]+$/,""),u.SetConfigstring("music",t);var n=qr("message","");u.SetConfigstring("message",n),Tt.gentities[m].s.number=m,Tt.gentities[m].r.ownerNum=v,Tt.gentities[m].classname="worldspawn",Tt.gentities[v].s.number=v,Tt.gentities[v].r.ownerNum=v,Tt.gentities[v].classname="nothing"},{SVF:pt,Init:kt,Shutdown:Lt,Frame:At,ClientConnect:un,ClientUserinfoChanged:an,ClientBegin:fn,ClientThink:dn,ClientDisconnect:ln,ClientCommand:zn,GetClientPlayerstate:An}}return{CreateInstance:function(e){return new o(e)}}}),define("server/sv",["underscore","ByteBuffer","common/qmath","common/qshared","common/cvar","clipmap/cm","game/gm"],function(e,t,n,r,i,s,o){function u(u){function N(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"SV:"),Function.apply.call(console.log,console,e)}function C(e){N("Initializing"),E=e,S=new m,x||(x=new d),T=!E,Nt(),Ct(),k(),L()}function k(){if(!T){var e=f.StringToAddr("localhost"),t=f.NetchanSetup(r.NS.SERVER,e,{onmessage:function(e){j(t,e)}});return}a.NetListen(vt.getAsInt(),{onrequest:Z,onaccept:et})}function L(){if(!T)return;a.CreateRemoteConsole(mt.getAsInt())}function A(){var e=St.getAsInt(),t=1e3/e;return t<1&&(t=1),t}function O(e){if(!M())return;var t=A();S.timeResidual+=e;if(S.restartTime&&S.time>=S.restartTime){S.restartTime=0,f.ExecuteBuffer("map_restart 0");return}i.Modified(r.CVAR.SERVERINFO)&&(W("serverInfo",i.GetCvarJSON(r.CVAR.SERVERINFO)),i.ClearModified(r.CVAR.SERVERINFO)),i.Modified(r.CVAR.SYSTEMINFO)&&(W("systemInfo",i.GetCvarJSON(r.CVAR.SYSTEMINFO)),i.ClearModified(r.CVAR.SYSTEMINFO)),D();var n=0;while(S.timeResidual>=t)S.timeResidual-=t,x.time+=t,S.time+=t,c.Frame(S.time),n++;P(),n>0&&$t(),B()}function M(){return x.initialized}function D(){for(var e=0;e<Et.getAsInt();e++){var t=x.clients[e];if(t.state!==y.ACTIVE){t.ping=999;continue}if(!t.gentity){t.ping=999;continue}var n=0,r=0;for(var i=0;i<f.PACKET_BACKUP;i++){if(t.frames[i].messageAcked<=0)continue;var s=t.frames[i].messageAcked-t.frames[i].messageSent;n+=s,r++}r?(t.ping=Math.floor(n/r),t.ping>999&&(t.ping=999)):t.ping=999;var o=c.GetClientPlayerstate(e);o.ping=t.ping}}function P(){var e=x.time-1e3*xt.getAsInt(),t=x.time-1e3*Tt.getAsInt();for(var n=0;n<Et.getAsInt();n++){var r=x.clients[n];if(r.state===y.FREE)continue;r.lastPacketTime>x.time&&(r.lastPacketTime=x.time);if(r.state===y.ZOMBIE&&r.lastPacketTime<t){N("Going from CS_ZOMBIE to CS_FREE for client",n),r.state=y.FREE;continue}r.state>=y.CONNECTED&&r.lastPacketTime<e&&(rt(r,"timed out"),r.state=y.FREE)}}function B(){if(!T)return;if(x.time<x.nextHeartbeatTime)return;x.nextHeartbeatTime=x.time+H,N("SendMasterHeartbeat");var e=f.StringToAddr(gt.getAsString()),t=f.NetchanSetup(r.NS.SERVER,e,{onopen:function(){var e={type:"heartbeat",port:vt.getAsInt()};f.NetchanPrint(t,JSON.stringify(e)),f.NetchanDestroy(t)}})}function j(e,n){if(!M())return;var r=new t(n,t.LITTLE_ENDIAN);if(n.byteLength>4&&r.view.getInt32(0,!!t.LITTLE_ENDIAN)===-1){F(e,r);return}for(var i=0;i<x.clients.length;i++){var s=x.clients[i];if(s.state===y.FREE)continue;if(s.netchan!==e)continue;f.NetchanProcess(s,r)&&(s.lastPacketTime=x.time,ht(s,r));return}}function F(e,t){t.readInt();var n=t.readCString();n.indexOf("connect")===0?tt(e,n.substr(8)):n.indexOf("getinfo")===0&&I(e)}function I(e){var t={},n=i.AddCvar("g_gametype");t.sv_hostname=bt.getAsString(),t.sv_mapname=wt.getAsString(),t.sv_maxClients=Et.getAsInt(),t.g_gametype=n.getAsInt();var r=0;for(var s=0;s<Et.getAsInt();s++)x.clients[s].state>=y.CONNECTED&&r++;t.clients=r,f.NetchanPrint(e,JSON.stringify(t))}function q(e){N("Spawning new server for",e,"at",f.frameTime),x.initialized=!1,Ot(),T||(E.MapLoading(),E.ShutdownSubsystems(),E.ShutdownCGame(),E.InitSubsystems()),x.snapFlagServerBit^=r.SNAPFLAG_SERVERCOUNT;var t=S.time;S=new m,f.LoadBsp(e,function(t,n){if(t)return f.Error(t);S.world=n,l.LoadWorld(n),wt.setValue(e),S.serverId=S.restartedServerId=f.frameTime,yt.setValue(S.serverId),Yt(),S.state=v.LOADING,At();for(var s=0;s<3;s++)c.Frame(S.time),S.time+=100,x.time+=100;U();for(var s=0;s<Et.getAsInt();s++){var o=x.clients[s];if(!o||o.state<y.CONNECTED)continue;o.gentity=null;var u=c.ClientConnect(s,!1);u&&rt(o,u),o.state=y.CONNECTED}c.Frame(S.time),S.time+=100,x.time+=100,W("systemInfo",i.GetCvarJSON(r.CVAR.SYSTEMINFO)),W("serverInfo",i.GetCvarJSON(r.CVAR.SERVERINFO)),S.state=v.GAME,x.initialized=!0})}function R(){N("KillServer"),Ot(),S=new m,x=new d}function U(){for(var e=0;e<r.MAX_GENTITIES;e++){var t=S.svEntities[e],n=Dt(t);if(!n.r.linked)continue;n.s.clone(S.svEntities[e].baseline)}}function z(e){var t=S.configstrings[e],n=t?JSON.parse(t):null;return n}function W(e,t){var n=JSON.stringify(t);if(n===S.configstrings[e])return;S.configstrings[e]=n;if(S.state===v.GAME||S.restarting)for(var r=0;r<Et.getAsInt();r++){var i=x.clients[r];if(i.state<y.ACTIVE){i.state===y.PRIMED&&(i.csUpdated[e]=!0);continue}X(i,e)}}function X(e,t){var n=S.configstrings[t];J(e,"cs",{k:t,v:JSON.parse(n)})}function V(e){for(var t in S.configstrings){if(!S.configstrings.hasOwnProperty(t))continue;if(!e.csUpdated[t])continue;X(e,t),e.csUpdated[t]=!1}}function $(e){return(e<0||e>=r.MAX_CLIENTS)&&f.Error("GetUserinfo: bad index "+e),x.clients[e].userinfo}function J(e,t,n){if(e!==null){K(e,t,n);return}for(var r=0;r<Et.getAsInt();r++)K(x.clients[r],t,n)}function K(e,t,n){if(e.state<y.PRIMED)return;e.reliableSequence++;var r={type:t,data:n};if(e.reliableSequence-e.reliableAcknowledge===f.MAX_RELIABLE_COMMANDS+1){N("----- pending server commands -----");for(var i=e.reliableAcknowledge+1;i<=e.reliableSequence;i++)N("cmd",i,e.reliableCommands[i%f.MAX_RELIABLE_COMMANDS]);N("cmd",i,r),rt(e,"Server command overflow");return}e.reliableCommands[e.reliableSequence%f.MAX_RELIABLE_COMMANDS]=r}function Q(){return{sys:sys,com:com}}function G(){return{sys:{ReadFile:a.ReadFile},com:{Error:f.Error}}}function Y(){return{sys:a,com:{Error:f.Error,ExecuteBuffer:f.ExecuteBuffer,AddCmd:f.AddCmd},sv:{LocateGameData:Pt,GetUserCmd:Ht,AdjustAreaPortalState:Ft,EntityContact:It,GetConfigstring:z,SetConfigstring:W,GetUserinfo:$,SendServerCommand:Bt,SetBrushModel:jt,GetEntityDefs:en,LinkEntity:rn,UnlinkEntity:sn,FindEntitiesInBox:on,Trace:fn,PointContents:hn}}}function Z(e){return!0}function et(e){var t=f.NetchanSetup(r.NS.SERVER,e,{onmessage:function(e){j(t,e)},onclose:function(){it(t)}})}function tt(e,t){if(!M())return;N("A client is connecting");var n;for(var i=0;i<r.MAX_CLIENTS;i++)if(x.clients[i].state===y.FREE){n=i;break}if(n===undefined){N("Rejected a connection.");return}var s=x.clients[n];s.reset(),s.netchan=e,s.userinfo=JSON.parse(t),c.ClientConnect(n,!0),at(s),N("Going from CS_FREE to CS_CONNECTED for ",n),s.state=y.CONNECTED,s.lastSnapshotTime=x.time,s.lastPacketTime=x.time,f.NetchanPrint(s.netchan,"connectResponse"),s.gamestateMessageNum=-1}function nt(e,t){var n=x.clients.indexOf(e);e.state=y.ACTIVE,N("Going from CS_CONNECTED to CS_ACTIVE for ",n),V(e),e.deltaMessage=-1,e.lastSnapshotTime=0,e.gentity=Mt(n),t?t.clone(e.lastUserCmd):e.lastUserCmd=new r.UserCmd,c.ClientBegin(n)}function rt(e,t){if(e.state===y.ZOMBIE)return;var n=ft(e);c.ClientDisconnect(n),e.state=y.ZOMBIE}function it(e){for(var t=0;t<x.clients.length;t++){var n=x.clients[t];if(n.state===y.FREE)continue;if(n.netchan===e){rt(n,"disconnected");return}}}function st(e,t,n){n?e.deltaMessage=e.messageAcknowledge:e.deltaMessage=-1;var i=t.readByte(t);if(i<1){N("UserMove cmd count < 1");return}var s=[];for(var o=0;o<i;o++){var u=new r.UserCmd;f.ReadDeltaUsercmd(t,null,u),s.push(u)}e.frames[e.messageAcknowledge%f.PACKET_BACKUP].messageAcked=x.time,e.state===y.PRIMED&&nt(e,s[0]);if(e.state!==y.ACTIVE){e.deltaMessage=-1;return}for(var o=0;o<s.length;o++){var u=s[o];if(u.serverTime>s[s.length-1].serverTime)continue;if(u.serverTime<=e.lastUserCmd.serverTime)return;ot(e,u)}}function ot(e,t){var n=ft(e);t.clone(e.lastUserCmd),c.ClientThink(n)}function ut(e){e.state=y.PRIMED,e.gamestateMessageNum=e.netchan.outgoingSequence;var n=new t(x.msgBuffer,t.LITTLE_ENDIAN);n.writeInt(e.lastClientCommand),n.writeByte(f.SVM.gamestate),n.writeInt(e.reliableSequence);for(var i in S.configstrings){if(!S.configstrings.hasOwnProperty(i))continue;n.writeByte(f.SVM.configstring),n.writeCString(JSON.stringify({k:i,v:z(i)}))}var s=new r.EntityState;for(var o=0;o<r.MAX_GENTITIES;o++){var u=S.svEntities[o].baseline;if(!u.number)continue;n.writeByte(f.SVM.baseline),f.WriteDeltaEntityState(n,s,u,!0)}n.writeByte(f.SVM.EOF),n.writeInt(ft(e)),n.writeByte(f.SVM.EOF),f.NetchanSend(e.netchan,n.buffer,n.index)}function at(e){e.name=e.userinfo.name;var t=20;t<1?t=1:t>St.getAsInt()&&(t=St.getAsInt()),t=1e3/t,t!=e.snapshotMsec&&(e.lastSnapshotTime=0,e.snapshotMsec=t)}function ft(e){return x.clients.indexOf(e)}function lt(e,t){e.userinfo=t,at(e);var n=ft(e);c.ClientUserinfoChanged(n)}function ct(e){rt(e,"disconnected")}function ht(e,t){var n=t.readInt();e.messageAcknowledge=t.readInt();if(e.messageAcknowledge<0)return;t.readInt();if(e.reliableAcknowledge<e.reliableSequence-f.MAX_RELIABLE_COMMANDS){e.reliableAcknowledge=e.reliableSequence;return}if(n!==S.serverId){if(n>=S.restartedServerId&&n<S.serverId)return;e.messageAcknowledge>e.gamestateMessageNum&&ut(e);return}e.oldServerTime&&n===yt.getAsInt()&&(e.oldServerTime=0);var r;for(;;){r=t.readUnsignedByte();if(r===f.CLM.EOF)break;if(r!==f.CLM.clientCommand)break;if(!pt(e,t))return;if(e.state===y.ZOMBIE)return}switch(r){case f.CLM.move:st(e,t,!0);break;case f.CLM.moveNoDelta:st(e,t,!1)}}function pt(e,t){var n=t.readInt(),r=JSON.parse(t.readCString());return e.lastClientCommand>=n?!0:n>e.lastClientCommand+1?(N("Client",e.name,"lost",n-e.lastClientCommand,"clientCommands"),rt(e,"Lost reliable commands"),!1):(e.nextReliableTime=x.time+1e3,dt(e,r),e.lastClientCommand=n,!0)}function dt(e,t){t.type==="userinfo"?lt(e,t.data):t.type==="disconnect"&&ct(e);if(S.state===v.GAME&&(e.state===y.ACTIVE||e.state===y.PRIMED)){var n=ft(e);c.ClientCommand(n,t)}}function Nt(){vt=i.AddCvar("sv_port",9001,r.CVAR.ARCHIVE,!0),mt=i.AddCvar("sv_rconPort",9002,r.CVAR.ARCHIVE,!0),gt=i.AddCvar("sv_master","master.quakejs.com:45735",r.CVAR.ARCHIVE),bt=i.AddCvar("sv_hostname","Anonymous",r.CVAR.ARCHIVE),yt=i.AddCvar("sv_serverid",0,r.CVAR.SYSTEMINFO|r.CVAR.ROM),wt=i.AddCvar("sv_mapname","nomap",r.CVAR.SERVERINFO),Et=i.AddCvar("sv_maxClients",8,r.CVAR.SERVERINFO|r.CVAR.LATCH|r.CVAR.ARCHIVE),St=i.AddCvar("sv_fps",20),xt=i.AddCvar("sv_timeout",200),Tt=i.AddCvar("sv_zombietime",2)}function Ct(){f.AddCmd("map",kt),f.AddCmd("map_restart",Lt),f.AddCmd("sectorlist",Gt)}function kt(e){q(e)}function Lt(e){if(f.frameTime===yt.getAsInt())return;if(S.restartTime)return;if(Et.modified()){N("Restart map is doing a hard restart - sv_maxClients changed."),q(wt.getAsString());return}x.snapFlagServerBit^=r.SNAPFLAG_SERVERCOUNT,S.serverId=f.frameTime,yt.setValue(S.serverId);for(var t=0;t<Et.getAsInt();t++)x.clients[t].state===y.PRIMED&&(x.clients[t].oldServerTime=S.restartTime);S.state=v.LOADING,S.restarting=!0,Ot(),At();for(var t=0;t<3;t++)c.Frame(S.time),S.time+=100,x.time+=100;S.state=v.GAME,S.restarting=!1;for(var t=0;t<Et.getAsInt();t++){var n=x.clients[t];if(n.state<y.CONNECTED)continue;K(n,"map_restart");var i=c.ClientConnect(t,!1);if(i){rt(n,i),N("MapRestart: dropped client",t,"- denied!");continue}n.state===y.ACTIVE?nt(n,n.lastUserCmd):nt(n,null)}c.Frame(S.time),S.time+=100,x.time+=100}function At(){x.gameInitialized=!0,c.Init(S.time)}function Ot(){if(!x.gameInitialized)return;x.gameInitialized=!1,c.Shutdown()}function Mt(e){return S.gameEntities[e]}function _t(e){var t=e.s.number;return(!e||t<0||t>=r.MAX_GENTITIES)&&f.Error("SvEntityForSharedEntity: bad game entity"),S.svEntities[t]}function Dt(e){var t=e.number;return(!e||t<0||t>=r.MAX_GENTITIES)&&f.Error("SharedEntityForSvEntity: bad sv entity"),Mt(t)}function Pt(e,t){S.gameEntities=e,S.gameClients=t}function Ht(e,t){(e<0||e>=r.MAX_CLIENTS)&&f.Error("GetUsercmd: bad clientNum: "+e),x.clients[e].lastUserCmd.clone(t)}function Bt(e,t,n){e===null?J(null,t,n):((e<0||e>=r.MAX_CLIENTS)&&f.Error("GetUsercmd: bad clientNum: "+e),J(x.clients[e],t,n))}function jt(e,t){t||f.Error("SV: SetBrushModel: null"),t.charAt(0)!=="*"&&f.Error("SV: SetBrushModel: "+t+"isn't a brush model"),e.s.modelIndex=parseInt(t.substr(1),10);var n=l.InlineModel(e.s.modelIndex);l.ModelBounds(n,e.r.mins,e.r.maxs),e.r.bmodel=!0,e.r.contents=-1}function Ft(e,t){var n=_t(e);if(n.areanum2===-1)return;l.AdjustAreaPortalState(n.areanum,n.areanum2,t)}function It(e,t,i){var s=i.r.currentOrigin,o=i.r.currentAngles,u=cn(i),a=new r.TraceResults;return l.TransformedBoxTrace(a,n.vec3origin,n.vec3origin,e,t,u,-1,s,o),a.startSolid}function qt(e,t){var n=e.gentity;if(!n||e.state===y.ZOMBIE)return!1;S.snapshotCounter++;var r=e.frames[e.netchan.outgoingSequence%f.PACKET_BACKUP],i=ft(e),s=c.GetClientPlayerstate(i);s.clone(r.ps);var o=S.svEntities[i];o.snapshotCounter=S.snapshotCounter;var u=[];Rt(n.s.arenaNum,r.ps.origin,r,u,!1),r.numEntities=0,r.firstEntity=x.nextSnapshotEntities;for(var a=0;a<u.length;a++){var l=Mt(u[a]),p=x.snapshotEntities[x.nextSnapshotEntities%h];l.s.clone(p),x.nextSnapshotEntities++,r.numEntities++}return!0}function Rt(e,t,n,i){var s=l.PointLeafnum(t),o=l.LeafArea(s),u=l.LeafCluster(s);for(var a=0;a<r.MAX_GENTITIES;a++){var h=Mt(a);if(!h||!h.r.linked)continue;if(h.s.arenaNum!==e)continue;h.s.number!==a&&f.Error("Entity number does not match.. WTF"+h.s.number+", "+a);if(h.r.svFlags&c.SVF.NOCLIENT)continue;if(h.r.svFlags&c.SVF.SINGLECLIENT&&h.r.singleClient!==n.ps.clientNum)continue;if(h.r.svFlags&c.SVF.NOTSINGLECLIENT&&h.r.singleClient===n.ps.clientNum)continue;var p=_t(h);if(p.snapshotCounter===S.snapshotCounter)continue;if(h.r.svFlags&c.SVF.BROADCAST){Ut(p,h,i);continue}if(!l.AreasConnected(o,p.areanum)&&!l.AreasConnected(o,p.areanum2))continue;if(!p.numClusters)continue;var d=0,v=0;for(d=0;d<p.numClusters;d++){v=p.clusternums[d];if(l.ClusterVisible(u,v))break}if(d===p.numClusters){if(!p.lastCluster)continue;for(;v<=p.lastCluster;v++)if(l.ClusterVisible(u,v))break;if(v===p.lastCluster)continue}Ut(p,h,i);if(h.r.svFlags&c.SVF.PORTAL){if(h.s.generic1){var m=vec3.subtract(h.s.origin,t,vec3.create());if(vec3.squaredLength(m)>h.s.generic1*h.s.generic1)continue}Rt(e,h.s.origin2,n,i)}}}function Ut(e,t,n){if(e.snapshotCounter===S.snapshotCounter)return;e.snapshotCounter=S.snapshotCounter,n.push(t.s.number)}function zt(e){if(!qt(e))return;var n=new t(x.msgBuffer,t.LITTLE_ENDIAN);n.writeInt(e.lastClientCommand),Wt(e,n),Xt(e,n),n.writeByte(f.SVM.EOF),e.frames[e.netchan.outgoingSequence%f.PACKET_BACKUP].messageSent=x.time,e.frames[e.netchan.outgoingSequence%f.PACKET_BACKUP].messageAcked=-1,f.NetchanSend(e.netchan,n.buffer,n.index)}function Wt(e,t){for(var n=e.reliableAcknowledge+1;n<=e.reliableSequence;n++){var r=e.reliableCommands[n%f.MAX_RELIABLE_COMMANDS];t.writeByte(f.SVM.serverCommand),t.writeInt(n),t.writeCString(JSON.stringify(r))}e.reliableAcknowledge=e.reliableSequence}function Xt(e,t){var n=e.frames[e.netchan.outgoingSequence%f.PACKET_BACKUP],i=null,s=0;e.deltaMessage<=0||e.state!==y.ACTIVE?(i=null,s=0):e.netchan.outgoingSequence-e.deltaMessage>=f.PACKET_BACKUP-3?(i=null,s=0):(i=e.frames[e.deltaMessage%f.PACKET_BACKUP],s=e.netchan.outgoingSequence-e.deltaMessage,i.firstEntity<=x.nextSnapshotEntities-x.numSnapshotEntities&&(N(e.name,": Delta request from out of date entities."),i=null,s=0)),t.writeUnsignedByte(f.SVM.snapshot);var o=S.time;e.oldServerTime&&(o=S.time+e.oldServerTime),t.writeInt(o),t.writeByte(s);var u=x.snapFlagServerBit;e.state!==y.ACTIVE&&(u|=r.SNAPFLAG_NOT_ACTIVE),t.writeInt(u),f.WriteDeltaPlayerState(t,i?i.ps:null,n.ps),Vt(t,i,n)}function Vt(e,t,n){var i,s,o,u,a,l,c;c=t?t.numEntities:0,i=null,s=null,o=0,u=0;while(u<n.numEntities||o<c){u>=n.numEntities?l=9999:(s=x.snapshotEntities[(n.firstEntity+u)%h],l=s.number),o>=c?a=9999:(i=x.snapshotEntities[(t.firstEntity+o)%h],a=i.number);if(l===a){f.WriteDeltaEntityState(e,i,s,!1),o++,u++;continue}if(l<a){f.WriteDeltaEntityState(e,S.svEntities[l].baseline,s,!0),u++;continue}if(l>a){f.WriteDeltaEntityState(e,i,null,!0),o++;continue}}e.writeShort(r.MAX_GENTITIES-1)}function $t(){for(var e=0;e<x.clients.length;e++){var t=x.clients[e];if(!t)continue;if(!t.state)continue;if(x.time-t.lastSnapshotTime<t.snapshotMsec)continue;zt(t),t.lastSnapshotTime=x.time}}function Gt(){for(var t=0;t<Kt.length;t++){var n=Kt[t];N("sector "+t+": "+e.keys(n.entities).length+" entities")}}function Yt(){Kt=[];var e=l.InlineModel(0),t=vec3.create(),n=vec3.create();l.ModelBounds(e,t,n),Zt(0,t,n)}function Zt(e,t,n){var r=Kt[Kt.length]=new Qt;if(e===Jt)return r.axis=-1,r.children[0]=r.children[1]=null,r;var i=vec3.subtract(n,t,vec3.create());i[0]>i[1]?r.axis=0:r.axis=1;var s=vec3.create(t),o=vec3.create(t),u=vec3.create(n),a=vec3.create(n);return r.dist=.5*(n[r.axis]+t[r.axis]),u[r.axis]=o[r.axis]=r.dist,r.children[0]=Zt(e+1,o,a),r.children[1]=Zt(e+1,s,u),r}function en(){return S.world.entities}function rn(e){var t,i,s,o=_t(e);o.worldSector&&sn(e),e.r.bmodel?e.s.solid=r.SOLID_BMODEL:e.r.contents&(r.CONTENTS.SOLID|r.CONTENTS.BODY)?(t=e.r.maxs[0],t<1?t=1:t>255&&(t=255),i=-e.r.mins[2],i<1?i=1:i>255&&(i=255),s=e.r.maxs[2]+32,s<1?s=1:s>255&&(s=255),e.s.solid=s<<16|i<<8|t):e.s.solid=0;var u=e.r.currentOrigin,a=e.r.currentAngles;if(e.r.bmodel&&(a[0]||a[1]||a[2])){var f=n.RadiusFromBounds(e.r.mins,e.r.maxs);for(t=0;t<3;t++)e.r.absmin[t]=u[t]-f,e.r.absmax[t]=u[t]+f}else vec3.add(u,e.r.mins,e.r.absmin),vec3.add(u,e.r.maxs,e.r.absmax);e.r.absmin[0]-=1,e.r.absmin[1]-=1,e.r.absmin[2]-=1,e.r.absmax[0]+=1,e.r.absmax[1]+=1,e.r.absmax[2]+=1,o.numClusters=0,o.lastCluster=0,o.areanum=-1,o.areanum2=-1;var c=l.BoxLeafnums(e.r.absmin,e.r.absmax,nn,tn);if(!c.count)return;for(t=0;t<c.count;t++){var h=l.LeafArea(nn[t]);if(h===-1)continue;o.areanum!==-1&&o.areanum!==h?o.areanum2=h:o.areanum=h}o.numClusters=0;for(t=0;t<c.count;t++){var d=l.LeafCluster(nn[t]);if(d===-1)continue;o.clusternums[o.numClusters++]=d;if(o.numClusters===p)break}t!==c.count&&(o.lastCluster=l.LeafCluster(c.lastLeaf));var v=Kt[0];for(;;){if(v.axis==-1)break;if(e.r.absmin[v.axis]>v.dist)v=v.children[0];else{if(!(e.r.absmax[v.axis]<v.dist))break;v=v.children[1]}}e.r.linked=!0,o.worldSector=v,v.entities[e.s.number]=o}function sn(e){var t=_t(e),n=t.worldSector;if(!n)return;e.r.linked=!1,delete n.entities[e.s.number],t.worldSector=null}function on(e,t,n){var i=[],s=function(o){for(var u in o.entities){if(!o.entities.hasOwnProperty(u))continue;var a=o.entities[u],f=Dt(a);if(n!==r.ARENANUM_NONE&&f.s.arenaNum!==n)continue;if(f.r.absmin[0]>t[0]||f.r.absmin[1]>t[1]||f.r.absmin[2]>t[2]||f.r.absmax[0]<e[0]||f.r.absmax[1]<e[1]||f.r.absmax[2]<e[2])continue;i.push(f.s.number)}if(o.axis==-1)return;t[o.axis]>o.dist&&s(o.children[0]),e[o.axis]<o.dist&&s(o.children[1])};return s(Kt[0]),i}function fn(e,t,n,i,s,o,u,a){i||(i=vec3.create()),s||(s=vec3.create()),l.BoxTrace(an.trace,t,n,i,s,0,a),an.trace.entityNum=an.trace.fraction!==1?r.ENTITYNUM_WORLD:r.ENTITYNUM_NONE;if(an.trace.fraction===0){an.trace.clone(e);return}an.contentmask=a,vec3.set(t,an.start),vec3.set(n,an.end),vec3.set(i,an.mins),vec3.set(s,an.maxs),an.arenaNum=o,an.passEntityNum=u;for(var f=0;f<3;f++)n[f]>t[f]?(an.boxmins[f]=an.start[f]+an.mins[f]-1,an.boxmaxs[f]=an.end[f]+an.maxs[f]+1):(an.boxmins[f]=an.end[f]+an.mins[f]-1,an.boxmaxs[f]=an.start[f]+an.maxs[f]+1);ln(an),an.trace.clone(e)}function ln(e){var t=vec3.create(),n=vec3.create(),i=-1,s=new r.TraceResults,o=on(e.boxmins,e.boxmaxs,e.arenaNum);e.passEntityNum!==r.ENTITYNUM_NONE&&(i=Mt(e.passEntityNum).r.ownerNum,i===r.ENTITYNUM_NONE&&(i=-1));for(var u=0;u<o.length;u++){if(e.trace.allSolid)return;var a=Mt(o[u]);if(e.passEntityNum!==r.ENTITYNUM_NONE){if(o[u]===e.passEntityNum)continue;if(a.r.ownerNum===e.passEntityNum)continue;if(a.r.ownerNum===i)continue}if(!(e.contentmask&a.r.contents))continue;var f=cn(a);vec3.set(a.r.currentOrigin,t),vec3.set(a.r.currentAngles,n),a.r.bmodel||(n[0]=n[1]=n[2]=0),l.TransformedBoxTrace(s,e.start,e.end,e.mins,e.maxs,f,e.contentmask,t,n),s.allSolid?(e.trace.allSolid=!0,s.entityNum=a.s.number):s.startSolid&&(e.trace.startSolid=!0,s.entityNum=a.s.number);if(s.fraction<e.trace.fraction){var c=e.trace.startSolid;s.entityNum=a.s.number,s.clone(e.trace),e.trace.startSolid|=c}}}function cn(e){return e.r.bmodel?l.InlineModel(e.s.modelIndex):l.TempBoxModel(e.r.mins,e.r.maxs)}function hn(e,t,r){var i=l.PointContents(e,0),s=on(e,e,t);for(var o=0;o<s.length;o++){if(s[o]===r)continue;var u=Mt(s[o]),a=cn(u),f=n.vec3origin;u.r.bmodel&&(f=u.r.currentAngles);var c=l.TransformedPointContents(e,a,u.r.currentOrigin,f);i|=c}return i}var a=u.sys,f=u.com,l=s.CreateInstance(G()),c=o.CreateInstance(Y()),h=r.MAX_CLIENTS*f.PACKET_BACKUP*64,p=16,d=function(){this.initialized=!1,this.gameInitialized=!1,this.time=0,this.nextHeartbeatTim=0,this.snapFlagServerBit=0,this.clients=new Array(r.MAX_CLIENTS),this.nextSnapshotEntities=0,this.snapshotEntities=new Array(h),this.msgBuffer=new ArrayBuffer(f.MAX_MSGLEN);for(var e=0;e<r.MAX_CLIENTS;e++)this.clients[e]=new b;for(var e=0;e<h;e++)this.snapshotEntities[e]=new r.EntityState},v={DEAD:0,LOADING:1,GAME:2},m=function(){this.state=v.DEAD,this.restarting=!1,this.serverId=0,this.restartedServerId=0,this.snapshotCounter=0,this.time=0,this.restartTime=0,this.timeResidual=0,this.configstrings={},this.world=null,this.svEntities=new Array(r.MAX_GENTITIES),this.gameEntities=null,this.gameClients=null;for(var e=0;e<r.MAX_GENTITIES;e++)this.svEntities[e]=new g,this.svEntities[e].number=e},g=function(){this.number=0,this.worldSector=null,this.baseline=new r.EntityState,this.numClusters=0,this.clusternums=new Array(p),this.lastCluster=0,this.areanum=0,this.areanum2=0,this.snapshotCounter=0},y={FREE:0,ZOMBIE:1,CONNECTED:2,PRIMED:3,ACTIVE:4},b=function(){this.reset()};b.prototype.reset=function(){this.state=y.FREE,this.userinfo={},this.messageAcknowledge=0,this.reliableCommands=new Array(f.MAX_RELIABLE_COMMANDS),this.reliableSequence=0,this.reliableAcknowledge=0,this.gamestateMessageNum=-1,this.lastUserCmd=new r.UserCmd,this.lastMessageNum=0,this.lastClientCommand=0,this.name=null,this.deltaMessage=-1,this.nextReliableTime=0,this.lastSnapshotTime=0,this.snapshotMsec=0,this.frames=new Array(f.PACKET_BACKUP),this.netchan=null,this.oldServerTime=0,this.csUpdated={};for(var e=0;e<f.PACKET_BACKUP;e++)this.frames[e]=new w};var w=function(){this.ps=new r.PlayerState,this.numEntities=0,this.firstEntity=0},E,S,x,T,H=3e4,vt,mt,gt,yt,bt,wt,Et,St,xt,Tt,Jt=4,Kt,Qt=function(){this.axis=0,this.dist=0,this.children=[null,null],this.entities={}},tn=128,nn=new Uint32Array(tn),un=function(){this.boxmins=vec3.create(),this.boxmaxs=vec3.create(),this.mins=vec3.create(),this.maxs=vec3.create(),this.start=vec3.create(),this.end=vec3.create(),this.trace=new r.TraceResults,this.arenaNum=0,this.passEntityNum=0,this.contentmask=0},an=new un;return{Init:C,Running:M,Frame:O,PacketEvent:j,ClientDisconnected:it,Kill:R}}return{CreateInstance:function(e){return new u(e)}}}),define("client/cl",[],function(){return{CreateInstance:function(){}}}),define("common/com",["underscore","ByteBuffer","common/qmath","common/qshared","common/bsp-serializer","common/cvar","server/sv","client/cl"],function(e,t,n,r,i,s,o,u){function y(){b("set",E),b("unset",S),b("echo",x),b("exec",T)}function b(e,t){g[e]=t}function w(e){return g[e]}function E(e,t){var n=s.AddCvar(e);if(n.getFlags()&r.CVAR.ROM){D("Can't modify internal cvars");return}n.setValue(t)}function S(e,t){var n=s.AddCvar(e);n(n.getDefaultValue())}function x(e){var t=s.GetCvar(e);if(!t)return;D(e,"is:",t.getValue(),", default:",t.getDefaultValue())}function T(e,t){if(!e){D("Enter a filename to execeute.");return}N.ReadFile(e,"utf8",function(n,r){if(n){D("Failed to execute '"+e+"'"),t&&t(n);return}D("Executing",e),r=r.replace(/^\s+|\s+$/g,"");var i=r.split(/\r\n|\r|\n/);for(var s=0;s<i.length;s++)q(i[s]);t&&t()})}function D(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"COM:"),Function.apply.call(console.log,console,e)}function P(e){D(e),k&&k.Disconnect(),C.Kill(),N.Error(e,!1)}function H(e,t,n){N=e,C=o.CreateInstance(X()),L=t,A=[],O=M=N.GetMilliseconds(),_=!1,y(),L||(k=u.CreateInstance(X()),k.Init(C)),U(function(){C.Init(k),_=!0,n()})}function B(){M=O,O=N.GetMilliseconds();if(!_)return;var e=O-M;R(),j(),C.Frame(e),k&&k.Frame(e)}function j(){var e=A.shift();while(e){switch(e.type){case f.KEY:e.pressed?k.KeyDownEvent(e.time,e.keyName):k.KeyUpEvent(e.time,e.keyName);break;case f.MOUSE:k.MouseMoveEvent(e.time,e.deltaX,e.deltaY)}e=A.shift()}}function F(e){e.time=N.GetMilliseconds(),A.push(e)}function q(e){var t=[],n;while(n=I.exec(e)){var r=n[1]||n[2];r=r.replace(/\\"/g,'"'),t.push(r)}var i=w(t[0]);if(i){i.apply(this,t.slice(1));return}if(i===null){k.ForwardCommandToServer(t);return}D("Unknown command '"+t[0]+"'")}function R(){if(!s.Modified(r.CVAR.ARCHIVE)&&(!k||!k.BindsModified()))return;s.ClearModified(r.CVAR.ARCHIVE),k&&k.ClearBindsModified(),z()}function U(e){T("default.cfg",function(){T("user.cfg",function(){s.ClearModified(r.CVAR.ARCHIVE),e()})})}function z(){var e="user.cfg",t="";t=W(t),k&&(t=k.WriteBindings(t)),N.WriteFile(e,t,"utf8",function(){})}function W(e){var t=s.GetCvarJSON(r.CVAR.ARCHIVE);for(var n in t){if(!t.hasOwnProperty(n))continue;e+="set "+n+" "+t[n]+"\n"}return e}function X(){var e={com:{MAX_MAP_AREA_BYTES:a,PACKET_BACKUP:l,MAX_PACKET_USERCMDS:c,MAX_RELIABLE_COMMANDS:h,MAX_MSGLEN:p,CLM:d,SVM:v,Error:P,ExecuteBuffer:q,LoadConfig:U,SaveConfig:z,AddCmd:b,GetCmd:w,WriteDeltaUsercmd:tt,ReadDeltaUsercmd:nt,WriteDeltaPlayerState:st,ReadDeltaPlayerState:ot,WriteDeltaEntityState:at,ReadDeltaEntityState:ft,NetchanSetup:mt,NetchanDestroy:gt,NetchanSend:bt,NetchanPrint:wt,NetchanProcess:Et,StringToAddr:St,LoadBsp:xt},sys:N};return Object.defineProperty(e.com,"frameTime",{get:function(){return O}}),e}function G(e){switch(e){case V:return"readFloat";case $:return"readByte";case J:return"readUnsignedByte";case K:return"readUnsignedShort";case Q:return"readUnsignedInt";default:throw new Error("fnread: bad bit count "+e)}}function Y(e){switch(e){case V:return"writeFloat";case $:return"writeByte";case J:return"writeUnsignedByte";case K:return"writeUnsignedShort";case Q:return"writeUnsignedInt";default:throw new Error("fnwrite: bad bit count "+e)}}function tt(e,t,n){t||(t=Z),e.writeInt(n.serverTime),e.writeUnsignedShort(n.angles[0]),e.writeUnsignedShort(n.angles[1]),e.writeUnsignedShort(n.angles[2]),e.writeByte(n.forwardmove),e.writeByte(n.rightmove),e.writeByte(n.upmove),e.writeUnsignedShort(n.buttons),e.writeUnsignedByte(n.weapon)}function nt(e,t,n){n.serverTime=e.readInt(),n.angles[0]=e.readUnsignedShort(),n.angles[1]=e.readUnsignedShort(),n.angles[2]=e.readUnsignedShort(),n.forwardmove=e.readByte(),n.rightmove=e.readByte(),n.upmove=e.readByte(),n.buttons=e.readUnsignedShort(),n.weapon=e.readUnsignedByte()}function st(e,t,n){var i,s,o,u,a,f;t||(t=it),s=0;for(i=0;i<rt.length;i++)o=rt[i],u=r.AGET(t,o.path),a=r.AGET(n,o.path),u!==a&&s++;e.writeByte(s);for(i=0;i<rt.length;i++){o=rt[i],u=r.AGET(t,o.path),a=r.AGET(n,o.path);if(u===a)continue;f=Y(o.bits),e.writeByte(i),e[f](r.AGET(n,o.path))}if(r.MAX_STATS>16||r.MAX_PERSISTANT>16||r.MAX_POWERUPS>16||r.MAX_WEAPONS>16)throw new Error("Array maxes exceed bitmask length");var l=0,c=0,h=0,p=0;for(i=0;i<r.MAX_STATS;i++)n.stats[i]!==t.stats[i]&&(l|=1<<i);for(i=0;i<r.MAX_PERSISTANT;i++)n.persistant[i]!==t.persistant[i]&&(c|=1<<i);for(i=0;i<r.MAX_POWERUPS;i++)n.powerups[i]!==t.powerups[i]&&(h|=1<<i);for(i=0;i<r.MAX_WEAPONS;i++)n.ammo[i]!==t.ammo[i]&&(p|=1<<i);var d=(l?1:0)|(c?2:0)|(h?4:0)|(p?8:0);e.writeByte(d);if(l){e.writeShort(l);for(i=0;i<r.MAX_STATS;i++)l&1<<i&&e.writeShort(n.stats[i])}if(c){e.writeShort(c);for(i=0;i<r.MAX_PERSISTANT;i++)c&1<<i&&e.writeShort(n.persistant[i])}if(h){e.writeShort(h);for(i=0;i<r.MAX_POWERUPS;i++)h&1<<i&&e.writeShort(n.powerups[i])}if(p){e.writeShort(p);for(i=0;i<r.MAX_WEAPONS;i++)p&1<<i&&e.writeShort(n.ammo[i])}}function ot(e,t,n){var i,s,o,u,a,f,l;t||(t=it),t.clone(n),s=e.readByte();for(i=0;i<s;i++)o=e.readByte(),u=rt[o],l=G(u.bits),r.ASET(n,u.path,e[l]());var c=e.readByte();if(c&1){var h=e.readShort();for(i=0;i<r.MAX_STATS;i++)h&1<<i&&(n.stats[i]=e.readShort())}if(c&2){var p=e.readShort();for(i=0;i<r.MAX_PERSISTANT;i++)p&1<<i&&(n.persistant[i]=e.readShort())}if(c&4){var d=e.readShort();for(i=0;i<r.MAX_POWERUPS;i++)d&1<<i&&(n.powerups[i]=e.readShort())}if(c&8){var v=e.readShort();for(i=0;i<r.MAX_WEAPONS;i++)v&1<<i&&(n.ammo[i]=e.readShort())}}function at(e,t,n,i){var s,o,u,a,f,l;if(n===null){if(t===null)return;e.writeShort(t.number),e.writeByte(1);return}if(n.number<0||n.number>=r.MAX_GENTITIES)throw new Error("WriteDeltaEntityState: Bad entity number: ",n.number);o=0;for(s=0;s<ut.length;s++)u=ut[s],a=r.AGET(t,u.path),f=r.AGET(n,u.path),a!==f&&o++;if(o===0){if(!i)return;e.writeShort(n.number),e.writeByte(0);return}e.writeShort(n.number),e.writeByte(2),e.writeByte(o);for(s=0;s<ut.length;s++){u=ut[s],a=r.AGET(t,u.path),f=r.AGET(n,u.path);if(a===f)continue;l=Y(u.bits),e.writeByte(s),e[l](r.AGET(n,u.path))}}function ft(e,t,n,i){var s,o,u,a,f,l,c;if(i<0||i>=r.MAX_GENTITIES)throw new Error("Bad delta entity number: ",i);var h=e.readByte(),p=h&1,d=h&2;if(p){n.reset(),n.number=r.MAX_GENTITIES-1;return}t.clone(n),n.number=i;if(!d)return;o=e.readByte();for(s=0;s<o;s++)u=e.readByte(),a=ut[u],c=G(a.bits),r.ASET(n,a.path,e[c]())}function mt(e,t,n){var i=new m;i.src=e;if(t instanceof r.NetAdr)i.remoteAddress=t,i.remoteAddress.type===r.NA.LOOPBACK?i.msocket={}:i.msocket=N.NetConnect(i.remoteAddress);else{var s=new r.NetAdr;s.type=r.NA.IP,i.remoteAddress=s,i.msocket=t}return i.msocket.onopen=function(){i.ready=!0,n.onopen&&n.onopen()},i.msocket.onmessage=function(e){n.onmessage&&n.onmessage(e)},i.msocket.onclose=function(e){n.onclose&&n.onclose(e)},i.remoteAddress.type===r.NA.LOOPBACK&&(pt[e]=i.msocket.onmessage,i.msocket.onopen()),i}function gt(e){e.ready=!1;if(e.remoteAddress.type===r.NA.LOOPBACK)return;N.NetClose(e.msocket)}function yt(e,t){var n=ht[e.src];n.msgs[n.send++%ct]=t;var i=e.src===r.NS.CLIENT?r.NS.SERVER:r.NS.CLIENT,s=pt[i];if(!s){P("No loopback handler for",i===r.NS.CLIENT?"client":"server");return}s(t)}function bt(e,n,i){var s=new t(dt,t.LITTLE_ENDIAN),o=new Uint8Array(n);s.writeInt(e.outgoingSequence++);for(var u=0;u<i;u++)s.writeUnsignedByte(o[u]);o=new Uint8Array(s.buffer,0,s.index);if(e.remoteAddress.type===r.NA.LOOPBACK){yt(e,o);return}N.NetSend(e.msocket,o)}function wt(e,n){var i=new t(dt,t.LITTLE_ENDIAN);i.writeInt(-1),i.writeCString(n);if(e.remoteAddress.type===r.NA.LOOPBACK){yt(e,i.buffer,i.index);return}var s=new Uint8Array(i.buffer,0,i.index);N.NetSend(e.msocket,s)}function Et(e,t){var n=t.readInt();return e.incomingSequence=n,!0}function St(e){if(!e)return null;var t=new r.NetAdr;if(e.indexOf("localhost")!==-1)return t.type=r.NA.LOOPBACK,t;t.type=r.NA.IP;var n=e.split(":");if(!n.length)return null;var i=parseInt(n[1],10);return isNaN(i)?null:(t.ip=n[0],t.port=i,t)}function xt(e,t){N.ReadFile("maps/"+e+".bsp","binary",function(e,n){if(e)return t(e);var r=i.deserialize(n);t(null,r)})}var a=32,f={CLNETMSG:0,SVNETMSG:1,SVNETCLOSE:2,KEY:3,MOUSE:4},l=32,c=32,h=64,p=16384,d={bad:0,move:1,moveNoDelta:2,clientCommand:3,EOF:4},v={bad:0,gamestate:1,configstring:2,baseline:3,serverCommand:4,snapshot:5,EOF:6},m=function(){this.src=0,this.remoteAddress=null,this.incomingSequence=0,this.outgoingSequence=1,this.ready=!1,this.msocket=null},g={},N,C,k,L,A,O,M,_,I=/([^"\s]+)|"((?:\\"|[^"])+)"/g,V=0,$=1,J=2,K=3,Q=4,Z=new r.UserCmd,et=[{path:r.FTA("angles[0]"),bits:K},{path:r.FTA("angles[1]"),bits:K},{path:r.FTA("angles[2]"),bits:K},{path:r.FTA("forwardmove"),bits:J},{path:r.FTA("rightmove"),bits:J},{path:r.FTA("upmove"),bits:J},{path:r.FTA("buttons"),bits:K},{path:r.FTA("weapon"),bits:J}],rt=[{path:r.FTA("commandTime"),bits:Q},{path:r.FTA("origin[0]"),bits:V},{path:r.FTA("origin[1]"),bits:V},{path:r.FTA("bobCycle"),bits:J},{path:r.FTA("velocity[0]"),bits:V},{path:r.FTA("velocity[1]"),bits:V},{path:r.FTA("viewangles[1]"),bits:V},{path:r.FTA("viewangles[0]"),bits:V},{path:r.FTA("weaponTime"),bits:K},{path:r.FTA("origin[2]"),bits:V},{path:r.FTA("velocity[2]"),bits:V},{path:r.FTA("legsTimer"),bits:J},{path:r.FTA("pm_time"),bits:K},{path:r.FTA("eventSequence"),bits:K},{path:r.FTA("torsoAnim"),bits:J},{path:r.FTA("movementDir"),bits:J},{path:r.FTA("events[0]"),bits:J},{path:r.FTA("legsAnim"),bits:J},{path:r.FTA("events[1]"),bits:J},{path:r.FTA("pm_flags"),bits:K},{path:r.FTA("groundEntityNum"),bits:K},{path:r.FTA("weaponState"),bits:J},{path:r.FTA("eFlags"),bits:K},{path:r.FTA("externalEvent"),bits:K},{path:r.FTA("gravity"),bits:K},{path:r.FTA("speed"),bits:K},{path:r.FTA("delta_angles[1]"),bits:K},{path:r.FTA("externalEventParm"),bits:J},{path:r.FTA("viewheight"),bits:J},{path:r.FTA("damageEvent"),bits:J},{path:r.FTA("damageYaw"),bits:J},{path:r.FTA("damagePitch"),bits:J},{path:r.FTA("damageCount"),bits:J},{path:r.FTA("generic1"),bits:J},{path:r.FTA("pm_type"),bits:J},{path:r.FTA("delta_angles[0]"),bits:K},{path:r.FTA("delta_angles[2]"),bits:K},{path:r.FTA("torsoTimer"),bits:K},{path:r.FTA("eventParms[0]"),bits:J},{path:r.FTA("eventParms[1]"),bits:J},{path:r.FTA("clientNum"),bits:J},{path:r.FTA("arenaNum"),bits:K},{path:r.FTA("weapon"),bits:J},{path:r.FTA("viewangles[2]"),bits:V},{path:r.FTA("jumppad_ent"),bits:K},{path:r.FTA("loopSound"),bits:K}],it=new r.PlayerState,ut=[{path:r.FTA("arenaNum"),bits:K},{path:r.FTA("pos.trTime"),bits:Q},{path:r.FTA("pos.trBase[0]"),bits:V},{path:r.FTA("pos.trBase[1]"),bits:V},{path:r.FTA("pos.trDelta[0]"),bits:V},{path:r.FTA("pos.trDelta[1]"),bits:V},{path:r.FTA("pos.trBase[2]"),bits:V},{path:r.FTA("apos.trBase[1]"),bits:V},{path:r.FTA("pos.trDelta[2]"),bits:V},{path:r.FTA("apos.trBase[0]"),bits:V},{path:r.FTA("event"),bits:K},{path:r.FTA("angles2[1]"),bits:V},{path:r.FTA("eType"),bits:J},{path:r.FTA("torsoAnim"),bits:J},{path:r.FTA("eventParm"),bits:J},{path:r.FTA("legsAnim"),bits:J},{path:r.FTA("groundEntityNum"),bits:K},{path:r.FTA("pos.trType"),bits:J},{path:r.FTA("eFlags"),bits:Q},{path:r.FTA("otherEntityNum"),bits:K},{path:r.FTA("weapon"),bits:J},{path:r.FTA("clientNum"),bits:J},{path:r.FTA("angles[1]"),bits:V},{path:r.FTA("pos.trDuration"),bits:Q},{path:r.FTA("apos.trType"),bits:J},{path:r.FTA("origin[0]"),bits:V},{path:r.FTA("origin[1]"),bits:V},{path:r.FTA("origin[2]"),bits:V},{path:r.FTA("solid"),bits:Q},{path:r.FTA("powerups"),bits:K},{path:r.FTA("modelIndex"),bits:J},{path:r.FTA("otherEntityNum2"),bits:K},{path:r.FTA("loopSound"),bits:J},{path:r.FTA("generic1"),bits:J},{path:r.FTA("origin2[2]"),bits:V},{path:r.FTA("origin2[0]"),bits:V},{path:r.FTA("origin2[1]"),bits:V},{path:r.FTA("modelIndex2"),bits:J},{path:r.FTA("angles[0]"),bits:V},{path:r.FTA("time"),bits:Q},{path:r.FTA("apos.trTime"),bits:Q},{path:r.FTA("apos.trDuration"),bits:Q},{path:r.FTA("apos.trBase[2]"),bits:V},{path:r.FTA("apos.trDelta[0]"),bits:V},{path:r.FTA("apos.trDelta[1]"),bits:V},{path:r.FTA("apos.trDelta[2]"),bits:V},{path:r.FTA("time2"),bits:Q},{path:r.FTA("angles[2]"),bits:V},{path:r.FTA("angles2[0]"),bits:V},{path:r.FTA("angles2[2]"),bits:V},{path:r.FTA("constantLight"),bits:Q},{path:r.FTA("frame"),bits:K}],lt=1400,ct=16,ht=[{msgs:new Array(ct),send:0},{msgs:new Array(ct),send:0}],pt=[],dt=new ArrayBuffer(p),vt=0;return{PACKET_BACKUP:l,SE:f,Init:H,Frame:B,ExecuteBuffer:q,QueueEvent:F}}),define("system/dedicated/sys",["underscore","glmatrix","common/qshared","common/com","common/cvar"],function(e,t,n,r,i){function f(e){var t=a[e];if(!t)return;for(var n=0;n<t.length;n++)t[n].active=!1}function l(e,t){var n=function(){if(!n.active)return;return t.apply(this,arguments)};return n.active=!0,a[e]||(a[e]=[]),a[e].push(n),n}function c(e,t,n,r){typeof r!="undefined"&&(n=l(r,n));var i=o.indexOf(e)>-1;i?A(e,t,n):O(e,t,n)}function h(e,t,n,r,i){typeof i!="undefined"&&(r=l(i,r));var s=o.indexOf(e)>-1;if(!s){g("Can't write to non-whitelisted files.");return}M(e,t,n,r)}function m(){var e=Array.prototype.slice.call(arguments);e.splice(0,0,"SYS:"),Function.apply.call(console.log,console,e)}function g(e){console.trace(),console.error(e),process.exit(0)}function y(){v=i.AddCvar("sys_cdn","http://content.quakejs.com:80",n.CVAR.ARCHIVE),m("Starting dedicated server for version",n.GAME_VERSION),setMatrixArrayType(Array),r.Init(C(),!0,function(){w(),setInterval(function(){r.Frame()},10)})}function b(e){var t=p.createServer(function(e){e.write("Welcome!\n");var t=d.createInterface({input:e,output:e,terminal:!0});t.setPrompt("quakejs> "),t.prompt(),t.on("line",function(e){r.ExecuteBuffer(e),t.prompt()}).on("close",function(){console.log("Have a great day!")})});t.listen(e,function(){m(new Date,"Rcon server is listening on port",t.address().port)})}function w(){var e=process.argv.slice(2);for(var t=0;t<e.length;t++){var n=e[t];if(n.indexOf("--exec")===0){var i=n.substr(7);r.ExecuteBuffer(i)}}}function E(){g("FullscreenChanged: Should not happen")}function S(){g("GetGLContext: Should not happen")}function x(){g("GetUIContext: Should not happen")}function N(){var e=process.hrtime();return T||(T=e[0]*1e3+parseInt(e[1]/1e6,10)),e[0]*1e3+parseInt(e[1]/1e6,10)-T}function C(){return{Error:g,GetMilliseconds:N,ReadFile:c,WriteFile:h,GetGLContext:S,GetUIContext:x,NetListen:H,NetConnect:B,NetSend:j,NetClose:F,CreateRemoteConsole:b}}function A(e,t,n){k.readFile(e,t,function(e,t){return e?(m(e),n(e)):n(null,t)})}function O(e,t,r){var i=t==="binary";e=v.getAsString()+"/assets/"+e+"?v="+n.GAME_VERSION,console.log("ReadFile",e),L.get(e,function(e){if(e.statusCode!==200)return r(new Error("Invalid HTTP response code: "+e.statusCode));if(i){var t=e.headers["content-length"],n=new Uint8Array(t),s=0;e.on("data",function(e){for(var t=0,r=e.length;t<r;t++)n[s++]=e[t]}).on("end",function(e){r(null,n)})}else{var o="";e.on("data",function(e){o+=e}).on("end",function(){r(null,o)})}}).on("error",function(t){r(new Error("Failed to read file: "+e))})}function M(e,t,n,r){k.writeFile(e,t,n,function(e){return e?r(e):r(null)})}function H(e,t){var n=L.createServer(),r=new P({server:n});r.on("connection",function(e){if(t.onrequest&&!t.onrequest(e._socket.remoteAddress)){m(new Date+" Connection from origin "+e._socket.origin+" rejected."),e.close();return}m(new Date,"Connection accepted from "+e._socket.remoteAddress+".");var n=new u;n.handle=e,e.on("message",function(e){if(n.onmessage){var t=new Uint8Array(e);n.onmessage(t)}}),e.on("error",function(e){n.onclose&&n.onclose(e)}),e.on("close",function(){n.onclose&&n.onclose()}),t.onaccept&&t.onaccept(n)}),n.listen(e,function(){m(new Date,"Game server is listening on port",n.address().port)})}function B(e){var t=new D("ws://"+e.ip+":"+e.port),n=new u;return n.handle=t,t.on("open",function(){n.onopen&&n.onopen()}),t.on("message",function(e,t){if(!t.binary)return;n.onmessage&&n.onmessage(e)}),t.on("error",function(e){n.onclose&&n.onclose(e)}),t.on("close",function(){n.onclose&&n.onclose()}),n}function j(e,t){var n=e.handle;n.send(t,{binary:!0})}function F(e){var t=e.handle;t.close()}var s={us:{"default":{8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"command",92:"_91",93:"select",96:"num0",97:"num1",98:"num2",99:"num3",100:"num4",101:"num5",102:"num6",103:"num7",104:"num8",105:"num9",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shifted:{48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",107:"+",109:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'}}},o=["user.cfg"],u=function(){this.handle=null,this.onmessage=null,this.onclose=null},a={},p=require("net"),d=require("readline"),v,T,k=require("fs"),L=require("http"),L=require("http"),_=require("url"),D=require("ws"),P=require("ws").Server;return{Init:y}});